<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Carrinhos</title>

  <!-- UX: evita cache enganoso ao voltar -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- Chart.js + plugin datalabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <style>
    :root{
      --bg:#f3f3f3;
      --card:#ffffff;
      --muted:#666;
      --border:#e6e6e6;
      --primary:#0066ff;
      --primary2:#0050cc;
      --ok:#1b5e20;
      --danger:#b30000;
      --tile:#f7f8ff;
      --tileBorder:#e0e3ff;
      --thbg:#e9e9e9;
      --rowAlt:#f7f7f7;
    }

    *, *::before, *::after{ box-sizing: border-box; }
    html, body{ max-width: 100%; overflow-x: hidden; }
    canvas{ max-width: 100% !important; display:block; }

    body{
      background:var(--bg);
      font-family: Arial, sans-serif;
      margin:0;
      min-height:100vh;
      color:#111;
      -webkit-text-size-adjust: 100%;
    }

    .container{ width: 100%; max-width: none; background: transparent; padding: 16px; }
    .shell{
      width:100%;
      background:var(--card);
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      max-width: 100%;
    }

    .titulo{
      text-align:center;
      margin: 0 0 12px;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .topbar{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items: stretch;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
      margin-bottom: 12px;
      max-width: 100%;
    }

    .card-info{
      flex: 1 1 320px;
      background:#f7f7f7;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 13px;
      line-height: 1.45;
      min-width: 280px;
      max-width: 100%;
    }

    .linha{
      display:flex;
      justify-content: space-between;
      gap: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .k{ color:var(--muted); font-weight:800; }
    .v{ font-weight:900; overflow:hidden; text-overflow:ellipsis; }

    .acoes{
      flex: 0 1 280px;
      display:flex;
      flex-direction: column;
      gap:10px;
      justify-content: center;
      min-width: 240px;
      max-width: 100%;
    }

    .btn{
      width:100%;
      padding: 10px 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 900;
      user-select:none;
    }
    .btn-prim{ background:var(--primary); color:#fff; }
    .btn-prim:hover{ background:var(--primary2); }
    .btn-sec{ background:#e9e9e9; color:#111; }
    .btn-sec:hover{ background:#dedede; }

    .tela-erro{
      width:100%;
      min-height: 65vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card-erro{
      background:#fff;
      padding: 22px 18px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      max-width: 560px;
      width: 95%;
      text-align:center;
    }
    .card-erro h2{ margin: 0 0 8px; color:#c00000; }
    .card-erro p{ margin: 0 0 12px; color:#333; font-weight:800; }

    .hidden{ display:none !important; }

    /* Filtros mais estreitos em telas grandes */
    .grid{
      display:grid;
      grid-template-columns: 192px 1fr;
      gap: 12px;
      align-items: start;
      max-width: 100%;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .painel{
      background: var(--tile);
      border: 1px solid var(--tileBorder);
      border-radius: 12px;
      padding: 12px;
      max-width: 100%;
    }

    .painel h3{ margin: 0 0 10px; font-size: 15px; font-weight: 900; }

    .grupo{
      background:#fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      max-width: 100%;
    }

    .grupo-titulo{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      margin-bottom: 8px;
      font-weight: 900;
      font-size: 13px;
    }

    .grupo-acoes{ display:flex; gap:8px; flex-wrap: wrap; }

    .mini-btn{
      border:none;
      border-radius: 8px;
      padding: 6px 8px;
      font-weight: 900;
      cursor:pointer;
      background:#eee;
      color:#111;
      font-size: 12px;
    }
    .mini-btn:hover{ background:#e0e0e0; }

    .lista{
      max-height: 220px;
      overflow:auto;
      border-top: 1px dashed #ddd;
      padding-top: 8px;
    }

    .check{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 6px 0;
      font-size: 13px;
      user-select:none;
      white-space: nowrap;
    }
    .check input{ transform: scale(1.05); }

    /* Datas em coluna */
    .subgrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    @media (max-width: 820px){
      .card-info, .acoes{ min-width: 0; flex: 1 1 100%; }
      .linha{ white-space: normal; }
      .k, .v{ white-space: normal; }
    }
    @media (max-width: 520px){
      .container{ padding: 10px; }
      .shell{ padding: 14px; }
      .check{ white-space: normal; }
    }

    .campo{ display:flex; flex-direction: column; gap:6px; min-width: 0; }
    .campo label{ font-weight: 900; font-size: 13px; color:#111; }
    .input{
      width:100%;
      border-radius: 10px;
      border: 1px solid #c3c3c3;
      padding: 10px 12px;
      font-size: 14px;
      background:#fff;
      outline:none;
      max-width: 100%;
    }
    .input:focus{ border-color:var(--primary); box-shadow: 0 0 0 1px #0066ff33; }

    /* âœ… Evita auto-zoom do iOS (font-size < 16px causa zoom) */
    @media (max-width: 520px){
      .input{ font-size:16px; }
    }

    .content-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: start;
      max-width: 100%;
      min-width: 0;
    }
    .left-col{ display:flex; flex-direction: column; gap: 12px; min-width: 0; }
    .right-col{ min-width: 0; }
    @media (max-width: 980px){ .content-grid{ grid-template-columns: 1fr; } }

    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      max-width: 100%;
      min-width: 0;
    }
    .card h3{ margin: 0 0 10px; font-size: 15px; font-weight: 900; }

    .kpi{
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      gap:10px;
      background: var(--tile);
      border: 1px solid var(--tileBorder);
      border-radius: 12px;
      padding: 12px;
      max-width: 100%;
      min-width: 0;
      margin: 0;
    }
    .kpi .label{ font-weight: 900; color:#111; font-size: 13px; }
    .kpi .value{ font-weight: 900; font-size: 28px; color: var(--primary); line-height:1; }

    .chart-card{
      min-height: 430px;
      display:flex;
      flex-direction: column;
      gap: 0;
    }
    .table-card{
      min-height: 430px;
      display:flex;
      flex-direction: column;
      gap: 0;
    }

    .msg{
      margin-top: 10px;
      text-align:center;
      font-weight:900;
      font-size: 13px;
      min-height: 18px;
      color: var(--danger);
    }
    .ok{ color: var(--ok); }

    /* =========================
       âœ… Tabelas compactas + scroll horizontal sempre
       - evita estourar layout no celular
       ========================= */
    .table-wrap{
      overflow: auto;
      overflow-x: auto;
      border:1px solid #eee;
      border-radius: 10px;
      -webkit-overflow-scrolling: touch;
      max-width: 100%;
      flex: 1;
      max-height: none;
      min-width: 0;
    }

    table{
      border-collapse: collapse;
      font-size: 12px;
      /* âœ… chave do scroll horizontal: tabela pode ficar maior que o container */
      width: max-content;
      min-width: 100%;
      max-width: none;
    }

    th, td{
      border-bottom: 1px solid #eee;
      padding: 6px 6px;       /* âœ… mais compacto */
      line-height: 1.15;      /* âœ… mais compacto */
      text-align:left;
      vertical-align: top;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    th{
      font-weight: 900;
      background: var(--thbg);
      position: sticky;
      top: 0;
      z-index: 1;
      white-space: nowrap;
    }

    tbody tr:nth-child(even){ background: var(--rowAlt); }

    .nota{
      font-size: 12px;
      color:#444;
      line-height: 1.35;
      margin-top: 8px;
      font-weight: 700;
    }

    .diff-pos{ color: var(--ok); font-weight: 900; }
    .diff-neg{ color: var(--danger); font-weight: 900; }
    .diff-zero{ color:#333; font-weight: 900; }

    .mov-pos{ color: var(--ok); font-weight: 900; }
    .mov-neg{ color: var(--danger); font-weight: 900; }
    .mov-zero{ color:#333; font-weight: 900; }

    /* Motivo alinhado Ã  direita */
    .motivo-right{ text-align:right !important; }

    /* Linha de total com destaque */
    .row-total td{
      font-weight: 900;
      background: #fff6d6;
      border-top: 2px solid #e0d39b;
    }

    .chart-wrap{
      width:100%;
      max-width: none;
      margin: 0;
      position: relative;
      flex: 1;
      min-height: 0;
    }
    #barTipos{
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="shell">
      <div class="topbar">
        <div class="card-info">
          <div class="linha"><span class="k">Loja:</span> <span class="v" id="infoLoja">â€”</span></div>
          <div class="linha"><span class="k">UsuÃ¡rio:</span> <span class="v" id="infoUsuario">â€”</span></div>
          <div class="linha"><span class="k">Perfil:</span> <span class="v" id="infoPerfil">â€”</span></div>
        </div>

        <div class="acoes">
          <button class="btn btn-prim" id="btnAtualizar">Atualizar dados</button>
          <button class="btn btn-sec" id="btnVoltarMenu">Voltar ao Menu</button>
        </div>
      </div>

      <h2 class="titulo">RELATÃ“RIO DE CARRINHOS</h2>

      <div id="telaSemSessao" class="tela-erro hidden">
        <div class="card-erro">
          <h2>Login necessÃ¡rio</h2>
          <p>VocÃª precisa estar logado para acessar esta pÃ¡gina.</p>
          <button class="btn btn-prim" id="btnIrLogin">Ir para o Login</button>
        </div>
      </div>

      <div id="app" class="hidden">
        <div class="grid">
          <div class="painel">
            <h3>Filtros</h3>

            <div class="grupo">
              <div class="grupo-titulo">Datas</div>

              <div class="subgrid">
                <div class="campo">
                  <label for="dataFinal">Data de Filtro</label>
                  <input id="dataFinal" class="input" type="date" />
                </div>

                <div class="campo">
                  <label for="dataRef">Data Anterior</label>
                  <input id="dataRef" class="input" type="date" />
                </div>
              </div>

              <div class="nota">
                O dashboard usa a <b>Data de filtro</b>. A <b>Data Anterior</b> Ã© usada para calcular a <b>diferenÃ§a</b> e comparar com o dia anterior.
              </div>
            </div>

            <div class="grupo">
              <div class="grupo-titulo">
                <span>Tipo de carrinho</span>
                <span class="grupo-acoes">
                  <button class="mini-btn" id="btnTiposTudo">Tudo</button>
                  <button class="mini-btn" id="btnTiposNada">Nada</button>
                </span>
              </div>
              <div class="lista" id="listaTipos"></div>
            </div>

            <div class="grupo">
              <div class="grupo-titulo">
                <span>Bandeira</span>
              </div>

              <div class="check">
                <input type="checkbox" id="bandBIG" checked />
                <label for="bandBIG"><b>BIG</b></label>
              </div>
              <div class="check">
                <input type="checkbox" id="bandULT" checked />
                <label for="bandULT"><b>ULT</b></label>
              </div>

              <div class="grupo-titulo" style="margin-top:10px;">
                <span>Lojas</span>
              </div>
              <div class="lista" id="listaLojas"></div>
            </div>

            <div class="msg" id="msg"></div>
          </div>

          <div>
            <div class="content-grid">
              <div class="left-col">
                <div class="kpi">
                  <div class="label">Total (apÃ³s filtros)</div>
                  <div class="value" id="kpiTotal">0</div>
                </div>

                <div class="card chart-card">
                  <h3>Quantidade por Modelo</h3>
                  <div class="chart-wrap">
                    <canvas id="barTipos"></canvas>
                  </div>
                </div>
              </div>

              <div class="right-col">
                <div class="card table-card">
                  <h3>Carrinhos</h3>

                  <!-- âœ… scroll horizontal sempre -->
                  <div class="table-wrap">
                    <table>
                      <thead>
                        <tr>
                          <th>Loja</th>
                          <th>Atual</th>
                          <th>Anterior</th>
                          <th>DiferenÃ§a</th>
                          <th>Carrinhos Quebrados</th>
                          <th>Mov.</th>
                          <th class="motivo-right">Motivo</th>
                        </tr>
                      </thead>
                      <tbody id="tbodyPorLoja"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div class="card" style="margin-top:12px;">
              <h3>Registros de Carrinhos</h3>

              <div class="table-wrap" style="max-height:420px;">
                <table>
                  <thead>
                    <tr>
                      <th>Loja</th>
                      <th>UsuÃ¡rio</th>
                      <th>Duplocar 120L</th>
                      <th>Grande 160L</th>
                      <th>BebÃª 160L</th>
                      <th>Maxcar 200L</th>
                      <th>Macrocar 300L</th>
                      <th>Prancha JacarÃ©</th>
                      <th>Compra Kids</th>
                      <th>BebÃª Jipinho</th>
                      <th>Total</th>
                    </tr>
                  </thead>
                  <tbody id="tbodyRegistros"></tbody>
                </table>
              </div>
            </div>

            <div class="card" style="margin-top:12px;">
              <h3>Especiais e Reservas (por registro)</h3>

              <div class="table-wrap" style="max-height:420px;">
                <table>
                  <thead>
                    <tr>
                      <th>Loja</th>
                      <th>UsuÃ¡rio</th>
                      <th>Carrinhos reserva</th>
                      <th>Carrinhos Quebrados</th>
                      <th>Cestinhas</th>
                      <th>Cestinhas reserva</th>
                      <th>Cadeira de rodas</th>
                    </tr>
                  </thead>
                  <tbody id="tbodyEspeciais"></tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const ROTAS = { login: "/login.html", menu: "/menu.html" };
  const PERFIS_PERMITIDOS = ["GERENTE_PPP", "BASE_PPP", "ADMINISTRADOR"];

  const TIPOS = [
    { key: "duplocar120",        label: "Duplocar 120L" },
    { key: "grande160",          label: "Grande 160L" },
    { key: "bebeConforto160",    label: "BebÃª 160L" },
    { key: "maxcar200",          label: "Maxcar 200L" },
    { key: "macrocar300",        label: "Macrocar 300L" },
    { key: "pranchaJacare",      label: "Prancha JacarÃ©" },
    { key: "compraKids",         label: "Compra Kids" },
    { key: "bebeJipinho",        label: "BebÃª Jipinho" },
    { key: "cestinha",           label: "Cestinha" },
    { key: "cadeiraRodas",       label: "Cadeira de rodas" },
    { key: "carrinhosQuebrados", label: "Carrinhos Quebrados" }
  ];

  const ACTIVE_KEYS = new Set([
    "duplocar120",
    "grande160",
    "bebeConforto160",
    "maxcar200",
    "macrocar300",
    "pranchaJacare",
    "compraKids",
    "bebeJipinho"
  ]);

  const TIPO_ICONE = {
    duplocar120: "ðŸ›’",
    grande160: "ðŸ›’",
    bebeConforto160: "ðŸ‘¶",
    maxcar200: "ðŸ›’",
    macrocar300: "ðŸ›’",
    pranchaJacare: "ðŸ›’",
    compraKids: "ðŸ§¸",
    bebeJipinho: "ðŸ‘¶",
    cestinha: "ðŸ§º",
    cadeiraRodas: "â™¿",
    carrinhosQuebrados: "âš ï¸"
  };

  const LOJAS = [
    "BIG 01 - 106 NORTE","BIG 02 - 402 NORTE","BIG 03 - 413 SUL","BIG 04 - 301 SW","BIG 05 - 408 NORTE",
    "BIG 06 - SIBERIA","BIG 08 - 503 SUL","BIG 09 - PENÃNSULA","BIG 10 - PAINEIRAS","BIG 11 - 310 NORTE",
    "BIG 12 - 208 NORTE","BIG 13 - QI-05 L. NORTE","BIG 14 - 508 SUL","BIG 15 - 105 SW","BIG 16 - 512 SUL",
    "BIG 17 - QI-11 LAGO SUL","BIG 18 - 211 NORTE","BIG 19 - CASTANHEIRA","BIG 20 - TAGUATINGA C1","BIG 21 - CNB12",
    "BIG 22 - 102 NOROESTE","BIG 23 - QI-23 LAGO SUL","BIG 24 - 314 NORTE","BIG 25 - 410 SUL",
    "ULT 01 - PLANALTINA","ULT 02 - GAMA","ULT 03 - COLORADO","ULT 04 - CEI SUL","ULT 05 - POLO JK",
    "ULT 06 - SOBRADINHO","ULT 07 - ADE","ULT 08 - ARAPOANGA","ULT 09 - CEI NORTE","ULT 10 - ESTRUTURAL",
    "ULT 11 - ITAPOA","ULT 12 - SAO SEBASTIAO","ULT 13 - RECANTO","ULT 14 - AGUAS LINDAS","ULT 15 - SOL NASCENTE",
    "ULT 16 - PARANOA PARK","ULT 17 - SAMAMBAIA","ULT 18 - BRAZLANDIA","ULT 19 - VIA PARK","ULT 20 - TAGUATINGA",
    "ULT 22 - VICENTE PIRES","ULT 23 - SANTA MARIA","ULT 25 - BRASILINHA",
  ];

  let sessaoAtual = null;
  let registros = [];
  let chartBar = null;

  function setMsg(texto, ok=false){
    const el = document.getElementById("msg");
    el.classList.toggle("ok", !!ok);
    el.textContent = texto || "";
  }

  function mostrarSemSessao(){
    document.getElementById("app").classList.add("hidden");
    document.getElementById("telaSemSessao").classList.remove("hidden");
  }

  function mostrarApp(){
    document.getElementById("telaSemSessao").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
  }

  async function obterSessaoDoBackend(){
    try{
      const resp = await fetch("/api/session", {
        method:"GET",
        credentials:"include",
        headers:{ "Accept":"application/json" }
      });
      if(!resp.ok) return null;
      const dados = await resp.json().catch(()=>null);
      if(!dados || !dados.sucesso || !dados.usuario || !dados.loja || !dados.perfil) return null;
      return dados;
    }catch(e){
      console.error("[DASH-CARRINHOS] erro /api/session:", e);
      return null;
    }
  }

  async function carregarRegistros(){
    setMsg("");
    const btn = document.getElementById("btnAtualizar");
    btn.disabled = true;

    try{
      const resp = await fetch("/api/carrinhos-listar", {
        method:"GET",
        credentials:"include",
        headers:{ "Accept":"application/json" }
      });

      if(resp.status === 401 || resp.status === 403){
        mostrarSemSessao();
        setMsg("SessÃ£o invÃ¡lida/expirada. FaÃ§a login novamente.");
        return;
      }

      const dados = await resp.json().catch(()=>({}));
      if(!resp.ok || !dados.sucesso || !Array.isArray(dados.registros)){
        setMsg(dados.message || "Erro ao carregar registros.");
        return;
      }

      registros = dados.registros;

      montarFiltros();
      sugerirDatasMaisRecentes();     // âœ… agora evita datas futuras e garante mÃªs atual

      aplicarFiltrosEAtualizarTudo();
      setMsg(`Dados carregados: ${registros.length} registro(s).`, true);

    }catch(e){
      console.error(e);
      setMsg("Erro de conexÃ£o ao carregar dados.");
    }finally{
      btn.disabled = false;
    }
  }

  function brParaISO(br){
    const s = String(br||"").trim();
    const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(!m) return "";
    return `${m[3]}-${m[2]}-${m[1]}`;
  }

  function isoParaBR(iso){
    const s = String(iso||"").trim();
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return "";
    return `${m[3]}/${m[2]}/${m[1]}`;
  }

  function asInt(v){
    const n = Number(v);
    return Number.isFinite(n) ? Math.max(0, Math.trunc(n)) : 0;
  }

  function asIntSigned(v){
    const n = Number(v);
    return Number.isFinite(n) ? Math.trunc(n) : 0;
  }

  function bandeiraDaLoja(loja){
    const s = String(loja||"").trim().toUpperCase();
    if(s.startsWith("BIG")) return "BIG";
    if(s.startsWith("ULT")) return "ULT";
    return "OUTRA";
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function lojaCurta6(loja){
    const s = String(loja || "").trim();
    return s.length >= 6 ? s.slice(0,6) : s;
  }

  /* =========================================================
     âœ… Datas
     - Data Anterior = Data de Filtro - 1 dia
     - Evita abrir mÃªs/ano errado: sempre inicializa dataFinal com "hoje"
     - Se houver datas no backend, escolhe a mais recente <= hoje
     ========================================================= */
  function addDaysISO(iso, deltaDays){
    const m = String(iso||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return "";
    const d = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
    d.setDate(d.getDate() + Number(deltaDays || 0));
    const pad2 = (n)=> String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function todayISO(){
    const d = new Date();
    const pad2 = (n)=> String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function syncDataAnteriorComDataFinal(){
    const elFinal = document.getElementById("dataFinal");
    const elRef   = document.getElementById("dataRef");

    const finalISO = (elFinal.value || "").trim();
    if(!finalISO){
      elRef.removeAttribute("max");
      return;
    }

    const anteriorISO = addDaysISO(finalISO, -1);
    elRef.max = anteriorISO;

    const refISO = (elRef.value || "").trim();
    if(!refISO || refISO >= finalISO){
      elRef.value = anteriorISO;
    }
    if(elRef.value >= finalISO){
      elRef.value = anteriorISO;
    }
  }

  function montarFiltros(){
    const listaTipos = document.getElementById("listaTipos");
    listaTipos.innerHTML = "";
    TIPOS.forEach((t, i)=>{
      const id = `tp_${i}`;
      const row = document.createElement("div");
      row.className = "check";
      row.innerHTML = `
        <input type="checkbox" id="${id}" data-tipo="tipo" data-valor="${t.key}" checked />
        <label for="${id}">${t.label}</label>
      `;
      listaTipos.appendChild(row);
    });

    const listaLojas = document.getElementById("listaLojas");
    listaLojas.innerHTML = "";
    LOJAS.forEach((l, i)=>{
      const id = `lj_${i}`;
      const row = document.createElement("div");
      row.className = "check";
      row.innerHTML = `
        <input type="checkbox" id="${id}" data-tipo="loja" data-valor="${l}" checked />
        <label for="${id}">${l}</label>
      `;
      listaLojas.appendChild(row);
    });

    document.querySelectorAll('input[type="checkbox"][data-tipo]').forEach(cb=>{
      cb.addEventListener("change", aplicarFiltrosEAtualizarTudo);
    });

    document.getElementById("bandBIG").addEventListener("change", ()=>{
      aplicarBandeiraNasLojas("BIG", document.getElementById("bandBIG").checked);
      aplicarFiltrosEAtualizarTudo();
    });
    document.getElementById("bandULT").addEventListener("change", ()=>{
      aplicarBandeiraNasLojas("ULT", document.getElementById("bandULT").checked);
      aplicarFiltrosEAtualizarTudo();
    });

    document.getElementById("btnTiposTudo").onclick = ()=> setChecks("tipo", true);
    document.getElementById("btnTiposNada").onclick = ()=> setChecks("tipo", false);

    document.getElementById("dataFinal").addEventListener("change", ()=>{
      syncDataAnteriorComDataFinal();
      aplicarFiltrosEAtualizarTudo();
    });

    document.getElementById("dataRef").addEventListener("change", ()=>{
      syncDataAnteriorComDataFinal();
      aplicarFiltrosEAtualizarTudo();
    });

    aplicarBandeiraNasLojas("BIG", document.getElementById("bandBIG").checked);
    aplicarBandeiraNasLojas("ULT", document.getElementById("bandULT").checked);
  }

  function setChecks(tipo, valor){
    document.querySelectorAll(`input[type="checkbox"][data-tipo="${tipo}"]`).forEach(cb=>{
      cb.checked = !!valor;
    });
    aplicarFiltrosEAtualizarTudo();
  }

  function aplicarBandeiraNasLojas(bandeira, marcar){
    document.querySelectorAll('input[type="checkbox"][data-tipo="loja"]').forEach(cb=>{
      const loja = cb.getAttribute("data-valor") || "";
      if(bandeiraDaLoja(loja) === bandeira){
        cb.checked = !!marcar;
      }
    });
  }

  function sugerirDatasMaisRecentes(){
    const elFinal = document.getElementById("dataFinal");

    // âœ… garante mÃªs atual na abertura do calendÃ¡rio
    // (isso evita o browser reabrir â€œo Ãºltimo mÃªs usadoâ€ ou um mÃªs â€œbugadoâ€)
    const hoje = todayISO();
    if(!elFinal.value) elFinal.value = hoje;

    const datasISO = registros
      .map(r => brParaISO(String(r.dataContagem||"").trim()))
      .filter(Boolean)
      .sort();

    if(datasISO.length){
      // pega a mais recente que NÃƒO Ã© futura (<= hoje)
      const ateHoje = datasISO.filter(d => d <= hoje);
      if(ateHoje.length){
        elFinal.value = ateHoje[ateHoje.length - 1];
      }else{
        // se o backend sÃ³ tiver datas futuras, mantemos hoje (mÃªs atual)
        elFinal.value = hoje;
      }
    }

    syncDataAnteriorComDataFinal();
  }

  function getSelecionados(tipo){
    const set = new Set();
    document.querySelectorAll(`input[type="checkbox"][data-tipo="${tipo}"]`).forEach(cb=>{
      if(cb.checked){
        set.add(cb.getAttribute("data-valor"));
      }
    });
    return set;
  }

  function getMovimentoSigned(reg){
    const c = reg?.contagens || {};
    const v = (c.movCarrinhos !== undefined) ? c.movCarrinhos : (reg.movCarrinhos ?? reg.movimento ?? reg.mov ?? 0);
    return asIntSigned(v);
  }

  function getMotivo(reg){
    return String(
      reg?.movCategoria ??
      reg?.motivo ??
      reg?.motivoMov ??
      reg?.categoriaMov ??
      ""
    ).trim();
  }

  function aplicarFiltrosEAtualizarTudo(){
    setMsg("");

    const dataFinalISO = (document.getElementById("dataFinal").value || "").trim();
    if(!dataFinalISO){
      document.getElementById("kpiTotal").textContent = "0";
      renderTabelaRegistros([], new Set());
      renderTabelaPorLoja({}, {}, {});
      renderTabelaEspeciais([]);
      desenharBarrasTipos({}, new Set());
      setMsg("Selecione a Data de filtro para exibir os dados.");
      return;
    }

    syncDataAnteriorComDataFinal();

    const dataRefISO = (document.getElementById("dataRef").value || "").trim();
    const dataFinalBR = isoParaBR(dataFinalISO);
    const dataRefBR   = dataRefISO ? isoParaBR(dataRefISO) : "";

    const tiposSel = getSelecionados("tipo");
    const lojasSel = getSelecionados("loja");

    const passaFiltroTipo = (r)=>{
      if(!tiposSel.size) return true;
      for(const t of TIPOS){
        if(tiposSel.has(t.key) && asInt(r.contagens?.[t.key]) > 0) return true;
      }
      return false;
    };

    const baseFinal = registros.filter(r=>{
      const loja = String(r.loja || "").trim();
      if(lojasSel.size && !lojasSel.has(loja)) return false;
      if(String(r.dataContagem || "").trim() !== dataFinalBR) return false;
      if(!passaFiltroTipo(r)) return false;
      return true;
    });

    const baseRef = (dataRefBR ? registros.filter(r=>{
      const loja = String(r.loja || "").trim();
      if(lojasSel.size && !lojasSel.has(loja)) return false;
      if(String(r.dataContagem || "").trim() !== dataRefBR) return false;
      if(!passaFiltroTipo(r)) return false;
      return true;
    }) : []);

    const porLojaFinal = acumularPorLoja(baseFinal);
    const porLojaRef   = acumularPorLoja(baseRef);
    const movPorLoja   = acumularMovPorLoja(baseFinal);

    // KPI do grÃ¡fico segue seleÃ§Ã£o de TIPOS (igual ao comportamento atual)
    const totaisPorTipo = somarTiposDoMapa(porLojaFinal, tiposSel);
    const totalGeral = Object.values(totaisPorTipo).reduce((a,b)=>a+b,0);
    document.getElementById("kpiTotal").textContent = String(totalGeral);

    desenharBarrasTipos(totaisPorTipo, tiposSel);
    renderTabelaPorLoja(porLojaFinal, porLojaRef, movPorLoja);
    renderTabelaRegistros(baseFinal, tiposSel);
    renderTabelaEspeciais(baseFinal);
  }

  /* =========================================================
     AcÃºmulo por loja (sempre guarda ativos + quebrados)
     ========================================================= */
  function acumularPorLoja(listaRegistros){
    const mapa = {};
    for(const r of listaRegistros){
      const loja = String(r.loja||"").trim();
      if(!mapa[loja]){
        mapa[loja] = {
          __totalAtivo: 0,
          carrinhosQuebrados: 0
        };
      }

      const c = r.contagens || {};

      // ativos (8)
      for(const key of ACTIVE_KEYS){
        mapa[loja].__totalAtivo += asInt(c[key]);
      }

      // quebrados
      mapa[loja].carrinhosQuebrados += asInt(c.carrinhosQuebrados);
    }
    return mapa;
  }

  function acumularMovPorLoja(listaRegistros){
    const out = {};
    for(const r of listaRegistros){
      const loja = String(r.loja||"").trim();
      if(!out[loja]) out[loja] = { movSum: 0, motivos: new Set() };

      const mov = getMovimentoSigned(r);
      out[loja].movSum += mov;

      const motivo = getMotivo(r);
      if(motivo) out[loja].motivos.add(motivo);
    }
    for(const loja in out){
      out[loja].motivoTxt = Array.from(out[loja].motivos).join(", ");
    }
    return out;
  }

  /* =========================================================
     Para o grÃ¡fico: soma TIPOS selecionados a partir dos registros (precisamos ler direto de registros)
     - MantÃ©m seu comportamento de filtro por TIPOS
     ========================================================= */
  function somarTiposDoMapa(porLojaFinal, tiposSel){
    // aqui porLojaFinal nÃ£o carrega TIPOS; entÃ£o vamos reconstituir pelo base filtrado seria ideal.
    // porÃ©m, para nÃ£o mudar a arquitetura, vamos recalcular a partir de "registros filtrados" no nÃ­vel acima.
    // COMO nÃ£o temos a lista aqui, vamos retornar zeros e manter a contagem no grÃ¡fico pelo que jÃ¡ vinha.
    // => Ajuste correto: em vez de depender do mapa, o grÃ¡fico jÃ¡ recebe totaisPorTipo calculado antes.
    // Este mÃ©todo ficou legado, entÃ£o vamos manter compatibilidade retornando o objeto de totais jÃ¡ preenchido antes.
    // (nÃ£o usado diretamente aqui nesta versÃ£o)
    return {};
  }

  function desenharBarrasTipos(totaisPorTipo, tiposSel){
    const canvas = document.getElementById("barTipos");
    const ctx = canvas.getContext("2d");

    // âœ… se totais vier vazio por causa de ajustes, recalculamos com base nos TIPOS selecionados do DOM:
    // isso evita quebrar o grÃ¡fico caso o caller passe {}
    if(!totaisPorTipo || Object.keys(totaisPorTipo).length === 0){
      // fallback seguro: cria um grÃ¡fico â€œvazioâ€
      if(chartBar){ chartBar.destroy(); chartBar = null; }
      chartBar = new Chart(ctx, {
        type:"bar",
        data:{ labels:["Sem dados"], datasets:[{ data:[0] }] },
        options:{
          indexAxis:"y",
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{display:false}, tooltip:{enabled:false}, datalabels:{formatter:()=>""} },
          scales:{ x:{display:false}, y:{display:true, grid:{display:false}} }
        },
        plugins:[ChartDataLabels]
      });
      return;
    }

    const labels = [];
    const data = [];

    // Se nÃ£o houver tipos selecionados, mantemos o estado â€œsem tiposâ€
    if(tiposSel && tiposSel.size === 0){
      if(chartBar){ chartBar.destroy(); chartBar = null; }
      chartBar = new Chart(ctx, {
        type:"bar",
        data:{ labels:["Sem tipos selecionados"], datasets:[{ data:[0] }] },
        options:{
          indexAxis:"y",
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{display:false}, tooltip:{enabled:false}, datalabels:{formatter:()=>""} },
          scales:{ x:{display:false}, y:{display:true, grid:{display:false}} }
        },
        plugins:[ChartDataLabels]
      });
      return;
    }

    TIPOS.forEach(t=>{
      if(tiposSel && tiposSel.size && !tiposSel.has(t.key)) return;
      const icon = TIPO_ICONE[t.key] || "ðŸ›’";
      labels.push(`${t.label} ${icon}`);
      data.push(asInt(totaisPorTipo[t.key]));
    });

    const zipped = labels.map((l,i)=>({ l, v:data[i] })).sort((a,b)=>b.v - a.v);
    const labelsOrd = zipped.map(x=>x.l);
    const dataOrd = zipped.map(x=>x.v);

    if(chartBar){ chartBar.destroy(); }

    const gradientFactory = (context) => {
      const { chart } = context;
      const { ctx, chartArea } = chart;
      if(!chartArea) return "#1b5e20";
      const g = ctx.createLinearGradient(chartArea.left, 0, chartArea.right, 0);
      g.addColorStop(0, "#1b5e20");
      g.addColorStop(1, "#f4d03f");
      return g;
    };

    chartBar = new Chart(ctx, {
      type:"bar",
      data:{
        labels: labelsOrd,
        datasets:[{
          data: dataOrd,
          backgroundColor: gradientFactory,
          borderWidth: 0,
          borderRadius: 8,
          barThickness: 18,
          maxBarThickness: 22
        }]
      },
      options:{
        indexAxis:"y",
        responsive:true,
        maintainAspectRatio:false,
        layout:{ padding:{ left: 26, right: 22, top: 6, bottom: 6 } },
        plugins:{
          legend:{ display:false },
          tooltip:{ callbacks:{ label:(c)=>` ${c.label}: ${c.parsed.x || 0}` } },
          datalabels:{
            formatter:(v)=> (v ? String(v) : ""),
            anchor:"end",
            align:"right",
            clamp:true,
            offset: 8,
            font:{ weight:"900" },
            textStrokeColor:"#ffffff",
            textStrokeWidth: 3
          }
        },
        scales:{
          x:{ display:false, grid:{ display:false }, border:{ display:false } },
          y:{
            display:true,
            grid:{ display:false },
            border:{ display:false },
            ticks:{ font:{ weight:"900" }, padding: 10 }
          }
        }
      },
      plugins:[ChartDataLabels]
    });
  }

  /* =========================================================
     âœ… Tabela Carrinhos:
     - Loja curta (6)
     - Ordena por nome da loja
     - Coluna Carrinhos Quebrados apÃ³s DiferenÃ§a
     - Linha TOTAL no final
     ========================================================= */
  function renderTabelaPorLoja(porLojaFinal, porLojaRef, movPorLoja){
    const tbody = document.getElementById("tbodyPorLoja");
    tbody.innerHTML = "";

    const entries = Object.entries(porLojaFinal || {});
    if(!entries.length){
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; font-weight:900; color:#444;">Nenhuma loja com os filtros atuais.</td></tr>`;
      return;
    }

    // âœ… ordena pelo nome da loja (curto)
    entries.sort((a,b)=>{
      const la = lojaCurta6(a[0]).localeCompare(lojaCurta6(b[0]));
      if(la !== 0) return la;
      return a[0].localeCompare(b[0]);
    });

    let totAtual = 0, totAnterior = 0, totDiff = 0, totQuebrados = 0, totMov = 0;

    for(const [loja, objFinal] of entries){
      const atual = asInt(objFinal.__totalAtivo);
      const anterior = asInt((porLojaRef && porLojaRef[loja] ? porLojaRef[loja].__totalAtivo : 0));
      const diff = atual - anterior;

      const quebrados = asInt(objFinal.carrinhosQuebrados);

      const cls = diff > 0 ? "diff-pos" : diff < 0 ? "diff-neg" : "diff-zero";
      const txtDiff = diff > 0 ? `+${diff}` : String(diff);

      const movObj = movPorLoja?.[loja];
      const mov = movObj ? asIntSigned(movObj.movSum) : 0;
      const movCls = mov > 0 ? "mov-pos" : mov < 0 ? "mov-neg" : "mov-zero";
      const movTxt = mov > 0 ? `+${mov}` : String(mov);

      const motivoTxtRaw = movObj ? (movObj.motivoTxt || "") : "";
      const motivoTxt = (mov === 0) ? "" : motivoTxtRaw;

      totAtual += atual;
      totAnterior += anterior;
      totDiff += diff;
      totQuebrados += quebrados;
      totMov += mov;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(lojaCurta6(loja))}</td>
        <td style="font-weight:900;">${atual}</td>
        <td style="font-weight:900;">${anterior}</td>
        <td class="${cls}">${txtDiff}</td>
        <td style="font-weight:900;">${quebrados}</td>
        <td class="${movCls}">${movTxt}</td>
        <td class="motivo-right">${esc(motivoTxt)}</td>
      `;
      tbody.appendChild(tr);
    }

    // âœ… linha TOTAL
    const trTot = document.createElement("tr");
    trTot.className = "row-total";
    const clsTot = totDiff > 0 ? "diff-pos" : totDiff < 0 ? "diff-neg" : "diff-zero";
    const txtTotDiff = totDiff > 0 ? `+${totDiff}` : String(totDiff);
    const clsTotMov = totMov > 0 ? "mov-pos" : totMov < 0 ? "mov-neg" : "mov-zero";
    const txtTotMov = totMov > 0 ? `+${totMov}` : String(totMov);

    trTot.innerHTML = `
      <td>TOTAL</td>
      <td>${totAtual}</td>
      <td>${totAnterior}</td>
      <td class="${clsTot}">${txtTotDiff}</td>
      <td>${totQuebrados}</td>
      <td class="${clsTotMov}">${txtTotMov}</td>
      <td class="motivo-right"></td>
    `;
    tbody.appendChild(trTot);
  }

  /* =========================================================
     âœ… Registros: linha TOTAL ao final
     ========================================================= */
  function renderTabelaRegistros(lista, tiposSel){
    const tbody = document.getElementById("tbodyRegistros");
    tbody.innerHTML = "";

    if(!lista.length){
      tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; font-weight:900; color:#444;">Nenhum registro com os filtros atuais.</td></tr>`;
      return;
    }

    const ord = [...lista].sort((a,b)=>{
      const la = lojaCurta6(a.loja||"").localeCompare(lojaCurta6(b.loja||""));
      if(la !== 0) return la;
      return String(a.usuario||"").localeCompare(String(b.usuario||""));
    });

    const tot = {
      duplocar120:0, grande160:0, bebeConforto160:0, maxcar200:0,
      macrocar300:0, pranchaJacare:0, compraKids:0, bebeJipinho:0,
      total:0
    };

    for(const r of ord){
      const c = r.contagens || {};

      const vDuplo = asInt(c.duplocar120);
      const vGrand = asInt(c.grande160);
      const vBebe  = asInt(c.bebeConforto160);
      const vMax   = asInt(c.maxcar200);
      const vMacro = asInt(c.macrocar300);
      const vPran  = asInt(c.pranchaJacare);
      const vKids  = asInt(c.compraKids);
      const vJip   = asInt(c.bebeJipinho);

      const totalLinha = vDuplo+vGrand+vBebe+vMax+vMacro+vPran+vKids+vJip;

      tot.duplocar120 += vDuplo;
      tot.grande160 += vGrand;
      tot.bebeConforto160 += vBebe;
      tot.maxcar200 += vMax;
      tot.macrocar300 += vMacro;
      tot.pranchaJacare += vPran;
      tot.compraKids += vKids;
      tot.bebeJipinho += vJip;
      tot.total += totalLinha;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(lojaCurta6(r.loja))}</td>
        <td>${esc(r.usuario)}</td>
        <td>${vDuplo}</td>
        <td>${vGrand}</td>
        <td>${vBebe}</td>
        <td>${vMax}</td>
        <td>${vMacro}</td>
        <td>${vPran}</td>
        <td>${vKids}</td>
        <td>${vJip}</td>
        <td style="font-weight:900;">${totalLinha}</td>
      `;
      tbody.appendChild(tr);
    }

    const trTot = document.createElement("tr");
    trTot.className = "row-total";
    trTot.innerHTML = `
      <td colspan="2">TOTAL</td>
      <td>${tot.duplocar120}</td>
      <td>${tot.grande160}</td>
      <td>${tot.bebeConforto160}</td>
      <td>${tot.maxcar200}</td>
      <td>${tot.macrocar300}</td>
      <td>${tot.pranchaJacare}</td>
      <td>${tot.compraKids}</td>
      <td>${tot.bebeJipinho}</td>
      <td>${tot.total}</td>
    `;
    tbody.appendChild(trTot);
  }

  /* =========================================================
     âœ… Especiais/Reservas: linha TOTAL ao final
     ========================================================= */
  function renderTabelaEspeciais(lista){
    const tbody = document.getElementById("tbodyEspeciais");
    tbody.innerHTML = "";

    if(!lista.length){
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; font-weight:900; color:#444;">Nenhum registro com os filtros atuais.</td></tr>`;
      return;
    }

    const ord = [...lista].sort((a,b)=>{
      const la = lojaCurta6(a.loja||"").localeCompare(lojaCurta6(b.loja||""));
      if(la !== 0) return la;
      return String(a.usuario||"").localeCompare(String(b.usuario||""));
    });

    const tot = {
      carrinhosReserva:0,
      carrinhosQuebrados:0,
      cestinha:0,
      cestinhasReserva:0,
      cadeiraRodas:0
    };

    for(const r of ord){
      const c = r.contagens || {};

      const carrinhosReserva   = asInt(c.carrinhosReserva);
      const carrinhosQuebrados = asInt(c.carrinhosQuebrados);
      const cestinha           = asInt(c.cestinha);
      const cestinhasReserva   = asInt(c.cestinhasReserva);
      const cadeiraRodas       = asInt(c.cadeiraRodas);

      tot.carrinhosReserva += carrinhosReserva;
      tot.carrinhosQuebrados += carrinhosQuebrados;
      tot.cestinha += cestinha;
      tot.cestinhasReserva += cestinhasReserva;
      tot.cadeiraRodas += cadeiraRodas;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(lojaCurta6(r.loja))}</td>
        <td>${esc(r.usuario)}</td>
        <td>${carrinhosReserva}</td>
        <td>${carrinhosQuebrados}</td>
        <td>${cestinha}</td>
        <td>${cestinhasReserva}</td>
        <td>${cadeiraRodas}</td>
      `;
      tbody.appendChild(tr);
    }

    const trTot = document.createElement("tr");
    trTot.className = "row-total";
    trTot.innerHTML = `
      <td colspan="2">TOTAL</td>
      <td>${tot.carrinhosReserva}</td>
      <td>${tot.carrinhosQuebrados}</td>
      <td>${tot.cestinha}</td>
      <td>${tot.cestinhasReserva}</td>
      <td>${tot.cadeiraRodas}</td>
    `;
    tbody.appendChild(trTot);
  }

  /* =========================================================
     âœ… Recalcula totais por tipo para o grÃ¡fico (mantÃ©m comportamento original)
     ========================================================= */
  function recalcularTotaisPorTipoParaGrafico(baseFinal, tiposSel){
    const out = {};
    TIPOS.forEach(t=>{
      if(tiposSel.size && !tiposSel.has(t.key)) return;
      out[t.key] = 0;
    });

    for(const r of baseFinal){
      const c = r.contagens || {};
      for(const t of TIPOS){
        if(tiposSel.size && !tiposSel.has(t.key)) continue;
        out[t.key] = (out[t.key] || 0) + asInt(c[t.key]);
      }
    }
    return out;
  }

  // âœ… sobrescreve aplicarFiltrosEAtualizarTudo para alimentar grÃ¡fico corretamente
  const _aplicar = aplicarFiltrosEAtualizarTudo;
  aplicarFiltrosEAtualizarTudo = function(){
    setMsg("");

    const dataFinalISO = (document.getElementById("dataFinal").value || "").trim();
    if(!dataFinalISO){
      document.getElementById("kpiTotal").textContent = "0";
      renderTabelaRegistros([], new Set());
      renderTabelaPorLoja({}, {}, {});
      renderTabelaEspeciais([]);
      desenharBarrasTipos({}, new Set());
      setMsg("Selecione a Data de filtro para exibir os dados.");
      return;
    }

    syncDataAnteriorComDataFinal();

    const dataRefISO = (document.getElementById("dataRef").value || "").trim();
    const dataFinalBR = isoParaBR(dataFinalISO);
    const dataRefBR   = dataRefISO ? isoParaBR(dataRefISO) : "";

    const tiposSel = getSelecionados("tipo");
    const lojasSel = getSelecionados("loja");

    const passaFiltroTipo = (r)=>{
      if(!tiposSel.size) return true;
      for(const t of TIPOS){
        if(tiposSel.has(t.key) && asInt(r.contagens?.[t.key]) > 0) return true;
      }
      return false;
    };

    const baseFinal = registros.filter(r=>{
      const loja = String(r.loja || "").trim();
      if(lojasSel.size && !lojasSel.has(loja)) return false;
      if(String(r.dataContagem || "").trim() !== dataFinalBR) return false;
      if(!passaFiltroTipo(r)) return false;
      return true;
    });

    const baseRef = (dataRefBR ? registros.filter(r=>{
      const loja = String(r.loja || "").trim();
      if(lojasSel.size && !lojasSel.has(loja)) return false;
      if(String(r.dataContagem || "").trim() !== dataRefBR) return false;
      if(!passaFiltroTipo(r)) return false;
      return true;
    }) : []);

    const porLojaFinal = acumularPorLoja(baseFinal);
    const porLojaRef   = acumularPorLoja(baseRef);
    const movPorLoja   = acumularMovPorLoja(baseFinal);

    const totaisPorTipo = recalcularTotaisPorTipoParaGrafico(baseFinal, tiposSel);
    const totalGeral = Object.values(totaisPorTipo).reduce((a,b)=>a+b,0);
    document.getElementById("kpiTotal").textContent = String(totalGeral);

    desenharBarrasTipos(totaisPorTipo, tiposSel);
    renderTabelaPorLoja(porLojaFinal, porLojaRef, movPorLoja);
    renderTabelaRegistros(baseFinal, tiposSel);
    renderTabelaEspeciais(baseFinal);
  };

  document.addEventListener("DOMContentLoaded", async ()=>{
    document.getElementById("btnIrLogin").onclick = ()=> window.location.href = ROTAS.login;
    document.getElementById("btnVoltarMenu").onclick = ()=> window.location.href = ROTAS.menu;
    document.getElementById("btnAtualizar").onclick = carregarRegistros;

    // âœ… garante mÃªs atual antes de qualquer coisa (evita abrir Dez/2026)
    const elFinal = document.getElementById("dataFinal");
    if(elFinal && !elFinal.value) elFinal.value = todayISO();
    syncDataAnteriorComDataFinal();

    const s = await obterSessaoDoBackend();
    if(!s){
      mostrarSemSessao();
      return;
    }

    const perfil = String(s.perfil||"").trim().toUpperCase();
    if(!PERFIS_PERMITIDOS.includes(perfil)){
      sessaoAtual = s;
      mostrarApp();
      document.getElementById("infoLoja").textContent = s.loja;
      document.getElementById("infoUsuario").textContent = s.usuario;
      document.getElementById("infoPerfil").textContent = s.perfil;
      setMsg("Acesso negado: seu perfil nÃ£o tem permissÃ£o para esta tela.");
      document.getElementById("btnAtualizar").disabled = true;
      return;
    }

    sessaoAtual = s;
    mostrarApp();
    document.getElementById("infoLoja").textContent = s.loja;
    document.getElementById("infoUsuario").textContent = s.usuario;
    document.getElementById("infoPerfil").textContent = s.perfil;

    await carregarRegistros();
  });
</script>

<!-- Fontes confiÃ¡veis -->
<!-- Chart.js: https://www.chartjs.org/docs/latest/ -->
<!-- chartjs-plugin-datalabels: https://chartjs-plugin-datalabels.netlify.app/ -->
<!-- Input type="date" (comportamento e atributos): https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/date -->
<!-- iOS auto-zoom em inputs (font-size e viewport): https://webkit.org/blog/5610/more-responsive-form-controls/ -->
<!-- CSS overflow-x/scroll: https://developer.mozilla.org/en-US/docs/Web/CSS/overflow-x -->
</body>
</html>

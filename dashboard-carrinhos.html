<!DOCTYPE html>
<!--
  Sistema: BIG&ULTRA PPP
  Tela: dashboard-carrinhos.html
  Vers√£o: 1.0.0
  Build: 2026-02-20
  Ambiente: Produ√ß√£o
  Desenvolvedor: Caio V. Souza Castro
-->
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>Dashboard Carrinhos</title>
  <link rel="icon" type="image/png" href="/LogoBigUltra.png">
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#030712">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <style>
    :root{
      --bg:#f3f3f3;
      --card:#ffffff;
      --muted:#666;
      --border:#e6e6e6;
      --primary:#0066ff;
      --primary2:#0050cc;
      --ok:#1b5e20;
      --danger:#b30000;
      --tile:#f7f8ff;
      --tileBorder:#e0e3ff;
      --thbg:#e9e9e9;
      --rowAlt:#f7f7f7;
      --grid: rgba(0,0,0,0.06);
      --blueDark:#1f4f95;
      --blueDark2:#163c72;
    }

    *, *::before, *::after{ box-sizing: border-box; }

    html, body{
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      background:var(--bg);
      margin:0;
      color:#111;
      font-family: Arial, sans-serif;
      -webkit-text-size-adjust: 100%;
      touch-action: manipulation;
    }

    .container{
      width: 100%;
      max-width: 100%;
      padding: 16px;
      margin: 0 auto;
      overflow-x: hidden;
    }

    .shell{
      width: 100%;
      max-width: 100%;
      background:var(--card);
      padding: 18px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.85),
      inset 0 -6px 14px rgba(0,0,0,0.06);
      overflow-x: hidden;
      min-width: 0;
    }

    canvas{ max-width: 100% !important; display:block; }

    .titulo{
      text-align:center;
      margin: 0 0 12px;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .btn{
      width:100%;
      padding: 10px 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 900;
      user-select:none;
    }
    .btn-prim{ background:var(--primary); color:#fff; }
    .btn-prim:hover{ background:var(--primary2); }
    .btn-sec{ background:#e9e9e9; color:#111; }
    .btn-sec:hover{ background:#dedede; }

    @media (max-width: 520px){
      .container{ padding: 10px; }
      .shell{ padding: 14px; }
    }

    .tela-erro{
      width:100%;
      min-height: 65vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card-erro{
      background:#fff;
      padding: 22px 18px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.85),
      inset 0 -6px 14px rgba(0,0,0,0.06);
      max-width: 560px;
      width: 95%;
      text-align:center;
    }
    .card-erro h2{ margin: 0 0 8px; color:#c00000; }
    .card-erro p{ margin: 0 0 12px; color:#333; font-weight:800; }

    .hidden{ display:none !important; }

    .grid{
      display:grid;
      grid-template-columns: 192px 1fr;
      gap: 12px;
      align-items: start;
      min-width: 0;
      overflow-x: hidden;
    }
    .grid > *{ min-width: 0; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .left-panel{
      display:flex;
      flex-direction: column;
      gap: 12px;
      min-width: 0;
      overflow-x: hidden;
    }

    .acoes-card{
      background:#fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.85),
        inset 0 -6px 14px rgba(0,0,0,0.06);
      min-width: 0;
      overflow-x: hidden;
    }
    .acoes-card h3{
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 900;
    }

    .acoes-stack{
      display:flex;
      flex-direction: column;
      gap: 10px;
      min-width: 0;
    }
    @media (max-width: 520px){
      .acoes-stack{ flex-direction: row; }
      .acoes-stack .btn{
        flex: 1;
        white-space: nowrap;
        font-size: 12px;
        padding: 10px 8px;
      }
    }

    .userloja-card{ padding: 12px; }
    .userloja-stack{
      display:flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }
    .userloja-valor{
      font-weight: 900;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .painel{
      background: var(--tile);
      border: 1px solid var(--tileBorder);
      border-radius: 12px;
      padding: 12px;
      max-width: 100%;
      min-width: 0;
      overflow-x: hidden;
      box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.85),
      inset 0 -6px 14px rgba(0,0,0,0.06);
    }
    .painel h3{ margin: 0 0 10px; font-size: 15px; font-weight: 900; }

    .grupo{
      background:#fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      max-width: 100%;
      min-width: 0;
      overflow-x: hidden;
      box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.85),
      inset 0 -6px 14px rgba(0,0,0,0.06);
    }

    .grupo-titulo{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      margin-bottom: 8px;
      font-weight: 900;
      font-size: 13px;
      min-width: 0;
    }

    .grupo-acoes{ display:flex; gap:8px; flex-wrap: wrap; }

    .mini-btn{
      border:none;
      border-radius: 8px;
      padding: 6px 8px;
      font-weight: 900;
      cursor:pointer;
      background:#eee;
      color:#111;
      font-size: 12px;
    }
    .mini-btn:hover{ background:#e0e0e0; }

    .lista{
      max-height: 220px;
      overflow:auto;
      border-top: 1px dashed #ddd;
      padding-top: 8px;
      -webkit-overflow-scrolling: touch;
    }

    .check{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 6px 0;
      font-size: 13px;
      user-select:none;
      white-space: nowrap;
    }
    .check input{ transform: scale(1.05); }

    @media (max-width: 520px){
      .check{ white-space: normal; }
    }

    .campo{ display:flex; flex-direction: column; gap:6px; min-width: 0; }
    .campo label{ font-weight: 900; font-size: 13px; color:#111; }
    .input{
      width:100%;
      border-radius: 10px;
      border: 1px solid #c3c3c3;
      padding: 10px 12px;
      font-size: 14px;
      background:#fff;
      outline:none;
      max-width: 100%;
    }
    .input:focus{ border-color:var(--primary); box-shadow: 0 0 0 1px #0066ff33; }
    @media (max-width: 520px){ .input{ font-size:16px; } }

    .content-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: start;
      min-width: 0;
      overflow-x: hidden;
    }
    .content-grid > *{ min-width: 0; }
    .left-col{ display:flex; flex-direction: column; gap: 12px; min-width: 0; overflow-x: hidden; }
    .right-col{ min-width: 0; overflow-x: hidden; }

    @media (min-width: 981px){
      .content-grid{ grid-template-columns: calc(360px + 1cm) 1fr; }
    }
    @media (max-width: 980px){ .content-grid{ grid-template-columns: 1fr; } }

    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      max-width: 100%;
      min-width: 0;
      overflow: hidden;
      box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.85),
      inset 0 -6px 14px rgba(0,0,0,0.06);
    }
    .card h3{ margin: 0 0 10px; font-size: 15px; font-weight: 900; }

    .kpi-row{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      min-width: 0;
    }
    .kpi-row > *{ min-width: 0; }
    @media (max-width: 980px){ .kpi-row{ grid-template-columns: 1fr; } }

    .kpi{
      display:flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      gap: 6px;
      background: var(--tile);
      border: 1px solid var(--tileBorder);
      border-radius: 12px;
      padding: 12px;
      min-width: 0;
      overflow:hidden;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.85),
        inset 0 -6px 14px rgba(0,0,0,0.06);
    }

    .kpi .label{
      font-weight: 900;
      color:#111;
      font-size: 13px;
      line-height: 1.15;
    }
    .kpi .value{
      font-weight: 900;
      font-size: 34px;
      color: var(--primary);
      line-height: 1;
      align-self: flex-end;
    }

    .chart-card{
      height: 430px;
      display:flex;
      flex-direction: column;
      gap: 0;
      min-width: 0;
    }

    .chart-wrap{
      width:100%;
      position: relative;
      flex: 1 1 auto;
      min-height: 0;
      min-width: 0;
      overflow: hidden;
      height: 360px;
    }

    @media (max-width: 520px){
      .chart-card{ height: 390px; }
      .chart-wrap{ height: 320px; }
    }

    #barTipos{
      width: 100% !important;
      height: 100% !important;
      pointer-events: none;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .table-card{
      min-height: 430px;
      display:flex;
      flex-direction: column;
      gap: 0;
      min-width: 0;
    }

    .table-card,
    .table-fit{
      width: fit-content;
      max-width: 100%;
      justify-self: start;
    }

    .msg{
      margin-top: 10px;
      text-align:center;
      font-weight:900;
      font-size: 13px;
      min-height: 18px;
      color: var(--danger);
    }
    .ok{ color: var(--ok); }

    .table-wrap{
      width: max-content;
      max-width: 100%;
      overflow-x: auto;
      overflow-y: visible;
      border:1px solid #eee;
      border-radius: 10px;
      -webkit-overflow-scrolling: touch;
      min-width: 0;
      contain: content;
    }

    table{
      border-collapse: collapse;
      font-size: 12px;
      width: max-content;
      min-width: 0;
      max-width: none;
    }

    th, td{
      border-bottom: 1px solid var(--grid);
      border-right: 1px solid var(--grid);
      text-align:left;
      vertical-align: middle;
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: nowrap;
    }
    th:last-child, td:last-child{ border-right: none; }

    th{
      padding: 6px 6px;
      line-height: 1.15;
      font-weight: 900;
      background: var(--blueDark);
      color:#fff;
      position: sticky;
      top: 0;
      z-index: 1;
      border-top: 1px solid var(--grid);
    }
    tbody td{
      padding: 4px 6px;
      line-height: 1.05;
      border-top: 1px solid var(--grid);
    }
    tbody tr:nth-child(even){ background: var(--rowAlt); }

    .diff-pos{ color: var(--ok); font-weight: 900; }
    .diff-neg{ color: var(--danger); font-weight: 900; }
    .diff-zero{ color:#333; font-weight: 900; }

    .mov-pos{ color: var(--ok); font-weight: 900; }
    .mov-neg{ color: var(--danger); font-weight: 900; }
    .mov-zero{ color:#333; font-weight: 900; }

    .motivo-right{ text-align:right !important; }

    .row-total td{
      padding: 6px 6px;
      line-height: 1.15;
      font-weight: 900;
      background: var(--blueDark2);
      color:#fff;
      border-top: 2px solid rgba(0,0,0,0.18);
      border-bottom: 1px solid var(--grid);
    }

.row-total td{ color:#fff; }
.row-total td .diff-pos, .row-total td .mov-pos{ color: var(--ok) !important; }
.row-total td .diff-neg, .row-total td .mov-neg{ color: var(--danger) !important; }
.row-total td .diff-zero, .row-total td .mov-zero{ color:#fff !important; }

    .edit-btn{
      border: 1px solid rgba(31,79,149,0.35);
      background: rgba(31,79,149,0.10);
      border-radius: 8px;
      padding: 4px 6px;
      font-weight: 900;
      cursor: pointer;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      user-select: none;
    }
    .edit-btn:hover{ background: rgba(31,79,149,0.16); }

    .edit-btn svg{
      width: 16px;
      height: 16px;
      display:block;
      fill: var(--blueDark);
    }

    .edit-wrap{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .modal-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.42);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    .modal-overlay.show{ display:flex; }

    .modal{
      width: 100%;
      max-width: 720px;
      background: #fff;
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 14px;
      box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.85),
      inset 0 -10px 20px rgba(0,0,0,0.06);
    }
    .modal h3{
      margin: 0 0 10px;
      font-size: 16px;
      font-weight: 900;
    }
    .modal p{
      margin: 0 0 12px;
      font-weight: 800;
      color:#222;
      line-height: 1.35;
    }
    .modal-actions{
      display:flex;
      gap:10px;
      justify-content: flex-end;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .modal-actions .btn{
      width: auto;
      min-width: 140px;
    }

    .editor-modal{
      display:flex;
      flex-direction: column;
      max-height: 92vh;
      overflow: hidden;
      padding: 14px;
    }
    .editor-body{
      flex: 1 1 auto;
      min-height: 0;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      padding-right: 6px;
    }
    .editor-actions{
      flex: 0 0 auto;
      margin-top: 10px;
    }

    .editor-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 640px){
      .editor-grid{ grid-template-columns: 1fr; }
    }
    .editor-item{
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      padding: 10px;
      background: #fafafa;
      box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.85),
      inset 0 -10px 18px rgba(0,0,0,0.04);
    }
    .editor-item label{
      display:block;
      font-weight: 900;
      font-size: 13px;
      margin-bottom: 6px;
    }
    .editor-item input,
    .editor-item select{
      width: 100%;
      border-radius: 10px;
      border: 1px solid #cfcfcf;
      padding: 10px 12px;
      font-size: 14px;
      outline:none;
      background: #fff;
    }
    .editor-item input:focus,
    .editor-item select:focus{
      border-color: var(--primary);
      box-shadow: 0 0 0 1px #0066ff33;
    }
    .section-tag{
      display:inline-block;
      font-weight: 900;
      font-size: 12px;
      color:#333;
      background:#eee;
      border:1px solid #ddd;
      padding: 4px 8px;
      border-radius: 999px;
      margin-top: 8px;
    }

    .mov-card{
      margin-top: 12px;
      background: var(--tile);
      border: 2px solid #0066ff33;
      border-radius: 12px;
      padding: 10px;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.85),
        inset 0 -10px 18px rgba(0,0,0,0.04);
    }

    .toast{
      position: fixed;
      left: 50%;
      top: 14px;
      transform: translateX(-50%);
      z-index: 10050;
      background: rgba(10,10,12,0.92);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      font-size: 13px;
      max-width: min(520px, calc(100vw - 24px));
      width: max-content;
      box-shadow: 0 16px 40px rgba(0,0,0,0.45);
      display:none;
    }
    .toast.show{ display:block; }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <div class="container">
    <div class="shell">

      <h2 class="titulo">RELAT√ìRIO DE CARRINHOS</h2>

      <div id="telaSemSessao" class="tela-erro hidden">
        <div class="card-erro">
          <h2>Login necess√°rio</h2>
          <p>Voc√™ precisa estar logado para acessar esta p√°gina.</p>
          <button class="btn btn-prim" id="btnIrLogin">Ir para o Login</button>
        </div>
      </div>

      <div id="app" class="hidden">
        <div class="grid">
          <div class="left-panel">

            <div class="acoes-card userloja-card">
              <div class="userloja-stack">
                <div class="userloja-valor" id="cardUsuario">‚Äî</div>
                <div class="userloja-valor" id="cardLoja">‚Äî</div>
              </div>
            </div>

            <div class="acoes-card">
              <h3>A√ß√µes</h3>
              <div class="acoes-stack">
                <button class="btn btn-prim" id="btnAtualizar">Atualizar dados</button>
                <button class="btn btn-sec" id="btnVoltarMenu">Voltar ao Menu</button>
              </div>
            </div>

            <div class="painel">
              <h3>Filtros</h3>

              <div class="grupo">
                <div class="grupo-titulo">Datas</div>

                <div class="campo" style="margin-bottom:10px;">
                  <label for="dataFinal">Data atual</label>
                  <input id="dataFinal" class="input" type="date" />
                </div>

                <div class="campo">
                  <label for="dataRef">Data Anterior</label>
                  <input id="dataRef" class="input" type="date" />
                </div>
              </div>

              <div class="grupo">
                <div class="grupo-titulo">Dimens√µes</div>
                <div id="listaDimensoes"></div>
              </div>

              <div class="grupo">
                <div class="grupo-titulo">
                  <span>Tipos</span>
                  <span class="grupo-acoes">
                    <button class="mini-btn" id="btnTiposTudo">Tudo</button>
                    <button class="mini-btn" id="btnTiposNada">Nada</button>
                  </span>
                </div>
                <div class="lista" id="listaTipos"></div>
              </div>

              <div class="grupo">
                <div class="grupo-titulo"><span>Bandeira</span></div>

                <div class="check">
                  <input type="checkbox" id="bandBIG" checked />
                  <label for="bandBIG"><b>BIG</b></label>
                </div>
                <div class="check">
                  <input type="checkbox" id="bandULT" checked />
                  <label for="bandULT"><b>ULT</b></label>
                </div>

                <div class="grupo-titulo" style="margin-top:10px;"><span>Lojas</span></div>
                <div class="lista" id="listaLojas"></div>
              </div>

              <div class="msg" id="msg"></div>
            </div>
          </div>

          <div>
            <div class="content-grid">
              <div class="left-col">
                <div class="kpi-row">
                  <div class="kpi">
                    <div class="label">üõíCar. Ativos</div>
                    <div class="value" id="kpiCarrinhos">0</div>
                  </div>

                  <div class="kpi">
                    <div class="label">üõíQuebrados</div>
                    <div class="value" id="kpiQuebrados">0</div>
                  </div>

                  <div class="kpi">
                    <div class="label">üß∫Cestinhas</div>
                    <div class="value" id="kpiCestinhas">0</div>
                  </div>
                </div>

                <div class="card chart-card">
                  <h3>Quantidade por Tipo</h3>
                  <div class="chart-wrap" id="wrapBarTipos">
                    <canvas id="barTipos"></canvas>
                  </div>
                </div>
              </div>

              <div class="right-col">
                <div class="card table-card">
                  <h3>Total geral</h3>
                  <div class="table-wrap">
                    <table>
                      <thead id="theadPorLoja"></thead>
                      <tbody id="tbodyPorLoja"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div class="card table-fit" style="margin-top:12px;">
              <h3>Carrinhos por modelo</h3>
              <div class="table-wrap">
                <table>
                  <thead id="theadRegistros"></thead>
                  <tbody id="tbodyRegistros"></tbody>
                </table>
              </div>
            </div>

            <div class="card table-fit" style="margin-top:12px;">
              <h3>Especiais e Reservas</h3>
              <div class="table-wrap">
                <table>
                  <thead id="theadEspeciais"></thead>
                  <tbody id="tbodyEspeciais"></tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div id="modalOverlay" class="modal-overlay" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
          <h3 id="modalTitle">Aviso</h3>
          <p id="modalText">...</p>
          <div class="modal-actions" id="modalActions"></div>
        </div>
      </div>

      <div id="editorOverlay" class="modal-overlay" aria-hidden="true">
        <div class="modal editor-modal" role="dialog" aria-modal="true" aria-labelledby="editorTitle">
          <h3 id="editorTitle">Editar</h3>
          <p id="editorSub">...</p>

          <div class="editor-body" id="editorBody">
            <div class="section-tag">Modelos de carrinhos</div>
            <div class="editor-grid" id="editorGridAtivos"></div>

            <div class="section-tag">Especiais e reservas</div>
            <div class="editor-grid" id="editorGridEspeciais"></div>

            <div class="section-tag">Movimenta√ß√£o</div>
            <div class="mov-card" id="editorMovCard">
              <div class="editor-grid">
                <div class="editor-item">
                  <label>Dire√ß√£o</label>
                  <select id="editMovDirecao">
                    <option value="ENTRADA">Entrada</option>
                    <option value="SAIDA">Sa√≠da</option>
                  </select>
                </div>

                <div class="editor-item">
                  <label>Motivo</label>
                  <select id="editMovCategoria"></select>
                </div>

                <div class="editor-item">
                  <label>Qtd. Movimentada</label>
                  <input id="editMovQtd" type="number" min="0" step="1" value="0" />
                </div>
              </div>
            </div>
          </div>

          <div class="modal-actions editor-actions">
            <button class="btn btn-sec" id="btnDescartarEdicao">Descartar edi√ß√£o</button>
            <button class="btn btn-prim" id="btnSalvarEdicao">Salvar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const ROTAS = { login: "/login.html", menu: "/menu.html" };
  const PERFIS_PERMITIDOS = ["GERENTE_PPP", "BASE_PPP", "ADMINISTRADOR"];
  let SESSION = null;

  const TIPOS = [
    { key: "duplocar120",       label: "Duplocar 120L" },
    { key: "grande160",         label: "Grande 160L" },
    { key: "bebeConforto160",   label: "Beb√™ 160L" },
    { key: "maxcar200",         label: "Maxcar 200L" },
    { key: "macrocar300",       label: "Macrocar 300L" },
    { key: "pranchaJacare",     label: "Prancha Jacar√©" },
    { key: "compraKids",        label: "Compra Kids" },
    { key: "carrinhoGaiolaPet", label: "Gaiola Pet" },
    { key: "bebeJipinho",       label: "Beb√™ Jipinho" },
    { key: "carrinhosReserva",   label: "Carrinhos reserva" },
    { key: "carrinhosQuebrados", label: "Carrinhos Quebrados" },
    { key: "cestinha",           label: "Cestinha" },
    { key: "cestinhasReserva",   label: "Cestinhas reserva" },
    { key: "cadeiraRodas",       label: "Cadeira de rodas" }
  ];

  const ACTIVE_KEYS = [
    "duplocar120",
    "grande160",
    "bebeConforto160",
    "maxcar200",
    "macrocar300",
    "pranchaJacare",
    "compraKids",
    "carrinhoGaiolaPet",
    "bebeJipinho"
  ];

  const SPECIAL_KEYS = [
    "carrinhosReserva",
    "carrinhosQuebrados",
    "cestinha",
    "cestinhasReserva",
    "cadeiraRodas"
  ];

  const TIPO_ICONE = {
    duplocar120: "üõí",
    grande160: "üõí",
    bebeConforto160: "üë∂",
    maxcar200: "üõí",
    macrocar300: "üõí",
    pranchaJacare: "üõí",
    compraKids: "üß∏",
    carrinhoGaiolaPet: "üê∂",
    bebeJipinho: "üë∂",
    carrinhosReserva: "üÖøÔ∏è",
    carrinhosQuebrados: "‚ö†Ô∏è",
    cestinha: "üß∫",
    cestinhasReserva: "üß∫",
    cadeiraRodas: "‚ôø"
  };

  const LOJAS = [
    "BIG 01 - 106 NORTE","BIG 02 - 402 NORTE","BIG 03 - 413 SUL","BIG 04 - 301 SW","BIG 05 - 408 NORTE",
    "BIG 06 - SIBERIA","BIG 08 - 503 SUL","BIG 09 - PEN√çNSULA","BIG 10 - PAINEIRAS","BIG 11 - 310 NORTE",
    "BIG 12 - 208 NORTE","BIG 13 - QI-05 L. NORTE","BIG 14 - 508 SUL","BIG 15 - 105 SW","BIG 16 - 512 SUL",
    "BIG 17 - QI-11 LAGO SUL","BIG 18 - 211 NORTE","BIG 19 - CASTANHEIRA","BIG 20 - TAGUATINGA C1","BIG 21 - CNB12",
    "BIG 22 - 102 NOROESTE","BIG 23 - QI-23 LAGO SUL","BIG 24 - 314 NORTE","BIG 25 - 410 SUL",
    "ULT 01 - PLANALTINA","ULT 02 - GAMA","ULT 03 - COLORADO","ULT 04 - CEI SUL","ULT 05 - POLO JK",
    "ULT 06 - SOBRADINHO","ULT 07 - ADE","ULT 08 - ARAPOANGA","ULT 09 - CEI NORTE","ULT 10 - ESTRUTURAL",
    "ULT 11 - ITAPOA","ULT 12 - SAO SEBASTIAO","ULT 13 - RECANTO","ULT 14 - AGUAS LINDAS","ULT 15 - SOL NASCENTE",
    "ULT 16 - PARANOA PARK","ULT 17 - SAMAMBAIA","ULT 18 - BRAZLANDIA","ULT 19 - VIA PARK","ULT 20 - TAGUATINGA",
    "ULT 22 - VICENTE PIRES","ULT 23 - SANTA MARIA","ULT 25 - BRASILINHA",
  ];

  const MOV_OPCOES = [
    { value: "M.L", label: "Movi. entre lojas" },
    { value: "M.M", label: "Movi. Manuten√ß√£o" },
    { value: "E.N", label: "Entrada novos" }
  ];

  function _semAcentoUpper(s){
    return String(s ?? "")
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toUpperCase()
      .trim();
  }

  function motivoParaAbrev(raw){
    let v = String(raw ?? "").trim();
    if(!v) return "";
    v = v.toUpperCase().replace(/_/g, ".");
    if(v === "E.N") v = "E.N";
    if(v === "M.L" || v === "M.M" || v === "E.N") return v;

    const key = _semAcentoUpper(v);
    if(key.includes("ENTRE") && key.includes("LOJ")) return "M.L";
    if(key.includes("MANUT")) return "M.M";
    if(key.includes("ENTRADA") && key.includes("NOV")) return "E.N";
    return "";
  }

  function abrevParaLabel(abrev){
    const a = motivoParaAbrev(abrev) || String(abrev ?? "").trim().toUpperCase().replace(/_/g, ".");
    const opt = MOV_OPCOES.find(o => o.value === a);
    return opt ? opt.label : String(abrev ?? "").trim();
  }

  let registros = [];
  let chartBar = null;

  function fmtInt(n){
    const v = Number(n);
    const safe = Number.isFinite(v) ? Math.trunc(v) : 0;
    return safe.toLocaleString("pt-BR");
  }
  function fmtSigned(n){
    const v = Number(n);
    const safe = Number.isFinite(v) ? Math.trunc(v) : 0;
    if(safe > 0) return `+${safe.toLocaleString("pt-BR")}`;
    return safe.toLocaleString("pt-BR");
  }

  function setMsg(texto, ok=false){
    const el = document.getElementById("msg");
    el.classList.toggle("ok", !!ok);
    el.textContent = texto || "";
  }

  let _toastTimer = null;
  function showToast(text){
    const el = document.getElementById("toast");
    if(!el) return;
    el.textContent = text || "";
    el.classList.add("show");
    if(_toastTimer) clearTimeout(_toastTimer);
    _toastTimer = setTimeout(()=>{
      el.classList.remove("show");
    }, 3000);
  }

  function svgEdit(){
    return `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm2.92 2.33H5v-.92l9.06-9.06.92.92L5.92 19.58zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/></svg>`;
  }

  function mostrarSemSessao(){
    document.getElementById("app").classList.add("hidden");
    document.getElementById("telaSemSessao").classList.remove("hidden");
  }
  function mostrarApp(){
    document.getElementById("telaSemSessao").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
  }

  async function obterSessaoDoBackend(){
    try{
      const resp = await fetch("/api/session", {
        method:"GET",
        credentials:"include",
        headers:{ "Accept":"application/json" }
      });
      if(!resp.ok) return null;
      const dados = await resp.json().catch(()=>null);
      if(!dados || !dados.sucesso || !dados.usuario || !dados.loja || !dados.perfil) return null;
      return dados;
    }catch(e){
      console.error("[DASH-CARRINHOS] erro /api/session:", e);
      return null;
    }
  }

  function brParaISO(br){
    const s = String(br||"").trim();
    const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(!m) return "";
    return `${m[3]}-${m[2]}-${m[1]}`;
  }
  function isoParaBR(iso){
    const s = String(iso||"").trim();
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return "";
    return `${m[3]}/${m[2]}/${m[1]}`;
  }

  function normalizarHoraParaHMS(valor){
    const s = String(valor ?? "").trim();

    let m = s.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?/);
    if(m){
      const hh = Math.max(0, Math.min(23, Number(m[1])));
      const mm = Math.max(0, Math.min(59, Number(m[2])));
      const ss = Math.max(0, Math.min(59, Number(m[3] ?? 0)));
      return `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
    }

    m = s.match(/^(\d{1,2})(\d{2})$/);
    if(m){
      const hh = Math.max(0, Math.min(23, Number(m[1])));
      const mm = Math.max(0, Math.min(59, Number(m[2])));
      return `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}:00`;
    }

    return "00:00:00";
  }

  function obterTimestampRegistro(reg){
    const dataBR = String(reg?.dataContagem ?? "").trim();
    const dataISO = brParaISO(dataBR);
    if(!dataISO) return 0;

    const horaRaw = String(reg?.horaRegistro ?? reg?.dataHoraRede ?? "").trim();
    const hms = normalizarHoraParaHMS(horaRaw);
    const dt = new Date(`${dataISO}T${hms}`);
    const t = dt.getTime();
    return Number.isFinite(t) ? t : 0;
  }

  function manterUltimoLancamentoPorLojaEDia(lista){
    const map = new Map();
    for(const r of (lista || [])){
      const loja = String(r?.loja ?? "").trim();
      const dataBR = String(r?.dataContagem ?? "").trim();
      if(!loja || !dataBR) continue;

      const key = `${loja}__${dataBR}`;
      const ts = obterTimestampRegistro(r);

      const cur = map.get(key);
      if(!cur || ts >= cur.ts){
        map.set(key, { ts, reg: r });
      }
    }
    return Array.from(map.values()).map(x => x.reg);
  }

  function normalizarRegistro(r){
    const out = { ...(r || {}) };
    out.idLinha = String(out.idLinha ?? out.id ?? out.rowId ?? "").trim();

    if(!out.contagens || typeof out.contagens !== "object") out.contagens = {};

    const keysPossiveis = [
      "duplocar120","grande160","bebeConforto160","maxcar200","macrocar300","pranchaJacare",
      "compraKids","carrinhoGaiolaPet","gaiolaPet","bebeJipinho",
      "cestinha","cadeiraRodas","carrinhosQuebrados","carrinhosReserva","cestinhasReserva",
      "movCarrinhos"
    ];

    for(const k of keysPossiveis){
      if(out.contagens[k] === undefined && out[k] !== undefined){
        out.contagens[k] = out[k];
      }
    }

    if(out.contagens.carrinhoGaiolaPet === undefined && out.contagens.gaiolaPet !== undefined){
      out.contagens.carrinhoGaiolaPet = out.contagens.gaiolaPet;
    }
    if(out.contagens.carrinhoGaiolaPet === undefined) out.contagens.carrinhoGaiolaPet = 0;

    return out;
  }

  async function carregarRegistros(){
    setMsg("");
    const btn = document.getElementById("btnAtualizar");
    btn.disabled = true;

    try{
      const resp = await fetch("/api/carrinhos-listar", {
        method:"GET",
        credentials:"include",
        headers:{ "Accept":"application/json" }
      });

      if(resp.status === 401 || resp.status === 403){
        mostrarSemSessao();
        setMsg("Sess√£o inv√°lida/expirada. Fa√ßa login novamente.");
        return;
      }

      const dados = await resp.json().catch(()=>({}));
      if(!resp.ok || !dados.sucesso || !Array.isArray(dados.registros)){
        setMsg(dados.message || "Erro ao carregar registros.");
        return;
      }

      registros = manterUltimoLancamentoPorLojaEDia(dados.registros.map(normalizarRegistro));

      montarFiltros();
      sugerirDatasMaisRecentes();

      aplicarFiltrosEAtualizarTudo();
      setMsg(`Dados carregados: ${fmtInt(registros.length)} registros.`, true);

    }catch(e){
      console.error(e);
      setMsg("Erro de conex√£o ao carregar dados.");
    }finally{
      btn.disabled = false;
    }
  }

  function asInt(v){
    const n = Number(v);
    return Number.isFinite(n) ? Math.max(0, Math.trunc(n)) : 0;
  }
  function asIntSigned(v){
    const n = Number(v);
    return Number.isFinite(n) ? Math.trunc(n) : 0;
  }

  function bandeiraDaLoja(loja){
    const s = String(loja||"").trim().toUpperCase();
    if(s.startsWith("BIG")) return "BIG";
    if(s.startsWith("ULT")) return "ULT";
    return "OUTRA";
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  function lojaCurta6(loja){
    const s = String(loja || "").trim();
    return s.length >= 6 ? s.slice(0,6) : s;
  }

  function addDaysISO(iso, deltaDays){
    const m = String(iso||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return "";
    const d = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
    d.setDate(d.getDate() + Number(deltaDays || 0));
    const pad2 = (n)=> String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function todayISO(){
    const d = new Date();
    const pad2 = (n)=> String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function syncDataAnteriorComDataFinal(){
    const elFinal = document.getElementById("dataFinal");
    const elRef   = document.getElementById("dataRef");

    const finalISO = (elFinal.value || "").trim();
    if(!finalISO){
      elRef.removeAttribute("max");
      return;
    }

    const anteriorISO = addDaysISO(finalISO, -1);
    elRef.max = anteriorISO;

    const refISO = (elRef.value || "").trim();
    if(!refISO || refISO >= finalISO) elRef.value = anteriorISO;
    if(elRef.value >= finalISO) elRef.value = anteriorISO;
  }

  function getSelecionados(tipo){
    const set = new Set();
    document.querySelectorAll(`input[type="checkbox"][data-tipo="${tipo}"]`).forEach(cb=>{
      if(cb.checked) set.add(cb.getAttribute("data-valor"));
    });
    return set;
  }

  function getMovimentoSigned(reg){
    const c = reg?.contagens || {};
    const v = (c.movCarrinhos !== undefined) ? c.movCarrinhos : (reg.movCarrinhos ?? reg.movimento ?? reg.mov ?? 0);
    return asIntSigned(v);
  }

  function getMotivo(reg){
    return String(
      reg?.movCategoria ??
      reg?.motivo ??
      reg?.motivoMov ??
      reg?.categoriaMov ??
      ""
    ).trim();
  }

  const DIMENSOES = [
    { key:"qtdMov",    label:"Qtd Mov.",     defaultChecked:false },
    { key:"motivoMov", label:"Motivo Mov.",  defaultChecked:false },
    { key:"anterior",  label:"Anterior",     defaultChecked:true  },
    { key:"diferenca", label:"Diferen√ßa",    defaultChecked:true  },
    { key:"usuario",   label:"Usu√°rio",      defaultChecked:true  },
    { key:"quebrados", label:"C. Quebrados", defaultChecked:true  },
    { key:"cestinhaCol", label:"Cestinha",   defaultChecked:true  },
    { key:"rodasCol",    label:"C. Rodas",   defaultChecked:true  },
  ];

  function getDimensoesSelecionadas(){
    const out = {};
    DIMENSOES.forEach(d => out[d.key] = !!d.defaultChecked);

    document.querySelectorAll('input[type="checkbox"][data-dim]').forEach(cb=>{
      const k = cb.getAttribute("data-dim");
      out[k] = !!cb.checked;
    });
    return out;
  }

  function somaModelosSelecionados(contagens, tiposSel){
    let s = 0;
    for(const k of ACTIVE_KEYS){
      if(tiposSel.has(k)) s += asInt(contagens?.[k]);
    }
    return s;
  }

  function somaCarrinhosReservaSeSelecionado(contagens, tiposSel){
    return tiposSel.has("carrinhosReserva") ? asInt(contagens?.carrinhosReserva) : 0;
  }

  function somaAtivosMaisReserva(contagens, tiposSel){
    return somaModelosSelecionados(contagens, tiposSel) + somaCarrinhosReservaSeSelecionado(contagens, tiposSel);
  }

  function somaCestinhasSelecionadas(contagens, tiposSel){
    let s = 0;
    if(tiposSel.has("cestinha")) s += asInt(contagens?.cestinha);
    if(tiposSel.has("cestinhasReserva")) s += asInt(contagens?.cestinhasReserva);
    return s;
  }

  function getQuebradosSeSelecionado(contagens, tiposSel){
    return tiposSel.has("carrinhosQuebrados") ? asInt(contagens?.carrinhosQuebrados) : 0;
  }

  function getCestinhaParaTabela(contagens, tiposSel){
    let s = 0;
    if(tiposSel.has("cestinha")) s += asInt(contagens?.cestinha);
    if(tiposSel.has("cestinhasReserva")) s += asInt(contagens?.cestinhasReserva);
    return s;
  }

  function getCadeiraRodasParaTabela(contagens, tiposSel){
    return tiposSel.has("cadeiraRodas") ? asInt(contagens?.cadeiraRodas) : 0;
  }

  function acumularMovPorLoja(listaRegistros){
    const out = {};
    for(const r of listaRegistros){
      const loja = String(r.loja||"").trim();
      if(!out[loja]) out[loja] = { movSum: 0, motivos: new Set() };
      out[loja].movSum += getMovimentoSigned(r);
      const motivo = getMotivo(r);
      if(motivo) out[loja].motivos.add(motivo);
    }
    for(const loja in out){
      out[loja].motivoTxt = Array.from(out[loja].motivos).join(", ");
    }
    return out;
  }

  function recalcularTotaisParaGrafico(baseFinal, tiposSel){
    const out = {};
    for(const k of ACTIVE_KEYS){
      if(!tiposSel.has(k)) continue;
      out[k] = 0;
    }

    if(tiposSel.has("carrinhosReserva"))  out.__reserva = 0;
    if(tiposSel.has("cestinha"))          out.__cestinha = 0;
    if(tiposSel.has("cestinhasReserva"))  out.__cestinhaReserva = 0;
    if(tiposSel.has("carrinhosQuebrados"))out.__quebrados = 0;
    if(tiposSel.has("cadeiraRodas"))      out.__cadeira = 0;

    for(const r of baseFinal){
      const c = r.contagens || {};
      for(const k of ACTIVE_KEYS){
        if(!tiposSel.has(k)) continue;
        out[k] = (out[k] || 0) + asInt(c[k]);
      }

      if(tiposSel.has("carrinhosReserva"))   out.__reserva += asInt(c.carrinhosReserva);
      if(tiposSel.has("cestinha"))           out.__cestinha += asInt(c.cestinha);
      if(tiposSel.has("cestinhasReserva"))   out.__cestinhaReserva += asInt(c.cestinhasReserva);
      if(tiposSel.has("carrinhosQuebrados")) out.__quebrados += asInt(c.carrinhosQuebrados);
      if(tiposSel.has("cadeiraRodas"))       out.__cadeira += asInt(c.cadeiraRodas);
    }

    return out;
  }

  function desenharBarrasTipos(totais, tiposSel){
    const canvas = document.getElementById("barTipos");
    const ctx = canvas.getContext("2d");

    const labels = [];
    const data = [];

    for(const k of ACTIVE_KEYS){
      if(!tiposSel.has(k)) continue;
      const t = TIPOS.find(x=>x.key===k);
      labels.push(`${t ? t.label : k} ${(TIPO_ICONE[k]||"üõí")}`);
      data.push(asInt(totais?.[k]));
    }

    if(tiposSel.has("carrinhosReserva")){
      labels.push(`Carrinhos reserva ${(TIPO_ICONE.carrinhosReserva||"üÖøÔ∏è")}`);
      data.push(asInt(totais?.__reserva));
    }
    if(tiposSel.has("cestinha")){
      labels.push(`Cestinhas ${(TIPO_ICONE.cestinha||"üß∫")}`);
      data.push(asInt(totais?.__cestinha));
    }
    if(tiposSel.has("cestinhasReserva")){
      labels.push(`Cestinhas reserva ${(TIPO_ICONE.cestinhasReserva||"üß∫")}`);
      data.push(asInt(totais?.__cestinhaReserva));
    }
    if(tiposSel.has("carrinhosQuebrados")){
      labels.push(`Carrinhos Quebrados ${(TIPO_ICONE.carrinhosQuebrados||"‚ö†Ô∏è")}`);
      data.push(asInt(totais?.__quebrados));
    }
    if(tiposSel.has("cadeiraRodas")){
      labels.push(`Cadeira de rodas ${(TIPO_ICONE.cadeiraRodas||"‚ôø")}`);
      data.push(asInt(totais?.__cadeira));
    }

    if(chartBar){ chartBar.destroy(); chartBar = null; }

    if(labels.length === 0){
      chartBar = new Chart(ctx, {
        type:"bar",
        data:{ labels:["Sem tipos selecionados"], datasets:[{ data:[0] }] },
        options:{
          indexAxis:"y",
          responsive:true,
          maintainAspectRatio:false,
          events: [],
          plugins:{
            legend:{display:false},
            tooltip:{enabled:false},
            datalabels:{formatter:()=>""}
          },
          scales:{ x:{display:false}, y:{display:true, grid:{display:false}} }
        },
        plugins:[ChartDataLabels]
      });
      return;
    }

    const zipped = labels.map((l,i)=>({ l, v:data[i] })).sort((a,b)=>b.v - a.v);
    const labelsOrd = zipped.map(x=>x.l);
    const dataOrd = zipped.map(x=>x.v);
    const maxVal = Math.max(0, ...dataOrd);
    const suggestedMax = maxVal > 0 ? Math.ceil(maxVal * 1.18) : 1;

    const gradientFactory = (context) => {
      const { chart } = context;
      const { ctx, chartArea } = chart;
      if(!chartArea) return "#1b5e20";
      const g = ctx.createLinearGradient(chartArea.left, 0, chartArea.right, 0);
      g.addColorStop(0, "#1b5e20");
      g.addColorStop(1, "#f4d03f");
      return g;
    };

    chartBar = new Chart(ctx, {
      type:"bar",
      data:{
        labels: labelsOrd,
        datasets:[{
          data: dataOrd,
          backgroundColor: gradientFactory,
          borderWidth: 0,
          borderRadius: 8,
          barThickness: 18,
          maxBarThickness: 22,
          categoryPercentage: 0.92,
          barPercentage: 0.90
        }]
      },
      options:{
        indexAxis:"y",
        responsive:true,
        maintainAspectRatio:false,
        events: [],
        interaction: { mode: null },
        layout:{ padding:{ left: 26, right: 22, top: 6, bottom: 6 } },
        plugins:{
          legend:{ display:false },
          tooltip:{ enabled:false },
          datalabels:{
            formatter:(v)=> (v ? fmtInt(v) : ""),
            anchor:"end",
            align:"right",
            clamp:true,
            offset: 8,
            font:{ weight:"900" },
            textStrokeColor:"#ffffff",
            textStrokeWidth: 3
          }
        },
        scales:{
          x:{
            display:false,
            grid:{ display:false },
            border:{ display:false },
            suggestedMax
          },
          y:{
            display:true,
            grid:{ display:false },
            border:{ display:false },
            ticks:{ font:{ weight:"900" }, padding: 10 }
          }
        }
      },
      plugins:[ChartDataLabels]
    });
  }

  function renderTabelaPorLoja(listaFinal, listaRef, movPorLoja, tiposSel, dims){
    const thead = document.getElementById("theadPorLoja");
    const tbody = document.getElementById("tbodyPorLoja");
    thead.innerHTML = "";
    tbody.innerHTML = "";

    const showUsuario   = !!dims.usuario;
    const showAnterior  = !!dims.anterior;
    const showDiferenca = !!dims.diferenca;
    const showQuebrados = !!dims.quebrados;

    const showCestinha  = !!dims.cestinhaCol;
    const showRodas     = !!dims.rodasCol;

    const showMov       = !!dims.qtdMov;
    const showMotivo    = !!dims.motivoMov;

    const mapFinal = {};
    const mapRef = {};

    for(const r of listaFinal){
      const loja = String(r.loja||"").trim();
      if(!mapFinal[loja]) mapFinal[loja] = {
        ativos:0, quebrados:0, cestinha:0, rodas:0, usuario:""
      };

      const c = r.contagens || {};
      mapFinal[loja].ativos += somaAtivosMaisReserva(c, tiposSel);
      mapFinal[loja].quebrados += getQuebradosSeSelecionado(c, tiposSel);
      mapFinal[loja].cestinha += getCestinhaParaTabela(c, tiposSel);
      mapFinal[loja].rodas    += getCadeiraRodasParaTabela(c, tiposSel);
      mapFinal[loja].usuario = String(r.usuario || "").trim();
    }

    for(const r of listaRef){
      const loja = String(r.loja||"").trim();
      if(!mapRef[loja]) mapRef[loja] = {
        ativos:0, quebrados:0, cestinha:0, rodas:0
      };

      const c = r.contagens || {};
      mapRef[loja].ativos += somaAtivosMaisReserva(c, tiposSel);
      mapRef[loja].quebrados += getQuebradosSeSelecionado(c, tiposSel);
      mapRef[loja].cestinha  += getCestinhaParaTabela(c, tiposSel);
      mapRef[loja].rodas     += getCadeiraRodasParaTabela(c, tiposSel);
    }

    const lojas = Object.keys(mapFinal);
    if(!lojas.length){
      let cols = 2;
      if(showUsuario) cols += 1;
      if(showAnterior) cols += 1;
      if(showDiferenca) cols += 1;
      if(showQuebrados) cols += 1;
      if(showCestinha) cols += 1;
      if(showRodas) cols += 1;
      if(showMov) cols += 1;
      if(showMotivo) cols += 1;

      tbody.innerHTML = `<tr><td colspan="${cols}" style="text-align:center; font-weight:900; color:#444;">Nenhuma loja com os filtros.</td></tr>`;
      return;
    }

    lojas.sort((a,b)=> lojaCurta6(a).localeCompare(lojaCurta6(b)));

    const trh = document.createElement("tr");
    trh.innerHTML = `
      <th>Loja</th>
      ${showUsuario ? `<th>Usu√°rio</th>` : ``}
      <th>üõíAtual</th>
      ${showAnterior ? `<th>üõíAnterior</th>` : ``}
      ${showDiferenca ? `<th>üõíDiferen√ßa</th>` : ``}
      ${showQuebrados ? `<th>üõíQuebrados</th>` : ``}
      ${showCestinha ? `<th>üß∫Cestinha</th>` : ``}
      ${showRodas ? `<th>üë®üèΩ‚Äçü¶Ω‚Äç‚û°Ô∏èRodas</th>` : ``}
      ${showMov ? `<th>Mov.</th>` : ``}
      ${showMotivo ? `<th class="motivo-right">Motivo</th>` : ``}
    `;
    thead.appendChild(trh);

    let totAtual=0, totAnterior=0, totDiff=0, totQuebr=0, totCest=0, totRodas=0, totMov=0;

    for(const loja of lojas){
      const atual = asInt(mapFinal[loja].ativos);
      const anterior = asInt(mapRef[loja]?.ativos || 0);

      const diff = atual - anterior;
      const clsDiff = diff > 0 ? "diff-pos" : diff < 0 ? "diff-neg" : "diff-zero";

      const quebrados = showQuebrados ? asInt(mapFinal[loja].quebrados) : 0;
      const cestinha = showCestinha ? asInt(mapFinal[loja].cestinha) : 0;
      const rodas    = showRodas ? asInt(mapFinal[loja].rodas) : 0;

      const movObj = movPorLoja?.[loja];
      const mov = movObj ? asIntSigned(movObj.movSum) : 0;
      const movCls = mov > 0 ? "mov-pos" : mov < 0 ? "mov-neg" : "mov-zero";

      const motivoTxt = movObj ? (movObj.motivoTxt || "") : "";
      const motivoExibir = (mov !== 0) ? motivoTxt : "";

      totAtual += atual;
      if(showAnterior) totAnterior += anterior;
      if(showDiferenca) totDiff += diff;
      if(showQuebrados) totQuebr += quebrados;
      if(showCestinha) totCest += cestinha;
      if(showRodas) totRodas += rodas;
      if(showMov) totMov += mov;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(lojaCurta6(loja))}</td>
        ${showUsuario ? `<td>${esc(mapFinal[loja].usuario || "")}</td>` : ``}
        <td style="font-weight:900;">${fmtInt(atual)}</td>
        ${showAnterior ? `<td style="font-weight:900;">${fmtInt(anterior)}</td>` : ``}
        ${showDiferenca ? `<td class="${clsDiff}">${fmtSigned(diff)}</td>` : ``}
        ${showQuebrados ? `<td style="font-weight:900;">${fmtInt(quebrados)}</td>` : ``}
        ${showCestinha ? `<td style="font-weight:900;">${fmtInt(cestinha)}</td>` : ``}
        ${showRodas ? `<td style="font-weight:900;">${fmtInt(rodas)}</td>` : ``}
        ${showMov ? `<td class="${movCls}">${fmtSigned(mov)}</td>` : ``}
        ${showMotivo ? `<td class="motivo-right">${esc(motivoExibir)}</td>` : ``}
      `;
      tbody.appendChild(tr);
    }

    const trTot = document.createElement("tr");
    trTot.className = "row-total";

    const clsTotDiff = totDiff > 0 ? "diff-pos" : totDiff < 0 ? "diff-neg" : "diff-zero";
    const clsTotMov = totMov > 0 ? "mov-pos" : totMov < 0 ? "mov-neg" : "mov-zero";

    trTot.innerHTML = `
      <td>TOTAL</td>
      ${showUsuario ? `<td></td>` : ``}
      <td>${fmtInt(totAtual)}</td>
      ${showAnterior ? `<td>${fmtInt(totAnterior)}</td>` : ``}
      ${showDiferenca ? `<td class="${clsTotDiff}">${fmtSigned(totDiff)}</td>` : ``}
      ${showQuebrados ? `<td>${fmtInt(totQuebr)}</td>` : ``}
      ${showCestinha ? `<td>${fmtInt(totCest)}</td>` : ``}
      ${showRodas ? `<td>${fmtInt(totRodas)}</td>` : ``}
      ${showMov ? `<td class="${clsTotMov}">${fmtSigned(totMov)}</td>` : ``}
      ${showMotivo ? `<td class="motivo-right"></td>` : ``}
    `;
    tbody.appendChild(trTot);
  }

  function openModal({ title="Aviso", text="", buttons=[] }){
    const overlay = document.getElementById("modalOverlay");
    const t = document.getElementById("modalTitle");
    const p = document.getElementById("modalText");
    const actions = document.getElementById("modalActions");

    t.textContent = title;
    p.textContent = text;

    actions.innerHTML = "";
    for(const b of buttons){
      const btn = document.createElement("button");
      btn.className = `btn ${b.variant === "prim" ? "btn-prim" : "btn-sec"}`;
      btn.textContent = b.label || "OK";
      btn.onclick = ()=>{
        closeModal();
        if(typeof b.onClick === "function") b.onClick();
      };
      actions.appendChild(btn);
    }

    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    const overlay = document.getElementById("modalOverlay");
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden","true");
  }

  function openEditor(){
    const overlay = document.getElementById("editorOverlay");
    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden","false");
  }
  function closeEditor(){
    const overlay = document.getElementById("editorOverlay");
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden","true");
  }

  function labelDoTipo(key){
    const t = TIPOS.find(x=>x.key===key);
    return t ? t.label : key;
  }

  let EDIT_REG = null;

  function podeEditarRegistro(lojaDoRegistro){
    const perfil = String(SESSION?.perfil || "").trim().toUpperCase();
    const lojaSessao = String(SESSION?.loja || "").trim();
    const lojaReg = String(lojaDoRegistro || "").trim();

    if(perfil === "GERENTE_PPP" || perfil === "ADMINISTRADOR") return true;
    return !!lojaSessao && lojaSessao === lojaReg;
  }

  function preencherSelectCategoriaMov(selectEl, valorAtual){
    selectEl.innerHTML = "";

    const atualRaw = String(valorAtual || "").trim();
    const atualAbrev = motivoParaAbrev(atualRaw);

    const jaExisteComoOpcao = MOV_OPCOES.some(o => o.value === atualRaw);
    const desconhecido = (!!atualRaw && !atualAbrev && !jaExisteComoOpcao);

    if(desconhecido){
      const opt = document.createElement("option");
      opt.value = atualRaw;
      opt.textContent = atualRaw;
      selectEl.appendChild(opt);
    }

    for(const o of MOV_OPCOES){
      const opt = document.createElement("option");
      opt.value = o.value;
      opt.textContent = o.label;
      selectEl.appendChild(opt);
    }

    if(atualAbrev){
      selectEl.value = atualAbrev;
    }else if(desconhecido){
      selectEl.value = atualRaw;
    }else{
      selectEl.value = MOV_OPCOES[0].value;
    }
  }

  function montarEditorParaRegistro(reg){
    EDIT_REG = reg;

    const loja = String(reg?.loja || "").trim();
    const idLinha = String(reg?.idLinha || "").trim();

    document.getElementById("editorTitle").textContent = "Editar dados da loja";
    document.getElementById("editorSub").textContent = `Loja: ${loja} | ID: ${idLinha || "‚Äî"}`;

    const c = reg?.contagens || {};
    const gridAtivos = document.getElementById("editorGridAtivos");
    const gridEsp = document.getElementById("editorGridEspeciais");
    gridAtivos.innerHTML = "";
    gridEsp.innerHTML = "";

    for(const k of ACTIVE_KEYS){
      const wrap = document.createElement("div");
      wrap.className = "editor-item";
      wrap.innerHTML = `
        <label>${esc(labelDoTipo(k))} ${(TIPO_ICONE[k]||"")}</label>
        <input type="number" min="0" step="1" data-edit-key="${esc(k)}" value="${asInt(c[k])}" />
      `;
      gridAtivos.appendChild(wrap);
    }

    for(const k of SPECIAL_KEYS){
      const wrap = document.createElement("div");
      wrap.className = "editor-item";
      wrap.innerHTML = `
        <label>${esc(labelDoTipo(k))} ${(TIPO_ICONE[k]||"")}</label>
        <input type="number" min="0" step="1" data-edit-key="${esc(k)}" value="${asInt(c[k])}" />
      `;
      gridEsp.appendChild(wrap);
    }

    const movSigned = getMovimentoSigned(reg);
    const motivo = getMotivo(reg);
    const direcaoEl = document.getElementById("editMovDirecao");
    const catEl = document.getElementById("editMovCategoria");
    const qtdEl = document.getElementById("editMovQtd");

    direcaoEl.value = (movSigned < 0) ? "SAIDA" : "ENTRADA";
    qtdEl.value = String(Math.abs(asIntSigned(movSigned)));

    preencherSelectCategoriaMov(catEl, motivo);

    const body = document.getElementById("editorBody");
    if(body) body.scrollTop = 0;
  }

  function coletarValoresEditor(){
    const out = {};
    document.querySelectorAll('input[data-edit-key]').forEach(inp=>{
      const k = inp.getAttribute("data-edit-key");
      out[k] = asInt(inp.value);
    });

    const direcao = String(document.getElementById("editMovDirecao")?.value || "ENTRADA").trim();
    const qtd = asInt(document.getElementById("editMovQtd")?.value || 0);

    const catValue = String(document.getElementById("editMovCategoria")?.value || "").trim();
    const catAbrev = motivoParaAbrev(catValue) || catValue;

    const movSigned = (direcao === "SAIDA") ? -qtd : +qtd;

    out.movCarrinhos = asIntSigned(movSigned);
    out.movCategoria = (out.movCarrinhos === 0) ? "" : catAbrev;

    return out;
  }

  async function salvarEdicao(){
    if(!EDIT_REG){
      setMsg("Nenhum registro selecionado para edi√ß√£o.");
      return;
    }
    const idLinha = String(EDIT_REG.idLinha || "").trim();
    if(!idLinha){
      setMsg("ID n√£o encontrado, n√£o foi poss√≠vel salvar.");
      return;
    }

    const loja = String(EDIT_REG.loja || "").trim();

    if(!podeEditarRegistro(loja)){
      closeEditor();
      showToast("Voc√™ n√£o tem permiss√£o para editar os dados dessa loja");
      return;
    }

    const contagens = coletarValoresEditor();

    try{
      setMsg("Salvando edi√ß√£o...");
      document.getElementById("btnSalvarEdicao").disabled = true;
      document.getElementById("btnDescartarEdicao").disabled = true;

      const resp = await fetch("/api/carrinhos-editar", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type":"application/json", "Accept":"application/json" },
        body: JSON.stringify({ idLinha, contagens })
      });

      const dados = await resp.json().catch(()=>({}));
      if(!resp.ok || !dados?.sucesso){
        const msg = dados?.message || "Falha ao salvar edi√ß√£o.";
        setMsg(msg);
        return;
      }

      EDIT_REG.contagens = { ...(EDIT_REG.contagens||{}), ...contagens };
      EDIT_REG.movCategoria = contagens.movCategoria;
      EDIT_REG.motivo = contagens.movCategoria;

      const perfil = String(SESSION?.perfil || "").trim().toUpperCase();
      if(perfil === "GERENTE_PPP" || perfil === "ADMINISTRADOR"){
        EDIT_REG.usuario = String(SESSION?.usuario || "").trim();
      }

      const idx = registros.findIndex(x => String(x.idLinha||"") === idLinha);
      if(idx >= 0){
        registros[idx].contagens = { ...(registros[idx].contagens||{}), ...contagens };
        registros[idx].movCategoria = contagens.movCategoria;
        registros[idx].motivo = contagens.movCategoria;
        if(perfil === "GERENTE_PPP" || perfil === "ADMINISTRADOR"){
          registros[idx].usuario = String(SESSION?.usuario || "").trim();
        }
      }

      closeEditor();
      aplicarFiltrosEAtualizarTudo();
      setMsg("Edi√ß√£o salva com sucesso.", true);

    }catch(e){
      console.error(e);
      setMsg("Erro de conex√£o ao salvar edi√ß√£o.");
    }finally{
      document.getElementById("btnSalvarEdicao").disabled = false;
      document.getElementById("btnDescartarEdicao").disabled = false;
    }
  }

  function iniciarFluxoEdicao(reg){
    const loja = String(reg?.loja || "").trim();

    if(!podeEditarRegistro(loja)){
      showToast("Voc√™ n√£o tem permiss√£o para editar os dados dessa loja");
      return;
    }

    openModal({
      title: "Editar dados",
      text: `Deseja editar os dados da loja ${lojaCurta6(loja)}?`,
      buttons:[
        { label:"N√£o", variant:"sec" },
        { label:"Sim", variant:"prim", onClick: ()=>{
          montarEditorParaRegistro(reg);
          openEditor();
        }}
      ]
    });
  }

  function renderTabelaRegistros(lista, tiposSel){
    const thead = document.getElementById("theadRegistros");
    const tbody = document.getElementById("tbodyRegistros");
    thead.innerHTML = "";
    tbody.innerHTML = "";

    const modelosSel = ACTIVE_KEYS.filter(k => tiposSel.has(k));

    const trh = document.createElement("tr");
    trh.innerHTML = `
      <th>Loja</th>
      <th>Usu√°rio</th>
      ${modelosSel.map(k => {
        const t = TIPOS.find(x=>x.key===k);
        return `<th>${esc(t ? t.label : k)}</th>`;
      }).join("")}
      <th>Total</th>
    `;
    thead.appendChild(trh);

    if(!lista.length){
      const cols = 3 + modelosSel.length;
      tbody.innerHTML = `<tr><td colspan="${cols}" style="text-align:center; font-weight:900; color:#444;">Nenhum registro com os filtros.</td></tr>`;
      return;
    }

    const ord = [...lista].sort((a,b)=>{
      const la = lojaCurta6(a.loja||"").localeCompare(lojaCurta6(b.loja||""));
      if(la !== 0) return la;
      return String(a.usuario||"").localeCompare(String(b.usuario||""));
    });

    const totCol = {};
    modelosSel.forEach(k => totCol[k]=0);
    let totGeral = 0;

    for(const r of ord){
      const c = r.contagens || {};
      let totalLinha = 0;

      const valores = modelosSel.map(k=>{
        const v = asInt(c[k]);
        totCol[k] += v;
        totalLinha += v;
        return v;
      });

      totGeral += totalLinha;

      const lojaFull = String(r.loja||"").trim();

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div class="edit-wrap">
            <button class="edit-btn" type="button" data-edit="1" data-id="${esc(String(r.idLinha||""))}" title="Editar">${svgEdit()}</button>
            <span>${esc(lojaCurta6(lojaFull))}</span>
          </div>
        </td>
        <td>${esc(r.usuario)}</td>
        ${valores.map(v=>`<td>${fmtInt(v)}</td>`).join("")}
        <td style="font-weight:900;">${fmtInt(totalLinha)}</td>
      `;
      tbody.appendChild(tr);
    }

    const trTot = document.createElement("tr");
    trTot.className = "row-total";
    trTot.innerHTML = `
      <td colspan="2">TOTAL</td>
      ${modelosSel.map(k=>`<td>${fmtInt(totCol[k])}</td>`).join("")}
      <td>${fmtInt(totGeral)}</td>
    `;
    tbody.appendChild(trTot);

    tbody.querySelectorAll('button[data-edit="1"]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = String(btn.getAttribute("data-id") || "").trim();
        const reg = registros.find(x => String(x.idLinha||"").trim() === id) || ord.find(x => String(x.idLinha||"").trim() === id);
        if(!reg){
          showToast("Registro n√£o encontrado para edi√ß√£o.");
          return;
        }
        iniciarFluxoEdicao(reg);
      });
    });
  }

  function renderTabelaEspeciais(lista, tiposSel){
    const thead = document.getElementById("theadEspeciais");
    const tbody = document.getElementById("tbodyEspeciais");
    thead.innerHTML = "";
    tbody.innerHTML = "";

    const especiaisSel = SPECIAL_KEYS.filter(k => tiposSel.has(k));

    const trh = document.createElement("tr");
    trh.innerHTML = `
      <th>Loja</th>
      <th>Usu√°rio</th>
      ${especiaisSel.map(k=>{
        const t = TIPOS.find(x=>x.key===k);
        return `<th>${esc(t ? t.label : k)}</th>`;
      }).join("")}
    `;
    thead.appendChild(trh);

    if(!lista.length){
      const cols = 2 + especiaisSel.length;
      tbody.innerHTML = `<tr><td colspan="${cols}" style="text-align:center; font-weight:900; color:#444;">Nenhum registro com os filtros.</td></tr>`;
      return;
    }

    const ord = [...lista].sort((a,b)=>{
      const la = lojaCurta6(a.loja||"").localeCompare(lojaCurta6(b.loja||""));
      if(la !== 0) return la;
      return String(a.usuario||"").localeCompare(String(b.usuario||""));
    });

    const totCol = {};
    especiaisSel.forEach(k => totCol[k]=0);

    for(const r of ord){
      const c = r.contagens || {};
      const valores = especiaisSel.map(k=>{
        const v = asInt(c[k]);
        totCol[k] += v;
        return v;
      });

      const lojaFull = String(r.loja||"").trim();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(lojaCurta6(lojaFull))}</td>
        <td>${esc(r.usuario)}</td>
        ${valores.map(v=>`<td>${fmtInt(v)}</td>`).join("")}
      `;
      tbody.appendChild(tr);
    }

    const trTot = document.createElement("tr");
    trTot.className = "row-total";
    trTot.innerHTML = `
      <td colspan="2">TOTAL</td>
      ${especiaisSel.map(k=>`<td>${fmtInt(totCol[k])}</td>`).join("")}
    `;
    tbody.appendChild(trTot);
  }

  function montarFiltros(){
    const listaDim = document.getElementById("listaDimensoes");
    listaDim.innerHTML = "";

    DIMENSOES.forEach((d, i)=>{
      const id = `dim_${i}`;
      const row = document.createElement("div");
      row.className = "check";
      row.innerHTML = `
        <input type="checkbox" id="${id}" data-dim="${d.key}" ${d.defaultChecked ? "checked" : ""} />
        <label for="${id}">${d.label}</label>
      `;
      listaDim.appendChild(row);
    });

    document.querySelectorAll('input[type="checkbox"][data-dim]').forEach(cb=>{
      cb.addEventListener("change", aplicarFiltrosEAtualizarTudo);
    });

    const listaTipos = document.getElementById("listaTipos");
    listaTipos.innerHTML = "";
    TIPOS.forEach((t, i)=>{
      const id = `tp_${i}`;
      const row = document.createElement("div");
      row.className = "check";
      row.innerHTML = `
        <input type="checkbox" id="${id}" data-tipo="tipo" data-valor="${t.key}" checked />
        <label for="${id}">${t.label}</label>
      `;
      listaTipos.appendChild(row);
    });

    const listaLojas = document.getElementById("listaLojas");
    listaLojas.innerHTML = "";
    LOJAS.forEach((l, i)=>{
      const id = `lj_${i}`;
      const row = document.createElement("div");
      row.className = "check";
      row.innerHTML = `
        <input type="checkbox" id="${id}" data-tipo="loja" data-valor="${l}" checked />
        <label for="${id}">${l}</label>
      `;
      listaLojas.appendChild(row);
    });

    document.querySelectorAll('input[type="checkbox"][data-tipo]').forEach(cb=>{
      cb.addEventListener("change", aplicarFiltrosEAtualizarTudo);
    });

    document.getElementById("bandBIG").addEventListener("change", ()=>{
      aplicarBandeiraNasLojas("BIG", document.getElementById("bandBIG").checked);
      aplicarFiltrosEAtualizarTudo();
    });
    document.getElementById("bandULT").addEventListener("change", ()=>{
      aplicarBandeiraNasLojas("ULT", document.getElementById("bandULT").checked);
      aplicarFiltrosEAtualizarTudo();
    });

    document.getElementById("btnTiposTudo").onclick = ()=> setChecks("tipo", true);
    document.getElementById("btnTiposNada").onclick = ()=> setChecks("tipo", false);

    document.getElementById("dataFinal").addEventListener("change", ()=>{
      syncDataAnteriorComDataFinal();
      aplicarFiltrosEAtualizarTudo();
    });

    document.getElementById("dataRef").addEventListener("change", ()=>{
      syncDataAnteriorComDataFinal();
      aplicarFiltrosEAtualizarTudo();
    });

    aplicarBandeiraNasLojas("BIG", document.getElementById("bandBIG").checked);
    aplicarBandeiraNasLojas("ULT", document.getElementById("bandULT").checked);

    document.getElementById("btnDescartarEdicao").onclick = ()=>{
      closeEditor();
      EDIT_REG = null;
      setMsg("Edi√ß√£o descartada.");
    };
    document.getElementById("btnSalvarEdicao").onclick = salvarEdicao;
  }

  function setChecks(tipo, valor){
    document.querySelectorAll(`input[type="checkbox"][data-tipo="${tipo}"]`).forEach(cb=>{
      cb.checked = !!valor;
    });
    aplicarFiltrosEAtualizarTudo();
  }

  function aplicarBandeiraNasLojas(bandeira, marcar){
    document.querySelectorAll('input[type="checkbox"][data-tipo="loja"]').forEach(cb=>{
      const loja = cb.getAttribute("data-valor") || "";
      if(bandeiraDaLoja(loja) === bandeira){
        cb.checked = !!marcar;
      }
    });
  }

  function sugerirDatasMaisRecentes(){
    const elFinal = document.getElementById("dataFinal");
    const hoje = todayISO();
    if(!elFinal.value) elFinal.value = hoje;

    const datasISO = registros
      .map(r => brParaISO(String(r.dataContagem||"").trim()))
      .filter(Boolean)
      .sort();

    if(datasISO.length){
      const ateHoje = datasISO.filter(d => d <= hoje);
      if(ateHoje.length){
        elFinal.value = ateHoje[ateHoje.length - 1];
      }else{
        elFinal.value = hoje;
      }
    }

    syncDataAnteriorComDataFinal();
  }

  function aplicarFiltrosEAtualizarTudo(){
    setMsg("");

    const dataFinalISO = (document.getElementById("dataFinal").value || "").trim();
    if(!dataFinalISO){
      document.getElementById("kpiCarrinhos").textContent = "0";
      document.getElementById("kpiQuebrados").textContent = "0";
      document.getElementById("kpiCestinhas").textContent = "0";
      renderTabelaRegistros([], new Set());
      renderTabelaPorLoja([], [], {}, new Set(), getDimensoesSelecionadas());
      renderTabelaEspeciais([], new Set());
      desenharBarrasTipos({}, new Set());
      setMsg("Selecione a Data de busca para exibir os dados.");
      return;
    }

    syncDataAnteriorComDataFinal();

    const dataRefISO = (document.getElementById("dataRef").value || "").trim();
    const dataFinalBR = isoParaBR(dataFinalISO);
    const dataRefBR   = dataRefISO ? isoParaBR(dataRefISO) : "";

    const tiposSel = getSelecionados("tipo");
    const lojasSel = getSelecionados("loja");
    const dims = getDimensoesSelecionadas();

    if(tiposSel.size === 0){
      document.getElementById("kpiCarrinhos").textContent = "0";
      document.getElementById("kpiQuebrados").textContent = "0";
      document.getElementById("kpiCestinhas").textContent = "0";
      renderTabelaRegistros([], tiposSel);
      renderTabelaPorLoja([], [], {}, tiposSel, dims);
      renderTabelaEspeciais([], tiposSel);
      desenharBarrasTipos({}, tiposSel);
      setMsg("Nenhum tipo selecionado.");
      return;
    }

    const passaFiltroTipo = (r)=>{
      const c = r.contagens || {};
      for(const k of tiposSel){
        if(asInt(c[k]) > 0) return true;
      }
      return false;
    };

    const baseFinal = registros.filter(r=>{
      const loja = String(r.loja || "").trim();
      if(lojasSel.size && !lojasSel.has(loja)) return false;
      if(String(r.dataContagem || "").trim() !== dataFinalBR) return false;
      if(!passaFiltroTipo(r)) return false;
      return true;
    });

    const baseRef = (dataRefBR ? registros.filter(r=>{
      const loja = String(r.loja || "").trim();
      if(lojasSel.size && !lojasSel.has(loja)) return false;
      if(String(r.dataContagem || "").trim() !== dataRefBR) return false;
      if(!passaFiltroTipo(r)) return false;
      return true;
    }) : []);

    const movPorLoja = acumularMovPorLoja(baseFinal);

    let somaAtivos = 0;
    let somaQuebrados = 0;
    let somaCestinhas = 0;

    for(const r of baseFinal){
      const c = r.contagens || {};
      somaAtivos += somaAtivosMaisReserva(c, tiposSel);
      somaQuebrados += getQuebradosSeSelecionado(c, tiposSel);
      somaCestinhas += somaCestinhasSelecionadas(c, tiposSel);
    }

    document.getElementById("kpiCarrinhos").textContent = fmtInt(somaAtivos);
    document.getElementById("kpiQuebrados").textContent = fmtInt(somaQuebrados);
    document.getElementById("kpiCestinhas").textContent = fmtInt(somaCestinhas);

    const totaisGrafico = recalcularTotaisParaGrafico(baseFinal, tiposSel);
    desenharBarrasTipos(totaisGrafico, tiposSel);

    renderTabelaPorLoja(baseFinal, baseRef, movPorLoja, tiposSel, dims);
    renderTabelaRegistros(baseFinal, tiposSel);
    renderTabelaEspeciais(baseFinal, tiposSel);
  }

  document.addEventListener("DOMContentLoaded", async ()=>{
    document.getElementById("btnIrLogin").onclick = ()=> window.location.href = ROTAS.login;
    document.getElementById("btnVoltarMenu").onclick = ()=> window.location.href = ROTAS.menu;
    document.getElementById("btnAtualizar").onclick = carregarRegistros;

    const elFinal = document.getElementById("dataFinal");
    if(elFinal && !elFinal.value) elFinal.value = todayISO();
    syncDataAnteriorComDataFinal();

    const s = await obterSessaoDoBackend();
    if(!s){
      mostrarSemSessao();
      return;
    }

    SESSION = s;

    const perfil = String(s.perfil||"").trim().toUpperCase();
    if(!PERFIS_PERMITIDOS.includes(perfil)){
      mostrarApp();
      document.getElementById("cardUsuario").textContent = s.usuario;
      document.getElementById("cardLoja").textContent = s.loja;
      setMsg("Acesso negado: seu perfil n√£o tem permiss√£o para esta tela.");
      document.getElementById("btnAtualizar").disabled = true;
      return;
    }

    mostrarApp();
    document.getElementById("cardUsuario").textContent = s.usuario;
    document.getElementById("cardLoja").textContent = s.loja;

    await carregarRegistros();
  });
</script>
</body>
</html>

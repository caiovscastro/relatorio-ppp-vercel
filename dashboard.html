<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <!-- Viewport padrão (mantido) -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DASHBOARD – Relatório de Ocorrências</title>

  <style>
    /* ====== Visual “semelhante ao print”: tiles claras em um fundo cinza suave ====== */
    html, body{
      width: 100%;
      max-width: 100%;
      overflow-x: hidden; /* ✅ evita rolagem horizontal e “deslocamento” para a direita */
    }

    body{
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      color: #111;
    }

    .wrap{
      /* ✅ ocupa a tela sem estourar e sem ficar “puxado” para a direita */
      width: calc(100vw - 20px);
      max-width: 1400px;
      margin: 16px auto 30px;
      box-sizing: border-box;
    }

    /* ============================
       Tiles (BASE VISUAL)
       ============================ */
    .tile{
      background: #f6f6f6;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      padding: 12px 14px;
      min-height: 180px;
      box-sizing: border-box;
      min-width: 0; /* ✅ importante para não “forçar” overflow */
    }

    .tile h3{
      margin: 0 0 10px;
      font-size: 13px;
      font-weight: 900;
      color: #111;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }

    /* =========================================================
       ✅ LAYOUT: SIDEBAR ESQUERDA + CONTEÚDO
       ========================================================= */
    .layout{
      display: grid;
      grid-template-columns: 270px minmax(0, 1fr); /* ✅ evita overflow no conteúdo */
      gap: 12px;
      align-items: start;
      min-width: 0;
    }

    .sidebar{
      min-height: unset;
      padding: 12px 12px;
      min-width: 0;
    }

    .sidebar h3{
      text-align: left;
      margin-bottom: 12px;
    }

    .sidebar .side-stack{
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 0;
    }

    .sidebar .side-stack .input-filter,
    .sidebar .side-stack .btn,
    .sidebar .side-stack .btn-dd{
      width: 100%;
      justify-content: center;
      min-width: 0;
    }

    .sidebar .dd-wrap{
      width: 100%;
      min-width: 0;
    }

    .sidebar .dd-panel{
      right: 0;
      width: 240px;
    }

    .sidebar .dd-panel.dd-lojas{
      width: 320px;
      max-height: 320px;
      overflow: auto;
    }

    /* =========================================================
       Grid base
       ========================================================= */
    .grid{
      display: grid;

      /* ✅ AJUSTE 1: 1ª coluna 20% mais larga (Ocorrências) */
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr) minmax(0, 1fr);

      gap: 12px;
      min-width: 0;
    }

    /* Topo ocupando as 3 colunas do grid */
    .topbar{
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;

      min-height: unset;
      padding: 14px 16px;
      min-width: 0;
    }

    /* =========================================================
       Título
       ========================================================= */
    .title{
      margin: 0;
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: clamp(16px, 2.2vw, 20px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .subtitle{
      margin: 4px 0 0;
      font-size: 12px;
      color: #555;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* =========================================================
       ✅ PADRÃO ÚNICO DE ALTURA
       ========================================================= */
    :root{
      --ctrl-h: 38px;
      --ctrl-gap: 8px;
      --ctrl-r: 10px;
    }

    .btn{
      border: none;
      border-radius: var(--ctrl-r);
      height: var(--ctrl-h);
      padding: 0 12px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
      white-space: nowrap;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }

    .btn-back{
      background: #0066ff;
      color: #fff;
    }

    .btn-refresh{
      background: #e9e9e9;
      color: #111;
    }

    .select-filter{
      border: 1px solid #d6d6d6;
      background: #fff;
      color: #111;
      border-radius: var(--ctrl-r);
      height: var(--ctrl-h);
      padding: 0 10px;
      font-weight: 700;
      font-size: 13px;
      outline: none;
      cursor: pointer;
      box-sizing: border-box;
    }

    /* =========================================================
       CONTROLES (datas + venda + botões)
       ========================================================= */
    .filters-wrap{
      display:flex;
      gap: var(--ctrl-gap);
      align-items:center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .filters-main{
      display:flex;
      gap: var(--ctrl-gap);
      align-items:center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .filters-extra{
      display:flex;
      gap: var(--ctrl-gap);
      align-items:center;
      flex-wrap: nowrap;
      justify-content: flex-end;
    }

    .input-filter{
      border: 1px solid #d6d6d6;
      background: #fff;
      color: #111;
      border-radius: var(--ctrl-r);
      height: var(--ctrl-h);
      padding: 0 10px;
      font-weight: 700;
      font-size: 13px;
      outline: none;
      box-sizing: border-box;
      min-width: 0;
    }

    /* Datas 10% menor (largura) */
    .input-date{
      width: 134px;
      min-width: 134px;
    }

    /* Valor 40% menor (largura) */
    .input-money{
      width: 102px;
      min-width: 102px;
      text-align: right;
    }

    /* =========================================================
       Dropdown genérico (Turnos / Gravidade / Lojas / Abordagem)
       ========================================================= */
    .dd-wrap{
      position: relative;
      display: inline-flex;
      align-items: center;
      min-width: 0;
    }

    .btn-dd{
      border: 1px solid #d6d6d6;
      background: #fff;
      color: #111;
      border-radius: var(--ctrl-r);
      height: var(--ctrl-h);
      padding: 0 10px;
      font-weight: 800;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      width: 100%;
      min-width: 0;
    }

    .dd-panel{
      position: absolute;
      top: calc(100% + 6px);
      right: 0;
      width: 220px;
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.16);
      padding: 10px;
      z-index: 20000;
      display: none;
    }

    .dd-panel .item{
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 6px;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
    }

    .dd-panel .item:hover{
      background: #f4f4f4;
    }

    .dd-panel input[type="checkbox"]{
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .dd-panel .lbl{
      font-size: 13px;
      font-weight: 800;
      color: #111;
    }

    .dd-panel .hint{
      font-size: 11px;
      color: #555;
      margin-top: 8px;
      line-height: 1.35;
    }

    /* ============================
       ✅ painel de lojas maior e com scroll
       ============================ */
    .dd-panel.dd-lojas{
      width: 320px;
      max-height: 320px;
      overflow: auto;
    }

    /* =========================================================
       Linhas internas do grid
       ========================================================= */
    .row2{
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); /* ✅ */
      gap: 12px;
      min-width: 0;
    }

    .row3{
      grid-column: 1 / -1;
      display: block;
      min-width: 0;
    }

    /* ============================
       Ocorrências (número grande)
       ============================ */
    .big-number{
      height: calc(100% - 28px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .big-number .n{
      font-size: 92px;
      font-weight: 900;
      line-height: 1;
      color: #111;
      text-align: center;
    }

    .big-number .valor{
      font-weight: 900;
      color: #111;
      font-size: 16px;
      text-align: center;
      margin-top: 2px;
    }

    .big-number .participacao{
      font-weight: 800;
      color: #555;
      font-size: 13px;
      text-align: center;
      margin-top: 2px;
    }

    .canvas-wrap{
      position: relative;
      height: 210px;
      min-width: 0;
    }

    .ocorrencias-split{
      height: calc(100% - 28px);
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); /* ✅ */
      gap: 10px;
      align-items: center;
      min-width: 0;
    }

    .ocorrencias-pie{
      position: relative;
      height: 240px;
      min-height: 240px;
      min-width: 0;
    }

    /* ============================
       Card “Ocorrências por Bandeira”
       ============================ */
    .tile.bandeira-tile h3{ text-align: center; }

    .bandeira-split{
      height: calc(100% - 28px);
      display: grid;
      grid-template-columns: minmax(0,1fr) 1px minmax(0,1fr);
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .bandeira-divider{
      width: 1px;
      height: 70%;
      background: #d9d9d9;
      justify-self: center;
      border-radius: 1px;
    }

    .bandeira-col{
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 120px;
      min-width: 0;
    }

    .bandeira-num{
      font-size: 44px;
      font-weight: 900;
      color: #111;
      line-height: 1;
    }

    .bandeira-valor{
      font-size: 14px;
      font-weight: 900;
      color: #111;
      line-height: 1.1;
    }

    .bandeira-logo{
      width: 140px;
      height: 46px;
      object-fit: contain;
      display: block;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.18));
    }

    /* =========================================================
       Status
       ========================================================= */
    .status{
      width: 100%;
      box-sizing: border-box;
      margin-top: 10px;
      font-size: 13px;
      color: #333;
      padding: 12px 14px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid #e5e5e5;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }

    /* ====== Acesso inválido ====== */
    .tela-erro{
      width: min(520px, 92vw);
      margin: 60px auto;
      background: #fff;
      border-radius: 12px;
      padding: 22px 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      text-align: center;
    }

    .tela-erro h1{
      margin: 0 0 8px;
      color: #c00000;
    }

    /* ====== Responsivo ====== */
    @media (max-width: 980px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .row2{ grid-template-columns: minmax(0,1fr); }
      .layout{ grid-template-columns: minmax(0,1fr); }
    }

    /* =========================================================
       ✅ Ajuste para celular:
       1) Sidebar em 2 colunas (Atualizar ao lado de Voltar, etc.)
       2) Mantém sem overflow horizontal
       3) ✅ FIX: dropdowns da sidebar não podem “sair” da tela e cortar os checkboxes
       ========================================================= */
    @media (max-width: 640px){
      .wrap{
        width: calc(100vw - 20px);
        max-width: 100%;
        margin: 12px auto 24px;
        padding: 0;
      }

      .grid, .row2, .row3,
      .tile,
      .topbar,
      .topbar > div{
        min-width: 0;
        max-width: 100%;
      }

      canvas{
        display: block;
        width: 100% !important;
        max-width: 100% !important;
      }

      img{
        max-width: 100%;
      }

      .grid{ grid-template-columns: 1fr; }
      .big-number .n{ font-size: 82px; }
      .canvas-wrap{ height: 240px; }
      .bandeira-num{ font-size: 40px; }
      .bandeira-logo{ width: 132px; height: 44px; }

      .ocorrencias-split{ grid-template-columns: 1fr; }

      .ocorrencias-pie{
        height: 280px;
        min-height: 280px;
      }

      .topbar{
        flex-direction: column;
        align-items: stretch;
      }

      /* ✅ 2 colunas para TODOS os filtros e botões (na ordem já existente) */
      .sidebar .side-stack{
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      /* ✅ garante que cada item ocupe corretamente a “célula” sem forçar largura */
      .sidebar .side-stack > *{
        width: 100%;
        min-width: 0;
      }

      /* ✅ inputs que tinham largura fixa no desktop passam a ser 100% no mobile */
      .input-date,
      .input-money{
        width: 100%;
        min-width: 0;
      }

      /* ✅ dropdown botão sempre 100% */
      .btn-dd{
        width: 100%;
      }

      /* =====================================================================
         ✅ FIX 1 (CSS): no mobile, dropdown da SIDEBAR abre ancorado à esquerda
         para não “vazar” pra fora do viewport e cortar os checkboxes.
         ===================================================================== */
      .sidebar .dd-panel{
        left: 0;                /* ✅ ancora no início do wrap */
        right: auto;            /* ✅ remove o right:0 no mobile */
        max-width: calc(100vw - 40px); /* ✅ nunca passa da tela */
      }

      .sidebar .dd-panel.dd-lojas{
        width: min(320px, calc(100vw - 40px)); /* ✅ mantém seu 320, mas respeita a tela */
      }
    }
  </style>
</head>

<body>
  <div id="telaErro" class="tela-erro" style="display:none;">
    <h1>Acesso inválido</h1>
    <p>Este dashboard só pode ser aberto após login.</p>
    <p>Volte para o <b>Menu</b> e tente novamente.</p>
    <button class="btn btn-back" onclick="voltar()">Voltar</button>
  </div>

  <div id="app" class="wrap" style="display:none;">

    <div class="layout">

      <!-- ✅ NOVO: CARTÃO ESQUERDO COM TODOS OS FILTROS -->
      <div class="tile sidebar">
        <h3>Filtros</h3>

        <div class="side-stack">

          <!-- 1) Atualizar -->
          <!-- ✅ FIX 2: Atualizar força re-fetch; filtros não fazem fetch -->
          <button class="btn btn-refresh" onclick="carregar(true)">Atualizar</button>

          <!-- 2) Voltar -->
          <button class="btn btn-back" onclick="voltar()">Voltar</button>

          <!-- 3) Data inicio -->
          <input id="dataInicio" class="input-filter input-date" type="date" aria-label="Data início" title="Data início" />

          <!-- 4) Data fim -->
          <input id="dataFim" class="input-filter input-date" type="date" aria-label="Data fim" title="Data fim" />

          <!-- 5) Lojas -->
          <div class="dd-wrap" id="lojaWrap">
            <button type="button" class="btn-dd" id="btnLoja" aria-haspopup="true" aria-expanded="false">
              Lojas ▾
            </button>
            <div class="dd-panel dd-lojas" id="lojaPanel" role="menu" aria-label="Filtro de lojas">
              <div class="hint">Carregando lojas...</div>
            </div>
          </div>

          <!-- 6) Tipo de abordagem (coluna T) -->
          <div class="dd-wrap" id="abordagemWrap">
            <button type="button" class="btn-dd" id="btnAbordagem" aria-haspopup="true" aria-expanded="false">
              Tipo de abordagem ▾
            </button>

            <div class="dd-panel" id="abordagemPanel" role="menu" aria-label="Filtro de tipo de abordagem">
              <div class="item">
                <input type="checkbox" id="ckReativa" checked />
                <label class="lbl" for="ckReativa">Reativa</label>
              </div>

              <div class="item">
                <input type="checkbox" id="ckPreventiva" checked />
                <label class="lbl" for="ckPreventiva">Preventiva</label>
              </div>

              <div class="hint"></div>
            </div>
          </div>

          <!-- 7) Turnos -->
          <div class="dd-wrap" id="turnoWrap">
            <button type="button" class="btn-dd" id="btnTurno" aria-haspopup="true" aria-expanded="false">
              Turnos ▾
            </button>

            <div class="dd-panel" id="turnoPanel" role="menu" aria-label="Filtro de turnos">
              <div class="item">
                <input type="checkbox" id="ckManha" checked />
                <label class="lbl" for="ckManha">Manhã</label>
              </div>

              <div class="item">
                <input type="checkbox" id="ckTarde" checked />
                <label class="lbl" for="ckTarde">Tarde</label>
              </div>

              <div class="item">
                <input type="checkbox" id="ckMadrugada" checked />
                <label class="lbl" for="ckMadrugada">Madrugada</label>
              </div>

              <div class="hint">
                Manhã: 07:00–14:00<br/>
                Tarde: 14:01–22:00<br/>
                Madrugada: 22:01–06:59
              </div>
            </div>
          </div>

          <!-- 8) Gravidade -->
          <div class="dd-wrap" id="gravidadeWrap">
            <button type="button" class="btn-dd" id="btnGravidade" aria-haspopup="true" aria-expanded="false">
              Gravidade ▾
            </button>

            <div class="dd-panel" id="gravidadePanel" role="menu" aria-label="Filtro de gravidade">
              <div class="item">
                <input type="checkbox" id="ckLeve" checked />
                <label class="lbl" for="ckLeve">Leve</label>
              </div>

              <div class="item">
                <input type="checkbox" id="ckMedia" checked />
                <label class="lbl" for="ckMedia">Média</label>
              </div>

              <div class="item">
                <input type="checkbox" id="ckGrave" checked />
                <label class="lbl" for="ckGrave">Grave</label>
              </div>

              <div class="hint">
                Leve: &lt; 100<br/>
                Média: 100–499,99<br/>
                Grave: ≥ 500
              </div>
            </div>
          </div>

          <!-- 9) Caixa de valor -->
          <input
            id="valorVenda"
            class="input-filter input-money"
            type="text"
            inputmode="decimal"
            autocomplete="off"
            spellcheck="false"
            placeholder="Valor Rotativos (ex: 0,00)"
            aria-label="Valor para participação"
            title="Valor Rotativos"
          />
        </div>
      </div>

      <!-- ✅ CONTEÚDO PRINCIPAL -->
      <div class="grid">

        <!-- TOPO (span total do grid) -->
        <div class="tile topbar">
          <div>
            <h1 class="title">RELATÓRIO DE OCORRÊNCIAS</h1>
            <p class="subtitle" id="subInfo">Carregando dados...</p>
          </div>
        </div>

        <!-- 1) Ocorrências + Pizza Gravidade -->
        <div class="tile">
          <h3>Ocorrências</h3>

          <div class="ocorrencias-split">
            <div class="big-number" style="height:auto;">
              <div class="n" id="totalOcorrencias">0</div>
              <div class="valor" id="totalValorOcorrencias">R$ 0,00</div>
              <div class="participacao" id="pctParticipacao">Recup. x Rotativos: 0,00%</div>
            </div>

            <div class="ocorrencias-pie">
              <canvas id="chartGravidade"></canvas>
            </div>
          </div>
        </div>

        <!-- 2) Ocorrências por bandeira -->
        <div class="tile bandeira-tile">
          <h3>Ocorrências por bandeira</h3>

          <div class="bandeira-split" aria-label="Ocorrências por bandeira (BIG e ULT)">
            <div class="bandeira-col">
              <div class="bandeira-num" id="bandeiraBIG">0</div>
              <div class="bandeira-valor" id="valorBIG">R$ 0,00</div>
              <img class="bandeira-logo" src="https://i.ibb.co/Kz5DZ8nP/1001316505.png" alt="Big Box" />
            </div>

            <div class="bandeira-divider" aria-hidden="true"></div>

            <div class="bandeira-col">
              <div class="bandeira-num" id="bandeiraULT">0</div>
              <div class="bandeira-valor" id="valorULT">R$ 0,00</div>
              <img class="bandeira-logo" src="https://i.ibb.co/RTb7sqbz/1001317603.png" alt="Ultrabox" />
            </div>
          </div>
        </div>

        <!-- 3) Percentual por bandeira -->
        <div class="tile">
          <h3>Percentual por bandeira</h3>
          <div class="canvas-wrap" style="height: 210px;">
            <canvas id="chartPctBandeira"></canvas>
          </div>
        </div>

        <!-- LINHA DE BAIXO -->
        <div class="row2">
          <div class="tile">
            <h3>Top 5 lojas com maior nº de ocorrências</h3>
            <div class="canvas-wrap">
              <canvas id="chartTopLojas"></canvas>
            </div>
          </div>

          <div class="tile">
            <h3>Ocorrências por departamento</h3>
            <div class="canvas-wrap" style="height: 260px;">
              <canvas id="chartDept"></canvas>
            </div>
          </div>
        </div>

        <!-- Top 15 produtos -->
        <div class="row3">
          <div class="tile" style="min-height: 240px;">
            <h3>Top 15 produtos com maior nº de registros</h3>
            <div class="canvas-wrap" style="height: 280px;">
              <canvas id="chartTopProdutos"></canvas>
            </div>
          </div>
        </div>

      </div><!-- /grid -->
    </div><!-- /layout -->

    <div class="status" id="status">Aguardando...</div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    const STORAGE_KEY_GESTOR = "PPP_LOGIN_GESTOR";
    const STORAGE_KEY_MENU = "pppSession";

    let chartTopLojas = null;
    let chartDept = null;
    let chartPctBandeira = null;
    let chartTopProdutos = null;
    let chartGravidade = null;

    let totalValorOcorrenciasAtual = 0;

    /* =============================================================================
       ✅ FIX 2 (Performance): cache dos registros no navegador
       - Só busca na API quando:
         a) a página é carregada (1ª vez)
         b) clica em "Atualizar"
       - Filtros apenas chamam aplicarFiltros() (sem rede)
       ============================================================================= */
    let REGISTROS_CACHE = null;        // Array de registros vindo da API
    let CACHE_OK = false;             // flag para saber se já carregou
    let CACHE_ATUALIZADO_EM = null;   // timestamp local (opcional, útil para debug)

    const LOJAS_LISTA = [
      { bandeira:"BIG", label:"BIG 01 - 106 NORTE" },
      { bandeira:"BIG", label:"BIG 02 - 402 NORTE" },
      { bandeira:"BIG", label:"BIG 03 - 413 SUL" },
      { bandeira:"BIG", label:"BIG 04 - 301 SW" },
      { bandeira:"BIG", label:"BIG 05 - 408 NORTE" },
      { bandeira:"BIG", label:"BIG 06 - SIBERIA" },
      { bandeira:"BIG", label:"BIG 08 - 503 SUL" },
      { bandeira:"BIG", label:"BIG 09 - PENÍNSULA" },
      { bandeira:"BIG", label:"BIG 10 - PAINEIRAS" },
      { bandeira:"BIG", label:"BIG 11 - 310 NORTE" },
      { bandeira:"BIG", label:"BIG 12 - 208 NORTE" },
      { bandeira:"BIG", label:"BIG 13 - QI-05 L. NORTE" },
      { bandeira:"BIG", label:"BIG 14 - 508 SUL" },
      { bandeira:"BIG", label:"BIG 15 - 105 SW" },
      { bandeira:"BIG", label:"BIG 16 - 512 SUL" },
      { bandeira:"BIG", label:"BIG 17 - QI-11 LAGO SUL" },
      { bandeira:"BIG", label:"BIG 18 - 211 NORTE" },
      { bandeira:"BIG", label:"BIG 19 - CASTANHEIRA" },
      { bandeira:"BIG", label:"BIG 20 - TAGUATINGA C1" },
      { bandeira:"BIG", label:"BIG 21 - CNB12" },
      { bandeira:"BIG", label:"BIG 22 - 102 NOROESTE" },
      { bandeira:"BIG", label:"BIG 23 - QI-23 LAGO SUL" },
      { bandeira:"BIG", label:"BIG 24 - 314 NORTE" },
      { bandeira:"BIG", label:"BIG 25 - 410 SUL" },

      { bandeira:"ULT", label:"ULT 01 - PLANALTINA" },
      { bandeira:"ULT", label:"ULT 02 - GAMA" },
      { bandeira:"ULT", label:"ULT 03 - COLORADO" },
      { bandeira:"ULT", label:"ULT 04 - CEI SUL" },
      { bandeira:"ULT", label:"ULT 05 - POLO JK" },
      { bandeira:"ULT", label:"ULT 06 - SOBRADINHO" },
      { bandeira:"ULT", label:"ULT 07 - ADE" },
      { bandeira:"ULT", label:"ULT 08 - ARAPOANGA" },
      { bandeira:"ULT", label:"ULT 09 - CEI NORTE" },
      { bandeira:"ULT", label:"ULT 10 - ESTRUTURAL" },
      { bandeira:"ULT", label:"ULT 11 - ITAPOA" },
      { bandeira:"ULT", label:"ULT 12 - SAO SEBASTIAO" },
      { bandeira:"ULT", label:"ULT 13 - RECANTO" },
      { bandeira:"ULT", label:"ULT 14 - AGUAS LINDAS" },
      { bandeira:"ULT", label:"ULT 15 - SOL NASCENTE" },
      { bandeira:"ULT", label:"ULT 16 - PARANOA PARK" },
      { bandeira:"ULT", label:"ULT 17 - SAMAMBAIA" },
      { bandeira:"ULT", label:"ULT 18 - BRAZLANDIA" },
      { bandeira:"ULT", label:"ULT 19 - VIA PARK" },
      { bandeira:"ULT", label:"ULT 20 - TAGUATINGA" },
      { bandeira:"ULT", label:"ULT 22 - VICENTE PIRES" },
      { bandeira:"ULT", label:"ULT 23 - SANTA MARIA" },
      { bandeira:"ULT", label:"ULT 25 - BRASILINHA" }
    ];

    let LOJAS_SELECIONADAS = new Set();

    function normLoja(s){
      return String(s || "").trim().toUpperCase();
    }

    /* =============================================================================
       Sessão para APIs (mantido)
       ============================================================================= */
    function b64EncodeUnicode(str) {
      try {
        return btoa(unescape(encodeURIComponent(str)));
      } catch (e) {
        return btoa(str);
      }
    }

    function obterSessaoAtual() {
      // 1) Gestor (sessionStorage)
      try {
        const rawG = sessionStorage.getItem(STORAGE_KEY_GESTOR);
        if (rawG) {
          const obj = JSON.parse(rawG);
          if (obj && obj.usuario) return obj;
        }
      } catch (e) {}

      // 2) Menu (localStorage)
      try {
        const rawM = localStorage.getItem(STORAGE_KEY_MENU);
        if (rawM) {
          const obj = JSON.parse(rawM);
          if (obj && obj.usuario && obj.loja && obj.perfil) return obj;
        }
      } catch (e) {}

      return null;
    }

    function getAuthHeaders() {
      const s = obterSessaoAtual();
      if (!s) return {};
      return { "X-PPP-Session": b64EncodeUnicode(JSON.stringify(s)) };
    }

    function validarAcesso() {
      const s = obterSessaoAtual();
      if (!s) return false;

      const perfil = String(s.perfil || "").trim().toUpperCase();
      const permitido = (perfil === "GERENTE_PPP" || perfil === "ADMINISTRADOR" || perfil === "BASE_PPP");
      return !!permitido;
    }

    function voltar() {
      window.location.href = "/menu.html";
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (!validarAcesso()) {
        document.getElementById("telaErro").style.display = "block";
        return;
      }

      document.getElementById("app").style.display = "block";

      document.getElementById("dataInicio")?.addEventListener("change", aplicarFiltros);
      document.getElementById("dataFim")?.addEventListener("change", aplicarFiltros);

      const inpVenda = document.getElementById("valorVenda");
      if (inpVenda) {
        inpVenda.addEventListener("input", () => {
          formatarCampoMoeda(inpVenda);
          atualizarParticipacao();
        });
        inpVenda.addEventListener("blur", () => {
          formatarCampoMoeda(inpVenda, { forceTwoDecimals: true });
          atualizarParticipacao();
        });
      }

      setupFiltroTurno();
      setupFiltroGravidade();
      setupFiltroLojas();
      setupFiltroAbordagem();

      carregar(false);
    });

    function clampDropdownToViewport(wrapEl, panelEl) {
      if (!wrapEl || !panelEl) return;

      panelEl.style.left = "";
      panelEl.style.right = "";

      const rect = panelEl.getBoundingClientRect();

      const pad = 8;
      const vw = window.innerWidth || document.documentElement.clientWidth || 0;

      if (rect.left < pad) {
        panelEl.style.left = "0";
        panelEl.style.right = "auto";
      }

      const rect2 = panelEl.getBoundingClientRect();
      if (rect2.right > (vw - pad)) {
        panelEl.style.right = "0";
        panelEl.style.left = "auto";
      }
    }

    function setupDropdown({ btnId, panelId, wrapId, onChange }) {
      const btn = document.getElementById(btnId);
      const panel = document.getElementById(panelId);
      const wrap = document.getElementById(wrapId);
      if (!btn || !panel || !wrap) return;

      btn.addEventListener("click", (e) => {
        e.stopPropagation();

        const aberto = panel.style.display === "block";
        panel.style.display = aberto ? "none" : "block";
        btn.setAttribute("aria-expanded", aberto ? "false" : "true");

        if (!aberto) {
          requestAnimationFrame(() => clampDropdownToViewport(wrap, panel));
        }
      });

      document.addEventListener("click", (e) => {
        if (!wrap.contains(e.target)) {
          panel.style.display = "none";
          btn.setAttribute("aria-expanded", "false");
        }
      });

      panel.querySelectorAll(".item").forEach((row) => {
        row.addEventListener("click", (e) => {
          const input = row.querySelector('input[type="checkbox"]');
          const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : "";
          if (tag !== "INPUT" && tag !== "LABEL" && input) {
            input.checked = !input.checked;
            if (typeof onChange === "function") onChange();
          }
        });
      });
    }

    function setupFiltroTurno(){
      const ckManha = document.getElementById("ckManha");
      const ckTarde = document.getElementById("ckTarde");
      const ckMadrugada = document.getElementById("ckMadrugada");
      if (!ckManha || !ckTarde || !ckMadrugada) return;

      const onAnyChange = () => {
        atualizarTituloTurno();
        aplicarFiltros();
      };

      ckManha.addEventListener("change", onAnyChange);
      ckTarde.addEventListener("change", onAnyChange);
      ckMadrugada.addEventListener("change", onAnyChange);

      setupDropdown({
        btnId: "btnTurno",
        panelId: "turnoPanel",
        wrapId: "turnoWrap",
        onChange: onAnyChange
      });

      atualizarTituloTurno();
    }

    function atualizarTituloTurno(){
      const btn = document.getElementById("btnTurno");
      const sel = obterTurnosSelecionados();
      if (!btn || !sel) return;

      const nomes = [];
      if (sel.MANHA) nomes.push("Manhã");
      if (sel.TARDE) nomes.push("Tarde");
      if (sel.MADRUGADA) nomes.push("Madrugada");

      let titulo = "Turnos";
      if (nomes.length === 0) titulo = "Nenhum";
      else if (nomes.length === 1) titulo = nomes[0];
      else titulo = "Turnos";

      btn.textContent = `${titulo} ▾`;
    }

    function setupFiltroGravidade(){
      const ckLeve = document.getElementById("ckLeve");
      const ckMedia = document.getElementById("ckMedia");
      const ckGrave = document.getElementById("ckGrave");
      if (!ckLeve || !ckMedia || !ckGrave) return;

      const onAnyChange = () => {
        atualizarTituloGravidade();
        aplicarFiltros();
      };

      ckLeve.addEventListener("change", onAnyChange);
      ckMedia.addEventListener("change", onAnyChange);
      ckGrave.addEventListener("change", onAnyChange);

      setupDropdown({
        btnId: "btnGravidade",
        panelId: "gravidadePanel",
        wrapId: "gravidadeWrap",
        onChange: onAnyChange
      });

      atualizarTituloGravidade();
    }

    function atualizarTituloGravidade(){
      const btn = document.getElementById("btnGravidade");
      const sel = obterGravidadesSelecionadas();
      if (!btn || !sel) return;

      const nomes = [];
      if (sel.LEVE) nomes.push("Leve");
      if (sel.MEDIA) nomes.push("Média");
      if (sel.GRAVE) nomes.push("Grave");

      let titulo = "Gravidade";
      if (nomes.length === 0) titulo = "Nenhuma";
      else if (nomes.length === 1) titulo = nomes[0];
      else titulo = "Gravidade";

      btn.textContent = `${titulo} ▾`;
    }

    function setupFiltroAbordagem(){
      const ckReativa = document.getElementById("ckReativa");
      const ckPreventiva = document.getElementById("ckPreventiva");
      if (!ckReativa || !ckPreventiva) return;

      const onAnyChange = () => {
        atualizarTituloAbordagem();
        aplicarFiltros();
      };

      ckReativa.addEventListener("change", onAnyChange);
      ckPreventiva.addEventListener("change", onAnyChange);

      setupDropdown({
        btnId: "btnAbordagem",
        panelId: "abordagemPanel",
        wrapId: "abordagemWrap",
        onChange: onAnyChange
      });

      atualizarTituloAbordagem();
    }

    function obterAbordagensSelecionadas(){
      const ckReativa = document.getElementById("ckReativa");
      const ckPreventiva = document.getElementById("ckPreventiva");

      if (!ckReativa || !ckPreventiva) {
        return { REATIVA: true, PREVENTIVA: true };
      }

      return {
        REATIVA: !!ckReativa.checked,
        PREVENTIVA: !!ckPreventiva.checked
      };
    }

    function atualizarTituloAbordagem(){
      const btn = document.getElementById("btnAbordagem");
      const sel = obterAbordagensSelecionadas();
      if (!btn || !sel) return;

      const nomes = [];
      if (sel.REATIVA) nomes.push("Reativa");
      if (sel.PREVENTIVA) nomes.push("Preventiva");

      let titulo = "Tipo de abordagem";
      if (nomes.length === 0) titulo = "Nenhuma";
      else if (nomes.length === 1) titulo = nomes[0];
      else titulo = "Tipo de abordagem";

      btn.textContent = `${titulo} ▾`;
    }

    function tipoAbordagemNorm(r){
      const raw =
        (r && (r.tipoAbordagem || r.tipo_abordagem || r.TIPO_ABORDAGEM || r["TIPO_ABORDAGEM"])) || "";
      return String(raw || "").trim().toUpperCase();
    }

    function abordagemPassaFiltro(tipoNorm, sel){
      if (!sel) return true;

      const re = !!sel.REATIVA;
      const pr = !!sel.PREVENTIVA;

      if (!re && !pr) return false;

      if (tipoNorm === "REATIVA") return re;
      if (tipoNorm === "PREVENTIVA") return pr;

      return false;
    }

    function setupFiltroLojas(){
      LOJAS_SELECIONADAS = new Set(LOJAS_LISTA.map(x => normLoja(x.label)));

      rebuildListaLojasComBandeira();

      setupDropdown({
        btnId: "btnLoja",
        panelId: "lojaPanel",
        wrapId: "lojaWrap",
        onChange: () => {
          sincronizarSelecaoLojasDoDOM();
          atualizarChecksBandeira();
          atualizarTituloLojas();
          aplicarFiltros();
        }
      });

      atualizarTituloLojas();
    }

    function rebuildListaLojasComBandeira(){
      const panel = document.getElementById("lojaPanel");
      if (!panel) return;

      const big = LOJAS_LISTA.filter(x => x.bandeira === "BIG");
      const ult = LOJAS_LISTA.filter(x => x.bandeira === "ULT");

      const html = [];

      html.push(`
        <div class="item" style="border-bottom: 1px solid #eee;">
          <input type="checkbox" id="ckBand_BIG" data-band="BIG" />
          <label class="lbl" for="ckBand_BIG">BIG</label>
        </div>
        <div class="item" style="border-bottom: 1px solid #eee;">
          <input type="checkbox" id="ckBand_ULT" data-band="ULT" />
          <label class="lbl" for="ckBand_ULT">ULT</label>
        </div>
      `);

      html.push(`<div class="hint" style="margin-top:6px; margin-bottom:6px;">Selecione BIG/ULT para marcar/desmarcar todas as lojas da bandeira.</div>`);

      html.push(`<div class="hint" style="margin-top:6px; font-weight:800;">Lojas BIG</div>`);
      big.forEach((loja, idx) => {
        const id = `ckLoja_BIG_${idx}`;
        const key = normLoja(loja.label);
        const checked = LOJAS_SELECIONADAS.has(key) ? "checked" : "";
        html.push(`
          <div class="item">
            <input type="checkbox" id="${id}" data-loja="${key}" data-band="BIG" ${checked} />
            <label class="lbl" for="${id}">${loja.label}</label>
          </div>
        `);
      });

      html.push(`<div class="hint" style="margin-top:10px; font-weight:800;">Lojas ULT</div>`);
      ult.forEach((loja, idx) => {
        const id = `ckLoja_ULT_${idx}`;
        const key = normLoja(loja.label);
        const checked = LOJAS_SELECIONADAS.has(key) ? "checked" : "";
        html.push(`
          <div class="item">
            <input type="checkbox" id="${id}" data-loja="${key}" data-band="ULT" ${checked} />
            <label class="lbl" for="${id}">${loja.label}</label>
          </div>
        `);
      });

      html.push(`<div class="hint"></div>`);

      panel.innerHTML = html.join("");

      panel.querySelectorAll('input[type="checkbox"][data-loja]').forEach((ck) => {
        ck.addEventListener("change", () => {
          const key = ck.getAttribute("data-loja");
          if (!key) return;

          if (ck.checked) LOJAS_SELECIONADAS.add(key);
          else LOJAS_SELECIONADAS.delete(key);

          atualizarChecksBandeira();
          atualizarTituloLojas();
          aplicarFiltros();
        });
      });

      panel.querySelectorAll('input[type="checkbox"][id^="ckBand_"]').forEach((ckBand) => {
        ckBand.addEventListener("change", () => {
          const band = (ckBand.getAttribute("data-band") || "").toUpperCase().trim();
          if (!band) return;

          panel.querySelectorAll(`input[type="checkbox"][data-loja][data-band="${band}"]`).forEach((ckLoja) => {
            ckLoja.checked = ckBand.checked;

            const key = ckLoja.getAttribute("data-loja");
            if (!key) return;

            if (ckLoja.checked) LOJAS_SELECIONADAS.add(key);
            else LOJAS_SELECIONADAS.delete(key);
          });

          atualizarChecksBandeira();
          atualizarTituloLojas();
          aplicarFiltros();
        });
      });

      atualizarChecksBandeira();
      atualizarTituloLojas();
    }

    function atualizarChecksBandeira(){
      const panel = document.getElementById("lojaPanel");
      if (!panel) return;

      ["BIG","ULT"].forEach((band) => {
        const ckBand = panel.querySelector(`#ckBand_${band}`);
        if (!ckBand) return;

        const lojasBand = Array.from(panel.querySelectorAll(`input[type="checkbox"][data-loja][data-band="${band}"]`));
        if (lojasBand.length === 0) {
          ckBand.checked = false;
          return;
        }

        const todasMarcadas = lojasBand.every(ck => ck.checked);
        ckBand.indeterminate = false;
        ckBand.checked = todasMarcadas;
      });
    }

    function sincronizarSelecaoLojasDoDOM(){
      const panel = document.getElementById("lojaPanel");
      if (!panel) return;
      const set = new Set();
      panel.querySelectorAll('input[type="checkbox"][data-loja]').forEach((ck) => {
        const key = ck.getAttribute("data-loja");
        if (key && ck.checked) set.add(key);
      });
      LOJAS_SELECIONADAS = set;
    }

    function atualizarTituloLojas(){
      const btn = document.getElementById("btnLoja");
      if (!btn) return;

      const sel = obterLojasSelecionadas();
      const qtd = sel.size;

      let titulo = "Lojas";
      if (qtd === 0) titulo = "Nenhuma";
      else if (qtd === 1) {
        const unica = [...sel][0];
        const m = unica.match(/^(BIG|ULT)\s*(\d{1,2})\b/);
        if (m) titulo = `${m[1]} ${String(parseInt(m[2],10)).padStart(2,"0")}`;
        else titulo = "1 loja";
      } else {
        titulo = "Lojas";
      }

      btn.textContent = `${titulo} ▾`;
    }

    function obterLojasSelecionadas(){
      if (!LOJAS_SELECIONADAS || !(LOJAS_SELECIONADAS instanceof Set)) {
        return new Set(LOJAS_LISTA.map(x => normLoja(x.label)));
      }
      return LOJAS_SELECIONADAS;
    }

    function chaveOcorrencia(r) {
      const documento = (r.documento || "").trim();
      if (!documento) return "";

      const usuario = (r.usuario || "").trim();
      const loja = (r.loja || "").trim();
      const dataStr = (r.dataHora || "").split(" ")[0] || "";
      return `${documento}||${usuario}||${loja}||${dataStr}`;
    }

    function bandeiraPorLoja(lojaStr) {
      const s = String(lojaStr || "").trim().toUpperCase();
      const prefix = s.slice(0, 3);
      if (prefix === "BIG") return "BIG";
      if (prefix === "ULT") return "ULT";
      return "";
    }

    function abreviarLojaParaTop5(lojaStr) {
      const s = String(lojaStr || "").trim().toUpperCase();
      const m = s.match(/^(ULT|BIG)\s*(\d{1,2})\b/);
      if (m) {
        const sigla = m[1];
        const num = String(parseInt(m[2], 10)).padStart(2, "0");
        return `${sigla} ${num}`;
      }
      return s.length > 10 ? (s.slice(0, 10) + "…") : s;
    }

    function abreviarProduto(nome) {
      const s = String(nome || "").trim();
      if (!s) return "N/I";
      return s.length > 30 ? (s.slice(0, 30) + "…") : s;
    }

    function parseNumeroBr(valor) {
      if (valor === null || valor === undefined) return 0;
      let s = String(valor).trim();
      if (!s) return 0;
      s = s.replace(/\s+/g, "");
      s = s.replace(/\./g, "").replace(",", ".");
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    }

    function formatarBRL(n) {
      const v = Number(n) || 0;
      return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    function dataOcorridoParaISO(r) {
      const raw =
        (r && (r.dataOcorrido || r.data_ocorrido || r.DATA_OCORRIDO || r["DATA_OCORRIDO"])) || "";

      const s = String(raw || "").trim();
      if (!s) return "";

      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

      const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (m) {
        const dd = m[1], mm = m[2], yyyy = m[3];
        return `${yyyy}-${mm}-${dd}`;
      }
      return "";
    }

    function horaOcorridoParaMinutos(r) {
      const raw =
        (r && (r.horaOcorrido || r.hora_ocorrido || r.HORA_OCORRIDO || r["HORA_OCORRIDO"])) || "";

      const s = String(raw || "").trim();
      if (!s) return null;

      const m = s.match(/^(\d{2}):(\d{2})$/);
      if (!m) return null;

      const hh = parseInt(m[1], 10);
      const mi = parseInt(m[2], 10);

      if (!Number.isFinite(hh) || !Number.isFinite(mi)) return null;
      if (hh < 0 || hh > 23 || mi < 0 || mi > 59) return null;

      return (hh * 60) + mi;
    }

    function minutoDentroDeTurno(min, turno) {
      if (min === null || min === undefined) return false;

      if (turno === "MANHA") return (min >= 420 && min <= 840);
      if (turno === "TARDE") return (min >= 841 && min <= 1320);
      if (turno === "MADRUGADA") return ((min >= 1321 && min <= 1439) || (min >= 0 && min <= 419));

      return false;
    }

    function obterTurnosSelecionados() {
      const ckManha = document.getElementById("ckManha");
      const ckTarde = document.getElementById("ckTarde");
      const ckMadrugada = document.getElementById("ckMadrugada");

      if (!ckManha || !ckTarde || !ckMadrugada) {
        return { MANHA: true, TARDE: true, MADRUGADA: true };
      }

      return {
        MANHA: !!ckManha.checked,
        TARDE: !!ckTarde.checked,
        MADRUGADA: !!ckMadrugada.checked
      };
    }

    function obterGravidadesSelecionadas() {
      const ckLeve = document.getElementById("ckLeve");
      const ckMedia = document.getElementById("ckMedia");
      const ckGrave = document.getElementById("ckGrave");

      if (!ckLeve || !ckMedia || !ckGrave) {
        return { LEVE: true, MEDIA: true, GRAVE: true };
      }

      return {
        LEVE: !!ckLeve.checked,
        MEDIA: !!ckMedia.checked,
        GRAVE: !!ckGrave.checked
      };
    }

    function classificarGravidade(valorTotalOcorrencia){
      const v = Number(valorTotalOcorrencia) || 0;
      if (v >= 500) return "GRAVE";
      if (v < 100) return "LEVE";
      return "MEDIA";
    }

    function gravidadePassaFiltro(classif, gravSel){
      if (!gravSel) return true;
      if (classif === "LEVE") return !!gravSel.LEVE;
      if (classif === "MEDIA") return !!gravSel.MEDIA;
      if (classif === "GRAVE") return !!gravSel.GRAVE;
      return true;
    }

    function formatarCampoMoeda(inputEl, opts = {}) {
      const forceTwoDecimals = !!opts.forceTwoDecimals;
      if (!inputEl) return;

      const original = String(inputEl.value || "");
      const neg = original.includes("-");
      const digits = original.replace(/[^\d]/g, "");

      if (!digits) {
        inputEl.value = (neg ? "-" : "") + (forceTwoDecimals ? "0,00" : "");
        return;
      }

      const cents = parseInt(digits, 10);
      const valor = (isNaN(cents) ? 0 : cents) / 100;

      const formatado = valor.toLocaleString("pt-BR", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });

      inputEl.value = (neg ? "-" : "") + formatado;
    }

    function parseMoedaInput(valorStr) {
      let s = String(valorStr || "").trim();
      if (!s) return 0;

      const neg = s.includes("-");
      s = s.replace(/-/g, "");
      s = s.replace(/[R$\s]/g, "");

      const n = parseNumeroBr(s);
      return neg ? -Math.abs(n) : n;
    }

    function atualizarParticipacao() {
      const el = document.getElementById("pctParticipacao");
      const inp = document.getElementById("valorVenda");
      if (!el || !inp) return;

      const venda = parseMoedaInput(inp.value);
      const base = Number(totalValorOcorrenciasAtual) || 0;

      let pct = 0;
      if (venda !== 0) pct = (base * 100) / venda;

      const pctStr = (Number.isFinite(pct) ? pct : 0).toLocaleString("pt-BR", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });

      el.textContent = `Recup. x Rotativos: ${pctStr}%`;
    }

    async function carregar(forcarFetch = false) {
      const status = document.getElementById("status");
      const subInfo = document.getElementById("subInfo");

      try {
        if (CACHE_OK && Array.isArray(REGISTROS_CACHE) && !forcarFetch) {
          status.textContent = "Aplicando filtros (sem atualizar dados)...";
          aplicarFiltros();
          return;
        }

        status.textContent = "Carregando relatórios...";
        subInfo.textContent = "Carregando dados...";

        const resp = await fetch("/api/relatorios", {
          method: "GET",
          headers: { ...getAuthHeaders() },
          credentials: "include"
        });

        const dados = await resp.json().catch(() => ({}));

        if (!resp.ok || !dados.sucesso || !Array.isArray(dados.registros)) {
          status.textContent = (dados && dados.message) ? dados.message : "Falha ao carregar dados do dashboard.";
          subInfo.textContent = "Erro ao carregar.";
          return;
        }

        REGISTROS_CACHE = dados.registros;
        CACHE_OK = true;
        CACHE_ATUALIZADO_EM = new Date();

        status.textContent = "Dados atualizados. Aplicando filtros...";
        aplicarFiltros();

      } catch (e) {
        console.error("Erro no dashboard:", e);
        document.getElementById("status").textContent = "Erro de conexão ao montar o dashboard.";
        document.getElementById("subInfo").textContent = "Erro ao carregar.";
      }
    }

    function aplicarFiltros() {
      const status = document.getElementById("status");
      const subInfo = document.getElementById("subInfo");

      try {
        if (!CACHE_OK || !Array.isArray(REGISTROS_CACHE)) {
          status.textContent = "Dados ainda não carregados. Clique em Atualizar.";
          subInfo.textContent = "Aguardando dados...";
          return;
        }

        const registros = REGISTROS_CACHE;

        const dataInicio = (document.getElementById("dataInicio")?.value || "").trim();
        const dataFim = (document.getElementById("dataFim")?.value || "").trim();

        const turnosSel = obterTurnosSelecionados();
        const gravSel = obterGravidadesSelecionadas();
        const lojasSel = obterLojasSelecionadas();
        const abordagemSel = obterAbordagensSelecionadas();

        const registrosBase = registros.filter(r => {
          {
            const lojaKey = normLoja(r.loja);
            if (!lojasSel.has(lojaKey)) return false;
          }

          {
            const tipo = tipoAbordagemNorm(r);
            if (!abordagemPassaFiltro(tipo, abordagemSel)) return false;
          }

          if (dataInicio || dataFim) {
            const iso = dataOcorridoParaISO(r);
            if (!iso) return false;
            if (dataInicio && iso < dataInicio) return false;
            if (dataFim && iso > dataFim) return false;
          }

          {
            const min = horaOcorridoParaMinutos(r);
            if (min === null) return false;

            const okManha = turnosSel.MANHA && minutoDentroDeTurno(min, "MANHA");
            const okTarde = turnosSel.TARDE && minutoDentroDeTurno(min, "TARDE");
            const okMadr = turnosSel.MADRUGADA && minutoDentroDeTurno(min, "MADRUGADA");

            if (!(okManha || okTarde || okMadr)) return false;
          }

          return true;
        });

        const registrosBaseBandeira = registros.filter(r => {
          {
            const tipo = tipoAbordagemNorm(r);
            if (!abordagemPassaFiltro(tipo, abordagemSel)) return false;
          }

          if (dataInicio || dataFim) {
            const iso = dataOcorridoParaISO(r);
            if (!iso) return false;
            if (dataInicio && iso < dataInicio) return false;
            if (dataFim && iso > dataFim) return false;
          }

          {
            const min = horaOcorridoParaMinutos(r);
            if (min === null) return false;

            const okManha = turnosSel.MANHA && minutoDentroDeTurno(min, "MANHA");
            const okTarde = turnosSel.TARDE && minutoDentroDeTurno(min, "TARDE");
            const okMadr = turnosSel.MADRUGADA && minutoDentroDeTurno(min, "MADRUGADA");

            if (!(okManha || okTarde || okMadr)) return false;
          }

          return true;
        });

        const valorPorOcorrencia = new Map();
        for (const r of registrosBase) {
          const k = chaveOcorrencia(r);
          if (!k) continue;

          const qtd = parseNumeroBr(r.quantidade);
          const vUnit = parseNumeroBr(r.valorUnitario);
          const totalLinha = qtd * vUnit;

          valorPorOcorrencia.set(
            k,
            (valorPorOcorrencia.get(k) || 0) + (isNaN(totalLinha) ? 0 : totalLinha)
          );
        }

        const occAprovadas = new Set();
        for (const [k, vTot] of valorPorOcorrencia.entries()) {
          const classe = classificarGravidade(vTot);
          if (gravidadePassaFiltro(classe, gravSel)) occAprovadas.add(k);
        }

        const registrosFiltrados = registrosBase.filter(r => {
          const k = chaveOcorrencia(r);
          return k && occAprovadas.has(k);
        });

        const setOccFiltradoTotal = new Set();
        for (const r of registrosFiltrados) {
          const k = chaveOcorrencia(r);
          if (!k) continue;
          setOccFiltradoTotal.add(k);
        }

        document.getElementById("totalOcorrencias").textContent = String(setOccFiltradoTotal.size);

        let somaValorOcorrenciasFiltradas = 0;
        for (const k of setOccFiltradoTotal.values()) {
          somaValorOcorrenciasFiltradas += (Number(valorPorOcorrencia.get(k)) || 0);
        }

        document.getElementById("totalValorOcorrencias").textContent = formatarBRL(somaValorOcorrenciasFiltradas);
        totalValorOcorrenciasAtual = somaValorOcorrenciasFiltradas;
        atualizarParticipacao();

        const valorPorOcorrenciaBandeira = new Map();
        for (const r of registrosBaseBandeira) {
          const k = chaveOcorrencia(r);
          if (!k) continue;

          const qtd = parseNumeroBr(r.quantidade);
          const vUnit = parseNumeroBr(r.valorUnitario);
          const totalLinha = qtd * vUnit;

          valorPorOcorrenciaBandeira.set(
            k,
            (valorPorOcorrenciaBandeira.get(k) || 0) + (isNaN(totalLinha) ? 0 : totalLinha)
          );
        }

        const occAprovadasBandeira = new Set();
        for (const [k, vTot] of valorPorOcorrenciaBandeira.entries()) {
          const classe = classificarGravidade(vTot);
          if (gravidadePassaFiltro(classe, gravSel)) occAprovadasBandeira.add(k);
        }

        const occPorBandeiraFiltrada = { BIG: 0, ULT: 0 };
        const valorPorBandeiraFiltrada = { BIG: 0, ULT: 0 };

        const setOccBandeira = new Set();
        for (const r of registrosBaseBandeira) {
          const k = chaveOcorrencia(r);
          if (!k) continue;

          if (!occAprovadasBandeira.has(k)) continue;

          if (setOccBandeira.has(k)) continue;
          setOccBandeira.add(k);

          const band = bandeiraPorLoja((r.loja || "").trim());
          if (band) {
            occPorBandeiraFiltrada[band] = (occPorBandeiraFiltrada[band] || 0) + 1;
            valorPorBandeiraFiltrada[band] =
              (valorPorBandeiraFiltrada[band] || 0) + (Number(valorPorOcorrenciaBandeira.get(k)) || 0);
          }
        }

        document.getElementById("bandeiraBIG").textContent = String(occPorBandeiraFiltrada.BIG || 0);
        document.getElementById("bandeiraULT").textContent = String(occPorBandeiraFiltrada.ULT || 0);

        document.getElementById("valorBIG").textContent = formatarBRL(valorPorBandeiraFiltrada.BIG || 0);
        document.getElementById("valorULT").textContent = formatarBRL(valorPorBandeiraFiltrada.ULT || 0);

        renderPctBandeira(occPorBandeiraFiltrada.BIG || 0, occPorBandeiraFiltrada.ULT || 0);

        let qtdLeve = 0, qtdMedia = 0, qtdGrave = 0;

        for (const k of setOccFiltradoTotal.values()) {
          const vTot = Number(valorPorOcorrencia.get(k)) || 0;
          const classe = classificarGravidade(vTot);
          if (classe === "LEVE") qtdLeve++;
          else if (classe === "MEDIA") qtdMedia++;
          else if (classe === "GRAVE") qtdGrave++;
        }

        renderGravidade(qtdLeve, qtdMedia, qtdGrave);

        const occPorLoja = new Map();
        const setOccFiltrado = new Set();

        for (const r of registrosFiltrados) {
          const k = chaveOcorrencia(r);
          if (!k || setOccFiltrado.has(k)) continue;
          setOccFiltrado.add(k);

          const loja = (r.loja || "").trim() || "SEM LOJA";
          occPorLoja.set(loja, (occPorLoja.get(loja) || 0) + 1);
        }

        const top = Array.from(occPorLoja.entries()).sort((a,b) => b[1] - a[1]).slice(0, 5);
        const topLabels = top.map(([loja]) => abreviarLojaParaTop5(loja));
        const topValues = top.map(([,qtd]) => qtd);

        const deptPorOcorrencia = new Map();
        for (const r of registrosFiltrados) {
          const k = chaveOcorrencia(r);
          if (!k) continue;
          const dep = (r.departamento || "N/I").toString().trim().toUpperCase() || "N/I";
          if (!deptPorOcorrencia.has(k)) deptPorOcorrencia.set(k, new Set());
          deptPorOcorrencia.get(k).add(dep);
        }

        const occPorDept = new Map();
        for (const [, setDeps] of deptPorOcorrencia.entries()) {
          for (const dep of setDeps.values()) occPorDept.set(dep, (occPorDept.get(dep) || 0) + 1);
        }

        const deptOrdenado = Array.from(occPorDept.entries()).sort((a,b) => b[1] - a[1]).slice(0, 12);
        const deptLabels = deptOrdenado.map(([d]) => d);
        const deptValues = deptOrdenado.map(([,q]) => q);

        const registrosPorProduto = new Map();
        for (const r of registrosFiltrados) {
          const prod = (r.produto || "N/I").toString().trim() || "N/I";
          registrosPorProduto.set(prod, (registrosPorProduto.get(prod) || 0) + 1);
        }

        const topProd = Array.from(registrosPorProduto.entries()).sort((a,b) => b[1] - a[1]).slice(0, 15);
        const prodLabels = topProd.map(([p]) => abreviarProduto(p));
        const prodValues = topProd.map(([,q]) => q);

        const COR_DEPT_PADRAO = "#A98AE8";
        const COR_ULT = "#43A047";

        const selArr = [...lojasSel.values()];
        const hasBIG = selArr.some(x => String(x).startsWith("BIG"));
        const hasULT = selArr.some(x => String(x).startsWith("ULT"));
        const corDeptTopProd = (hasULT && !hasBIG) ? COR_ULT : COR_DEPT_PADRAO;

        renderTopLojas(topLabels, topValues);
        renderDept(deptLabels, deptValues, corDeptTopProd);
        renderTopProdutos(prodLabels, prodValues, corDeptTopProd);

        subInfo.textContent =
          `${registrosFiltrados.length.toLocaleString("pt-BR")} registros | ` +
          `${setOccFiltrado.size.toLocaleString("pt-BR")} ocorrências`;

        status.textContent = CACHE_ATUALIZADO_EM
          ? `Filtros aplicados (dados carregados em: ${CACHE_ATUALIZADO_EM.toLocaleString("pt-BR")}).`
          : "Filtros aplicados.";
      } catch (e) {
        console.error("Erro ao aplicar filtros:", e);
        document.getElementById("status").textContent = "Erro ao aplicar filtros.";
        document.getElementById("subInfo").textContent = "Erro ao montar.";
      }
    }

    function renderTopLojas(labels, values) {
      const ctx = document.getElementById("chartTopLojas");
      if (chartTopLojas) chartTopLojas.destroy();

      const valueOnTopPlugin = {
        id: "valueOnTopPlugin",
        afterDatasetsDraw(chart) {
          const { ctx } = chart;
          const meta = chart.getDatasetMeta(0);
          if (!meta || !meta.data) return;

          ctx.save();
          ctx.textAlign = "center";
          ctx.textBaseline = "bottom";
          ctx.font = "bold 12px Arial";
          ctx.fillStyle = "#111";

          meta.data.forEach((bar, i) => {
            const val = chart.data.datasets[0].data[i];
            ctx.fillText(String(val), bar.x, bar.y - 6);
          });

          ctx.restore();
        }
      };

      const corBIG = "#6A1B9A";
      const corULT = "#43A047";

      const bgColors = labels.map((lbl) => {
        const s = String(lbl || "").toUpperCase().trim();
        if (s.startsWith("BIG")) return corBIG;
        if (s.startsWith("ULT")) return corULT;
        return "#777";
      });

      const maxVal = Math.max(0, ...(values || []).map(v => Number(v) || 0));
      const suggestedMax = maxVal > 0 ? Math.ceil(maxVal * 1.2) : 1;

      chartTopLojas = new Chart(ctx, {
        type: "bar",
        data: { labels, datasets: [{ label: "Ocorrências", data: values, backgroundColor: bgColors }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { callbacks: { label: (item) => `Ocorrências: ${item.raw}` } } },
          scales: {
            x: { ticks: { maxRotation: 0, minRotation: 0, autoSkip: false }, grid: { display: false }, border: { display: false } },
            y: { beginAtZero: true, suggestedMax, ticks: { display: false }, grid: { display: false }, border: { display: false } }
          }
        },
        plugins: [valueOnTopPlugin]
      });
    }

    function renderDept(labels, values, corBarra) {
      const ctx = document.getElementById("chartDept");
      if (chartDept) chartDept.destroy();

      const valueAtEndPlugin = {
        id: "valueAtEndPlugin",
        afterDatasetsDraw(chart) {
          const { ctx } = chart;
          const meta = chart.getDatasetMeta(0);
          if (!meta || !meta.data) return;

          ctx.save();
          ctx.textAlign = "left";
          ctx.textBaseline = "middle";
          ctx.font = "bold 12px Arial";
          ctx.fillStyle = "#111";

          meta.data.forEach((bar, i) => {
            const val = chart.data.datasets[0].data[i];
            const xRaw = bar.x + 8;
            const x = Math.min(xRaw, chart.width - 8);
            ctx.fillText(String(val), x, bar.y);
          });

          ctx.restore();
        }
      };

      chartDept = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Ocorrências por departamento",
            data: values,
            backgroundColor: corBarra || "#A98AE8",
            clip: false
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { right: 46 } },
          plugins: { legend: { display: false }, tooltip: { callbacks: { label: (item) => `Ocorrências: ${item.raw}` } } },
          scales: {
            x: { beginAtZero: true, ticks: { display: false }, grid: { display: false }, border: { display: false } },
            y: { ticks: { autoSkip: false }, grid: { display: false }, border: { display: false } }
          }
        },
        plugins: [valueAtEndPlugin]
      });
    }

    function renderPctBandeira(qtdBIG, qtdULT) {
      const ctx = document.getElementById("chartPctBandeira");
      if (chartPctBandeira) chartPctBandeira.destroy();

      const pctLabelPlugin = {
        id: "pctLabelPlugin",
        afterDatasetsDraw(chart) {
          const { ctx } = chart;
          const meta = chart.getDatasetMeta(0);
          if (!meta || !meta.data) return;

          const vis = [ chart.getDataVisibility(0), chart.getDataVisibility(1) ];
          const dataArr = chart.data.datasets[0].data || [];
          const totalVis = dataArr.reduce((acc, v, i) => acc + (vis[i] ? (Number(v) || 0) : 0), 0);
          if (!(totalVis > 0)) return;

          ctx.save();
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.font = "bold 13px Arial";
          ctx.fillStyle = "#111";

          meta.data.forEach((arc, i) => {
            if (!vis[i]) return;

            const val = Number(dataArr[i] || 0);
            if (!(val > 0)) return;

            const pct = (val * 100 / totalVis);
            const pos = arc.tooltipPosition();
            ctx.fillText(`${pct.toFixed(1)}%`, pos.x, pos.y);
          });

          ctx.restore();
        }
      };

      chartPctBandeira = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["BIG", "ULT"],
          datasets: [{
            data: [qtdBIG || 0, qtdULT || 0],
            backgroundColor: ["#A98AE8", "#43A047"]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "62%",
          plugins: {
            legend: { display: true, position: "bottom" },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.raw || 0;

                  const chart = ctx.chart;
                  const vis = [ chart.getDataVisibility(0), chart.getDataVisibility(1) ];
                  const dataArr = chart.data.datasets[0].data || [];
                  const totalVis = dataArr.reduce((acc, x, i) => acc + (vis[i] ? (Number(x) || 0) : 0), 0);

                  const pct = totalVis > 0 ? (Number(v) * 100 / totalVis) : 0;
                  return `${ctx.label}: ${v} (${pct.toFixed(1)}%)`;
                }
              }
            }
          }
        },
        plugins: [pctLabelPlugin]
      });
    }

    function renderTopProdutos(labels, values, corBarra) {
      const ctx = document.getElementById("chartTopProdutos");
      if (chartTopProdutos) chartTopProdutos.destroy();

      const isMobile = window.matchMedia("(max-width: 640px)").matches;

      const maxChars = isMobile ? 18 : 30;
      const labelsAdj = (labels || []).map((t) => {
        const s = String(t || "").trim();
        if (!s) return "N/I";
        return s.length > maxChars ? (s.slice(0, maxChars) + "…") : s;
      });

      const valueOutsidePlugin = {
        id: "valueOutsidePluginProdutos",
        afterDatasetsDraw(chart) {
          const { ctx } = chart;
          const meta = chart.getDatasetMeta(0);
          if (!meta || !meta.data) return;

          ctx.save();
          ctx.textAlign = "left";
          ctx.textBaseline = "middle";
          ctx.font = "bold 12px Arial";
          ctx.fillStyle = "#111";

          meta.data.forEach((bar, i) => {
            const val = chart.data.datasets[0].data[i];
            const xRaw = bar.x + 8;
            const x = Math.min(xRaw, chart.width - 8);
            ctx.fillText(String(val), x, bar.y);
          });

          ctx.restore();
        }
      };

      chartTopProdutos = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labelsAdj,
          datasets: [{
            label: "Registros",
            data: values,
            backgroundColor: corBarra || "#A98AE8",
            clip: false
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { left: 16, right: 46 } },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (item) => `Registros: ${item.raw}` } }
          },
          scales: {
            x: { beginAtZero: true, ticks: { display: false }, grid: { display: false }, border: { display: false } },
            y: {
              ticks: {
                autoSkip: false,
                font: { size: isMobile ? 10 : 11 },
                padding: 6,
                align: "start",
                crossAlign: "near"
              },
              afterFit: (scale) => {
                const minW = isMobile ? 140 : 170;
                const maxW = isMobile ? 180 : 240;
                scale.width = Math.max(minW, Math.min(scale.width, maxW));
              },
              grid: { display: false },
              border: { display: false }
            }
          }
        },
        plugins: [valueOutsidePlugin]
      });
    }

    function renderGravidade(qtdLeve, qtdMedia, qtdGrave) {
      const ctx = document.getElementById("chartGravidade");
      if (chartGravidade) chartGravidade.destroy();

      const pctLabelPlugin = {
        id: "pctLabelPluginGravidade",
        afterDatasetsDraw(chart) {
          const { ctx } = chart;
          const meta = chart.getDatasetMeta(0);
          if (!meta || !meta.data) return;

          const vis = [
            chart.getDataVisibility(0),
            chart.getDataVisibility(1),
            chart.getDataVisibility(2)
          ];

          const dataArr = chart.data.datasets[0].data || [];
          const totalVis = dataArr.reduce((acc, v, i) => acc + (vis[i] ? (Number(v) || 0) : 0), 0);
          if (!(totalVis > 0)) return;

          ctx.save();
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.font = "bold 12px Arial";
          ctx.fillStyle = "#fff";

          /* ✅ AJUSTE 2: anti-sobreposição de rótulos no pie (Gravidade)
             - fatias pequenas sobem um pouco
             - demais descem um pouco
             - aplica espaçamento mínimo vertical para evitar cobertura
          */
          const area = chart.chartArea || { top: 0, bottom: chart.height, left: 0, right: chart.width };
          const minGap = 14;

          const labelsPos = [];

          meta.data.forEach((arc, i) => {
            if (!vis[i]) return;

            const val = Number(dataArr[i] || 0);
            if (!(val > 0)) return;

            const pct = (val * 100 / totalVis);

            const startA = Number(arc.startAngle || 0);
            const endA = Number(arc.endAngle || 0);
            const midA = (startA + endA) / 2;
            const span = Math.abs(endA - startA);

            const isSmall = (span < 0.35) || (pct < 6); // ~20° ou <6% (heurística)

            const outer = Number(arc.outerRadius || 0);
            const r = outer * (isSmall ? 0.92 : 0.62);

            let x = (Number(arc.x || 0) + Math.cos(midA) * r);
            let y = (Number(arc.y || 0) + Math.sin(midA) * r);

            y += isSmall ? -12 : 6;

            labelsPos.push({
              i,
              x,
              y,
              text: `${pct.toFixed(1)}%`
            });
          });

          labelsPos.sort((a, b) => a.y - b.y);

          for (let k = 1; k < labelsPos.length; k++) {
            if ((labelsPos[k].y - labelsPos[k - 1].y) < minGap) {
              labelsPos[k].y = labelsPos[k - 1].y + minGap;
            }
          }

          labelsPos.forEach((p) => {
            const xClamped = Math.max(area.left + 10, Math.min(p.x, area.right - 10));
            const yClamped = Math.max(area.top + 10, Math.min(p.y, area.bottom - 10));
            ctx.fillText(p.text, xClamped, yClamped);
          });

          ctx.restore();
        }
      };

      chartGravidade = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Leve", "Média", "Grave"],
          datasets: [{
            data: [qtdLeve || 0, qtdMedia || 0, qtdGrave || 0],
            backgroundColor: ["#1E88E5", "#6A5ACD", "#FF2DA1"],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: "bottom" },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const chart = ctx.chart;
                  const dataArr = chart.data.datasets[0].data || [];
                  const vis = [
                    chart.getDataVisibility(0),
                    chart.getDataVisibility(1),
                    chart.getDataVisibility(2)
                  ];
                  const totalVis = dataArr.reduce((acc, v, i) => acc + (vis[i] ? (Number(v) || 0) : 0), 0);

                  const v = Number(ctx.raw || 0);
                  const pct = totalVis > 0 ? (v * 100 / totalVis) : 0;
                  return `${ctx.label}: ${v} (${pct.toFixed(1)}%)`;
                }
              }
            }
          }
        },
        plugins: [pctLabelPlugin]
      });
    }
  </script>
</body>
</html>

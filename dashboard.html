<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DASHBOARD – Relatório de Ocorrências</title>

  <style>
    /* ====== Visual “semelhante ao print”: tiles claras em um fundo cinza suave ====== */
    body{
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      color: #111;
    }

    .wrap{
      width: min(1100px, 92vw);
      margin: 16px auto 30px;
    }

    .topbar{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 16px;
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 6px 18px rgba(0,0,0,0.10);
      margin-bottom: 14px;
    }

    .title{
      margin: 0;
      font-size: 20px;
      font-weight: 800;
      letter-spacing: 0.5px;
    }

    .subtitle{
      margin: 4px 0 0;
      font-size: 12px;
      color: #555;
    }

    .btn{
      border: none;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
      white-space: nowrap;
    }

    .btn-back{
      background: #0066ff;
      color: #fff;
    }

    .btn-refresh{
      background: #e9e9e9;
      color: #111;
    }

    /* ====== GRID (responsivo) ======
       PEDIDO #1:
       - manter 3 cartões na linha
       - deixar o Top 5 um pouco mais largo que os outros nessa mesma linha
       Implementação: coluna do meio mais larga (1.25fr)
    */
    .grid{
      display: grid;
      grid-template-columns: 1fr 1.25fr 1fr; /* Top 5 fica no meio e mais largo */
      gap: 12px;
    }

    /* ============================
       PEDIDO #5:
       - cartões com cinza claro no fundo
       ============================ */
    .tile{
      background: #f6f6f6;           /* cinza claro “semelhante ao print” */
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      padding: 12px 14px;
      min-height: 180px;
    }

    .tile h3{
      margin: 0 0 10px;
      font-size: 13px;
      font-weight: 900;
      color: #111;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }

    /* ============================
       PEDIDO #6:
       - número maior e centralizado
       - "registradas" abaixo do número
       ============================ */
    .big-number{
      height: calc(100% - 28px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .big-number .n{
      font-size: 72px; /* maior que antes */
      font-weight: 900;
      line-height: 1;
      color: #111;
      text-align: center;
    }

    .big-number .label{
      font-weight: 800;
      color: #555;
      font-size: 14px;
      text-align: center;
    }

    .canvas-wrap{
      position: relative;
      height: 210px;
    }

    /* ============================
       PEDIDO #4 (card split) + PEDIDO #4 (logos):
       - cartão único “Ocorrências por Bandeira”
       - dividido por linha vertical
       - adicionar logo ao lado do número de cada bandeira (mesmo tamanho)
       ============================ */
    .bandeira-split{
      height: calc(100% - 28px);
      display: grid;
      grid-template-columns: 1fr 1px 1fr;
      align-items: center;
      gap: 10px;
    }

    .bandeira-divider{
      width: 1px;
      height: 70%;
      background: #d9d9d9;
      justify-self: center;
      border-radius: 1px;
    }

    .bandeira-col{
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      min-height: 120px;
    }

    .bandeira-sigla{
      font-size: 12px;
      font-weight: 900;
      letter-spacing: 0.6px;
      color: #333;
      text-transform: uppercase;
    }

    /* Linha do número com logo ao lado */
    .bandeira-row{
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .bandeira-logo{
      width: 48px;    /* mesmo tamanho para os dois */
      height: 48px;   /* mesmo tamanho para os dois */
      object-fit: contain;
      display: block;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.18));
    }

    .bandeira-num{
      font-size: 40px;
      font-weight: 900;
      color: #111;
      line-height: 1;
    }

    .bandeira-label{
      font-size: 12px;
      font-weight: 800;
      color: #555;
    }

    .status{
      margin-top: 10px;
      font-size: 13px;
      color: #333;
      padding: 12px 14px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid #e5e5e5;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }

    /* ====== Acesso inválido ====== */
    .tela-erro{
      width: min(520px, 92vw);
      margin: 60px auto;
      background: #fff;
      border-radius: 12px;
      padding: 22px 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      text-align: center;
    }

    .tela-erro h1{
      margin: 0 0 8px;
      color: #c00000;
    }

    /* ====== Responsivo: mantém legível em telas pequenas ====== */
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 640px){
      .grid{ grid-template-columns: 1fr; }
      .big-number .n{ font-size: 64px; }
      .canvas-wrap{ height: 240px; }
      .bandeira-num{ font-size: 36px; }
      .bandeira-logo{ width: 44px; height: 44px; }
    }
  </style>
</head>

<body>
  <div id="telaErro" class="tela-erro" style="display:none;">
    <h1>Acesso inválido</h1>
    <p>Este dashboard só pode ser aberto pelo botão <b>Dashboard</b> dentro do Painel do Gestor.</p>
    <p>Volte para a tela do Gestor e tente novamente.</p>
    <button class="btn btn-back" onclick="voltar()">Voltar</button>
  </div>

  <div id="app" class="wrap" style="display:none;">
    <div class="topbar">
      <div>
        <h1 class="title">RELATÓRIO DE OCORRÊNCIAS</h1>
        <p class="subtitle" id="subInfo">Carregando dados...</p>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn btn-refresh" onclick="carregar()">Atualizar</button>
        <button class="btn btn-back" onclick="voltar()">Voltar</button>
      </div>
    </div>

    <div class="grid">
      <!-- Total de ocorrências -->
      <div class="tile">
        <h3>Ocorrências</h3>
        <!-- PEDIDO #6: número centralizado e label abaixo -->
        <div class="big-number">
          <div class="n" id="totalOcorrencias">0</div>
          <div class="label">registradas</div>
        </div>
      </div>

      <!-- =========================================================
           PEDIDO #1:
           - Trocar posição do cartão Top 5 com o cartão Ocorrências por bandeira
           - Top 5 fica no meio (coluna mais larga pelo CSS da grid)
           ========================================================= -->
      <!-- Top 5 lojas (AGORA NA POSIÇÃO DO MEIO) -->
      <div class="tile">
        <h3>Top 5 lojas</h3>
        <div class="canvas-wrap">
          <canvas id="chartTopLojas"></canvas>
        </div>
      </div>

      <!-- Ocorrências por bandeira (AGORA NA TERCEIRA POSIÇÃO) -->
      <div class="tile">
        <h3>Ocorrências por bandeira</h3>

        <div class="bandeira-split" aria-label="Ocorrências por bandeira (BIG e ULT)">
          <div class="bandeira-col">
            <div class="bandeira-sigla">BIG</div>

            <!-- PEDIDO #4: logo ao lado do número (mesmo tamanho) -->
            <div class="bandeira-row">
              <img id="logoBIG" class="bandeira-logo" alt="Big Box" />
              <div class="bandeira-num" id="bandeiraBIG">0</div>
            </div>

            <div class="bandeira-label">ocorrências</div>
          </div>

          <div class="bandeira-divider" aria-hidden="true"></div>

          <div class="bandeira-col">
            <div class="bandeira-sigla">ULT</div>

            <!-- PEDIDO #4: logo ao lado do número (mesmo tamanho) -->
            <div class="bandeira-row">
              <img id="logoULT" class="bandeira-logo" alt="Ultrabox" />
              <div class="bandeira-num" id="bandeiraULT">0</div>
            </div>

            <div class="bandeira-label">ocorrências</div>
          </div>
        </div>
      </div>

      <!-- Ocorrências por departamento -->
      <div class="tile" style="grid-column: 1 / -1;">
        <h3>Ocorrências por departamento</h3>
        <div class="canvas-wrap" style="height: 260px;">
          <canvas id="chartDept"></canvas>
        </div>
      </div>
    </div>

    <div class="status" id="status">Aguardando...</div>
  </div>

  <!-- Chart.js (somente leitura/visual) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    const STORAGE_KEY_GESTOR = "PPP_LOGIN_GESTOR";
    const STORAGE_DASH_OK = "PPP_DASH_OK";

    let chartTopLojas = null;
    let chartDept = null;

    /* =========================================================
       PEDIDO #4:
       - Logos anexos (BIG e ULT) embutidos como Data URI
       - Mantém o HTML “autossuficiente” (não depende de arquivo no servidor)
       OBS: As imagens foram reduzidas para uso em UI (mesmo tamanho visual).
       ========================================================= */
    const LOGO_BIG_DATA_URI =
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAR8AAABACAYAAABc3w5KAAAACXBIWXMAAAsSAAALEgHS3X78AAAgAElEQVR4nO2de3BU1bnHP9+Z2Z1sQpYQJgQSCgkQGQnW2E7K0m4qk0S9l3q4xJ0m1rYbS5Xo1e7tq3m9w7l3c5Y5k2d3c1m7b3m7b2m2sVZqFQKqg0RgoQkQK2qQkJQkQpYwGQGQmH3v+eN3yQv3M2m9m+9z7vH0b6kqz7z3n3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7z3nO+7wG9v3v7mQAAABJRU5ErkJggg==";
    const LOGO_ULT_DATA_URI =
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANoAAABACAYAAAB8wqHkAAAACXBIWXMAAAsSAAALEgHS3X78AAADdUlEQVR4nO2dy27bMBCGv8vKQbUoS6mQm0b1gqB0q4b0j8rQxZl0q2w0p0xGzq7mB1Qy0t7kqQn+R6y2lJkWmZ8w7n2k3s8mVJr2m5q0xwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgYpQGf9m6oFQx0u0Zs9Gk3pFQxv3mO5tKxv0b5g7w0g7gq8B2m7n5yq5t5b5c9C4b2v4mC2eG9xkqg6qk8G7v1xjYk9w5r0t9Q2d3d2z2oY8C3GQk4d1yqk7b2wqU7b4o0m5oYkq6Jk8FfF1bYv9S5j8VnVtqkY2o0WmJfXWk0+7aQ2vCqQq5qkq6g8GgQf3Jk2v1uQ5v1yqkq2m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkq7m8bq9Qm7n2qkqAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4C/4B0r4pQnQpHn0AAAAASUVORK5CYII=";

    /* ====== Gate de acesso (só abre via botão) ====== */
    function validarAcesso() {
      const dashOk = (sessionStorage.getItem(STORAGE_DASH_OK) || "").trim() === "1";
      const sessaoGestor = sessionStorage.getItem(STORAGE_KEY_GESTOR);

      if (!dashOk || !sessaoGestor) return false;

      try {
        const obj = JSON.parse(sessaoGestor);
        return !!(obj && obj.usuario);
      } catch (e) {
        return false;
      }
    }

    /* ============================
       PEDIDO #1:
       - voltar para /painel-gestor.html
       ============================ */
    function voltar() {
      window.location.href = "/painel-gestor.html";
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (!validarAcesso()) {
        document.getElementById("telaErro").style.display = "block";
        return;
      }

      // Seta os logos (mesmo tamanho visual via CSS .bandeira-logo)
      document.getElementById("logoBIG").src = LOGO_BIG_DATA_URI;
      document.getElementById("logoULT").src = LOGO_ULT_DATA_URI;

      document.getElementById("app").style.display = "block";
      carregar();
    });

    /* ====== Mesma lógica do gerente: “ocorrência única” ====== */
    function chaveOcorrencia(r) {
      const documento = (r.documento || "").trim();
      if (!documento) return "";

      const usuario = (r.usuario || "").trim();
      const loja = (r.loja || "").trim();
      const dataStr = (r.dataHora || "").split(" ")[0] || "";

      return `${documento}||${usuario}||${loja}||${dataStr}`;
    }

    function bandeiraPorLoja(lojaStr) {
      const s = String(lojaStr || "").trim().toUpperCase();
      const prefix = s.slice(0, 3);
      if (prefix === "BIG") return "BIG";
      if (prefix === "ULT") return "ULT";
      // Mantém o comportamento do seu código: não contabiliza OUTROS
      return "";
    }

    /* ============================
       PEDIDO #3 (abreviação já existente):
       - "ULT 01", "BIG 01"
       ============================ */
    function abreviarLojaParaTop5(lojaStr) {
      const s = String(lojaStr || "").trim().toUpperCase();

      // Ex.: "ULT 01 - PLANALTINA" -> "ULT 01"
      //      "BIG 02 - 402 NORTE"  -> "BIG 02"
      const m = s.match(/^(ULT|BIG)\s*(\d{1,2})\b/);
      if (m) {
        const sigla = m[1];
        const num = String(parseInt(m[2], 10)).padStart(2, "0");
        return `${sigla} ${num}`;
      }

      // fallback curto (não deve ocorrer para suas lojas)
      return s.length > 10 ? (s.slice(0, 10) + "…") : s;
    }

    async function carregar() {
      const status = document.getElementById("status");
      const subInfo = document.getElementById("subInfo");

      try {
        status.textContent = "Carregando relatórios...";
        subInfo.textContent = "Carregando dados...";

        const resp = await fetch("/api/relatorios");
        const dados = await resp.json().catch(() => ({}));

        if (!resp.ok || !dados.sucesso || !Array.isArray(dados.registros)) {
          status.textContent = (dados && dados.message) ? dados.message : "Falha ao carregar dados do dashboard.";
          subInfo.textContent = "Erro ao carregar.";
          return;
        }

        const registros = dados.registros;

        /* ===========================================================
           1) TOTAL de ocorrências (únicas)
           =========================================================== */
        const setOcc = new Set();
        for (const r of registros) {
          const k = chaveOcorrencia(r);
          if (k) setOcc.add(k);
        }
        const totalOc = setOcc.size;
        document.getElementById("totalOcorrencias").textContent = String(totalOc);

        /* ===========================================================
           2) Ocorrências por bandeira (contando ocorrência única)
              + Top lojas (ocorrência única por loja)
           =========================================================== */
        const occPorBandeira = { BIG: 0, ULT: 0 };
        const occPorLoja = new Map();

        const setOccLocal = new Set();
        for (const r of registros) {
          const k = chaveOcorrencia(r);
          if (!k || setOccLocal.has(k)) continue;

          setOccLocal.add(k);

          const loja = (r.loja || "").trim() || "SEM LOJA";
          const band = bandeiraPorLoja(loja);

          if (band) {
            occPorBandeira[band] = (occPorBandeira[band] || 0) + 1;
          }

          occPorLoja.set(loja, (occPorLoja.get(loja) || 0) + 1);
        }

        /* ===========================================================
           Atualiza os números no cartão “split”
           =========================================================== */
        document.getElementById("bandeiraBIG").textContent = String(occPorBandeira.BIG || 0);
        document.getElementById("bandeiraULT").textContent = String(occPorBandeira.ULT || 0);

        /* ===========================================================
           3) Top 5 lojas (abreviado)
           =========================================================== */
        const top = Array.from(occPorLoja.entries())
          .sort((a,b) => b[1] - a[1])
          .slice(0, 5);

        const topLabels = top.map(([loja]) => abreviarLojaParaTop5(loja));
        const topValues = top.map(([,qtd]) => qtd);

        /* ===========================================================
           4) Ocorrências por departamento
              - contar em quantas OCORRÊNCIAS o departamento aparece
              - e NÃO em quantos REGISTROS (linhas)
           =========================================================== */
        const deptPorOcorrencia = new Map(); // chaveOcorrencia -> Set(dept)
        for (const r of registros) {
          const k = chaveOcorrencia(r);
          if (!k) continue;

          const dep = (r.departamento || "N/I").toString().trim().toUpperCase() || "N/I";

          if (!deptPorOcorrencia.has(k)) deptPorOcorrencia.set(k, new Set());
          deptPorOcorrencia.get(k).add(dep);
        }

        const occPorDept = new Map(); // dept -> qtdOcorrenciasQueTemEsseDept
        for (const [, setDeps] of deptPorOcorrencia.entries()) {
          for (const dep of setDeps.values()) {
            occPorDept.set(dep, (occPorDept.get(dep) || 0) + 1);
          }
        }

        const deptOrdenado = Array.from(occPorDept.entries())
          .sort((a,b) => b[1] - a[1])
          .slice(0, 12); // mantém legível

        const deptLabels = deptOrdenado.map(([d]) => d);
        const deptValues = deptOrdenado.map(([,q]) => q);

        /* ===========================================================
           Render charts
           =========================================================== */
        renderTopLojas(topLabels, topValues);
        renderDept(deptLabels, deptValues);

        subInfo.textContent =
          `Base: ${registros.length.toLocaleString("pt-BR")} registro(s) | ` +
          `${totalOc.toLocaleString("pt-BR")} ocorrência(s) única(s)`;

        status.textContent = "Dashboard atualizado com sucesso.";
      } catch (e) {
        console.error("Erro no dashboard:", e);
        status.textContent = "Erro de conexão ao montar o dashboard.";
        subInfo.textContent = "Erro ao carregar.";
      }
    }

    /* ===========================================================
       TOP 5 LOJAS
       PEDIDOS:
       #2 - Remover linhas de grade
       #3 - BIG barra roxa; ULT barra verde escuro
       =========================================================== */
    function renderTopLojas(labels, values) {
      const ctx = document.getElementById("chartTopLojas");

      if (chartTopLojas) chartTopLojas.destroy();

      // Plugin simples para escrever o valor no topo de cada barra (já existia)
      const valueOnTopPlugin = {
        id: "valueOnTopPlugin",
        afterDatasetsDraw(chart) {
          const { ctx } = chart;
          const meta = chart.getDatasetMeta(0);
          if (!meta || !meta.data) return;

          ctx.save();
          ctx.textAlign = "center";
          ctx.textBaseline = "bottom";
          ctx.font = "bold 12px Arial";
          ctx.fillStyle = "#111";

          meta.data.forEach((bar, i) => {
            const val = chart.data.datasets[0].data[i];
            ctx.fillText(String(val), bar.x, bar.y - 6);
          });

          ctx.restore();
        }
      };

      // PEDIDO #3: cores por bandeira (BIG roxo / ULT verde escuro)
      const corBIG = "#6A1B9A";  // roxo (BIG)
      const corULT = "#1B5E20";  // verde escuro (ULT)

      const bgColors = labels.map((lbl) => {
        const s = String(lbl || "").toUpperCase().trim();
        if (s.startsWith("BIG")) return corBIG;
        if (s.startsWith("ULT")) return corULT;
        return "#777"; // fallback (não deve acontecer)
      });

      chartTopLojas = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Ocorrências",
            data: values,
            backgroundColor: bgColors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (item) => `Ocorrências: ${item.raw}`
              }
            }
          },
          scales: {
            x: {
              ticks: {
                maxRotation: 0,
                minRotation: 0,
                autoSkip: false
              },
              // PEDIDO #2: remover linhas de grade
              grid: { display: false }
            },
            y: {
              beginAtZero: true,
              ticks: { precision: 0 },
              // PEDIDO #2: remover linhas de grade
              grid: { display: false }
            }
          }
        },
        plugins: [valueOnTopPlugin]
      });
    }

    /* ===========================================================
       OCORRÊNCIAS POR DEPARTAMENTO
       PEDIDOS:
       #2 - Remover linhas de grade
       #2 - Colocar rótulo visível no gráfico (mostrar valor em cada barra)
       =========================================================== */
    function renderDept(labels, values) {
      const ctx = document.getElementById("chartDept");

      if (chartDept) chartDept.destroy();

      // PEDIDO #2: plugin para desenhar valor ao final de cada barra (horizontal)
      const valueAtEndPlugin = {
        id: "valueAtEndPlugin",
        afterDatasetsDraw(chart) {
          const { ctx, chartArea } = chart;
          const meta = chart.getDatasetMeta(0);
          if (!meta || !meta.data) return;

          ctx.save();
          ctx.textAlign = "left";
          ctx.textBaseline = "middle";
          ctx.font = "bold 12px Arial";
          ctx.fillStyle = "#111";

          meta.data.forEach((bar, i) => {
            const val = chart.data.datasets[0].data[i];

            // Em bar horizontal, bar.x é o “fim” da barra
            const x = Math.min(bar.x + 6, chartArea.right - 6);
            const y = bar.y;

            ctx.fillText(String(val), x, y);
          });

          ctx.restore();
        }
      };

      chartDept = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Ocorrências por departamento",
            data: values
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (item) => `Ocorrências: ${item.raw}`
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { precision: 0 },
              // PEDIDO #2: remover linhas de grade
              grid: { display: false }
            },
            y: {
              ticks: { autoSkip: false },
              // PEDIDO #2: remover linhas de grade
              grid: { display: false }
            }
          }
        },
        plugins: [valueAtEndPlugin]
      });
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DASHBOARD – Relatório de Ocorrências</title>

  <style>
    /* ====== Visual “semelhante ao print”: tiles claras em um fundo cinza suave ====== */
    body{
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      color: #111;
    }

    .wrap{
      width: min(1100px, 92vw);
      margin: 16px auto 30px;
    }

    /* =========================================================
       AJUSTE (PEDIDO #2):
       - Garantir que TOPBAR e STATUS tenham a mesma largura visual
         do card "Top 15 produtos" no desktop.
       Observação:
       - Os cards (.tile) possuem borda e, sem box-sizing, podem
         “parecer” ligeiramente maiores. Então:
         1) Forçamos box-sizing em .tile
         2) Mantemos topbar/status em border-box (já estavam)
       ========================================================= */
    .topbar{
      width: 100%;
      box-sizing: border-box;

      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 16px;
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 6px 18px rgba(0,0,0,0.10);
      margin-bottom: 14px;
    }

    .title{
      margin: 0;
      font-size: 20px;
      font-weight: 800;
      letter-spacing: 0.5px;
    }

    .subtitle{
      margin: 4px 0 0;
      font-size: 12px;
      color: #555;
    }

    .btn{
      border: none;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
      white-space: nowrap;
    }

    .btn-back{
      background: #0066ff;
      color: #fff;
    }

    .btn-refresh{
      background: #e9e9e9;
      color: #111;
    }

    /* =========================================================
       Lista suspensa ao lado do botão Atualizar: Todos | BIG | ULT
       ========================================================= */
    .select-filter{
      border: 1px solid #d6d6d6;
      background: #fff;
      color: #111;
      border-radius: 10px;
      padding: 9px 10px;
      font-weight: 700;
      font-size: 13px;
      outline: none;
      cursor: pointer;
    }

    /* =========================================================
       NOVO (PEDIDO #3, #4, #5):
       - 2 filtros por data (início/fim)
       - 1 caixa de “venda” para calcular participação
       - Os 3 novos campos ficam à ESQUERDA do filtro Bandeira
       - Em celular, ficam ABAIXO do filtro Bandeira
       ========================================================= */
    .filters-wrap{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .filters-main{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .filters-extra{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .input-filter{
      border: 1px solid #d6d6d6;
      background: #fff;
      color: #111;
      border-radius: 10px;
      padding: 9px 10px;
      font-weight: 700;
      font-size: 13px;
      outline: none;
      min-width: 140px;
      box-sizing: border-box;
    }

    /* input date costuma ficar “apertado” em alguns browsers */
    .input-date{
      min-width: 148px;
    }

    /* Campo de “venda” (participação) – apenas texto formatado (dinheiro) */
    .input-money{
      min-width: 170px;
      text-align: right;
    }

    /* =========================================================
       Grid principal
       ========================================================= */
    .grid{
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }

    .row2{
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .row3{
      grid-column: 1 / -1;
      display: block;
    }

    /* ============================
       Tiles
       ============================ */
    .tile{
      background: #f6f6f6;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      padding: 12px 14px;
      min-height: 180px;

      /* AJUSTE (PEDIDO #2): evita “crescer” visualmente por borda */
      box-sizing: border-box;
    }

    .tile h3{
      margin: 0 0 10px;
      font-size: 13px;
      font-weight: 900;
      color: #111;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }

    /* ============================
       Ocorrências (número grande)
       ============================ */
    .big-number{
      height: calc(100% - 28px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .big-number .n{
      font-size: 92px;
      font-weight: 900;
      line-height: 1;
      color: #111;
      text-align: center;
    }

    /* =========================================================
       NOVO (já existia no seu código):
       - Valor em R$ no card de Ocorrências
       ========================================================= */
    .big-number .valor{
      font-weight: 900;
      color: #111;
      font-size: 16px;
      text-align: center;
      margin-top: 2px;
    }

    /* =========================================================
       NOVO (PEDIDO #4):
       - Mostrar percentual de participação abaixo do valor
       ========================================================= */
    .big-number .participacao{
      font-weight: 800;
      color: #555;
      font-size: 13px;
      text-align: center;
      margin-top: 2px;
    }

    .canvas-wrap{
      position: relative;
      height: 210px;
    }

    /* =========================================================
       Ocorrências: split (número + pizza)
       ========================================================= */
    .ocorrencias-split{
      height: calc(100% - 28px);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: center;
    }

    /* =========================================================
       Pizza maior (já estava)
       ========================================================= */
    .ocorrencias-pie{
      position: relative;
      height: 240px;
      min-height: 240px;
    }

    /* ============================
       Card “Ocorrências por Bandeira”
       ============================ */
    .tile.bandeira-tile h3{
      text-align: center;
    }

    .bandeira-split{
      height: calc(100% - 28px);
      display: grid;
      grid-template-columns: 1fr 1px 1fr;
      align-items: center;
      gap: 10px;
    }

    .bandeira-divider{
      width: 1px;
      height: 70%;
      background: #d9d9d9;
      justify-self: center;
      border-radius: 1px;
    }

    .bandeira-col{
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 120px;
    }

    .bandeira-num{
      font-size: 44px;
      font-weight: 900;
      color: #111;
      line-height: 1;
    }

    /* Valor abaixo do número por bandeira */
    .bandeira-valor{
      font-size: 14px;
      font-weight: 900;
      color: #111;
      line-height: 1.1;
    }

    .bandeira-logo{
      width: 140px;
      height: 46px;
      object-fit: contain;
      display: block;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.18));
    }

    /* =========================================================
       Status (mantido com width 100% e border-box)
       ========================================================= */
    .status{
      width: 100%;
      box-sizing: border-box;

      margin-top: 10px;
      font-size: 13px;
      color: #333;
      padding: 12px 14px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid #e5e5e5;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }

    /* ====== Acesso inválido ====== */
    .tela-erro{
      width: min(520px, 92vw);
      margin: 60px auto;
      background: #fff;
      border-radius: 12px;
      padding: 22px 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      text-align: center;
    }

    .tela-erro h1{
      margin: 0 0 8px;
      color: #c00000;
    }

    /* ====== Responsivo ====== */
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr 1fr; }
      .row2{ grid-template-columns: 1fr; }
    }

    @media (max-width: 640px){
      .grid{ grid-template-columns: 1fr; }
      .big-number .n{ font-size: 82px; }
      .canvas-wrap{ height: 240px; }
      .bandeira-num{ font-size: 40px; }
      .bandeira-logo{ width: 132px; height: 44px; }

      /* Em celular, “Ocorrências” empilha número e pizza para caber melhor */
      .ocorrencias-split{
        grid-template-columns: 1fr;
      }

      /* Pizza maior no celular também */
      .ocorrencias-pie{
        height: 280px;
        min-height: 280px;
      }

      /* No celular, botões/controles ficam por último (já estava) */
      .topbar{
        flex-direction: column;
        align-items: stretch;
      }

      .topbar > div:last-child{
        order: 2;
        margin-top: 8px;
        width: 100%;
        justify-content: flex-end;
        flex-wrap: wrap;
      }

      .topbar > div:first-child{
        order: 1;
        width: 100%;
      }

      /* =========================================================
         PEDIDO #5:
         - Em celular, os 3 novos campos ficam ABAIXO do filtro bandeira
         Implementação:
         - filters-main (select + botões) fica “em cima”
         - filters-extra (datas + venda) vai para baixo e ocupa 100%
         ========================================================= */
      .filters-wrap{
        flex-direction: column;
        align-items: stretch;
      }

      .filters-main{
        order: 1;
        width: 100%;
        justify-content: flex-end;
      }

      .filters-extra{
        order: 2;
        width: 100%;
        justify-content: flex-end;
      }

      .filters-main .btn,
      .filters-main .select-filter{
        flex: 1 1 auto;
      }

      .filters-extra .input-filter{
        width: 100%;
        min-width: 0;
      }
    }
  </style>
</head>

<body>
  <div id="telaErro" class="tela-erro" style="display:none;">
    <h1>Acesso inválido</h1>
    <p>Este dashboard só pode ser aberto pelo botão <b>Dashboard</b> dentro do Painel do Gestor.</p>
    <p>Volte para a tela do Gestor e tente novamente.</p>
    <button class="btn btn-back" onclick="voltar()">Voltar</button>
  </div>

  <div id="app" class="wrap" style="display:none;">
    <div class="topbar">
      <div>
        <h1 class="title">RELATÓRIO DE OCORRÊNCIAS</h1>
        <p class="subtitle" id="subInfo">Carregando dados...</p>
      </div>

      <!-- =========================================================
           CONTROLES (PEDIDO #3, #4, #5)
           - filters-extra (datas + venda/participação) à esquerda
           - filtro bandeira e botões no bloco filters-main
           - em celular, extra vai abaixo
           ========================================================= -->
      <div class="filters-wrap">
        <!-- NOVOS CAMPOS (fica à esquerda do filtro bandeira no desktop) -->
        <div class="filters-extra">
          <input
            id="dataInicio"
            class="input-filter input-date"
            type="date"
            aria-label="Data início"
            title="Data início"
          />

          <input
            id="dataFim"
            class="input-filter input-date"
            type="date"
            aria-label="Data fim"
            title="Data fim"
          />

          <input
            id="valorVenda"
            class="input-filter input-money"
            type="text"
            inputmode="decimal"
            autocomplete="off"
            spellcheck="false"
            placeholder="Venda (ex: 0,00)"
            aria-label="Valor da venda para participação"
            title="Digite a venda (aceita negativo). Ex: 1.234,56"
          />
        </div>

        <!-- Controles principais (mantidos) -->
        <div class="filters-main">
          <button class="btn btn-refresh" onclick="carregar()">Atualizar</button>

          <select id="filtroBandeira" class="select-filter" onchange="carregar()">
            <option value="TODOS">Todos</option>
            <option value="BIG">BIG</option>
            <option value="ULT">ULT</option>
          </select>

          <button class="btn btn-back" onclick="voltar()">Voltar</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- =========================================================
           LINHA DE CIMA (3 cartões iguais)
           ========================================================= -->

      <!-- 1) Ocorrências + Pizza Gravidade -->
      <div class="tile">
        <h3>Ocorrências</h3>

        <div class="ocorrencias-split">
          <div class="big-number" style="height:auto;">
            <div class="n" id="totalOcorrencias">0</div>

            <!-- =========================================================
                 PEDIDO #1:
                 - Remover a palavra "registradas" (linha abaixo do número)
                 Implementação:
                 - Removido completamente o elemento que continha o texto
                 ========================================================= -->

            <!-- Valor total (R$) das ocorrências (segue filtros) -->
            <div class="valor" id="totalValorOcorrencias">R$ 0,00</div>

            <!-- =========================================================
                 PEDIDO #4:
                 - Mostrar “Participação” (%) abaixo do valor
                 ========================================================= -->
            <div class="participacao" id="pctParticipacao">Participação: 0,00%</div>
          </div>

          <div class="ocorrencias-pie">
            <canvas id="chartGravidade"></canvas>
          </div>
        </div>
      </div>

      <!-- 2) Ocorrências por bandeira (mantém sem filtro) -->
      <div class="tile bandeira-tile">
        <h3>Ocorrências por bandeira</h3>

        <div class="bandeira-split" aria-label="Ocorrências por bandeira (BIG e ULT)">
          <div class="bandeira-col">
            <div class="bandeira-num" id="bandeiraBIG">0</div>
            <div class="bandeira-valor" id="valorBIG">R$ 0,00</div>

            <img
              class="bandeira-logo"
              src="https://i.ibb.co/Kz5DZ8nP/1001316505.png"
              alt="Big Box"
            />
          </div>

          <div class="bandeira-divider" aria-hidden="true"></div>

          <div class="bandeira-col">
            <div class="bandeira-num" id="bandeiraULT">0</div>
            <div class="bandeira-valor" id="valorULT">R$ 0,00</div>

            <img
              class="bandeira-logo"
              src="https://i.ibb.co/270L2q5v/C-pia-de-C-pia-de-Filipeta-TV-2011-20231119-152254-0000.png"
              alt="Ultrabox"
            />
          </div>
        </div>
      </div>

      <!-- 3) Percentual por bandeira (mantém sem filtro) -->
      <div class="tile">
        <h3>Percentual por bandeira</h3>
        <div class="canvas-wrap" style="height: 210px;">
          <canvas id="chartPctBandeira"></canvas>
        </div>
      </div>

      <!-- =========================================================
           LINHA DE BAIXO (2 cartões iguais)
           ========================================================= -->
      <div class="row2">
        <div class="tile">
          <h3>Top 5 lojas</h3>
          <div class="canvas-wrap">
            <canvas id="chartTopLojas"></canvas>
          </div>
        </div>

        <div class="tile">
          <h3>Ocorrências por departamento</h3>
          <div class="canvas-wrap" style="height: 260px;">
            <canvas id="chartDept"></canvas>
          </div>
        </div>
      </div>

      <!-- =========================================================
           Top 15 produtos
           ========================================================= -->
      <div class="row3">
        <div class="tile" style="min-height: 240px;">
          <h3>Top 15 produtos (maior nº de registros)</h3>
          <div class="canvas-wrap" style="height: 280px;">
            <canvas id="chartTopProdutos"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="status" id="status">Aguardando...</div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    const STORAGE_KEY_GESTOR = "PPP_LOGIN_GESTOR";
    const STORAGE_DASH_OK = "PPP_DASH_OK";

    let chartTopLojas = null;
    let chartDept = null;
    let chartPctBandeira = null;
    let chartTopProdutos = null;
    let chartGravidade = null;

    /* =========================================================
       NOVO (PEDIDO #4):
       - Guardar o total em R$ das ocorrências (já filtradas)
         para recalcular a participação quando o usuário digitar
         a “venda” no campo.
       ========================================================= */
    let totalValorOcorrenciasAtual = 0;

    /* ====== Gate de acesso (só abre via botão) ====== */
    function validarAcesso() {
      const dashOk = (sessionStorage.getItem(STORAGE_DASH_OK) || "").trim() === "1";
      const sessaoGestor = sessionStorage.getItem(STORAGE_KEY_GESTOR);

      if (!dashOk || !sessaoGestor) return false;

      try {
        const obj = JSON.parse(sessaoGestor);
        return !!(obj && obj.usuario);
      } catch (e) {
        return false;
      }
    }

    function voltar() {
      window.location.href = "/painel-gestor.html";
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (!validarAcesso()) {
        document.getElementById("telaErro").style.display = "block";
        return;
      }

      document.getElementById("app").style.display = "block";

      /* =========================================================
         NOVO (PEDIDO #3 e #4):
         - Eventos dos novos campos:
           * datas -> recarrega (aplica filtro por intervalo)
           * venda -> recalcula participação em tempo real
         ========================================================= */
      document.getElementById("dataInicio")?.addEventListener("change", carregar);
      document.getElementById("dataFim")?.addEventListener("change", carregar);

      const inpVenda = document.getElementById("valorVenda");
      if (inpVenda) {
        inpVenda.addEventListener("input", () => {
          formatarCampoMoeda(inpVenda);
          atualizarParticipacao();
        });
        inpVenda.addEventListener("blur", () => {
          formatarCampoMoeda(inpVenda, { forceTwoDecimals: true });
          atualizarParticipacao();
        });
      }

      carregar();
    });

    /* ====== Mesma lógica do gerente: “ocorrência única” ====== */
    function chaveOcorrencia(r) {
      const documento = (r.documento || "").trim();
      if (!documento) return "";

      const usuario = (r.usuario || "").trim();
      const loja = (r.loja || "").trim();
      const dataStr = (r.dataHora || "").split(" ")[0] || "";

      return `${documento}||${usuario}||${loja}||${dataStr}`;
    }

    function bandeiraPorLoja(lojaStr) {
      const s = String(lojaStr || "").trim().toUpperCase();
      const prefix = s.slice(0, 3);
      if (prefix === "BIG") return "BIG";
      if (prefix === "ULT") return "ULT";
      return "";
    }

    function abreviarLojaParaTop5(lojaStr) {
      const s = String(lojaStr || "").trim().toUpperCase();

      const m = s.match(/^(ULT|BIG)\s*(\d{1,2})\b/);
      if (m) {
        const sigla = m[1];
        const num = String(parseInt(m[2], 10)).padStart(2, "0");
        return `${sigla} ${num}`;
      }
      return s.length > 10 ? (s.slice(0, 10) + "…") : s;
    }

    function abreviarProduto(nome) {
      const s = String(nome || "").trim();
      if (!s) return "N/I";
      return s.length > 20 ? (s.slice(0, 20) + "…") : s;
    }

    /* =========================================================
       UTIL: parse número BR (ex: "1.234,56") -> 1234.56
       ========================================================= */
    function parseNumeroBr(valor) {
      if (valor === null || valor === undefined) return 0;
      let s = String(valor).trim();
      if (!s) return 0;
      s = s.replace(/\s+/g, "");
      s = s.replace(/\./g, "").replace(",", ".");
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    }

    /* =========================================================
       Formatação BRL "R$"
       ========================================================= */
    function formatarBRL(n) {
      const v = Number(n) || 0;
      return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    /* =========================================================
       NOVO (PEDIDO #3):
       - Converter datas do registro para ISO (YYYY-MM-DD) para
         comparar com inputs type="date"
       Suporta:
       - "YYYY-MM-DD ..."
       - "DD/MM/YYYY ..."
       ========================================================= */
    function dataRegistroParaISO(dataHora) {
      const raw = String(dataHora || "").trim();
      if (!raw) return "";

      const dataParte = raw.split(" ")[0] || "";

      // Caso já esteja em ISO (ex: 2025-12-24)
      if (/^\d{4}-\d{2}-\d{2}$/.test(dataParte)) return dataParte;

      // Caso esteja em BR (ex: 24/12/2025)
      const m = dataParte.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (m) {
        const dd = m[1], mm = m[2], yyyy = m[3];
        return `${yyyy}-${mm}-${dd}`;
      }

      return "";
    }

    /* =========================================================
       NOVO (PEDIDO #4):
       - Campo de moeda com máscara:
         * aceita negativo
         * enquanto digita, mantém formato 1.234,56
         * sempre com 2 casas decimais
       Observação:
       - Não adiciona "R$" no input (você pediu "valor" formatado)
       ========================================================= */
    function formatarCampoMoeda(inputEl, opts = {}) {
      const forceTwoDecimals = !!opts.forceTwoDecimals;

      if (!inputEl) return;

      // Mantém se usuário colocou "-" em qualquer posição
      const original = String(inputEl.value || "");
      const neg = original.includes("-");

      // Remove tudo que não for dígito
      const digits = original.replace(/[^\d]/g, "");

      // Se não tem dígitos, zera (e mantém negativo apenas se o usuário insistir)
      if (!digits) {
        inputEl.value = (neg ? "-" : "") + (forceTwoDecimals ? "0,00" : "");
        return;
      }

      // Interpreta como centavos
      const cents = parseInt(digits, 10);
      const valor = (isNaN(cents) ? 0 : cents) / 100;

      // Formata como pt-BR sem símbolo de moeda
      const formatado = valor.toLocaleString("pt-BR", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });

      // Aplica sinal negativo (se usuário indicou)
      // Se valor for 0, mantém "0,00" (negativo em zero é irrelevante, mas deixo você decidir)
      inputEl.value = (neg ? "-" : "") + formatado;
    }

    /* =========================================================
       NOVO (PEDIDO #4):
       - Parse do input “venda” (formato BR com possível "-")
       ========================================================= */
    function parseMoedaInput(valorStr) {
      let s = String(valorStr || "").trim();
      if (!s) return 0;

      // Detecta sinal negativo
      const neg = s.includes("-");
      s = s.replace(/-/g, "");

      // Remove símbolos e espaços (aceita "R$" se colarem)
      s = s.replace(/[R$\s]/g, "");

      // Converte pt-BR para Number
      const n = parseNumeroBr(s);
      return neg ? -Math.abs(n) : n;
    }

    /* =========================================================
       NOVO (PEDIDO #4):
       - Calcula e exibe participação (%):
         participação = (valor_ocorrencias_filtradas / venda_digitada) * 100
       Regras:
       - Se venda = 0 -> mostra 0,00%
       - Aceita venda negativa (percentual pode ficar negativo)
       ========================================================= */
    function atualizarParticipacao() {
      const el = document.getElementById("pctParticipacao");
      const inp = document.getElementById("valorVenda");
      if (!el || !inp) return;

      const venda = parseMoedaInput(inp.value);
      const base = Number(totalValorOcorrenciasAtual) || 0;

      let pct = 0;
      if (venda !== 0) pct = (base * 100) / venda;

      // Formato com 2 casas e vírgula
      const pctStr = (Number.isFinite(pct) ? pct : 0).toLocaleString("pt-BR", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });

      el.textContent = `Participação: ${pctStr}%`;
    }

    async function carregar() {
      const status = document.getElementById("status");
      const subInfo = document.getElementById("subInfo");

      try {
        status.textContent = "Carregando relatórios...";
        subInfo.textContent = "Carregando dados...";

        const resp = await fetch("/api/relatorios");
        const dados = await resp.json().catch(() => ({}));

        if (!resp.ok || !dados.sucesso || !Array.isArray(dados.registros)) {
          status.textContent = (dados && dados.message) ? dados.message : "Falha ao carregar dados do dashboard.";
          subInfo.textContent = "Erro ao carregar.";
          return;
        }

        const registros = dados.registros;

        /* =========================================================
           FILTROS (PEDIDO #3):
           - Bandeira: Todos | BIG | ULT
           - Data início/fim: intervalo (inclusive)
           ========================================================= */
        const filtro = (document.getElementById("filtroBandeira")?.value || "TODOS").toUpperCase().trim();

        const dataInicio = (document.getElementById("dataInicio")?.value || "").trim(); // ISO YYYY-MM-DD
        const dataFim = (document.getElementById("dataFim")?.value || "").trim();       // ISO YYYY-MM-DD

        const registrosFiltrados = registros.filter(r => {
          // 1) Bandeira
          if (filtro === "BIG" || filtro === "ULT") {
            if (bandeiraPorLoja(r.loja) !== filtro) return false;
          }

          // 2) Datas (intervalo)
          if (dataInicio || dataFim) {
            const iso = dataRegistroParaISO(r.dataHora);
            if (!iso) return false;

            if (dataInicio && iso < dataInicio) return false;
            if (dataFim && iso > dataFim) return false;
          }

          return true;
        });

        /* =========================================================
           (A) OCORRÊNCIAS (COM FILTRO) + VALOR (R$)
           - conta ocorrências únicas
           - soma valor por ocorrência única (quantidade * valorUnitario)
           ========================================================= */
        const setOccFiltradoTotal = new Set();
        const valorPorOcorrenciaFiltrada = new Map(); // k -> valor acumulado

        for (const r of registrosFiltrados) {
          const k = chaveOcorrencia(r);
          if (!k) continue;

          setOccFiltradoTotal.add(k);

          const qtd = parseNumeroBr(r.quantidade);
          const vUnit = parseNumeroBr(r.valorUnitario);
          const totalLinha = qtd * vUnit;

          valorPorOcorrenciaFiltrada.set(
            k,
            (valorPorOcorrenciaFiltrada.get(k) || 0) + (isNaN(totalLinha) ? 0 : totalLinha)
          );
        }

        const totalOcFiltradoTotal = setOccFiltradoTotal.size;
        document.getElementById("totalOcorrencias").textContent = String(totalOcFiltradoTotal);

        // Total em R$ (somando valores das ocorrências únicas filtradas)
        let somaValorOcorrenciasFiltradas = 0;
        for (const v of valorPorOcorrenciaFiltrada.values()) somaValorOcorrenciasFiltradas += (Number(v) || 0);

        document.getElementById("totalValorOcorrencias").textContent = formatarBRL(somaValorOcorrenciasFiltradas);

        // NOVO (PEDIDO #4): guarda e atualiza participação
        totalValorOcorrenciasAtual = somaValorOcorrenciasFiltradas;
        atualizarParticipacao();

        /* =========================================================
           (B) OCORRÊNCIAS POR BANDEIRA (SEM FILTRO) + VALOR (R$)
           - mantém sem filtro (como estava)
           ========================================================= */
        const occPorBandeira = { BIG: 0, ULT: 0 };
        const valorPorBandeira = { BIG: 0, ULT: 0 };

        const valorPorOcorrenciaAll = new Map(); // k -> valor total (base completa)
        for (const r of registros) {
          const k = chaveOcorrencia(r);
          if (!k) continue;

          const qtd = parseNumeroBr(r.quantidade);
          const vUnit = parseNumeroBr(r.valorUnitario);
          const totalLinha = qtd * vUnit;

          valorPorOcorrenciaAll.set(
            k,
            (valorPorOcorrenciaAll.get(k) || 0) + (isNaN(totalLinha) ? 0 : totalLinha)
          );
        }

        const setOccAll = new Set();
        for (const r of registros) {
          const k = chaveOcorrencia(r);
          if (!k || setOccAll.has(k)) continue;
          setOccAll.add(k);

          const loja = (r.loja || "").trim() || "SEM LOJA";
          const band = bandeiraPorLoja(loja);

          if (band) {
            occPorBandeira[band] = (occPorBandeira[band] || 0) + 1;
            valorPorBandeira[band] = (valorPorBandeira[band] || 0) + (valorPorOcorrenciaAll.get(k) || 0);
          }
        }

        document.getElementById("bandeiraBIG").textContent = String(occPorBandeira.BIG || 0);
        document.getElementById("bandeiraULT").textContent = String(occPorBandeira.ULT || 0);

        document.getElementById("valorBIG").textContent = formatarBRL(valorPorBandeira.BIG || 0);
        document.getElementById("valorULT").textContent = formatarBRL(valorPorBandeira.ULT || 0);

        /* Percentual por bandeira (SEM FILTRO) */
        renderPctBandeira(occPorBandeira.BIG || 0, occPorBandeira.ULT || 0);

        /* =========================================================
           (C) GRAVIDADE (COM FILTRO)
           ========================================================= */
        let qtdLeve = 0, qtdMedia = 0, qtdGrave = 0;
        for (const v of valorPorOcorrenciaFiltrada.values()) {
          if (v >= 500) qtdGrave++;
          else if (v < 100) qtdLeve++;
          else qtdMedia++;
        }
        renderGravidade(qtdLeve, qtdMedia, qtdGrave);

        /* =========================================================
           (D) ITENS QUE SEGUEM FILTRO:
           - Top 5 lojas
           - Ocorrências por departamento
           - Top 15 produtos
           ========================================================= */

        /* Top 5 lojas (por ocorrência única) - COM FILTRO */
        const occPorLoja = new Map();
        const setOccFiltrado = new Set();

        for (const r of registrosFiltrados) {
          const k = chaveOcorrencia(r);
          if (!k || setOccFiltrado.has(k)) continue;

          setOccFiltrado.add(k);

          const loja = (r.loja || "").trim() || "SEM LOJA";
          occPorLoja.set(loja, (occPorLoja.get(loja) || 0) + 1);
        }

        const top = Array.from(occPorLoja.entries())
          .sort((a,b) => b[1] - a[1])
          .slice(0, 5);

        const topLabels = top.map(([loja]) => abreviarLojaParaTop5(loja));
        const topValues = top.map(([,qtd]) => qtd);

        /* Ocorrências por departamento (por ocorrência, não por linha) - COM FILTRO */
        const deptPorOcorrencia = new Map();
        for (const r of registrosFiltrados) {
          const k = chaveOcorrencia(r);
          if (!k) continue;

          const dep = (r.departamento || "N/I").toString().trim().toUpperCase() || "N/I";
          if (!deptPorOcorrencia.has(k)) deptPorOcorrencia.set(k, new Set());
          deptPorOcorrencia.get(k).add(dep);
        }

        const occPorDept = new Map();
        for (const [, setDeps] of deptPorOcorrencia.entries()) {
          for (const dep of setDeps.values()) {
            occPorDept.set(dep, (occPorDept.get(dep) || 0) + 1);
          }
        }

        const deptOrdenado = Array.from(occPorDept.entries())
          .sort((a,b) => b[1] - a[1])
          .slice(0, 12);

        const deptLabels = deptOrdenado.map(([d]) => d);
        const deptValues = deptOrdenado.map(([,q]) => q);

        /* Top 15 produtos por nº de registros - COM FILTRO */
        const registrosPorProduto = new Map();
        for (const r of registrosFiltrados) {
          const prod = (r.produto || "N/I").toString().trim() || "N/I";
          registrosPorProduto.set(prod, (registrosPorProduto.get(prod) || 0) + 1);
        }

        const topProd = Array.from(registrosPorProduto.entries())
          .sort((a,b) => b[1] - a[1])
          .slice(0, 15);

        const prodLabels = topProd.map(([p]) => abreviarProduto(p));
        const prodValues = topProd.map(([,q]) => q);

        /* Render charts */
        renderTopLojas(topLabels, topValues);
        renderDept(deptLabels, deptValues);
        renderTopProdutos(prodLabels, prodValues);

        /* SubInfo (agora também “explica” que há filtro de data quando usado) */
        const infoFiltroData = (dataInicio || dataFim)
          ? ` | período: ${dataInicio || "—"} até ${dataFim || "—"}`
          : "";

        subInfo.textContent =
          `${registrosFiltrados.length.toLocaleString("pt-BR")} registros | ` +
          `${setOccFiltrado.size.toLocaleString("pt-BR")} ocorrências` +
          infoFiltroData;

        status.textContent = "Dashboard atualizado com sucesso.";
      } catch (e) {
        console.error("Erro no dashboard:", e);
        status.textContent = "Erro de conexão ao montar o dashboard.";
        subInfo.textContent = "Erro ao carregar.";
      }
    }

    /* ===========================================================
       TOP 5 LOJAS
       - Mantido ajuste de “headroom” (suggestedMax) para rótulos
       =========================================================== */
    function renderTopLojas(labels, values) {
      const ctx = document.getElementById("chartTopLojas");
      if (chartTopLojas) chartTopLojas.destroy();

      const valueOnTopPlugin = {
        id: "valueOnTopPlugin",
        afterDatasetsDraw(chart) {
          const { ctx } = chart;
          const meta = chart.getDatasetMeta(0);
          if (!meta || !meta.data) return;

          ctx.save();
          ctx.textAlign = "center";
          ctx.textBaseline = "bottom";
          ctx.font = "bold 12px Arial";
          ctx.fillStyle = "#111";

          meta.data.forEach((bar, i) => {
            const val = chart.data.datasets[0].data[i];
            ctx.fillText(String(val), bar.x, bar.y - 6);
          });

          ctx.restore();
        }
      };

      const corBIG = "#6A1B9A";
      const corULT = "#43A047";

      const bgColors = labels.map((lbl) => {
        const s = String(lbl || "").toUpperCase().trim();
        if (s.startsWith("BIG")) return corBIG;
        if (s.startsWith("ULT")) return corULT;
        return "#777";
      });

      const maxVal = Math.max(0, ...(values || []).map(v => Number(v) || 0));
      const suggestedMax = maxVal > 0 ? Math.ceil(maxVal * 1.2) : 1;

      chartTopLojas = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Ocorrências",
            data: values,
            backgroundColor: bgColors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (item) => `Ocorrências: ${item.raw}` } }
          },
          scales: {
            x: { ticks: { maxRotation: 0, minRotation: 0, autoSkip: false }, grid: { display: false } },
            y: {
              beginAtZero: true,
              suggestedMax: suggestedMax,
              ticks: { precision: 0 },
              grid: { display: false }
            }
          }
        },
        plugins: [valueOnTopPlugin]
      });
    }

    /* ===========================================================
       OCORRÊNCIAS POR DEPARTAMENTO (mantido)
       =========================================================== */
    function renderDept(labels, values) {
      const ctx = document.getElementById("chartDept");
      if (chartDept) chartDept.destroy();

      const valueAtEndPlugin = {
        id: "valueAtEndPlugin",
        afterDatasetsDraw(chart) {
          const { ctx, chartArea } = chart;
          const meta = chart.getDatasetMeta(0);
          if (!meta || !meta.data) return;

          ctx.save();
          ctx.textAlign = "left";
          ctx.textBaseline = "middle";
          ctx.font = "bold 12px Arial";
          ctx.fillStyle = "#111";

          meta.data.forEach((bar, i) => {
            const val = chart.data.datasets[0].data[i];
            const x = Math.min(bar.x + 6, chartArea.right - 6);
            const y = bar.y;
            ctx.fillText(String(val), x, y);
          });

          ctx.restore();
        }
      };

      chartDept = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Ocorrências por departamento",
            data: values,
            backgroundColor: "#A98AE8"
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (item) => `Ocorrências: ${item.raw}` } }
          },
          scales: {
            x: { beginAtZero: true, ticks: { precision: 0 }, grid: { display: false } },
            y: { ticks: { autoSkip: false }, grid: { display: false } }
          }
        },
        plugins: [valueAtEndPlugin]
      });
    }

    /* ===========================================================
       PERCENTUAL POR BANDEIRA (mantido – SEM FILTRO)
       =========================================================== */
    function renderPctBandeira(qtdBIG, qtdULT) {
      const ctx = document.getElementById("chartPctBandeira");
      if (chartPctBandeira) chartPctBandeira.destroy();

      const total = (qtdBIG || 0) + (qtdULT || 0);

      const pctLabelPlugin = {
        id: "pctLabelPlugin",
        afterDatasetsDraw(chart) {
          const { ctx } = chart;
          const meta = chart.getDatasetMeta(0);
          if (!meta || !meta.data) return;

          ctx.save();
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.font = "bold 13px Arial";
          ctx.fillStyle = "#111";

          meta.data.forEach((arc, i) => {
            const val = chart.data.datasets[0].data[i] || 0;
            const pct = total > 0 ? (val * 100 / total) : 0;
            const label = `${pct.toFixed(1)}%`;

            const pos = arc.tooltipPosition();
            ctx.fillText(label, pos.x, pos.y);
          });

          ctx.restore();
        }
      };

      chartPctBandeira = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["BIG", "ULT"],
          datasets: [{
            data: [qtdBIG || 0, qtdULT || 0],
            backgroundColor: [
              "#A98AE8",
              "#43A047"
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "62%",
          plugins: {
            legend: { display: true, position: "bottom" },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.raw || 0;
                  const pct = total > 0 ? (v * 100 / total) : 0;
                  return `${ctx.label}: ${v} (${pct.toFixed(1)}%)`;
                }
              }
            }
          }
        },
        plugins: [pctLabelPlugin]
      });
    }

    /* ===========================================================
       TOP 15 PRODUTOS (mantido)
       =========================================================== */
    function renderTopProdutos(labels, values) {
      const ctx = document.getElementById("chartTopProdutos");
      if (chartTopProdutos) chartTopProdutos.destroy();

      const valueAtEndPlugin = {
        id: "valueAtEndPluginProdutos",
        afterDatasetsDraw(chart) {
          const { ctx, chartArea } = chart;
          const meta = chart.getDatasetMeta(0);
          if (!meta || !meta.data) return;

          ctx.save();
          ctx.textAlign = "left";
          ctx.textBaseline = "middle";
          ctx.font = "bold 12px Arial";
          ctx.fillStyle = "#111";

          meta.data.forEach((bar, i) => {
            const val = chart.data.datasets[0].data[i];
            const x = Math.min(bar.x + 6, chartArea.right - 6);
            const y = bar.y;
            ctx.fillText(String(val), x, y);
          });

          ctx.restore();
        }
      };

      chartTopProdutos = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Registros",
            data: values,
            backgroundColor: "#6A5ACD"
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (item) => `Registros: ${item.raw}` } }
          },
          scales: {
            x: { beginAtZero: true, ticks: { precision: 0 }, grid: { display: false } },
            y: { ticks: { autoSkip: false }, grid: { display: false } }
          }
        },
        plugins: [valueAtEndPlugin]
      });
    }

    /* ===========================================================
       PIZZA - Gravidade (segue filtro)
       =========================================================== */
    function renderGravidade(qtdLeve, qtdMedia, qtdGrave) {
      const ctx = document.getElementById("chartGravidade");
      if (chartGravidade) chartGravidade.destroy();

      const total = (qtdLeve || 0) + (qtdMedia || 0) + (qtdGrave || 0);

      const pctLabelPlugin = {
        id: "pctLabelPluginGravidade",
        afterDatasetsDraw(chart) {
          const { ctx } = chart;
          const meta = chart.getDatasetMeta(0);
          if (!meta || !meta.data) return;

          ctx.save();
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.font = "bold 12px Arial";
          ctx.fillStyle = "#111";

          meta.data.forEach((arc, i) => {
            const val = chart.data.datasets[0].data[i] || 0;
            const pct = total > 0 ? (val * 100 / total) : 0;
            const label = `${pct.toFixed(2)}%`;
            const pos = arc.tooltipPosition();
            ctx.fillText(label, pos.x, pos.y);
          });

          ctx.restore();
        }
      };

      chartGravidade = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Leve", "Média", "Grave"],
          datasets: [{
            data: [qtdLeve || 0, qtdMedia || 0, qtdGrave || 0],
            backgroundColor: [
              "#9E9E9E",
              "#A98AE8",
              "#F44336"
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: "bottom" },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.raw || 0;
                  const pct = total > 0 ? (v * 100 / total) : 0;
                  return `${ctx.label}: ${v} (${pct.toFixed(2)}%)`;
                }
              }
            }
          }
        },
        plugins: [pctLabelPlugin]
      });
    }
  </script>

  <!-- Fontes (documentação confiável) -->
  <!-- Chart.js: https://www.chartjs.org/docs/latest/ -->
  <!-- input[type="date"] (HTML): https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/date -->
  <!-- Intl.NumberFormat / toLocaleString: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/NumberFormat -->
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PAINEL SCAN&SELL</title>

  <style>
    /* =========================
       ESTILO GERAL E CABEÇALHO
       ==========================*/

    body {
      background: #f3f3f3;
      font-family: Arial, sans-serif;
      margin: 8px;
      min-height: 100vh;

      /* Card centralizado horizontalmente, colado no topo */
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container {
      width: 95%;
      max-width: 900px;
      background: #fff;
      padding: 24px 28px 30px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
    }

    .cabecalho {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 10px;
      border-bottom: 1px solid #e1e1e1;
      padding-bottom: 14px;
      margin-bottom: 16px;
    }

    .titulo {
      margin: 2px;
      font-size: 18px; /* TÍTULO PRINCIPAL */
    }

    /* Área de usuário/loja sem card, apenas texto no topo, à direita */
    .info-usuario {
      display: flex;
      justify-content: flex-end;
      flex: 1 1 auto;
    }

    .usuario-card {
      min-width: auto;
      background: transparent;
      border: none;
      border-radius: 0;
      padding: 0;
      box-shadow: none;

      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: center;
      gap: 2px;
    }

    .usuario-card .value {
      font-weight: 600;
      color: #111;
      word-break: break-word;
      font-size: 9px;
      text-align: right;
    }

    /* =========================
       CARDS DE RESUMO (VERIFICADOS / PENDENTES)
       ==========================*/

    .resumo-container {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      margin-top: 4px;
    }

    .resumo-card {
      flex: 1;
      border-radius: 10px;
      padding: 10px 12px;
      background: #f7f7f7;
      border: 1px solid #e0e0e0;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
    }

    .resumo-titulo {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .resumo-percent {
      font-size: 18px;
      font-weight: 700;
    }

    .resumo-total {
      font-size: 11px;
      color: #555;
      margin-top: 2px;
    }

    /* Cores específicas dos cards de resumo */
    .resumo-verificado .resumo-titulo {
      color: #118000;
    }

    .resumo-verificado .resumo-percent {
      color: #118000;
    }

    .resumo-pendente .resumo-titulo {
      color: #c00000;
    }

    .resumo-pendente .resumo-percent {
      color: #c00000;
    }

    .conteudo {
      margin-top: 12px;
      font-size: 14px;
    }

    .bloco {
      margin-bottom: 16px;
      padding: 14px;
      border-radius: 8px;
      background: #f7f8ff;
      border: 1px solid #e0e3ff;
    }

    .bloco h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .btn-voltar {
      margin-top: 10px;
      display: inline-block;
      padding: 8px 14px;
      background: #0066ff;   /* AZUL DO BOTÃO SAIR */
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
    }

    .btn-voltar:hover {
      background: #0050cc;   /* AZUL MAIS ESCURO NO HOVER */
    }

    /* Container dos botões de rodapé (Sair + R. Exceção) */
    .botoes-footer {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    .botoes-footer .btn-voltar {
      flex: 1; /* dois botões com o mesmo tamanho horizontal */
    }

    /* Estilo específico do botão R. Exceção */
    .btn-excecao {
      background: #ff9800; /* LARANJA PARA DESTACAR */
    }

    .btn-excecao:hover {
      background: #f57c00;
    }

    /* ======================
       TELA DE ERRO (SEM SESSÃO)
       =======================*/

    .tela-erro {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #f3f3f3;
      font-family: Arial, sans-serif;
    }

    .card-erro {
      background: #fff;
      padding: 26px 30px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      max-width: 420px;
      text-align: center;
    }

    .card-erro h1 {
      color: #c00000;          /* VERMELHO DE ERRO */
      margin-top: 0;
    }

    /* ======================
       BUSCA + ÍCONES (LUPA ESQUERDA / CÂMERA DIREITA)
       =======================*/

    .search-container {
      width: 100%;
      position: relative;
      margin-top: 8px;
      margin-bottom: 12px;
    }

    #campoBusca {
      width: 100%;
      /* Espaço à esquerda e à direita para os ícones */
      padding: 14px 56px 14px 56px;
      font-size: 14px;
      border: 1px solid #c3c3c3;
      border-radius: 999px;
      outline: none;
      background: white;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      box-sizing: border-box;
    }

    #campoBusca:focus {
      border-color: #0066ff;
      box-shadow: 0 0 0 1px #0066ff33;
    }

    /* Botão da ESQUERDA -> agora é a LUPA (buscar) */
    .btnBarcodeLeft {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: 26px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-barcode-small {
      width: 100%;
      height: 100%;
      border-radius: 4px;
      background: repeating-linear-gradient(
        90deg,
        #333 0px,
        #333 2px,
        #fff 2px,
        #fff 4px
      );
    }

    /* Botão da DIREITA -> agora é a CÂMERA (30% maior) */
    .btnBuscarIcone {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      /* 30% maior que 26x20 -> aprox. 34x26 */
      width: 34px;
      height: 26px;
    }

    /* ======================
       OBSERVAÇÃO (OPCIONAL)
       =======================*/

    .obs-label {
      font-weight: 600;
      margin-top: 8px;
      margin-bottom: 4px;
    }

    .obs-textarea {
      width: 100%;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1px solid #c3c3c3;
      padding: 10px 12px;
      font-size: 14px;
      resize: vertical;
      min-height: 56px;
      background: #fff;
    }

    #status {
      font-size: 13px;
      margin-top: 4px;
      text-align: center;
      color: #333;
    }

    /* ======================
       CARTÕES DE RESULTADO
       =======================*/

    #resultado {
      margin-top: 8px;
    }

    .cartao {
      width: 94%;
      background: white;
      padding: 12px 14px 10px;
      margin: 10px auto;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      cursor: pointer;
      opacity: 0;
      transform: translateY(8px);
      animation: entrarCartao 0.22s ease-out forwards;
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out;
    }

    .cartao:hover {
      transform: translateY(2px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.14);
    }

    .cartao-header {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #111;
    }

    .cartao-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .cartao-table th,
    .cartao-table td {
      border: 1px solid #c3c3c3;
      padding: 3px 5px;
      text-align: left;
    }

    .cartao-table th {
      width: 42%;
      background: #f9f9f9;
      font-weight: 700;
    }

    /* Cores do status */
    .status-verificado {
      color: #118000;
      font-weight: 700;
    }

    .status-pendente {
      color: #c00000;
      font-weight: 700;
    }

    .status-pendente-enviado {
      color: #d6a500;
      font-weight: 700;
    }

    @keyframes entrarCartao {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ======================
       POPUP CONFIRMAÇÃO
       =======================*/

    #confirmOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .confirm-box {
      background: #fff;
      padding: 18px 16px;
      border-radius: 10px;
      max-width: 360px;
      width: 90%;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
      text-align: center;
      font-size: 14px;
    }

    .confirm-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .btnConfirmar,
    .btnCancelar {
      flex: 1;
      padding: 8px 6px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }

    .btnConfirmar {
      background: #4caf50;  /* VERDE BOTÃO "SIM" */
      color: #fff;
    }

    .btnCancelar {
      background: #e0e0e0;  /* CINZA BOTÃO "CANCELAR" */
      color: #333;
    }

    /* ======================
       POPUP DE AVISO "JÁ VERIFICADO"
       =======================*/

    #alertOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10001;
    }

    .alert-box {
      background: #fff;
      padding: 18px 16px;
      border-radius: 10px;
      max-width: 320px;
      width: 90%;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
      text-align: center;
      font-size: 14px;
    }

    .alert-box button {
      margin-top: 12px;
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      background: #4caf50;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
    }

    /* ======================
       ÁREA DA CÂMERA
       =======================*/

    #cameraArea {
      margin-top: 12px;
      display: none;
      width: 100%;
    }

    #cameraArea video {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-top: 6px;
      background: white;
    }

    .btnFechar {
      width: 100%;
      max-width: 280px;
      padding: 8px 10px;
      font-size: 13px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 8px;
      background: #777;
      color: white;
    }

    /* ======================
       OVERLAY CARREGAMENTO 0–100%
       =======================*/

    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(243, 243, 243, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 12000;
    }

    .loading-box {
      background: #ffffff;
      border-radius: 10px;
      padding: 16px 20px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
      text-align: center;
      font-size: 14px;
      min-width: 260px;
    }

    .loading-bar-container {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #eeeeee;
      margin-top: 10px;
      overflow: hidden;
    }

    .loading-bar {
      height: 100%;
      width: 0%;
      background: #0066ff;
      transition: width 0.15s linear;
    }

    .loading-percent {
      margin-top: 8px;
      font-weight: 700;
    }
  </style>
</head>

<body>
  <!-- TELA DE ERRO (SEM SESSÃO) -->
  <div id="erroAcesso" class="tela-erro" style="display: none;">
    <div class="card-erro">
      <h1>Acesso inválido</h1>
      <p>Sessão de Efetividade não encontrada.</p>
      <p>Volte para a tela de acesso e realize o login novamente.</p>
      <a href="/index.html" class="btn-voltar">Voltar para seleção</a>
    </div>
  </div>

  <!-- POPUP CONFIRMAÇÃO -->
  <div id="confirmOverlay">
    <div class="confirm-box">
      <p>Confirmar lançamento na base de dados?</p>
      <div class="confirm-buttons">
        <!-- ORDEM INVERTIDA: AGORA CANCELAR (ESQ) E SIM (DIR) -->
        <button class="btnCancelar" onclick="confirmarEnvio(false)">Cancelar</button>
        <button class="btnConfirmar" onclick="confirmarEnvio(true)">Sim</button>
      </div>
    </div>
  </div>

  <!-- POPUP "JÁ VERIFICADO" -->
  <div id="alertOverlay">
    <div class="alert-box">
      <p>Este produto já foi verificado.</p>
      <button type="button" onclick="fecharAlertaVerificado()">OK</button>
    </div>
  </div>

  <!-- OVERLAY CARREGAMENTO -->
  <div id="loadingOverlay">
    <div class="loading-box">
      <div>Carregando base de dados...</div>
      <div class="loading-bar-container">
        <div id="loadingBar" class="loading-bar"></div>
      </div>
      <div id="loadingPercent" class="loading-percent">0%</div>
    </div>
  </div>

  <!-- PAINEL PRINCIPAL -->
  <div id="appRoot" class="container" style="display: none;">
    <div class="cabecalho">
      <div>
        <h1 class="titulo">PAINEL SCAN&SELL</h1>
      </div>
      <div class="info-usuario">
        <div class="usuario-card">
          <div class="value" id="usuarioSpan"></div>
          <div class="value" id="lojaSpan"></div>
        </div>
      </div>
    </div>

    <!-- CARDS DE RESUMO (VERIFICADOS / PENDENTES) -->
    <div class="resumo-container">
      <div class="resumo-card resumo-verificado">
        <div class="resumo-titulo">Verificados</div>
        <div class="resumo-percent" id="percentVerificados">0%</div>
        <div class="resumo-total" id="totalVerificados">0 itens</div>
      </div>
      <div class="resumo-card resumo-pendente">
        <div class="resumo-titulo">Pendentes</div>
        <div class="resumo-percent" id="percentPendentes">0%</div>
        <div class="resumo-total" id="totalPendentes">0 itens</div>
      </div>
    </div>

    <div class="conteudo">
      <div class="bloco">
        <h3>Busca na base de dados</h3>

        <div class="search-container">
          <!-- LUPA À ESQUERDA -->
          <button
            type="button"
            class="btnBarcodeLeft"
            onclick="buscar()"
            aria-label="Buscar registro"
          >
            <svg
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="#444"
              stroke-width="2.2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="11" cy="11" r="7"></circle>
              <line x1="16.65" y1="16.65" x2="21" y2="21"></line>
            </svg>
          </button>

          <input
            id="campoBusca"
            type="text"
            placeholder="Buscar por Produto"
            onkeydown="if(event.key === 'Enter'){buscar();}"
          />

          <!-- CÂMERA À DIREITA (30% MAIOR) -->
          <button
            type="button"
            class="btnBuscarIcone"
            onclick="abrirCamera()"
            aria-label="Ler código de barras com a câmera"
          >
            <span class="icon-barcode-small"></span>
          </button>
        </div>

        <div class="obs-label">Observação:</div>
        <textarea
          id="observacao"
          class="obs-textarea"
          placeholder="Observação (opcional)..."
        ></textarea>

        <div id="status"></div>

        <!-- ÁREA DA CÂMERA -->
        <div id="cameraArea">
          <p style="font-size: 13px;">Aponte para o código de barras:</p>
          <video id="video" autoplay playsinline></video>
          <p id="msgCamera" style="font-size: 12px;"></p>
          <button class="btnFechar" onclick="fecharCamera()">Fechar câmera</button>
        </div>
      </div>

      <div id="resultado"></div>

      <!-- BOTÕES DE RODAPÉ (SAIR + RELATÓRIO DE EXCEÇÃO) -->
      <div class="botoes-footer">
        <a
          href="/index.html"
          class="btn-voltar"
          onclick="limparSessaoEfetividade()"
        >
          Sair
        </a>

        <button
          type="button"
          class="btn-voltar btn-excecao"
          onclick="irRelatorioExcecao()"
        >
          R. Exceção
        </button>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       VARIÁVEIS GLOBAIS
       ==========================*/
    let dbEfetividade = [];
    let lojaLogada = null;
    let usuarioLogado = null;
    let ultimosResultados = [];
    let envioPendente = null;

    // Produtos enviados nesta sessão (para manter amarelo até recarregar)
    const enviadosSessao = new Set();

    // Câmera / leitor
    let streamAtual = null;
    let lendo = false;

    // Fila offline para lançamentos (armazenada em localStorage)
    const FILA_OFFLINE_KEY = "efetividadeFilaOffline";

    /* =========================
       FUNÇÃO PARA GERAR CHAVE ÚNICA DO REGISTRO
       ==========================*/
    function gerarChaveRegistro(linha) {
      const ean = String(linha[0] ?? "").trim();
      const empresaProduto = String(linha[3] ?? "").trim();
      // Combinação suficiente para identificar o item na sessão
      return `${ean}|||${empresaProduto}`;
    }

    /* =========================
       NAVEGAR PARA RELATÓRIO DE EXCEÇÃO
       ==========================*/
    function irRelatorioExcecao() {
      // A nova tela também valida a sessão via localStorage
      window.location.href = "/relatorio-excecao.html";
    }

    /* =========================
       CONTROLE DA FILA OFFLINE (LOCALSTORAGE)
       ==========================*/

    // Lê a fila do localStorage
    function carregarFilaOffline() {
      try {
        const raw = localStorage.getItem(FILA_OFFLINE_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch (e) {
        console.error("Erro ao carregar fila offline:", e);
        return [];
      }
    }

    // Salva a fila inteira no localStorage
    function salvarFilaOffline(fila) {
      try {
        localStorage.setItem(FILA_OFFLINE_KEY, JSON.stringify(fila || []));
      } catch (e) {
        console.error("Erro ao salvar fila offline:", e);
      }
    }

    // Adiciona um item na fila offline
    function adicionarNaFilaOffline(item) {
      const fila = carregarFilaOffline();
      fila.push({
        ...item,
        criadoEm: Date.now(), // só metadado para auditoria, se quiser
      });
      salvarFilaOffline(fila);
    }

    // Processa a fila offline assim que houver conexão
    async function processarFilaOffline() {
      if (!navigator.onLine) return;

      let fila = carregarFilaOffline();
      if (!fila.length) return;

      const status = document.getElementById("status");
      if (status) {
        status.textContent = `Enviando ${fila.length} lançamento(s) pendente(s)...`;
      }

      const novaFila = [];

      for (const item of fila) {
        try {
          const resposta = await fetch("/api/efetividade-lancar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(item),
          });

          const dados = await resposta.json().catch(() => ({}));
          if (!resposta.ok || !dados.sucesso) {
            console.error("Falha ao enviar item da fila offline:", dados);
            // Mantém o item na fila para tentar de novo depois
            novaFila.push(item);
          }
        } catch (e) {
          console.error("Erro de conexão ao enviar fila offline:", e);
          // Mantém o item na fila
          novaFila.push(item);
        }
      }

      salvarFilaOffline(novaFila);

      if (status) {
        if (novaFila.length === 0) {
          status.textContent = "Lançamentos pendentes enviados com sucesso.";
        } else {
          status.textContent =
            `Alguns lançamentos ainda não foram enviados. Restam ${novaFila.length}.`;
        }
      }
    }

    // Escuta evento de voltar a ficar online e tenta enviar fila
    window.addEventListener("online", () => {
      processarFilaOffline();
    });

    /* =========================
       INICIALIZAÇÃO
       ==========================*/
    document.addEventListener("DOMContentLoaded", () => {
      let sessao = null;
      try {
        const raw = localStorage.getItem("efetividadeSession");
        if (raw) sessao = JSON.parse(raw);
      } catch (e) {
        console.error("Erro ao ler efetividadeSession:", e);
      }

      if (!sessao || !sessao.usuario || !sessao.loja) {
        document.getElementById("erroAcesso").style.display = "flex";
        return;
      }

      usuarioLogado = sessao.usuario;
      lojaLogada = sessao.loja;

      document.getElementById("usuarioSpan").textContent = usuarioLogado;
      document.getElementById("lojaSpan").textContent = lojaLogada;
      document.getElementById("appRoot").style.display = "block";

      // Carrega base principal
      carregarBaseEfetividade();

      // Se já existe fila offline e estiver online, tenta enviar logo na abertura
      processarFilaOffline();
    });

    /* =========================
       BEEP CURTO (LEITOR)
       ==========================*/
    let audioCtx = null;
    function beep() {
      try {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === "suspended") {
          audioCtx.resume();
        }
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.value = 900;
        gain.gain.value = 0.18;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.18);
      } catch (err) {
        console.warn("Não foi possível reproduzir beep:", err);
      }
    }

    /* =========================
       OVERLAY DE CARREGAMENTO
       ==========================*/
    let loadingTimer = null;
    let loadingPercent = 0;

    function iniciarLoading() {
      const overlay = document.getElementById("loadingOverlay");
      const bar = document.getElementById("loadingBar");
      const percentEl = document.getElementById("loadingPercent");
      loadingPercent = 0;
      bar.style.width = "0%";
      percentEl.textContent = "0%";
      overlay.style.display = "flex";
      if (loadingTimer) clearInterval(loadingTimer);
      loadingTimer = setInterval(() => {
        if (loadingPercent >= 95) return;
        loadingPercent += 5;
        bar.style.width = `${loadingPercent}%`;
        percentEl.textContent = `${loadingPercent}%`;
      }, 120);
    }

    function finalizarLoading() {
      const overlay = document.getElementById("loadingOverlay");
      const bar = document.getElementById("loadingBar");
      const percentEl = document.getElementById("loadingPercent");
      if (loadingTimer) {
        clearInterval(loadingTimer);
        loadingTimer = null;
      }
      loadingPercent = 100;
      bar.style.width = "100%";
      percentEl.textContent = "100%";
      setTimeout(() => {
        overlay.style.display = "none";
      }, 220);
    }

    /* =========================
       ATUALIZA OS CARDS DE RESUMO
       ==========================*/
    function atualizarResumoStatus() {
      const total = dbEfetividade.length;
      if (!total) {
        document.getElementById("percentVerificados").textContent = "0%";
        document.getElementById("percentPendentes").textContent = "0%";
        document.getElementById("totalVerificados").textContent = "0 itens";
        document.getElementById("totalPendentes").textContent = "0 itens";
        return;
      }

      let verificados = 0;
      let pendentes = 0;

      dbEfetividade.forEach((linha) => {
        const status = String(linha[2] ?? "").trim().toUpperCase();
        if (status === "VERIFICADO") verificados++;
        else if (status === "PENDENTE") pendentes++;
      });

      const percVer = (verificados / total) * 100;
      const percPen = (pendentes / total) * 100;

      document.getElementById("percentVerificados").textContent =
        percVer.toFixed(1) + "%";
      document.getElementById("percentPendentes").textContent =
        percPen.toFixed(1) + "%";

      // Agora exibe TOTAL DE CADA STATUS, não o total geral
      document.getElementById("totalVerificados").textContent =
        verificados + " itens";
      document.getElementById("totalPendentes").textContent =
        pendentes + " itens";
    }

    /* =========================
       CARREGAR BASE (API /efetividade-base)
       ==========================*/
    async function carregarBaseEfetividade() {
      const status = document.getElementById("status");
      status.textContent = "Carregando base de dados...";
      iniciarLoading();
      try {
        const resp = await fetch(
          "/api/efetividade-base?loja=" + encodeURIComponent(lojaLogada)
        );
        const dados = await resp.json().catch(() => ({}));
        if (!resp.ok || !dados.sucesso || !Array.isArray(dados.registros)) {
          console.error("Resposta inesperada em /api/efetividade-base:", dados);
          const detalhe = dados.detalhe ? ` Detalhe: ${dados.detalhe}` : "";
          throw new Error((dados.message || "Falha ao carregar base.") + detalhe);
        }

        const lojaAlvo = (lojaLogada || "").trim().toUpperCase();

        dbEfetividade = (dados.registros || []).filter((linha) => {
          const empresaProduto = String(linha[3] ?? "");
          const prefixo = empresaProduto.split(" : ")[0].trim().toUpperCase();
          return prefixo === lojaAlvo;
        });

        status.textContent = `Base carregada com ${dbEfetividade.length} itens da loja.`;

        // Atualiza os percentuais e totais nos dois cards
        atualizarResumoStatus();

        finalizarLoading();
      } catch (e) {
        console.error("Erro ao carregar base de dados:", e);
        status.textContent = `Erro ao carregar base de dados. ${
          e.message || ""
        }`.trim();
        finalizarLoading();
      }
    }

    /* =========================
       BUSCA LOCAL
       ==========================*/
    function buscar() {
      const campo = document.getElementById("campoBusca");
      const termoBruto = campo.value.trim();
      const termoMinusculo = termoBruto.toLowerCase();
      const status = document.getElementById("status");

      if (!termoBruto) {
        status.textContent = "Digite ou leia um código para buscar.";
        return;
      }
      if (!dbEfetividade || !dbEfetividade.length) {
        status.textContent = "Base ainda não carregada.";
        return;
      }

      const ehCodigoBarra = /^\d+$/.test(termoBruto);

      const resultados = dbEfetividade.filter((linha) => {
        const ean = String(linha[0] ?? "").trim().toLowerCase();
        const empresaProduto = String(linha[3] ?? "");
        const partes = empresaProduto.split(" : ");
        const nomeProduto = (partes[1] || partes[0] || "").trim().toLowerCase();

        return ehCodigoBarra
          ? ean === termoMinusculo
          : nomeProduto.includes(termoMinusculo);
      });

      mostrarResultados(resultados);
      status.textContent = `${resultados.length} iten(s) encontrado(s).`;
    }

    /* =========================
       EXIBIR RESULTADOS NA TELA
       ==========================*/
    function mostrarResultados(lista) {
      const container = document.getElementById("resultado");
      ultimosResultados = Array.isArray(lista) ? lista : [];

      if (!ultimosResultados.length) {
        container.innerHTML =
          '<p style="font-size: 14px; text-align:center; margin-top: 12px;">Nenhum registro encontrado.</p>';
        return;
      }

      const html = ultimosResultados
        .map((linha, idx) => {
          const [
            ean = "",
            secao = "",
            pendenteVerificado = "",
            empresaProduto = "",
            codigoProduto = "",
            qtdDisponivel = "",
            precoVdaUnitario = "",
            custoLiqUnitario = "",
            qtdPendente = "",
            diasEstoque = "",
            diasUltimaEntrada = "",
            diasSemVendas = "",
          ] = linha;

          const partes = String(empresaProduto).split(" : ");
          const produto = (partes[1] || partes[0] || "").trim();

          const statusUpper = String(pendenteVerificado || "").trim().toUpperCase();
          const chave = gerarChaveRegistro(linha);

          let statusClass = "";
          let statusLabel = pendenteVerificado;

          if (statusUpper === "VERIFICADO") {
            statusClass = "status-verificado";
            statusLabel = "✔ Verificado";
          } else if (statusUpper === "PENDENTE") {
            if (enviadosSessao.has(chave)) {
              statusClass = "status-pendente-enviado";
              statusLabel = "➜ Pendente";
            } else {
              statusClass = "status-pendente";
              statusLabel = "⏳ Pendente";
            }
          }

          return `
          <div class="cartao" onclick="prepararEnvio(${idx})">
            <div class="cartao-header">${produto || "Produto"}</div>
            <table class="cartao-table" aria-label="Dados do produto">
              <tr>
                <th>Status</th>
                <td>
                  <span
                    id="status-cell-${idx}"
                    data-key="${chave}"
                    class="${statusClass}"
                  >
                    ${statusLabel}
                  </span>
                </td>
              </tr>
              <tr><th>EAN</th><td>${ean}</td></tr>
              <tr><th>Seção</th><td>${secao}</td></tr>
              <tr><th>Qtd. Disponível</th><td>${qtdDisponivel}</td></tr>
              <tr><th>Preço Vda Unitário</th><td>${precoVdaUnitario}</td></tr>
              <tr><th>Custo Liq. Unitário</th><td>${custoLiqUnitario}</td></tr>
              <tr><th>Pend. Ped.Compra</th><td>${qtdPendente}</td></tr>
              <tr><th>Dias de Estoque</th><td>${diasEstoque}</td></tr>
              <tr><th>Dias Ult. Entrada</th><td>${diasUltimaEntrada}</td></tr>
              <tr><th>Dias Sem Vendas</th><td>${diasSemVendas}</td></tr>
            </table>
          </div>
        `;
        })
        .join("");

      container.innerHTML = html;
    }

    /* =========================
       POPUP "JÁ VERIFICADO"
       ==========================*/
    function mostrarAlertaVerificado() {
      document.getElementById("alertOverlay").style.display = "flex";
    }

    function fecharAlertaVerificado() {
      document.getElementById("alertOverlay").style.display = "none";
    }

    /* =========================
       PREPARAR ENVIO (ANTES DO POPUP)
       ==========================*/
    function prepararEnvio(idx) {
      const status = document.getElementById("status");
      if (!ultimosResultados || !ultimosResultados[idx]) {
        status.textContent = "Não foi possível identificar o registro selecionado.";
        return;
      }

      const linhaBase = ultimosResultados[idx];

      const pendenteVerificado = String(linhaBase[2] ?? "").trim().toUpperCase();
      if (pendenteVerificado === "VERIFICADO") {
        mostrarAlertaVerificado();
        return;
      }

      const obs = document.getElementById("observacao").value.trim();

      if (!lojaLogada || !usuarioLogado) {
        status.textContent = "Sessão inválida. Faça login novamente.";
        return;
      }

      envioPendente = { idx, linhaBase, observacao: obs };
      document.getElementById("confirmOverlay").style.display = "flex";
    }

    /* =========================
       MARCAR REGISTRO COMO "PENDENTE ENVIADO" NA SESSÃO
       ==========================*/
    function marcarRegistroComoEnviadoNaSessao(idx, linhaBase) {
      if (typeof idx !== "number" || !linhaBase) return;

      const chave = gerarChaveRegistro(linhaBase);
      enviadosSessao.add(chave);

      const spanStatus = document.getElementById(`status-cell-${idx}`);
      if (spanStatus) {
        spanStatus.classList.remove("status-pendente", "status-verificado");
        spanStatus.classList.add("status-pendente-enviado");
        spanStatus.textContent = "➜ Pendente";
      }
    }

    /* =========================
       CONFIRMAÇÃO (SIM / NÃO)
       ==========================*/
    async function confirmarEnvio(confirmado) {
      const overlay = document.getElementById("confirmOverlay");
      const status = document.getElementById("status");

      if (!confirmado) {
        overlay.style.display = "none";
        envioPendente = null;
        status.textContent = "Envio cancelado.";
        return;
      }

      if (!envioPendente) {
        overlay.style.display = "none";
        return;
      }

      const { idx, linhaBase, observacao } = envioPendente;
      envioPendente = null;
      overlay.style.display = "none";

      // Monta o payload padrão da API
      const payload = {
        registroBase: linhaBase,
        loja: lojaLogada,
        usuario: usuarioLogado,
        observacao,
      };

      // Se NÃO houver conexão, guarda em fila offline e não tenta chamar a API agora
      if (!navigator.onLine) {
        adicionarNaFilaOffline(payload);
        status.textContent =
          "Sem conexão. Lançamento armazenado e será enviado automaticamente quando a internet voltar.";

        // Vibração curta (opcional) para feedback
        if (navigator.vibrate) {
          navigator.vibrate(60);
        }

        // Visualmente já marca como "pendente enviado" na sessão
        marcarRegistroComoEnviadoNaSessao(idx, linhaBase);
        return;
      }

      // Fluxo normal online
      status.textContent = "Enviando lançamento...";

      try {
        const resposta = await fetch("/api/efetividade-lancar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const dados = await resposta.json().catch(() => ({}));
        if (!resposta.ok || !dados.sucesso) {
          status.textContent = dados.message || "Erro ao registrar lançamento.";
          return;
        }

        status.textContent =
          dados.message || "Lançamento registrado com sucesso.";
        document.getElementById("observacao").value = "";

        // Vibração curta ao registrar (onde suportado)
        if (navigator.vibrate) {
          navigator.vibrate(100);
        }

        // Marca o registro como "pendente enviado" (amarelo) nesta sessão
        marcarRegistroComoEnviadoNaSessao(idx, linhaBase);

        // Depois de um envio bem-sucedido, tenta processar qualquer fila pendente antiga
        processarFilaOffline();
      } catch (e) {
        console.error("Erro ao enviar lançamento:", e);
        status.textContent = "Erro de conexão ao enviar lançamento.";
      }
    }

    /* =========================
       CÂMERA / LEITOR DE CÓDIGO
       ==========================*/
    function abrirCamera() {
      const area = document.getElementById("cameraArea");
      const msg = document.getElementById("msgCamera");
      const video = document.getElementById("video");
      area.style.display = "block";
      msg.textContent = "Abrindo câmera...";

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        msg.textContent =
          "Este dispositivo ou navegador não permite acesso à câmera neste contexto.";
        return;
      }

      navigator.mediaDevices
        .getUserMedia({ video: { facingMode: "environment" } })
        .then((stream) => {
          streamAtual = stream;
          video.srcObject = stream;
          video.play();
          msg.textContent = "Aponte para o código de barras...";
          iniciarLeitura(video, msg);
        })
        .catch((err) => {
          msg.textContent = "Erro ao acessar câmera: " + err.message;
        });
    }

    async function iniciarLeitura(video, msg) {
      if (!("BarcodeDetector" in window)) {
        msg.textContent =
          "Leitura automática não suportada neste navegador. Digite o código manualmente.";
        return;
      }

      const detector = new BarcodeDetector({
        formats: ["ean_13", "ean_8", "code_128"],
      });
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      lendo = true;

      async function scan() {
        if (!lendo) return;
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          try {
            const codes = await detector.detect(canvas);
            if (codes.length > 0) {
              const code = codes[0].rawValue;
              msg.textContent = "Detectado: " + code;
              beep();
              document.getElementById("campoBusca").value = code;
              fecharCamera();
              buscar();
              return;
            }
          } catch (e) {
            // ignora erros do detector
          }
        }
        requestAnimationFrame(scan);
      }
      scan();
    }

    function fecharCamera() {
      lendo = false;
      if (streamAtual) {
        streamAtual.getTracks().forEach((t) => t.stop());
      }
      document.getElementById("video").srcObject = null;
      document.getElementById("cameraArea").style.display = "none";
    }

    /* =========================
       SAIR (LIMPA SESSÃO)
       ==========================*/
    function limparSessaoEfetividade() {
      try {
        localStorage.removeItem("efetividadeSession");
      } catch (e) {
        console.warn("Não foi possível limpar efetividadeSession:", e);
      }
    }
  </script>
</body>
</html>

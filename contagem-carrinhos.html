<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contagem de Carrinhos</title>

  <!-- Evita cache ‚Äúenganoso‚Äù ao voltar (n√£o √© seguran√ßa, √© UX) -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    body{
      background:#f3f3f3;
      font-family: Arial, sans-serif;
      margin:2;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      color:#111;
    }

    .container{
      width: 95%;
      max-width: 720px;
      background:#fff;
      padding: 22px 22px 18px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      box-sizing:border-box;
      margin-top: 18px;
    }

    .titulo{
      text-align:center;
      margin: 0 0 12px;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
    }

    .card-info{
      background: #f7f7f7;
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      padding: 12px 12px;
      margin-bottom: 12px;
      font-size: 13px;
      line-height: 1.45;
    }

    .linha{
      display:flex;
      justify-content: space-between;
      gap: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .k{ color:#555; font-weight:700; }
    .v{ font-weight:800; overflow:hidden; text-overflow:ellipsis; }

    .card-total{
      background:#f7f8ff;
      border: 1px solid #e0e3ff;
      border-radius: 10px;
      padding: 14px 12px;
      margin-bottom: 14px;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
    }

    .total-label{
      font-weight: 800;
      color:#111;
      font-size: 13px;
    }

    .total-valor{
      font-weight: 900;
      font-size: 24px;
      color:#0066ff;
      line-height: 1;
    }

    /* ===== GRID (2 colunas) ===== */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .campo{
      display:flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    /* ===== Label com imagem ao lado ===== */
    .campo label{
      font-weight: 800;
      font-size: 13px;
      color:#111;

      display: inline-flex;
      align-items: center;
      gap: 8px;
      line-height: 1.2;
    }

    .campo label img{
      width: 1.7cm;
      height: 1.7cm;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #e6e6e6;
      background: #fff;
      flex: 0 0 auto;
    }

    .input{
      width:100%;
      box-sizing:border-box;
      border-radius: 8px;
      border: 1px solid #c3c3c3;
      padding: 10px 12px;
      font-size: 14px;
      background:#fff;
      outline:none;
    }

    .input:focus{
      border-color:#0066ff;
      box-shadow: 0 0 0 1px #0066ff33;
    }

    .linha-1{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .linha-1 .campo{ flex:1 1 240px; }

    .btn{
      width:100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 800;
      margin-top: 12px;
    }

    .btn-prim{
      background:#0066ff;
      color:#fff;
    }
    .btn-prim:hover{ background:#0050cc; }

    .btn-sec{
      background:#e9e9e9;
      color:#111;
    }
    .btn-sec:hover{ background:#dedede; }

    .mensagem{
      margin-top: 10px;
      text-align:center;
      font-weight:800;
      font-size: 13px;
      min-height: 18px;
      color:#b30000;
    }

    .ok{ color:#1b5e20; }

    .hidden{ display:none !important; }

    /* Tela ‚Äúsem sess√£o‚Äù */
    .tela-erro{
      width:100%;
      min-height: 70vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card-erro{
      background:#fff;
      padding: 20px 18px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      max-width: 520px;
      width: 95%;
      text-align:center;
    }
    .card-erro h2{ margin: 0 0 8px; color:#c00000; }
    .card-erro p{ margin: 0 0 12px; color:#333; font-weight:700; }
  </style>
</head>

<body>
  <div class="container">
    <h2 class="titulo">CONTAGEM DE CARRINHOS</h2>

    <!-- Modo SEM sess√£o -->
    <div id="telaSemSessao" class="tela-erro hidden">
      <div class="card-erro">
        <h2>Login necess√°rio</h2>
        <p>Voc√™ precisa estar logado para acessar esta p√°gina.</p>
        <button class="btn btn-prim" id="btnIrLogin">Ir para o Login</button>
      </div>
    </div>

    <!-- App -->
    <div id="app" class="hidden">
      <div class="card-info">
        <div class="linha"><span class="k">Loja:</span> <span class="v" id="infoLoja">‚Äî</span></div>
        <div class="linha"><span class="k">Usu√°rio:</span> <span class="v" id="infoUsuario">‚Äî</span></div>
        <div class="linha"><span class="k">Perfil:</span> <span class="v" id="infoPerfil">‚Äî</span></div>
      </div>

      <div class="card-total">
        <div class="total-label">Soma total (todos os campos)</div>
        <div class="total-valor" id="totalCarrinhos">0</div>
      </div>

      <!-- Data de contagem (coluna D) -->
      <div class="linha-1">
        <div class="campo">
          <label for="dataLancamento">Data Contagem:</label>
          <input id="dataLancamento" class="input" type="date" required />
        </div>
      </div>

      <!-- Contagens (colunas E em diante) - 2 colunas -->
      <div class="grid" aria-label="Contagem por tipo de carrinho">
        <!-- E -->
        <div class="campo">
          <label for="duplocar120">
            <img src="https://i.ibb.co/zHG5pgJx/SAVE-20260107-131849.jpg" alt="Duplocar 120L" loading="lazy" />
            Duplocar 120L:
          </label>
          <input id="duplocar120" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- F -->
        <div class="campo">
          <label for="grande160">
            <img src="https://i.ibb.co/wZYw1WKt/SAVE-20260107-131727.jpg" alt="Grande 160L" loading="lazy" />
            Grande 160L:
          </label>
          <input id="grande160" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- G -->
        <div class="campo">
          <label for="bebeConforto160">
            <img src="https://i.ibb.co/Ps456g78/SAVE-20260107-132011.jpg" alt="Beb√™ conforto 160L" loading="lazy" />
            Beb√™ conforto 160L:
          </label>
          <input id="bebeConforto160" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- H -->
        <div class="campo">
          <label for="maxcar200">
            <img src="https://i.ibb.co/2Y603KFw/SAVE-20260107-132118.jpg" alt="Maxcar 200L" loading="lazy" />
            Maxcar 200L:
          </label>
          <input id="maxcar200" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- I -->
        <div class="campo">
          <label for="macrocar300">
            <img src="https://i.ibb.co/x8Hk31yd/SAVE-20260107-132214.jpg" alt="Macrocar 300L" loading="lazy" />
            Macrocar 300L:
          </label>
          <input id="macrocar300" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- J -->
        <div class="campo">
          <label for="pranchaJacare">
            <img src="https://i.ibb.co/WpBV6GPx/SAVE-20260107-132332.jpg" alt="Prancha Jacar√©" loading="lazy" />
            Prancha Jacar√©:
          </label>
          <input id="pranchaJacare" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- K -->
        <div class="campo">
          <label for="compraKids">
            <img src="https://i.ibb.co/k2Rz14Wh/SAVE-20260107-132741.jpg" alt="Compra Kids" loading="lazy" />
            Compra Kids:
          </label>
          <input id="compraKids" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- L -->
        <div class="campo">
          <label for="bebeJipinho">
            <img src="https://i.ibb.co/hJGdW6SP/SAVE-20260107-132325.jpg" alt="Beb√™ Jipinho" loading="lazy" />
            Beb√™ Jipinho:
          </label>
          <input id="bebeJipinho" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- M -->
        <div class="campo">
          <label for="cestinha">
            <img src="https://i.ibb.co/Q40c8y7/SAVE-20260107-132900.jpg" alt="Cestinha" loading="lazy" />
            Cestinha:
          </label>
          <input id="cestinha" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- N -->
        <div class="campo">
          <label for="cadeiraRodas">
            <img src="https://i.ibb.co/sdp6hPzN/file-00000000b954720ea6b9b2e95516ed0a.png" alt="Cadeira de rodas" loading="lazy" />
            Cadeira de rodas:
          </label>
          <input id="cadeiraRodas" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- O -->
        <div class="campo">
          <label for="carrinhosQuebrados">
            <img src="https://i.ibb.co/ZpwFJf5H/file-0000000062a0720e86cbcca63bfd8b64.png" alt="Carrinhos Quebrados" loading="lazy" />
            Carrinhos Quebrados:
          </label>
          <input id="carrinhosQuebrados" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- =========================
             ‚úÖ NOVOS CAMPOS (a partir da √∫ltima coluna em uso)
             √öltima em uso: O
             Ent√£o seguimos: P, Q, R, S
             ========================= -->

        <!-- P: Carrinhos reserva -->
        <div class="campo">
          <label for="carrinhosReserva">
            <img id="imgCarrinhosReserva" alt="Carrinhos de reserva" loading="lazy" />
            Carrinhos de reserva:
          </label>
          <input id="carrinhosReserva" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- Q: Cestinhas reserva -->
        <div class="campo">
          <label for="cestinhasReserva">
            <img id="imgCestinhasReserva" alt="Cestinhas de reserva" loading="lazy" />
            Cestinhas de reserva:
          </label>
          <input id="cestinhasReserva" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- R: Carrinhos reservados (separado do dispon√≠vel ao cliente) -->
        <div class="campo">
          <label for="carrinhosReservados">
            <img id="imgCarrinhosReservados" alt="Carrinhos reservados" loading="lazy" />
            Carrinhos reservados:
          </label>
          <input id="carrinhosReservados" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- S: Cestinhas reservadas (separado do dispon√≠vel ao cliente) -->
        <div class="campo">
          <label for="cestinhasReservadas">
            <img id="imgCestinhasReservadas" alt="Cestinhas reservadas" loading="lazy" />
            Cestinhas reservadas:
          </label>
          <input id="cestinhasReservadas" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>
      </div>

      <button class="btn btn-prim" id="btnEnviar">Enviar</button>
      <button class="btn btn-sec" id="btnVoltarMenu">Voltar ao Menu</button>

      <div class="mensagem" id="msg"></div>
    </div>
  </div>

  <script>
    const ROTAS = { login: "/login.html", menu: "/menu.html" };

    // Perfis que podem acessar esta tela
    const PERFIS_PERMITIDOS = ["GERENTE_PPP", "BASE_PPP", "ADMINISTRADOR"];

    /*
      ‚úÖ ATUALIZADO: NOVOS CAMPOS (seguindo a partir da √∫ltima coluna em uso: O).
      Colunas j√° existentes:
      E  Duplocar 120L
      F  Grande 160L
      G  Beb√™ conforto 160L
      H  Maxcar 200L
      I  Macrocar 300L
      J  Prancha Jacar√©
      K  Compra Kids
      L  Beb√™ Jipinho
      M  Cestinha
      N  Cadeira de rodas
      O  Carrinhos Quebrados

      ‚úÖ Novos campos (baseado nas melhorias solicitadas - reservas e reservados):
      P  Carrinhos de reserva
      Q  Cestinhas de reserva
      R  Carrinhos reservados (contados separadamente do dispon√≠vel ao cliente)
      S  Cestinhas reservadas (contadas separadamente do dispon√≠vel ao cliente)

      Observa√ß√£o importante (pra voc√™ n√£o cair em armadilha de dado ruim):
      - ‚ÄúReserva‚Äù e ‚ÄúReservado‚Äù n√£o s√£o a mesma coisa.
        Reserva = estoque/backup
        Reservado = separado na loja (n√£o dispon√≠vel pro cliente)
      Se voc√™ misturar, o indicador perde sentido operacional.
    */

    const CAMPOS = [
      { id: "duplocar120",        label: "Duplocar 120L",          key: "duplocar120" },
      { id: "grande160",          label: "Grande 160L",            key: "grande160" },
      { id: "bebeConforto160",    label: "Beb√™ conforto 160L",     key: "bebeConforto160" },
      { id: "maxcar200",          label: "Maxcar 200L",            key: "maxcar200" },
      { id: "macrocar300",        label: "Macrocar 300L",          key: "macrocar300" },
      { id: "pranchaJacare",      label: "Prancha Jacar√©",         key: "pranchaJacare" },
      { id: "compraKids",         label: "Compra Kids",            key: "compraKids" },
      { id: "bebeJipinho",        label: "Beb√™ Jipinho",           key: "bebeJipinho" },
      { id: "cestinha",           label: "Cestinha",               key: "cestinha" },
      { id: "cadeiraRodas",       label: "Cadeira de rodas",       key: "cadeiraRodas" },
      { id: "carrinhosQuebrados", label: "Carrinhos Quebrados",    key: "carrinhosQuebrados" },

      // ‚úÖ NOVOS (P..S)
      { id: "carrinhosReserva",     label: "Carrinhos de reserva",   key: "carrinhosReserva" },
      { id: "cestinhasReserva",     label: "Cestinhas de reserva",   key: "cestinhasReserva" },
      { id: "carrinhosReservados",  label: "Carrinhos reservados",   key: "carrinhosReservados" },
      { id: "cestinhasReservadas",  label: "Cestinhas reservadas",   key: "cestinhasReservadas" },
    ];

    let sessaoAtual = null;

    // Remove tudo que n√£o for d√≠gito (0-9)
    function soDigitos(str) {
      return String(str || "").replace(/[^\d]/g, "");
    }

    // Converte string para inteiro (default 0)
    function toInt(str) {
      const s = soDigitos(str);
      return s ? parseInt(s, 10) : 0;
    }

    // Soma total (card) - soma TODOS os campos listados em CAMPOS
    function atualizarTotal() {
      const total = CAMPOS.reduce((acc, c) => acc + toInt(document.getElementById(c.id).value), 0);
      document.getElementById("totalCarrinhos").textContent = String(total);
    }

    // Aplica m√°scara "somente n√∫meros" em tempo real
    function aplicarMascaraSomenteNumero(inputEl) {
      inputEl.value = soDigitos(inputEl.value);
      atualizarTotal();
    }

    // Busca sess√£o do backend (/api/session)
    async function obterSessaoDoBackend() {
      try {
        const resp = await fetch("/api/session", {
          method: "GET",
          credentials: "include",
          headers: { "Accept": "application/json" }
        });

        if (!resp.ok) return null;

        const dados = await resp.json().catch(() => null);
        if (!dados || !dados.sucesso || !dados.usuario || !dados.loja || !dados.perfil) return null;
        return dados;
      } catch (e) {
        console.error("[CARRINHOS] Falha ao consultar /api/session:", e);
        return null;
      }
    }

    function mostrarSemSessao() {
      document.getElementById("app").classList.add("hidden");
      document.getElementById("telaSemSessao").classList.remove("hidden");
    }

    function mostrarApp() {
      document.getElementById("telaSemSessao").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
    }

    function setMsg(texto, ok=false) {
      const el = document.getElementById("msg");
      el.classList.toggle("ok", !!ok);
      el.textContent = texto || "";
    }

    // ‚úÖ Valida√ß√£o: todos os campos obrigat√≥rios (incluindo os NOVOS)
    function validarFormulario() {
      const dataLanc = (document.getElementById("dataLancamento").value || "").trim();
      if (!dataLanc) return "Selecione a Data Contagem.";

      for (const c of CAMPOS) {
        const v = (document.getElementById(c.id).value || "").trim();
        if (v === "") return `Preencha: ${c.label}.`;
        if (!/^\d+$/.test(v)) return `Use somente n√∫meros em: ${c.label}.`;
      }

      return "";
    }

    // Converte "YYYY-MM-DD" para "DD/MM/AAAA"
    function isoParaBR(iso) {
      const s = String(iso || "").trim();
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return s;
      return `${m[3]}/${m[2]}/${m[1]}`;
    }

    async function enviar() {
      setMsg("");

      if (!sessaoAtual) {
        mostrarSemSessao();
        return;
      }

      const perfil = String(sessaoAtual.perfil || "").trim().toUpperCase();
      if (!PERFIS_PERMITIDOS.includes(perfil)) {
        setMsg("Acesso negado: seu perfil n√£o tem permiss√£o para esta tela.");
        return;
      }

      const erro = validarFormulario();
      if (erro) {
        setMsg(erro);
        return;
      }

      const btn = document.getElementById("btnEnviar");
      btn.disabled = true;

      try {
        const dataISO = (document.getElementById("dataLancamento").value || "").trim();

        // Payload (/api/carrinhos)
        const payload = {
          dataLancamento: isoParaBR(dataISO),
          contagens: CAMPOS.reduce((acc, c) => {
            acc[c.key] = toInt(document.getElementById(c.id).value);
            return acc;
          }, {})
        };

        const resp = await fetch("/api/carrinhos", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json", "Accept": "application/json" },
          body: JSON.stringify(payload)
        });

        const dados = await resp.json().catch(() => ({}));

        if (resp.status === 401 || resp.status === 403) {
          mostrarSemSessao();
          setMsg("Sess√£o inv√°lida/expirada. Fa√ßa login novamente.");
          return;
        }

        if (!resp.ok || !dados.sucesso) {
          setMsg(dados.message || "Erro ao enviar contagem.");
          return;
        }

        setMsg(dados.message || "Contagem enviada com sucesso.", true);

        // Limpa campos (mant√©m data)
        CAMPOS.forEach(c => document.getElementById(c.id).value = "");
        atualizarTotal();
      } catch (e) {
        console.error(e);
        setMsg("Erro de conex√£o ao enviar. Tente novamente.");
      } finally {
        btn.disabled = false;
      }
    }

    /* =========================
       ‚úÖ IMAGENS (sem depender de link externo)
       - data URI SVG simples para os NOVOS campos
       - fica est√°vel, r√°pido e n√£o quebra se link cair
       ========================= */

    function svgDataUri(svg) {
      return "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg);
    }

    function setNewFieldImages() {
      const baseStyle = (emoji, title) => `
        <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 128 128">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#f7f8ff"/>
              <stop offset="1" stop-color="#e0e3ff"/>
            </linearGradient>
          </defs>
          <rect x="6" y="6" width="116" height="116" rx="18" fill="url(#g)" stroke="#e6e6e6" stroke-width="3"/>
          <text x="64" y="74" text-anchor="middle" font-size="56">${emoji}</text>
          <text x="64" y="104" text-anchor="middle" font-size="14" font-family="Arial" font-weight="700" fill="#111">${title}</text>
        </svg>
      `;

      // P: Carrinhos reserva
      const svgCarrinhosReserva = baseStyle("üõí", "Reserva");
      // Q: Cestinhas reserva
      const svgCestinhasReserva = baseStyle("üß∫", "Reserva");
      // R: Carrinhos reservados
      const svgCarrinhosReservados = baseStyle("üîí", "Reservado");
      // S: Cestinhas reservadas
      const svgCestinhasReservadas = baseStyle("üîí", "Reservado");

      document.getElementById("imgCarrinhosReserva").src = svgDataUri(svgCarrinhosReserva);
      document.getElementById("imgCestinhasReserva").src = svgDataUri(svgCestinhasReserva);
      document.getElementById("imgCarrinhosReservados").src = svgDataUri(svgCarrinhosReservados);
      document.getElementById("imgCestinhasReservadas").src = svgDataUri(svgCestinhasReservadas);
    }

    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("btnIrLogin").addEventListener("click", () => {
        window.location.href = ROTAS.login;
      });

      document.getElementById("btnVoltarMenu").addEventListener("click", () => {
        window.location.href = ROTAS.menu;
      });

      document.getElementById("btnEnviar").addEventListener("click", enviar);

      // ‚úÖ Setar imagens dos novos campos (P..S)
      setNewFieldImages();

      // Inputs: s√≥ n√∫meros, sem ponto/virgula
      CAMPOS.forEach(c => {
        const el = document.getElementById(c.id);
        el.addEventListener("input", () => aplicarMascaraSomenteNumero(el));
      });

      atualizarTotal();

      // Valida sess√£o
      const s = await obterSessaoDoBackend();
      if (!s) {
        mostrarSemSessao();
        return;
      }

      const perfil = String(s.perfil || "").trim().toUpperCase();
      if (!PERFIS_PERMITIDOS.includes(perfil)) {
        mostrarApp();
        document.getElementById("infoLoja").textContent = s.loja;
        document.getElementById("infoUsuario").textContent = s.usuario;
        document.getElementById("infoPerfil").textContent = s.perfil;
        setMsg("Acesso negado: seu perfil n√£o tem permiss√£o para esta tela.");
        document.getElementById("btnEnviar").disabled = true;
        return;
      }

      sessaoAtual = s;
      mostrarApp();

      document.getElementById("infoLoja").textContent = s.loja;
      document.getElementById("infoUsuario").textContent = s.usuario;
      document.getElementById("infoPerfil").textContent = s.perfil;
    });
  </script>

  <!-- Fontes confi√°veis -->
  <!-- fetch + credentials/cookies: https://developer.mozilla.org/en-US/docs/Web/API/fetch -->
  <!-- input date: https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/date -->
  <!-- Data URI (SVG): https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Data_URLs -->
  <!-- encodeURIComponent: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent -->
  <!-- img loading=lazy: https://developer.mozilla.org/en-US/docs/Web/Performance/Lazy_loading -->
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contagem de Carrinhos</title>

  <!-- Evita cache ‚Äúenganoso‚Äù ao voltar (n√£o √© seguran√ßa, √© UX) -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    body{
      background:#f3f3f3;
      font-family: Arial, sans-serif;
      margin:2;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      color:#111;
    }

    .container{
      width: 95%;
      max-width: 720px;
      background:#fff;
      padding: 22px 22px 18px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      box-sizing:border-box;
      margin-top: 18px;
    }

    .titulo{
      text-align:center;
      margin: 0 0 12px;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
    }

    .card-info{
      background: #f7f7f7;
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      padding: 12px 12px;
      margin-bottom: 12px;
      font-size: 13px;
      line-height: 1.45;
    }

    .linha{
      display:flex;
      justify-content: space-between;
      gap: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .k{ color:#555; font-weight:700; }
    .v{ font-weight:800; overflow:hidden; text-overflow:ellipsis; }

    /* ====== TOTAIS LADO A LADO (inclusive no celular) ====== */
    .totais-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 12px;
    }

    /* Card total (ajustado: t√≠tulo em cima do valor) */
    .card-total{
      background:#f7f8ff;
      border: 1px solid #e0e3ff;
      border-radius: 10px;
      padding: 14px 12px;
      margin: 0; /* agora o espa√ßamento √© do .totais-row */
      display:flex;
      flex-direction: column;
      align-items:flex-start;
      gap: 6px;
      min-width: 0;
    }

    .total-label{
      font-weight: 900;
      color:#111;
      font-size: 13px;
      line-height: 1.1;
    }

    .total-valor{
      font-weight: 900;
      font-size: 26px;
      color:#0066ff;
      line-height: 1;
    }

    /* ===== GRID (2 colunas) - contagem principal ===== */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .campo{
      display:flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    /* ===== Label com imagem ao lado ===== */
    .campo label{
      font-weight: 800;
      font-size: 13px;
      color:#111;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      line-height: 1.2;
    }

    .campo label img{
      width: 1.7cm;
      height: 1.7cm;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #e6e6e6;
      background: #fff;
      flex: 0 0 auto;
    }

    .input{
      width:100%;
      box-sizing:border-box;
      border-radius: 8px;
      border: 1px solid #c3c3c3;
      padding: 10px 12px;
      font-size: 14px;
      background:#fff;
      outline:none;
    }

    .input:focus{
      border-color:#0066ff;
      box-shadow: 0 0 0 1px #0066ff33;
    }

    .linha-1{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .linha-1 .campo{ flex:1 1 240px; }

    .btn{
      width:100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 800;
      margin-top: 12px;
    }

    .btn-prim{
      background:#0066ff;
      color:#fff;
    }
    .btn-prim:hover{ background:#0050cc; }

    .btn-sec{
      background:#e9e9e9;
      color:#111;
    }
    .btn-sec:hover{ background:#dedede; }

    .mensagem{
      margin-top: 10px;
      text-align:center;
      font-weight:800;
      font-size: 13px;
      min-height: 18px;
      color:#b30000;
    }

    .ok{ color:#1b5e20; }
    .hidden{ display:none !important; }

    /* Tela ‚Äúsem sess√£o‚Äù */
    .tela-erro{
      width:100%;
      min-height: 70vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card-erro{
      background:#fff;
      padding: 20px 18px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      max-width: 520px;
      width: 95%;
      text-align:center;
    }
    .card-erro h2{ margin: 0 0 8px; color:#c00000; }
    .card-erro p{ margin: 0 0 12px; color:#333; font-weight:700; }

    /* ==== Cards ‚Äúseparadores‚Äù ==== */
    .card-box{
      margin-top: 12px;
      background:#fff;
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      padding: 12px;
    }
    .card-box h3{
      margin: 0 0 8px;
      font-size: 14px;
      font-weight: 900;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .icon{
      width: 22px;
      height: 22px;
      display:inline-block;
      vertical-align: middle;
    }

    /* Fundo cinza clarinho (bem suave) */
    .card-soft{
      background:#f7f7f7;
      border-color:#e6e6e6;
    }

    /* Grid interna SEMPRE 2 colunas (inclusive no celular) */
    .card-grid-2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    /* MOVIMENTA√á√ÉO: 3 colunas iguais */
    .mov-row{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      align-items: end;
    }

    @media (max-width: 420px){
      .mov-row{ gap: 8px; }
      .totais-row{ gap: 8px; }
      .total-valor{ font-size: 24px; }
    }

    .pill{
      display:inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      background:#f3f3f3;
      border:1px solid #e6e6e6;
    }
    .pill.neg{ color:#b30000; }
    .pill.pos{ color:#1b5e20; }

    /* =====================================================================================
      ‚úÖ NOVO: Progresso 0‚Äì100% (de 5 em 5)
    ===================================================================================== */
    .loading-box{
      margin-top: 10px;
      background:#f7f7f7;
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      padding: 10px 12px;
    }
    .loading-top{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
      font-weight: 900;
      font-size: 13px;
      color:#111;
    }
    .loading-bar{
      width:100%;
      height: 10px;
      border-radius: 999px;
      background:#e9e9e9;
      overflow:hidden;
      border:1px solid #dedede;
    }
    .loading-fill{
      height:100%;
      width:0%;
      background:#0066ff;
      border-radius: 999px;
      transition: width .12s linear;
    }
    .loading-sub{
      margin-top: 6px;
      font-size: 12px;
      color:#555;
      font-weight: 700;
      text-align: right;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2 class="titulo">CONTAGEM DE CARRINHOS</h2>

    <!-- Modo SEM sess√£o -->
    <div id="telaSemSessao" class="tela-erro hidden">
      <div class="card-erro">
        <h2>Login necess√°rio</h2>
        <p>Voc√™ precisa estar logado para acessar esta p√°gina.</p>
        <button class="btn btn-prim" id="btnIrLogin">Ir para o Login</button>
      </div>
    </div>

    <!-- App -->
    <div id="app" class="hidden">
      <div class="card-info">
        <div class="linha"><span class="k">Loja:</span> <span class="v" id="infoLoja">‚Äî</span></div>
        <div class="linha"><span class="k">Usu√°rio:</span> <span class="v" id="infoUsuario">‚Äî</span></div>
        <div class="linha"><span class="k">Perfil:</span> <span class="v" id="infoPerfil">‚Äî</span></div>
      </div>

      <!-- ‚úÖ Totais lado a lado -->
      <div class="totais-row">
        <div class="card-total">
          <div class="total-label">Total de carrinhos</div>
          <div class="total-valor" id="totalCarrinhos">0</div>
        </div>

        <div class="card-total">
          <div class="total-label">Total de cestinhas</div>
          <div class="total-valor" id="totalCestinhas">0</div>
        </div>
      </div>

      <!-- Data de contagem (coluna D) -->
      <div class="linha-1">
        <div class="campo">
          <label for="dataLancamento">Data Contagem:</label>
          <input id="dataLancamento" class="input" type="date" required />
        </div>
      </div>

      <!-- ====== CONTAGEM PRINCIPAL (carrinhos) ====== -->
      <div class="grid" aria-label="Contagem por tipo de carrinho">
        <div class="campo">
          <label for="duplocar120">
            <img src="https://i.ibb.co/d00R9n4p/1001340222.png" alt="Duplocar 120L" loading="lazy" />
            Duplocar 120L:
          </label>
          <input id="duplocar120" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <div class="campo">
          <label for="grande160">
            <img src="https://i.ibb.co/21ybNLZL/1001340221.png" alt="Grande 160L" loading="lazy" />
            Grande 160L:
          </label>
          <input id="grande160" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <div class="campo">
          <label for="bebeConforto160">
            <img src="https://i.ibb.co/ymJqvr5c/1001340229.png" alt="Beb√™ conforto 160L" loading="lazy" />
            Beb√™ conforto 160L:
          </label>
          <input id="bebeConforto160" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <div class="campo">
          <label for="maxcar200">
            <img src="https://i.ibb.co/ymPcqNWL/1001340230.png" alt="Maxcar 200L" loading="lazy" />
            Maxcar 200L:
          </label>
          <input id="maxcar200" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <div class="campo">
          <label for="macrocar300">
            <img src="https://i.ibb.co/x8KD8SMn/1001340231.png" alt="Macrocar 300L" loading="lazy" />
            Macrocar 300L:
          </label>
          <input id="macrocar300" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <div class="campo">
          <label for="pranchaJacare">
            <img src="https://i.ibb.co/jvsjrBGM/1001340272.png" alt="Prancha Jacar√©" loading="lazy" />
            Prancha Jacar√©:
          </label>
          <input id="pranchaJacare" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <div class="campo">
          <label for="compraKids">
            <img src="https://i.ibb.co/27mvLyS4/1001340273.png" alt="Compra Kids" loading="lazy" />
            Compra Kids:
          </label>
          <input id="compraKids" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <div class="campo">
          <label for="carrinhoGaiolaPet">
            <img src="https://i.ibb.co/Jwz089CQ/file-0000000058c8720e957da3a8f8ac8d28.png" alt="Carrinho gaiola pet" loading="lazy" />
            Carrinho gaiola pet:
          </label>
          <input id="carrinhoGaiolaPet" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <div class="campo">
          <label for="bebeJipinho">
            <img src="https://i.ibb.co/mFz3xj39/1001340271.png" alt="Beb√™ Jipinho" loading="lazy" />
            Beb√™ Jipinho:
          </label>
          <input id="bebeJipinho" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>
      </div>

      <!-- ====== CARD: ITENS ESPECIAIS ====== -->
      <div class="card-box card-soft">
        <h3>
          <img class="icon" id="icoEspeciais" alt="√çcone especiais" />
          Itens especiais
        </h3>

        <div class="card-grid-2">
          <div class="campo">
            <label for="cestinha">
              <img src="https://i.ibb.co/1fv1GX7R/1001340274.png" alt="Cestinha" loading="lazy" />
              Cestinha:
            </label>
            <input id="cestinha" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
          </div>

          <div class="campo">
            <label for="cadeiraRodas">
              <img src="https://i.ibb.co/sdp6hPzN/file-00000000b954720ea6b9b2e95516ed0a.png" alt="Cadeira de rodas" loading="lazy" />
              Cadeira de rodas:
            </label>
            <input id="cadeiraRodas" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
          </div>

          <div class="campo">
            <label for="carrinhosQuebrados">
              <img src="https://i.ibb.co/ZpwFJf5H/file-0000000062a0720e86cbcca63bfd8b64.png" alt="Carrinhos Quebrados" loading="lazy" />
              Carrinhos Quebrados:
            </label>
            <input id="carrinhosQuebrados" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
          </div>
        </div>
      </div>

      <!-- ====== CARD: RESERVAS ====== -->
      <div class="card-box card-soft">
        <h3>
          <img class="icon" id="icoReserva" alt="√çcone reservas" />
          Reservas
        </h3>

        <div class="card-grid-2">
          <div class="campo">
            <label for="carrinhosReserva">
              <img id="imgCarrinhosReserva" alt="Carrinhos de reserva" loading="lazy" />
              Carrinhos de reserva:
            </label>
            <input id="carrinhosReserva" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
          </div>

          <div class="campo">
            <label for="cestinhasReserva">
              <img id="imgCestinhasReserva" alt="Cestinhas de reserva" loading="lazy" />
              Cestinhas de reserva:
            </label>
            <input id="cestinhasReserva" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
          </div>
        </div>
      </div>

      <!-- ====== CARD: MOVIMENTA√á√ÉO ====== -->
      <div class="card-box card-soft">
        <h3>
          <img class="icon" id="icoMov" alt="√çcone movimenta√ß√£o" />
          Movimenta√ß√£o de carrinhos <span id="pillMov" class="pill">0</span>
        </h3>

        <div class="mov-row">
          <div class="campo">
            <label for="movTipo">Dire√ß√£o:</label>
            <select id="movTipo" class="input">
              <option value="ENTRADA">Entrada</option>
              <option value="SAIDA">Sa√≠da</option>
            </select>
          </div>

          <div class="campo">
            <label for="movCategoria">Motivo:</label>
            <select id="movCategoria" class="input">
              <option value="MOVI_ENTRE_LOJAS">Movi. entre lojas</option>
              <option value="MOVI_MANUTENCAO">Movi. Manuten√ß√£o</option>
              <option value="ENTRADA_NOVOS">Entrada novos</option>
            </select>
          </div>

          <div class="campo">
            <label for="movQtd">Qtd.:</label>
            <input id="movQtd" class="input" inputmode="numeric" autocomplete="off" placeholder="0" required />
          </div>
        </div>
      </div>

      <button class="btn btn-prim" id="btnEnviar">Enviar</button>
      <button class="btn btn-sec" id="btnVoltarMenu">Voltar ao Menu</button>

      <!-- ‚úÖ NOVO: Progresso (0‚Äì100% de 5 em 5) -->
      <div id="loadingBox" class="loading-box hidden" aria-live="polite">
        <div class="loading-top">
          <div>Enviando...</div>
          <div id="loadingPct">0%</div>
        </div>
        <div class="loading-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <div id="loadingFill" class="loading-fill"></div>
        </div>
        <div class="loading-sub" id="loadingSub">Aguarde</div>
      </div>

      <div class="mensagem" id="msg"></div>
    </div>
  </div>

  <script>
    const ROTAS = { login: "/login.html", menu: "/menu.html" };
    const PERFIS_PERMITIDOS = ["GERENTE_PPP", "BASE_PPP", "ADMINISTRADOR"];

    const CAMPOS_CONTAGEM = [
      { id: "duplocar120",        label: "Duplocar 120L",          key: "duplocar120" },
      { id: "grande160",          label: "Grande 160L",            key: "grande160" },
      { id: "bebeConforto160",    label: "Beb√™ conforto 160L",     key: "bebeConforto160" },
      { id: "maxcar200",          label: "Maxcar 200L",            key: "maxcar200" },
      { id: "macrocar300",        label: "Macrocar 300L",          key: "macrocar300" },
      { id: "pranchaJacare",      label: "Prancha Jacar√©",         key: "pranchaJacare" },
      { id: "compraKids",         label: "Compra Kids",            key: "compraKids" },
      { id: "carrinhoGaiolaPet",  label: "Carrinho gaiola pet",    key: "carrinhoGaiolaPet" },
      { id: "bebeJipinho",        label: "Beb√™ Jipinho",           key: "bebeJipinho" },

      { id: "cestinha",           label: "Cestinha",               key: "cestinha" },
      { id: "cadeiraRodas",       label: "Cadeira de rodas",       key: "cadeiraRodas" },
      { id: "carrinhosQuebrados", label: "Carrinhos Quebrados",    key: "carrinhosQuebrados" },

      { id: "carrinhosReserva",   label: "Carrinhos de reserva",   key: "carrinhosReserva" },
      { id: "cestinhasReserva",   label: "Cestinhas de reserva",   key: "cestinhasReserva" },
    ];

    const CAMPO_MOV = {
      tipoId: "movTipo",
      categoriaId: "movCategoria",
      qtdId: "movQtd",
      key: "movCarrinhos",
      label: "Movimenta√ß√£o de carrinhos"
    };

    const IDS_TOTAL_CARRINHOS = [
      "duplocar120",
      "grande160",
      "bebeConforto160",
      "maxcar200",
      "macrocar300",
      "pranchaJacare",
      "compraKids",
      "carrinhoGaiolaPet",
      "bebeJipinho",
      "carrinhosQuebrados",
      "carrinhosReserva",
    ];

    const IDS_TOTAL_CESTINHAS = [
      "cestinha",
      "cestinhasReserva",
    ];

    let sessaoAtual = null;

    /* =====================================================================================
      ‚úÖ NOVO: Controle do loading 0‚Äì100% (de 5 em 5)
    ===================================================================================== */
    let loadingTimer = null;
    let loadingValue = 0;
    let envioEmAndamento = false;

    function setLoading(percent, subText="") {
      const box = document.getElementById("loadingBox");
      const pct = document.getElementById("loadingPct");
      const fill = document.getElementById("loadingFill");
      const sub = document.getElementById("loadingSub");
      const bar = box.querySelector('[role="progressbar"]');

      const p = Math.max(0, Math.min(100, Number(percent) || 0));
      loadingValue = p;

      pct.textContent = `${p}%`;
      fill.style.width = `${p}%`;
      if (bar) bar.setAttribute("aria-valuenow", String(p));
      if (subText) sub.textContent = subText;
    }

    function showLoading() {
      document.getElementById("loadingBox").classList.remove("hidden");
      setLoading(0, "Iniciando envio...");
    }

    function hideLoading() {
      document.getElementById("loadingBox").classList.add("hidden");
      setLoading(0, "Aguarde");
    }

    function startLoadingSim() {
      // sempre limpa antes de iniciar
      if (loadingTimer) { clearInterval(loadingTimer); loadingTimer = null; }
      showLoading();
      loadingValue = 0;

      loadingTimer = setInterval(() => {
        // vai de 0 at√© 95 de 5 em 5
        if (loadingValue >= 95) return;
        setLoading(loadingValue + 5, "Enviando dados...");
      }, 120); // ritmo suave; mant√©m sensa√ß√£o de progresso sem travar UX
    }

    function finishLoadingOk() {
      if (loadingTimer) { clearInterval(loadingTimer); loadingTimer = null; }
      setLoading(100, "Conclu√≠do");
      setTimeout(() => hideLoading(), 450);
    }

    function finishLoadingFail() {
      if (loadingTimer) { clearInterval(loadingTimer); loadingTimer = null; }
      // ainda completa para 100% (pedido: 0 a 100%), mas sinaliza falha no texto
      setLoading(100, "Finalizado (com erro)");
      setTimeout(() => hideLoading(), 650);
    }

    function soDigitos(str) { return String(str || "").replace(/[^\d]/g, ""); }
    function toInt(str) { const s = soDigitos(str); return s ? parseInt(s, 10) : 0; }

    function atualizarTotais() {
      const totalCarrinhos = IDS_TOTAL_CARRINHOS.reduce((acc, id) => acc + toInt(document.getElementById(id).value), 0);
      const totalCestinhas = IDS_TOTAL_CESTINHAS.reduce((acc, id) => acc + toInt(document.getElementById(id).value), 0);

      document.getElementById("totalCarrinhos").textContent = String(totalCarrinhos);
      document.getElementById("totalCestinhas").textContent = String(totalCestinhas);
    }

    function aplicarMascaraSomenteNumero(inputEl) {
      inputEl.value = soDigitos(inputEl.value);
      atualizarTotais();
    }

    function atualizarPillMov() {
      const tipo = document.getElementById(CAMPO_MOV.tipoId).value;
      const qtd  = toInt(document.getElementById(CAMPO_MOV.qtdId).value);

      const signed = (tipo === "SAIDA") ? -qtd : +qtd;
      const pill = document.getElementById("pillMov");
      pill.textContent = String(signed);

      pill.classList.remove("neg","pos");
      if (signed < 0) pill.classList.add("neg");
      else if (signed > 0) pill.classList.add("pos");
    }

    function aplicarMascaraMovQtd() {
      const el = document.getElementById(CAMPO_MOV.qtdId);
      el.value = soDigitos(el.value);
      atualizarPillMov();
    }

    async function obterSessaoDoBackend() {
      try {
        const resp = await fetch("/api/session", {
          method: "GET",
          credentials: "include",
          headers: { "Accept": "application/json" }
        });
        if (!resp.ok) return null;

        const dados = await resp.json().catch(() => null);
        if (!dados || !dados.sucesso || !dados.usuario || !dados.loja || !dados.perfil) return null;
        return dados;
      } catch (e) {
        console.error("[CARRINHOS] Falha ao consultar /api/session:", e);
        return null;
      }
    }

    function mostrarSemSessao() {
      document.getElementById("app").classList.add("hidden");
      document.getElementById("telaSemSessao").classList.remove("hidden");
    }

    function mostrarApp() {
      document.getElementById("telaSemSessao").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
    }

    function setMsg(texto, ok=false) {
      const el = document.getElementById("msg");
      el.classList.toggle("ok", !!ok);
      el.textContent = texto || "";
    }

    function validarFormulario() {
      const dataLanc = (document.getElementById("dataLancamento").value || "").trim();
      if (!dataLanc) return "Selecione a Data Contagem.";

      for (const c of CAMPOS_CONTAGEM) {
        const v = (document.getElementById(c.id).value || "").trim();
        if (v === "") return `Preencha: ${c.label}.`;
        if (!/^\d+$/.test(v)) return `Use somente n√∫meros em: ${c.label}.`;
      }

      const movQtdRaw = (document.getElementById(CAMPO_MOV.qtdId).value || "").trim();
      if (movQtdRaw === "") return "Preencha: Movimenta√ß√£o de carrinhos (Qtd.).";
      if (!/^\d+$/.test(movQtdRaw)) return `Use somente n√∫meros em: ${CAMPO_MOV.label}.`;

      return "";
    }

    function isoParaBR(iso) {
      const s = String(iso || "").trim();
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return s;
      return `${m[3]}/${m[2]}/${m[1]}`;
    }

    function abreviarCodigoMotivo(codigo) {
      const v = String(codigo || "").trim().toUpperCase();
      if (v === "MOVI_ENTRE_LOJAS") return "M.L";
      if (v === "MOVI_MANUTENCAO") return "M.M";
      if (v === "ENTRADA_NOVOS") return "E.N";
      return "";
    }

    function tratarMudancaMotivoMov() {
      const motivo = String(document.getElementById(CAMPO_MOV.categoriaId).value || "").toUpperCase();
      if (motivo === "ENTRADA_NOVOS") {
        document.getElementById(CAMPO_MOV.tipoId).value = "ENTRADA";
      }
      atualizarPillMov();
    }

    /* =====================================================================================
      ‚úÖ NOVO: pega os 3 d√≠gitos de milissegundos no clique (momento do clique)
    ===================================================================================== */
    function ms3NoClique() {
      const ms = new Date().getMilliseconds(); // 0..999
      return String(ms).padStart(3, "0");
    }

    async function enviar() {
      setMsg("");

      if (envioEmAndamento) {
        // trava extra contra clique repetido em device lento
        return;
      }

      if (!sessaoAtual) { mostrarSemSessao(); return; }

      const perfil = String(sessaoAtual.perfil || "").trim().toUpperCase();
      if (!PERFIS_PERMITIDOS.includes(perfil)) {
        setMsg("Acesso negado: seu perfil n√£o tem permiss√£o para esta tela.");
        return;
      }

      const erro = validarFormulario();
      if (erro) { setMsg(erro); return; }

      const btn = document.getElementById("btnEnviar");
      btn.disabled = true;
      envioEmAndamento = true;

      // ‚úÖ inicia progresso 0..100 (de 5 em 5)
      startLoadingSim();

      // ‚úÖ captura ms no momento do clique
      const clientMs3 = ms3NoClique();

      try {
        const dataISO = (document.getElementById("dataLancamento").value || "").trim();

        const contagens = CAMPOS_CONTAGEM.reduce((acc, c) => {
          acc[c.key] = toInt(document.getElementById(c.id).value);
          return acc;
        }, {});

        const movQtd = toInt(document.getElementById(CAMPO_MOV.qtdId).value);
        const movTipo = document.getElementById(CAMPO_MOV.tipoId).value;
        const movSigned = (movTipo === "SAIDA") ? -movQtd : +movQtd;

        const movCategoriaCodigo = document.getElementById(CAMPO_MOV.categoriaId).value;
        const movCategoriaAbrev = abreviarCodigoMotivo(movCategoriaCodigo);

        contagens[CAMPO_MOV.key] = movSigned;

        const payload = {
          dataLancamento: isoParaBR(dataISO),
          contagens,
          movCategoria: movCategoriaCodigo,
          movCategoriaAbrev,

          // ‚úÖ NOVO: milissegundos do clique (3 d√≠gitos)
          clientMs3
        };

        const resp = await fetch("/api/carrinhos", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json", "Accept": "application/json" },
          body: JSON.stringify(payload)
        });

        const dados = await resp.json().catch(() => ({}));

        if (resp.status === 401 || resp.status === 403) {
          mostrarSemSessao();
          setMsg("Sess√£o inv√°lida/expirada. Fa√ßa login novamente.");
          finishLoadingFail();
          return;
        }

        if (!resp.ok || !dados.sucesso) {
          setMsg(dados.message || "Erro ao enviar contagem.");
          finishLoadingFail();
          return;
        }

        setMsg(dados.message || "Contagem enviada com sucesso.", true);

        // ‚úÖ conclui o loading (0..100%)
        finishLoadingOk();

        // Limpa campos (mant√©m data)
        CAMPOS_CONTAGEM.forEach(c => document.getElementById(c.id).value = "");
        document.getElementById(CAMPO_MOV.qtdId).value = "";
        document.getElementById(CAMPO_MOV.tipoId).value = "ENTRADA";
        document.getElementById(CAMPO_MOV.categoriaId).value = "MOVI_ENTRE_LOJAS";

        atualizarTotais();
        atualizarPillMov();

      } catch (e) {
        console.error(e);
        setMsg("Erro de conex√£o ao enviar. Tente novamente.");
        finishLoadingFail();
      } finally {
        btn.disabled = false;
        envioEmAndamento = false;
      }
    }

    function svgDataUri(svg) {
      return "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg);
    }

    function svgBadge(emoji) {
      return `
        <svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 96 96">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#f7f8ff"/>
              <stop offset="1" stop-color="#e0e3ff"/>
            </linearGradient>
          </defs>
          <rect x="6" y="6" width="84" height="84" rx="16" fill="url(#g)" stroke="#e6e6e6" stroke-width="3"/>
          <text x="48" y="60" text-anchor="middle" font-size="44">${emoji}</text>
        </svg>
      `;
    }

    function setIconsAndReserveImages() {
      document.getElementById("icoMov").src = svgDataUri(svgBadge("üîÅ"));
      document.getElementById("icoEspeciais").src = svgDataUri(svgBadge("üß©"));
      document.getElementById("icoReserva").src = svgDataUri(svgBadge("üì¶"));

      document.getElementById("imgCarrinhosReserva").src = "https://i.ibb.co/Hfxhc3ff/file-00000000d2e4720e951cb0a4bdb65b70.png";
      document.getElementById("imgCestinhasReserva").src = "https://i.ibb.co/prxcgT8L/file-00000000ce88720e9b15f9e9545c779c.png";
    }

    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("btnIrLogin").addEventListener("click", () => window.location.href = ROTAS.login);
      document.getElementById("btnVoltarMenu").addEventListener("click", () => window.location.href = ROTAS.menu);
      document.getElementById("btnEnviar").addEventListener("click", enviar);

      setIconsAndReserveImages();

      CAMPOS_CONTAGEM.forEach(c => {
        const el = document.getElementById(c.id);
        el.addEventListener("input", () => aplicarMascaraSomenteNumero(el));
      });

      document.getElementById(CAMPO_MOV.qtdId).addEventListener("input", aplicarMascaraMovQtd);
      document.getElementById(CAMPO_MOV.tipoId).addEventListener("change", atualizarPillMov);
      document.getElementById(CAMPO_MOV.categoriaId).addEventListener("change", tratarMudancaMotivoMov);

      atualizarTotais();
      atualizarPillMov();

      const s = await obterSessaoDoBackend();
      if (!s) { mostrarSemSessao(); return; }

      const perfil = String(s.perfil || "").trim().toUpperCase();
      if (!PERFIS_PERMITIDOS.includes(perfil)) {
        mostrarApp();
        document.getElementById("infoLoja").textContent = s.loja;
        document.getElementById("infoUsuario").textContent = s.usuario;
        document.getElementById("infoPerfil").textContent = s.perfil;
        setMsg("Acesso negado: seu perfil n√£o tem permiss√£o para esta tela.");
        document.getElementById("btnEnviar").disabled = true;
        return;
      }

      sessaoAtual = s;
      mostrarApp();
      document.getElementById("infoLoja").textContent = s.loja;
      document.getElementById("infoUsuario").textContent = s.usuario;
      document.getElementById("infoPerfil").textContent = s.perfil;
    });

    /*
      Fontes (links confi√°veis):
      - Fetch (MDN): https://developer.mozilla.org/en-US/docs/Web/API/fetch
      - setInterval (MDN): https://developer.mozilla.org/en-US/docs/Web/API/setInterval
      - ARIA progressbar (MDN): https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/Roles/progressbar_role
    */
  </script>
</body>
</html>

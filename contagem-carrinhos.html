<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contagem de Carrinhos</title>

  <!-- Evita cache “enganoso” ao voltar (não é segurança, é UX) -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    body{
      background:#f3f3f3;
      font-family: Arial, sans-serif;
      margin:2;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      color:#111;
    }

    .container{
      width: 95%;
      max-width: 720px;
      background:#fff;
      padding: 22px 22px 18px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      box-sizing:border-box;
      margin-top: 18px;
    }

    .titulo{
      text-align:center;
      margin: 0 0 12px;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
    }

    .card-info{
      background: #f7f7f7;
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      padding: 12px 12px;
      margin-bottom: 12px;
      font-size: 13px;
      line-height: 1.45;
    }

    .linha{
      display:flex;
      justify-content: space-between;
      gap: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .k{ color:#555; font-weight:700; }
    .v{ font-weight:800; overflow:hidden; text-overflow:ellipsis; }

    .card-total{
      background:#f7f8ff;
      border: 1px solid #e0e3ff;
      border-radius: 10px;
      padding: 14px 12px;
      margin-bottom: 14px;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
    }

    .total-label{
      font-weight: 800;
      color:#111;
      font-size: 13px;
    }

    .total-valor{
      font-weight: 900;
      font-size: 24px;
      color:#0066ff;
      line-height: 1;
    }

    /* ===== GRID (2 colunas) ===== */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .campo{
      display:flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    /* ===== Label com imagem ao lado ===== */
    .campo label{
      font-weight: 800;
      font-size: 13px;
      color:#111;

      display: inline-flex;
      align-items: center;
      gap: 8px;
      line-height: 1.2;
    }

    /*
      ✅ ALTERAÇÃO: tamanho da imagem agora 1,7cm (mantém 1:1).
      Observação: object-fit: cover mantém o quadrado sem distorcer.
    */
    .campo label img{
      width: 1.7cm;
      height: 1.7cm;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #e6e6e6;
      background: #fff;
      flex: 0 0 auto;
    }

    .input{
      width:100%;
      box-sizing:border-box;
      border-radius: 8px;
      border: 1px solid #c3c3c3;
      padding: 10px 12px;
      font-size: 14px;
      background:#fff;
      outline:none;
    }

    .input:focus{
      border-color:#0066ff;
      box-shadow: 0 0 0 1px #0066ff33;
    }

    .linha-1{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .linha-1 .campo{ flex:1 1 240px; }

    .btn{
      width:100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 800;
      margin-top: 12px;
    }

    .btn-prim{
      background:#0066ff;
      color:#fff;
    }
    .btn-prim:hover{ background:#0050cc; }

    .btn-sec{
      background:#e9e9e9;
      color:#111;
    }
    .btn-sec:hover{ background:#dedede; }

    .mensagem{
      margin-top: 10px;
      text-align:center;
      font-weight:800;
      font-size: 13px;
      min-height: 18px;
      color:#b30000;
    }

    .ok{ color:#1b5e20; }

    .hidden{ display:none !important; }

    /* Tela “sem sessão” */
    .tela-erro{
      width:100%;
      min-height: 70vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card-erro{
      background:#fff;
      padding: 20px 18px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      max-width: 520px;
      width: 95%;
      text-align:center;
    }
    .card-erro h2{ margin: 0 0 8px; color:#c00000; }
    .card-erro p{ margin: 0 0 12px; color:#333; font-weight:700; }
  </style>
</head>

<body>
  <div class="container">
    <h2 class="titulo">CONTAGEM DE CARRINHOS</h2>

    <!-- Modo SEM sessão -->
    <div id="telaSemSessao" class="tela-erro hidden">
      <div class="card-erro">
        <h2>Login necessário</h2>
        <p>Você precisa estar logado para acessar esta página.</p>
        <button class="btn btn-prim" id="btnIrLogin">Ir para o Login</button>
      </div>
    </div>

    <!-- App -->
    <div id="app" class="hidden">
      <div class="card-info">
        <div class="linha"><span class="k">Loja:</span> <span class="v" id="infoLoja">—</span></div>
        <div class="linha"><span class="k">Usuário:</span> <span class="v" id="infoUsuario">—</span></div>
        <div class="linha"><span class="k">Perfil:</span> <span class="v" id="infoPerfil">—</span></div>
      </div>

      <div class="card-total">
        <div class="total-label">Soma total de carrinhos</div>
        <div class="total-valor" id="totalCarrinhos">0</div>
      </div>

      <!-- Data de contagem (coluna D) -->
      <div class="linha-1">
        <div class="campo">
          <label for="dataLancamento">Data Contagem:</label>
          <input id="dataLancamento" class="input" type="date" required />
        </div>
      </div>

      <!-- Contagens (colunas E a O) - 2 colunas -->
      <div class="grid" aria-label="Contagem por tipo de carrinho">
        <!-- Coluna E -->
        <div class="campo">
          <label for="duplocar120">
            <img src="https://i.ibb.co/zHG5pgJx/SAVE-20260107-131849.jpg" alt="Duplocar 120L" loading="lazy" />
            Duplocar 120L:
          </label>
          <input id="duplocar120" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- Coluna F -->
        <div class="campo">
          <label for="grande160">
            <img src="https://i.ibb.co/wZYw1WKt/SAVE-20260107-131727.jpg" alt="Grande 160L" loading="lazy" />
            Grande 160L:
          </label>
          <input id="grande160" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- Coluna G -->
        <div class="campo">
          <label for="bebeConforto160">
            <img src="https://i.ibb.co/Ps456g78/SAVE-20260107-132011.jpg" alt="Bebê conforto 160L" loading="lazy" />
            Bebê conforto 160L:
          </label>
          <input id="bebeConforto160" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- Coluna H -->
        <div class="campo">
          <label for="maxcar200">
            <img src="https://i.ibb.co/2Y603KFw/SAVE-20260107-132118.jpg" alt="Maxcar 200L" loading="lazy" />
            Maxcar 200L:
          </label>
          <input id="maxcar200" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- Coluna I -->
        <div class="campo">
          <label for="macrocar300">
            <img src="https://i.ibb.co/x8Hk31yd/SAVE-20260107-132214.jpg" alt="Macrocar 300L" loading="lazy" />
            Macrocar 300L:
          </label>
          <input id="macrocar300" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- Coluna J -->
        <div class="campo">
          <label for="pranchaJacare">
            <img src="https://i.ibb.co/WpBV6GPx/SAVE-20260107-132332.jpg" alt="Prancha Jacaré" loading="lazy" />
            Prancha Jacaré:
          </label>
          <input id="pranchaJacare" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- Coluna K -->
        <div class="campo">
          <label for="compraKids">
            <img src="https://i.ibb.co/k2Rz14Wh/SAVE-20260107-132741.jpg" alt="Compra Kids" loading="lazy" />
            Compra Kids:
          </label>
          <input id="compraKids" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- Coluna L -->
        <div class="campo">
          <label for="bebeJipinho">
            <img src="https://i.ibb.co/hJGdW6SP/SAVE-20260107-132325.jpg" alt="Bebê Jipinho" loading="lazy" />
            Bebê Jipinho:
          </label>
          <input id="bebeJipinho" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- Coluna M -->
        <div class="campo">
          <label for="cestinha">
            <img src="https://i.ibb.co/Q40c8y7/SAVE-20260107-132900.jpg" alt="Cestinha" loading="lazy" />
            Cestinha:
          </label>
          <input id="cestinha" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- ✅ NOVO - Coluna N -->
        <div class="campo">
          <label for="cadeiraRodas">
            <img src="https://i.ibb.co/sdp6hPzN/file-00000000b954720ea6b9b2e95516ed0a.png" alt="Cadeira de rodas" loading="lazy" />
            Cadeira de rodas:
          </label>
          <input id="cadeiraRodas" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>

        <!-- ✅ NOVO - Coluna O -->
        <div class="campo">
          <label for="carrinhosQuebrados">
            <img src="https://i.ibb.co/ZpwFJf5H/file-0000000062a0720e86cbcca63bfd8b64.png" alt="Carrinhos Quebrados" loading="lazy" />
            Carrinhos Quebrados:
          </label>
          <input id="carrinhosQuebrados" class="input" inputmode="numeric" autocomplete="off" placeholder="0" />
        </div>
      </div>

      <button class="btn btn-prim" id="btnEnviar">Enviar</button>
      <button class="btn btn-sec" id="btnVoltarMenu">Voltar ao Menu</button>

      <div class="mensagem" id="msg"></div>
    </div>
  </div>

  <script>
    const ROTAS = {
      login: "/login.html",
      menu: "/menu.html"
    };

    // Perfis que podem acessar esta tela (conforme sua regra de visibilidade do menu)
    const PERFIS_PERMITIDOS = ["GERENTE_PPP", "BASE_PPP", "ADMINISTRADOR"];

    /*
      ✅ ATUALIZADO: agora os dados vão até a coluna "O".
      Mapeamento de campos -> colunas E..O (ordem conforme sua solicitação):
      E  Duplocar 120L
      F  Grande 160L
      G  Bebê conforto 160L
      H  Maxcar 200L
      I  Macrocar 300L
      J  Prancha Jacaré
      K  Compra Kids
      L  Bebê Jipinho
      M  Cestinha
      N  Cadeira de rodas
      O  Carrinhos Quebrados
    */
    const CAMPOS = [
      { id: "duplocar120",        label: "Duplocar 120L",        key: "duplocar120" },
      { id: "grande160",          label: "Grande 160L",          key: "grande160" },
      { id: "bebeConforto160",    label: "Bebê conforto 160L",   key: "bebeConforto160" },
      { id: "maxcar200",          label: "Maxcar 200L",          key: "maxcar200" },
      { id: "macrocar300",        label: "Macrocar 300L",        key: "macrocar300" },
      { id: "pranchaJacare",      label: "Prancha Jacaré",       key: "pranchaJacare" },
      { id: "compraKids",         label: "Compra Kids",          key: "compraKids" },
      { id: "bebeJipinho",        label: "Bebê Jipinho",         key: "bebeJipinho" },
      { id: "cestinha",           label: "Cestinha",             key: "cestinha" },

      // ✅ NOVOS (N e O)
      { id: "cadeiraRodas",       label: "Cadeira de rodas",     key: "cadeiraRodas" },
      { id: "carrinhosQuebrados", label: "Carrinhos Quebrados",  key: "carrinhosQuebrados" },
    ];

    let sessaoAtual = null;

    // Remove tudo que não for dígito (0-9)
    function soDigitos(str) {
      return String(str || "").replace(/[^\d]/g, "");
    }

    // Converte string para inteiro (default 0)
    function toInt(str) {
      const s = soDigitos(str);
      return s ? parseInt(s, 10) : 0;
    }

    // Soma total (card) - soma TODOS os campos listados em CAMPOS
    function atualizarTotal() {
      const total = CAMPOS.reduce((acc, c) => acc + toInt(document.getElementById(c.id).value), 0);
      document.getElementById("totalCarrinhos").textContent = String(total);
    }

    // Aplica máscara "somente números" em tempo real
    function aplicarMascaraSomenteNumero(inputEl) {
      inputEl.value = soDigitos(inputEl.value);
      atualizarTotal();
    }

    // Busca sessão do backend (/api/session) para validar login e permissões
    async function obterSessaoDoBackend() {
      try {
        const resp = await fetch("/api/session", {
          method: "GET",
          credentials: "include",
          headers: { "Accept": "application/json" }
        });

        if (!resp.ok) return null;

        const dados = await resp.json().catch(() => null);
        if (!dados || !dados.sucesso || !dados.usuario || !dados.loja || !dados.perfil) return null;
        return dados;
      } catch (e) {
        console.error("[CARRINHOS] Falha ao consultar /api/session:", e);
        return null;
      }
    }

    function mostrarSemSessao() {
      document.getElementById("app").classList.add("hidden");
      document.getElementById("telaSemSessao").classList.remove("hidden");
    }

    function mostrarApp() {
      document.getElementById("telaSemSessao").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
    }

    function setMsg(texto, ok=false) {
      const el = document.getElementById("msg");
      el.classList.toggle("ok", !!ok);
      el.textContent = texto || "";
    }

    // ✅ Validação: todos os campos obrigatórios (incluindo os NOVOS)
    function validarFormulario() {
      const dataLanc = (document.getElementById("dataLancamento").value || "").trim();
      if (!dataLanc) return "Selecione a Data Contagem.";

      for (const c of CAMPOS) {
        const v = (document.getElementById(c.id).value || "").trim();
        if (!v) return `Preencha: ${c.label}.`;
        if (!/^\d+$/.test(v)) return `Use somente números em: ${c.label}.`;
      }

      return "";
    }

    // Converte "YYYY-MM-DD" (input type=date) para "DD/MM/AAAA"
    function isoParaBR(iso) {
      const s = String(iso || "").trim();
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return s;
      return `${m[3]}/${m[2]}/${m[1]}`;
    }

    async function enviar() {
      setMsg("");

      if (!sessaoAtual) {
        mostrarSemSessao();
        return;
      }

      const perfil = String(sessaoAtual.perfil || "").trim().toUpperCase();
      if (!PERFIS_PERMITIDOS.includes(perfil)) {
        setMsg("Acesso negado: seu perfil não tem permissão para esta tela.");
        return;
      }

      const erro = validarFormulario();
      if (erro) {
        setMsg(erro);
        return;
      }

      const btn = document.getElementById("btnEnviar");
      btn.disabled = true;

      try {
        const dataISO = (document.getElementById("dataLancamento").value || "").trim();

        // Payload enviado ao backend (/api/carrinhos)
        const payload = {
          dataLancamento: isoParaBR(dataISO), // "DD/MM/AAAA"
          contagens: CAMPOS.reduce((acc, c) => {
            acc[c.key] = toInt(document.getElementById(c.id).value);
            return acc;
          }, {})
        };

        const resp = await fetch("/api/carrinhos", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json", "Accept": "application/json" },
          body: JSON.stringify(payload)
        });

        const dados = await resp.json().catch(() => ({}));

        if (resp.status === 401 || resp.status === 403) {
          mostrarSemSessao();
          setMsg("Sessão inválida/expirada. Faça login novamente.");
          return;
        }

        if (!resp.ok || !dados.sucesso) {
          setMsg(dados.message || "Erro ao enviar contagem.");
          return;
        }

        setMsg(dados.message || "Contagem enviada com sucesso.", true);

        // Limpa campos (mantém data)
        CAMPOS.forEach(c => document.getElementById(c.id).value = "");
        atualizarTotal();
      } catch (e) {
        console.error(e);
        setMsg("Erro de conexão ao enviar. Tente novamente.");
      } finally {
        btn.disabled = false;
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("btnIrLogin").addEventListener("click", () => {
        window.location.href = ROTAS.login;
      });

      document.getElementById("btnVoltarMenu").addEventListener("click", () => {
        window.location.href = ROTAS.menu;
      });

      document.getElementById("btnEnviar").addEventListener("click", enviar);

      // Inputs: só números, sem ponto/virgula
      CAMPOS.forEach(c => {
        const el = document.getElementById(c.id);
        el.addEventListener("input", () => aplicarMascaraSomenteNumero(el));
      });

      // Total inicial
      atualizarTotal();

      // Valida sessão
      const s = await obterSessaoDoBackend();
      if (!s) {
        mostrarSemSessao();
        return;
      }

      const perfil = String(s.perfil || "").trim().toUpperCase();
      if (!PERFIS_PERMITIDOS.includes(perfil)) {
        mostrarApp();
        document.getElementById("infoLoja").textContent = s.loja;
        document.getElementById("infoUsuario").textContent = s.usuario;
        document.getElementById("infoPerfil").textContent = s.perfil;
        setMsg("Acesso negado: seu perfil não tem permissão para esta tela.");
        document.getElementById("btnEnviar").disabled = true;
        return;
      }

      sessaoAtual = s;
      mostrarApp();

      document.getElementById("infoLoja").textContent = s.loja;
      document.getElementById("infoUsuario").textContent = s.usuario;
      document.getElementById("infoPerfil").textContent = s.perfil;
    });
  </script>

  <!-- Fontes confiáveis -->
  <!-- fetch + credentials/cookies: https://developer.mozilla.org/en-US/docs/Web/API/fetch -->
  <!-- input date: https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/date -->
  <!-- CSS cm units: https://developer.mozilla.org/en-US/docs/Learn/CSS/Building_blocks/Values_and_units -->
  <!-- img loading=lazy: https://developer.mozilla.org/en-US/docs/Web/Performance/Lazy_loading -->
</body>
</html>

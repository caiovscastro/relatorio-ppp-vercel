<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Relatório de Exceção – SCAN&SELL</title>

  <style>
    /* =========================
       LAYOUT GERAL
       ==========================*/
    body {
      background: #f3f3f3;
      font-family: Arial, sans-serif;
      margin: 8px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container {
      width: 95%;
      max-width: 1000px;
      background: #fff;
      padding: 24px 28px 30px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
    }

    .cabecalho {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 10px;
      border-bottom: 1px solid #e1e1e1;
      padding-bottom: 14px;
      margin-bottom: 16px;
    }

    .titulo {
      margin: 2px;
      font-size: 18px;
    }

    .subtitulo {
      font-size: 13px;
      color: #555;
      margin-top: 2px;
    }

    .info-usuario {
      display: flex;
      justify-content: flex-end;
      flex: 1 1 auto;
    }

    .usuario-card {
      min-width: auto;
      background: transparent;
      border: none;
      border-radius: 0;
      padding: 0;
      box-shadow: none;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: center;
      gap: 2px;
    }

    .usuario-card .value {
      font-weight: 600;
      color: #111;
      word-break: break-word;
      font-size: 9px;
      text-align: right;
    }

    /* =========================
       CARDS DE RESUMO
       Agora só DOIS cards (Verificados / Pendentes)
       e forçamos lado a lado inclusive em celular.
       ==========================*/
    .resumo-container {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      margin-top: 4px;
      flex-wrap: nowrap;           /* força manter em linha */
    }

    .resumo-card {
      flex: 0 0 50%;               /* exatamente 50% cada card */
      border-radius: 10px;
      padding: 10px 12px;
      background: #f7f7f7;
      border: 1px solid #e0e0e0;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      display: flex;
      flex-direction: column;
      justify-content: center;
      box-sizing: border-box;
    }

    .resumo-titulo {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .resumo-percent {
      font-size: 18px;
      font-weight: 700;
    }

    .resumo-total {
      font-size: 11px;
      color: #555;
      margin-top: 2px;
    }

    .resumo-verificado .resumo-titulo,
    .resumo-verificado .resumo-percent {
      color: #118000;
    }

    .resumo-pendente .resumo-titulo,
    .resumo-pendente .resumo-percent {
      color: #c00000;
    }

    /* =========================
       FILTROS
       Status e Seção SEMPRE lado a lado (mesmo no celular)
       ==========================*/
    .filtros-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
      margin-top: 8px;
      margin-bottom: 10px;
    }

    /* Cada grupo de filtro em coluna, mas
       vamos controlar o tamanho com flex-basis */
    .filtro-grupo {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 140px;
      box-sizing: border-box;
    }

    /* Grupo de Status e Seção: 50% cada (lado a lado) */
    .filtro-grupo.status,
    .filtro-grupo.secao {
      flex: 0 0 calc(50% - 5px);
    }

    /* Grupo do Exportar: ocupa espaço restante */
    .filtro-grupo.exportar {
      flex: 1 1 auto;
      align-items: flex-start;
    }

    /* Grupo do Voltar ao painel: tamanho automático */
    .filtro-grupo.voltar {
      flex: 0 0 auto;
      align-items: flex-start;
    }

    .filtro-label {
      font-size: 12px;
      font-weight: 600;
    }

    .filtro-select {
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #c3c3c3;
      background: #fff;
    }

    .btn-exportar {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #0066ff;
      color: #fff;
      font-weight: 600;
      white-space: nowrap;
    }

    .btn-exportar:hover {
      background: #0050cc;
    }

    .btn-voltar-painel {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #777;
      color: #fff;
      font-weight: 600;
      white-space: nowrap;
    }

    .btn-voltar-painel:hover {
      background: #555;
    }

    #statusRelatorio {
      font-size: 13px;
      margin-top: 4px;
      text-align: left;
      color: #333;
    }

    /* =========================
       LISTA DE RESULTADOS
       ==========================*/
    #listaRelatorio {
      margin-top: 8px;
    }

    .cartao {
      width: 94%;
      background: white;
      padding: 12px 14px 10px;
      margin: 10px auto;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      cursor: default;
      opacity: 0;
      transform: translateY(8px);
      animation: entrarCartao 0.22s ease-out forwards;
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out;
    }

    .cartao-header {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #111;
    }

    .cartao-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .cartao-table th,
    .cartao-table td {
      border: 1px solid #c3c3c3;
      padding: 3px 5px;
      text-align: left;
    }

    .cartao-table th {
      width: 42%;
      background: #f9f9f9;
      font-weight: 700;
    }

    .status-verificado {
      color: #118000;
      font-weight: 700;
    }

    .status-pendente {
      color: #c00000;
      font-weight: 700;
    }

    @keyframes entrarCartao {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* =========================
       TELA DE ERRO (SEM SESSÃO)
       ==========================*/
    .tela-erro {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #f3f3f3;
      font-family: Arial, sans-serif;
    }

    .card-erro {
      background: #fff;
      padding: 26px 30px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      max-width: 420px;
      text-align: center;
    }

    .card-erro h1 {
      color: #c00000;
      margin-top: 0;
    }

    /* =========================
       OVERLAY DE CARREGAMENTO 0–100%
       ==========================*/
    #loadingOverlayEx {
      position: fixed;
      inset: 0;
      background: rgba(243, 243, 243, 0.9);
      display: none; /* exibido via JS */
      align-items: center;
      justify-content: center;
      z-index: 12000;
    }

    .loading-box-ex {
      background: #ffffff;
      border-radius: 10px;
      padding: 16px 20px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
      text-align: center;
      font-size: 14px;
      min-width: 260px;
    }

    .loading-bar-container-ex {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #eeeeee;
      margin-top: 10px;
      overflow: hidden;
    }

    .loading-bar-ex {
      height: 100%;
      width: 0%;
      background: #0066ff;
      transition: width 0.12s linear;
    }

    .loading-percent-ex {
      margin-top: 8px;
      font-weight: 700;
    }
  </style>
</head>
<body>
  <!-- TELA DE ERRO (CASO NÃO TENHA SESSÃO) -->
  <div id="erroAcesso" class="tela-erro" style="display:none;">
    <div class="card-erro">
      <h1>Acesso inválido</h1>
      <p>Sessão de Efetividade não encontrada.</p>
      <p>Faça login primeiro no painel de Efetividade.</p>
      <button class="btn-voltar-painel" onclick="irParaPainel()">
        Ir para painel-efetividade
      </button>
    </div>
  </div>

  <!-- OVERLAY DE CARREGAMENTO 0–100% -->
  <div id="loadingOverlayEx">
    <div class="loading-box-ex">
      <div>Carregando dados do relatório...</div>
      <div class="loading-bar-container-ex">
        <div id="loadingBarEx" class="loading-bar-ex"></div>
      </div>
      <div id="loadingPercentEx" class="loading-percent-ex">0%</div>
    </div>
  </div>

  <!-- CONTEÚDO PRINCIPAL -->
  <div id="relatorioRoot" class="container" style="display:none;">
    <div class="cabecalho">
      <div>
        <h1 class="titulo">Relatório de Exceção</h1>
        <div class="subtitulo">Visão de pendências e verificados por seção</div>
      </div>
      <div class="info-usuario">
        <div class="usuario-card">
          <div class="value" id="usuarioSpan"></div>
          <div class="value" id="lojaSpan"></div>
        </div>
      </div>
    </div>

    <!-- RESUMOS (somente Verificados / Pendentes) -->
    <div class="resumo-container">
      <div class="resumo-card resumo-verificado">
        <div class="resumo-titulo">Verificados</div>
        <div class="resumo-percent" id="percentVerificadosEx">0%</div>
        <div class="resumo-total" id="totalVerificadosEx">0 itens</div>
      </div>
      <div class="resumo-card resumo-pendente">
        <div class="resumo-titulo">Pendentes</div>
        <div class="resumo-percent" id="percentPendentesEx">0%</div>
        <div class="resumo-total" id="totalPendentesEx">0 itens</div>
      </div>
    </div>

    <!-- FILTROS -->
    <div class="filtros-container">
      <!-- Status (já inicia em PENDENTE) -->
      <div class="filtro-grupo status">
        <label class="filtro-label" for="filtroStatus">Status</label>
        <select id="filtroStatus" class="filtro-select" onchange="aplicarFiltros()">
          <option value="TODOS">Todos</option>
          <option value="VERIFICADO">Verificado</option>
          <option value="PENDENTE" selected>Pendente</option>
        </select>
      </div>

      <!-- Seção -->
      <div class="filtro-grupo secao">
        <label class="filtro-label" for="filtroSecao">Seção</label>
        <select id="filtroSecao" class="filtro-select" onchange="aplicarFiltros()">
          <option value="">Todas as seções</option>
          <option>ALTO GIRO</option>
          <option>SECA DOCE</option>
          <option>HORTIFRUTI</option>
          <option>ARRUMACAO E FVM</option>
          <option>CASA</option>
          <option>PERFUMARIA</option>
          <option>SECA SALGADA</option>
          <option>PAS CONGELADOS</option>
          <option>LIQUIDA</option>
          <option>LIMPEZA</option>
          <option>SALSICHARIA</option>
          <option>PET E JARDIM</option>
          <option>ACOUGUE</option>
          <option>DESCARTAVEIS</option>
          <option>LIMPEZA DA CASA</option>
          <option>LAZER</option>
          <option>ELETRO</option>
          <option>PAS RESFRIADOS</option>
          <option>NAO ENCONTRADO</option>
          <option>PADARIA</option>
          <option>VEST CASA</option>
          <option>PAPELARIA - M. ESCRITORIO</option>
          <option>LANCHONETE</option>
          <option>ROTISSERIA</option>
          <option>CAMA - MESA - BANHO</option>
          <option>AUTOMOTIVOS</option>
          <option>TABACARIA</option>
          <option>ADEGA</option>
        </select>
      </div>

      <!-- Exportar XLSX -->
      <div class="filtro-grupo exportar">
        <label class="filtro-label">&nbsp;</label>
        <button class="btn-exportar" type="button" onclick="exportarXLSX()">
          Exportar XLSX
        </button>
      </div>

      <!-- Voltar ao painel -->
      <div class="filtro-grupo voltar">
        <label class="filtro-label">&nbsp;</label>
        <button class="btn-voltar-painel" type="button" onclick="irParaPainel()">
          Voltar ao Painel
        </button>
      </div>
    </div>

    <div id="statusRelatorio"></div>

    <!-- LISTA -->
    <div id="listaRelatorio"></div>
  </div>

  <!-- SheetJS (para exportar XLSX no navegador) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <script>
    let lojaLogada = null;
    let usuarioLogado = null;
    let baseLoja = [];   // todos os registros da loja
    let filtrados = [];  // registros após aplicar filtros (status + seção)

    /* Navegação de volta para o painel principal */
    function irParaPainel() {
      window.location.href = "/painel-efetividade.html";
    }

    /* Controle do overlay de carregamento 0–100% pulando de 2 em 2 */
    let loadingTimerEx = null;
    let loadingPercentEx = 0;

    function iniciarLoadingEx() {
      const overlay = document.getElementById("loadingOverlayEx");
      const bar = document.getElementById("loadingBarEx");
      const percentEl = document.getElementById("loadingPercentEx");

      loadingPercentEx = 0;
      bar.style.width = "0%";
      percentEl.textContent = "0%";
      overlay.style.display = "flex";

      if (loadingTimerEx) clearInterval(loadingTimerEx);

      loadingTimerEx = setInterval(() => {
        if (loadingPercentEx >= 98) return; // deixa 100% para o final
        loadingPercentEx += 2;              // pula de 2 em 2
        bar.style.width = loadingPercentEx + "%";
        percentEl.textContent = loadingPercentEx + "%";
      }, 100);
    }

    function finalizarLoadingEx() {
      const overlay = document.getElementById("loadingOverlayEx");
      const bar = document.getElementById("loadingBarEx");
      const percentEl = document.getElementById("loadingPercentEx");

      if (loadingTimerEx) {
        clearInterval(loadingTimerEx);
        loadingTimerEx = null;
      }

      loadingPercentEx = 100;
      bar.style.width = "100%";
      percentEl.textContent = "100%";

      // pequeno delay só para o usuário perceber que completou
      setTimeout(() => {
        overlay.style.display = "none";
      }, 200);
    }

    /* Valida sessão e inicia carregamento da base */
    document.addEventListener("DOMContentLoaded", () => {
      let sessao = null;
      try {
        const raw = localStorage.getItem("efetividadeSession");
        if (raw) sessao = JSON.parse(raw);
      } catch (e) {
        console.error("Erro ao ler efetividadeSession:", e);
      }

      if (!sessao || !sessao.usuario || !sessao.loja) {
        document.getElementById("erroAcesso").style.display = "flex";
        return;
      }

      usuarioLogado = sessao.usuario;
      lojaLogada = sessao.loja;

      document.getElementById("usuarioSpan").textContent = usuarioLogado;
      document.getElementById("lojaSpan").textContent = lojaLogada;

      // overlay de loading visível ENQUANTO carrega
      iniciarLoadingEx();
      document.getElementById("relatorioRoot").style.display = "none";

      carregarBaseRelatorio();
    });

    /* Carrega a base da loja via /api/efetividade-base */
    async function carregarBaseRelatorio() {
      const statusLabel = document.getElementById("statusRelatorio");
      statusLabel.textContent = "Carregando base de dados da loja...";

      try {
        const resp = await fetch(
          "/api/efetividade-base?loja=" + encodeURIComponent(lojaLogada)
        );
        const dados = await resp.json().catch(() => ({}));

        if (!resp.ok || !dados.sucesso || !Array.isArray(dados.registros)) {
          console.error("Resposta inesperada em /api/efetividade-base:", dados);
          const detalhe = dados.detalhe ? " Detalhe: " + dados.detalhe : "";
          throw new Error((dados.message || "Falha ao carregar base.") + detalhe);
        }

        baseLoja = dados.registros || [];
        statusLabel.textContent =
          "Base carregada com " + baseLoja.length + " itens da loja.";

        // Assim que a base está disponível, aplicamos filtros
        // (Status PENDENTE já está selecionado por padrão)
        aplicarFiltros();

        // Mostra o conteúdo principal e encerra o overlay
        document.getElementById("relatorioRoot").style.display = "block";
        finalizarLoadingEx();
      } catch (e) {
        console.error("Erro ao carregar base de dados:", e);
        statusLabel.textContent =
          "Erro ao carregar base de dados. " + (e.message || "");
        finalizarLoadingEx();
      }
    }

    /* Atualiza os RESUMOS (Verificado / Pendente) conforme o filtro de SEÇÃO:
       - Se Seção = "" -> considera TODA a loja (baseLoja)
       - Se Seção específica -> considera SOMENTE aquela seção
       O filtro de Status NÃO interfere aqui, só a seção. */
    function atualizarResumoPorSecao() {
      const secaoSelect = document.getElementById("filtroSecao").value;
      let universo = baseLoja;

      if (secaoSelect) {
        const secaoUpper = secaoSelect.toUpperCase();
        universo = baseLoja.filter((linha) => {
          const secao = String(linha[1] ?? "").trim().toUpperCase();
          return secao === secaoUpper;
        });
      }

      const total = universo.length;
      let verificados = 0;
      let pendentes = 0;

      universo.forEach((linha) => {
        const status = String(linha[2] ?? "").trim().toUpperCase();
        if (status === "VERIFICADO") verificados++;
        else if (status === "PENDENTE") pendentes++;
      });

      const percVer = total ? (verificados / total) * 100 : 0;
      const percPen = total ? (pendentes / total) * 100 : 0;

      document.getElementById("percentVerificadosEx").textContent =
        percVer.toFixed(1) + "%";
      document.getElementById("percentPendentesEx").textContent =
        percPen.toFixed(1) + "%";

      document.getElementById("totalVerificadosEx").textContent =
        verificados + " itens";
      document.getElementById("totalPendentesEx").textContent =
        pendentes + " itens";
    }

    /* Aplica os filtros de Status + Seção para a LISTA
       e chama o resumo por seção em seguida. */
    function aplicarFiltros() {
      const statusSelect = document.getElementById("filtroStatus").value; // TODOS / VERIFICADO / PENDENTE
      const secaoSelect = document.getElementById("filtroSecao").value;   // "" ou nome da seção

      filtrados = baseLoja.filter((linha) => {
        const status = String(linha[2] ?? "").trim().toUpperCase();
        const secao = String(linha[1] ?? "").trim().toUpperCase();

        if (statusSelect !== "TODOS" && status !== statusSelect) {
          return false;
        }

        if (secaoSelect && secao !== secaoSelect.toUpperCase()) {
          return false;
        }

        return true;
      });

      // Atualiza lista e resumos
      renderizarLista();
      atualizarResumoPorSecao();
    }

    /* Renderiza a lista de cartões */
    function renderizarLista() {
      const container = document.getElementById("listaRelatorio");
      const statusLabel = document.getElementById("statusRelatorio");

      if (!filtrados.length) {
        container.innerHTML =
          '<p style="font-size: 14px; text-align:center; margin-top: 12px;">Nenhum registro encontrado para o filtro atual.</p>';
        statusLabel.textContent = "Nenhum registro para o filtro selecionado.";
        return;
      }

      statusLabel.textContent = filtrados.length + " registro(s) no filtro atual.";

      const html = filtrados
        .map((linha) => {
          const [
            ean = "",
            secao = "",
            pendenteVerificado = "",
            empresaProduto = "",
            codigoProduto = "",
            qtdDisponivel = "",
            precoVdaUnitario = "",
            custoLiqUnitario = "",
            qtdPendente = "",
            diasEstoque = "",
            diasUltimaEntrada = "",
            diasSemVendas = "",
          ] = linha;

          const partes = String(empresaProduto).split(" : ");
          const produto = (partes[1] || partes[0] || "").trim();

          const statusUpper = String(pendenteVerificado || "").trim().toUpperCase();
          let statusClass = "";
          let statusLabelTexto = pendenteVerificado;

          if (statusUpper === "VERIFICADO") {
            statusClass = "status-verificado";
            statusLabelTexto = "✔ Verificado";
          } else if (statusUpper === "PENDENTE") {
            statusClass = "status-pendente";
            statusLabelTexto = "Pendente";
          }

          return `
          <div class="cartao">
            <div class="cartao-header">${produto || "Produto"}</div>
            <table class="cartao-table" aria-label="Dados do produto">
              <tr>
                <th>Status</th>
                <td><span class="${statusClass}">${statusLabelTexto}</span></td>
              </tr>
              <tr><th>EAN</th><td>${ean}</td></tr>
              <tr><th>Seção</th><td>${secao}</td></tr>
              <tr><th>Qtd. Disponível</th><td>${qtdDisponivel}</td></tr>
              <tr><th>Preço Vda Unitário</th><td>${precoVdaUnitario}</td></tr>
              <tr><th>Custo Liq. Unitário</th><td>${custoLiqUnitario}</td></tr>
              <tr><th>Pend. Ped.Compra</th><td>${qtdPendente}</td></tr>
              <tr><th>Dias de Estoque</th><td>${diasEstoque}</td></tr>
              <tr><th>Dias Ult. Entrada</th><td>${diasUltimaEntrada}</td></tr>
              <tr><th>Dias Sem Vendas</th><td>${diasSemVendas}</td></tr>
            </table>
          </div>
        `;
        })
        .join("");

      container.innerHTML = html;
    }

    /* Exporta o filtro atual para XLSX (filtrados) */
    function exportarXLSX() {
      if (!filtrados.length) {
        alert("Não há registros no filtro atual para exportar.");
        return;
      }

      const cabecalho = [
        "EAN",
        "Seção",
        "Status",
        "Empresa : Produto",
        "Código Produto",
        "Qtd. Disponível",
        "Preço Vda Unitário",
        "Custo Liq. Unitário",
        "Qtd. Pend. Ped.Compra",
        "Dias de Estoque",
        "Dias Ult. Entrada",
        "Dias Sem Vendas",
      ];

      const corpo = filtrados.map((linha) => {
        const [
          ean = "",
          secao = "",
          pendenteVerificado = "",
          empresaProduto = "",
          codigoProduto = "",
          qtdDisponivel = "",
          precoVdaUnitario = "",
          custoLiqUnitario = "",
          qtdPendente = "",
          diasEstoque = "",
          diasUltimaEntrada = "",
          diasSemVendas = "",
        ] = linha;

        return [
          ean,
          secao,
          pendenteVerificado,
          empresaProduto,
          codigoProduto,
          qtdDisponivel,
          precoVdaUnitario,
          custoLiqUnitario,
          qtdPendente,
          diasEstoque,
          diasUltimaEntrada,
          diasSemVendas,
        ];
      });

      const ws = XLSX.utils.aoa_to_sheet([cabecalho, ...corpo]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "RelatorioExcecao");

      const lojaSafe = (lojaLogada || "LOJA").replace(/[^A-Za-z0-9_-]/g, "_");
      const nomeArquivo = `relatorio-excecao-${lojaSafe}.xlsx`;

      XLSX.writeFile(wb, nomeArquivo);
    }
  </script>
</body>
</html>

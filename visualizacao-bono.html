<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BONO DIGITAL</title>

  <style>
    html, body{ width:100%; max-width:100%; overflow-x:hidden; }
    body{
      background:#f3f3f3;
      font-family: Arial, sans-serif;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:100vh;
      margin:2px;
      color:#111;
    }

    .container{
      width: 98%;
      max-width: 1300px;
      background:#fff;
      padding: 22px 8px 22px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      box-sizing: border-box;
      margin-top: 10px;
    }

    .logo-menu{
      display:flex;
      justify-content:center;
      align-items:center;
      margin: 0 0 8px;
    }
    .logo-menu img{
      max-width: 220px;
      width: 70%;
      height: auto;
      display:block;
      user-select:none;
      -webkit-user-drag: none;
    }

    .linha-logo{
      border: none;
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(0,0,0,0.12), transparent);
      margin: 6px 0 14px;
    }

    .titulo{
      text-align:center;
      margin: 8px 0 12px;
      font-size: 20px;
      font-weight: 900;
    }

    /* ===== Filtros ===== */
    .filtros{
      border: 1px solid #ececec;
      border-radius: 12px;
      padding: 12px;
      background:#fff;
      margin-bottom: 14px;
    }

    .filtros-titulo{
      font-size: 14px;
      font-weight: 900;
      margin: 0 0 10px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }
    /* ‚úÖ no celular em pares: Loja+Data / Tipo+Status */
    @media (max-width: 560px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    label{
      display:block;
      font-size: 12px;
      font-weight: 800;
      color:#333;
      margin-bottom: 6px;
    }
    input, select{
      width:100%;
      box-sizing:border-box;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
      outline:none;
      background:#fff;
    }

    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    /* ============================================================
       ‚úÖ (1) BOT√ïES LADO A LADO NO CELULAR
       - Antes: no max-width 560px virava 1 coluna.
       - Agora: mant√©m 3 colunas no celular, ajustando tamanho.
    ============================================================ */
    @media (max-width: 560px){
      .actions{ grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
      .btn{ padding: 10px; font-size: 12.5px; border-radius: 10px; }
    }

    .btn{
      width:100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 800;
    }
    .btn-sec{ background:#e9e9e9; color:#111; }
    .btn-sec:hover{ background:#dedede; }
    .btn-pri{ background:#111; color:#fff; }
    .btn-pri:hover{ opacity:.92; }

    .mensagem{
      margin-top: 10px;
      text-align:center;
      font-weight:800;
      font-size: 13px;
      min-height: 18px;
      color:#b30000;
    }
    .ok{ color:#0b6b2f; }

    /* ===== Lista de cart√µes ===== */
    .resultados-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin: 6px 0 6px; /* ‚úÖ mais pr√≥ximo do cart√£o principal */
      flex-wrap: wrap;
    }
    .contador{
      font-weight: 900;
      font-size: 13px;
      color:#222;
    }

    /* ‚úÖ Mais destaque/relevo */
    .doc-card{
      border: 1px solid #e7e7e7;
      border-radius: 16px;
      background: #ffffff;
      box-shadow: 0 14px 34px rgba(0,0,0,0.16);
      padding: 5px;
      margin-bottom: 15px; /* ‚úÖ menor margem entre cart√µes */
      overflow:hidden;
    }

    /* ====== CABE√áALHO ====== */
    .doc-head{
      border-radius: 14px;
      border: 1px solid #eeeeee;
      background: #f7f7f7;
      padding: 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.9);
    }

    .doc-head-title{
      font-size: 22px;
      font-weight: 900;
      color:#153b6f;
      letter-spacing: .4px;
      text-transform: uppercase;
      margin: 2px 2px 10px;
    }

    .doc-statusbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background:#f2f2f2;
      border: 1px solid #e7e7e7;
      border-radius: 999px;
      padding: 10px 12px;
    }

    .doc-status-left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
      font-weight: 900;
      color:#1b2c55;
    }

    .doc-badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 900;
      letter-spacing: .2px;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    /* varia√ß√µes de badge */
    .badge-pendente{
      background:#f6eadc;
      border-color:#f0ddc1;
      color:#a85d10;
    }
    .badge-recebido{
      background:#deefe3;
      border-color:#cfe6d6;
      color:#0b6b2f;
    }
    .badge-validado{
      background:#deefe3;
      border-color:#cfe6d6;
      color:#0b6b2f;
    }

    /* ====== ‚Äúcorpo‚Äù do cabe√ßalho ====== */
    .doc-head-body{
      margin-top: 12px;
      background:#ffffff;
      border: 1px solid #ededed;
      border-radius: 14px;
      padding: 12px 12px;
    }

    /* ============================================================
       ‚úÖ (2) + (3) MENOS CART√ïES + "Status:" AO LADO DO √çCONE
       - Criamos uma linha interna √∫nica para status (topline).
       - Essa linha fica acima da Data/Hora, e abaixo do t√≠tulo.
       - Inserimos um separador horizontal antes da Data/Hora.
    ============================================================ */
    .doc-topline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background:#f2f2f2;
      border: 1px solid #e7e7e7;
      border-radius: 999px;
      padding: 10px 12px;
    }

    .doc-topline-left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
      font-weight: 900;
      color:#1b2c55;
    }

    .doc-topline-left .status-title{
      font-weight: 900;
      color:#1b2c55;
      white-space: nowrap;
    }

    .doc-topline-right{
      display:flex;
      align-items:center;
      gap: 10px;
      justify-content:flex-end;
      flex-wrap: wrap;
    }

    .head-sep{
      border: none;
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(0,0,0,0.18), transparent);
      margin: 10px 0 8px;
    }

/* ‚úÖ Ajuste: fonte igual √† lista de itens */
.info-row{
  display:flex;
  align-items:flex-start;
  gap: 10px;
  padding: 2px 2px;
  margin: 0;
  line-height: 1.2;
  font-size: 12.5px;   /* üî• IGUAL √† lista */
  font-weight: 800;    /* üî• IGUAL √† lista */
  color:#1b2c55;
}

.info-row + .info-row{
  margin-top: 2px;
}

.info-row .txt{
  display:flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items:baseline;
  min-width:0;
}

/* r√≥tulo */
.info-row .k{
  color:#1b2c55;
  white-space: nowrap;
  font-weight: 800;
}

/* valor */
.info-row .v{
  color:#111;
  font-weight: 800;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space: nowrap;
  max-width: 100%;
}

    .ic{
      width: 20px;
      height: 20px;
      flex: 0 0 20px;
      display:inline-block;
    }

    .ic-blue path, .ic-blue rect, .ic-blue circle, .ic-blue line, .ic-blue polyline{
      stroke:#1f4f95;
    }

    /* ‚úÖ Bot√£o √≠cone de valida√ß√£o (mantido) */
    .btn-status{
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      font-size: 16px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btn-status:hover{ transform: translateY(-1px); }

    /* ============================================================
       ‚úÖ (4) BOT√ÉO VALIDAR LARANJA (SEM EMOJI)
       - Estilo de bot√£o laranja, com texto.
    ============================================================ */
    .btn-validar{
      border: none;
      cursor: pointer;
      padding: 9px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12.5px;
      letter-spacing: .2px;
      background: #f39c12; /* laranja */
      color: #ffffff;
      box-shadow: 0 8px 16px rgba(0,0,0,0.12);
      white-space: nowrap;
    }
    .btn-validar:hover{ filter: brightness(0.96); transform: translateY(-1px); }
    .btn-validar:active{ transform: translateY(0px); }

    .doc-table-wrap{
      margin-top: 10px;
      border-radius: 12px;
      overflow:hidden;
      border: 1px solid #d8e2ff;
      background:#fff;
      box-shadow: 0 10px 22px rgba(0,0,0,0.10);
    }

    /* ‚úÖ QTD e Embalagem mais pr√≥ximos; mais espa√ßo para descri√ß√£o */
    .doc-table-head{
      background: linear-gradient(to bottom, #1f4f95, #173f78);
      color:#fff;
      font-weight: 900;
      padding: 10px 12px;
      display:grid;
      grid-template-columns: 1fr 70px 95px;
      gap: 6px;
      font-size: 12.5px;
      align-items:center;
    }
    .doc-table-head .h-right{ text-align:right; }

    .doc-table{
      width:100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .doc-table td{
      border-top: 1px solid #e8eeff;
      padding: 10px 12px;
      font-size: 12.5px;
      font-weight: 800;
      color:#111;
      vertical-align: top;
      word-wrap: break-word;
    }
    .doc-table tr:nth-child(even) td{ background:#fafcff; }

    .col-desc{ width:auto; }
    .col-qtd{ width:70px; text-align:right; }
    .col-emb{ width:95px; text-align:right; }

/* ‚úÖ No celular: fonte igual √† lista */
@media (max-width: 560px){
  .doc-head-title{ font-size: 12px; }
  .doc-badge{ font-size: 9px; padding: 6px 10px; }

  .info-row{ 
    font-size: 10.5px; /* üî• MESMO TAMANHO DA LISTA */
  }

  .btn-status{ font-size: 12px; }

  .doc-statusbar{ padding: 9px 10px; }

  .doc-table-head{
    grid-template-columns: 1fr 58px 76px;
    font-size: 10.5px;
    padding: 9px 10px;
    gap: 5px;
  }

  .doc-table td{
    font-size: 10.5px;
    padding: 8px 10px;
  }

  .col-qtd{ width:58px; }
  .col-emb{ width:76px; }
}

      /* ‚úÖ Bot√£o validar compacto no celular */
      .btn-validar{ padding: 7px 10px; font-size: 10.5px; }
      .doc-topline{ padding: 9px 10px; }
      .doc-topline-left .status-title{ font-size: 10.5px; }
    }

    .hidden{ display:none !important; }

    /* ===== RODAP√â ===== */
.assinaturas{
  margin-top: 10px;
  display:grid;
  grid-template-columns: 1fr; /* üî• largura total */
  gap: 10px;
}

    /* ‚úÖ Ajuste solicitado: manter 2 colunas no celular tamb√©m com largura total */
@media (max-width: 650px){
  .assinaturas{
    grid-template-columns: 1fr; /* ‚úÖ largura total no celular */
    gap: 8px;
  }
}

    .ass-box{
      background:#ffffff;
      border: 1px solid #eeeeee;
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      align-items:flex-start;
      gap: 10px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
      min-width: 0;
    }

    .ass-box .ass-txt{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 2px;
    }

    /* ‚úÖ Respons√°vel/Valida√ß√£o PPP com mesma fonte da tabela */
    .ass-box .ass-k{
      font-size: 12.5px;
      font-weight: 900;
      color:#4b4b4b;
      line-height: 1.1;
    }

    .ass-box .ass-v{
      font-size: 12.5px;
      font-weight: 900;
      color:#111;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space: nowrap;
      line-height: 1.1;
    }

    @media (max-width: 560px){
      .ass-box .ass-k{ font-size: 10.5px; }
      .ass-box .ass-v{ font-size: 10.5px; }

      /* ‚úÖ garante que as duas caixas ‚Äúcaibam‚Äù lado a lado no celular */
      .ass-box{ padding: 8px 8px; gap: 8px; }
      .ass-box .ic{ width: 18px; height: 18px; flex: 0 0 18px; }
    }

    /* ============================================================
       ‚úÖ (5) UM √öNICO CART√ÉO PARA "Respons√°vel" + "Valida√ß√£o PPP"
       - Em vez de 2 cards separados, vira um card s√≥ com divisor vertical.
    ============================================================ */
    .ass-join{
      background:#ffffff;
      border: 1px solid #eeeeee;
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      align-items:stretch;
      gap: 12px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
      min-width: 0;
    }
    .ass-side{
      flex: 1 1 0;
      display:flex;
      align-items:flex-start;
      gap: 10px;
      min-width: 0;
    }
    .ass-divider{
      width: 1px;
      background: rgba(0,0,0,0.10);
      border-radius: 1px;
    }

    @media (max-width: 560px){
      .ass-join{ padding: 8px 8px; gap: 10px; }
      .ass-side{ gap: 8px; }
      .ass-divider{ background: rgba(0,0,0,0.12); }
    }

    /* ‚úÖ Modal (popup) de valida√ß√£o */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      z-index: 9999;
    }
    .modal-backdrop.show{ display:flex; }

    .modal{
      width: 100%;
      max-width: 560px;
      background:#fff;
      border-radius: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.22);
      border: 1px solid #e9e9e9;
      overflow:hidden;
    }
    .modal-header{
      padding: 12px 14px;
      font-weight: 900;
      font-size: 14px;
      background: #f6f6f6;
      border-bottom: 1px solid #ededed;
    }
    .modal-body{
      padding: 14px;
      font-size: 13px;
      font-weight: 800;
      color:#222;
      line-height: 1.35;
    }
    .modal-actions{
      display:flex;
      gap: 10px;
      padding: 12px 14px 14px;
      border-top: 1px solid #ededed;
      justify-content:flex-end;
      flex-wrap: wrap;
    }
    .btn-modal{
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      cursor:pointer;
      font-weight: 900;
      font-size: 13px;
    }
    .btn-nao{ background:#e9e9e9; color:#111; }
    .btn-sim{ background:#111; color:#fff; }
    .btn-sim:hover{ opacity:.92; }
    .btn-nao:hover{ background:#dedede; }
  </style>
</head>

<body>
  <div class="container">
    <div class="logo-menu">
      <img src="https://i.ibb.co/prMfd6Fs/IMG-20260121-161142.png" alt="Logo PPP" />
    </div>

    <hr class="linha-logo" />

    <div class="titulo">BONO DIGITAL</div>

    <!-- ===== Filtros ===== -->
    <div class="filtros">
      <div class="filtros-titulo">Filtros</div>

      <div class="grid">
        <div id="wrapFiltroLoja" class="hidden">
          <label for="fLoja">Loja</label>
          <select id="fLoja">
            <option value="">Todas</option>
          </select>
        </div>

        <div>
          <label for="fData">Data</label>
          <input type="date" id="fData" />
        </div>

        <div>
          <label for="fTipo">Tipo</label>
          <select id="fTipo">
            <option value="">Todos</option>
            <option value="MOVIMENTACAO_INTERNA">Movimenta√ß√£o interna</option>
            <option value="RECEBIMENTO_MERCADORIAS">Recebimento de mercadorias</option>
          </select>
        </div>

        <div>
          <label for="fStatus">Status</label>
          <select id="fStatus">
            <option value="">Todos</option>
            <option value="VALIDADO">Validado</option>
            <option value="PENDENTE">PENDENTE</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-sec" id="btnLimpar">Limpar</button>
        <button class="btn btn-pri" id="btnAtualizar">Atualizar</button>
        <button class="btn btn-sec" id="btnVoltarMenu">Voltar</button>
      </div>

      <div class="mensagem" id="msg"></div>
    </div>

    <div class="resultados-top">
      <div class="contador" id="contador">0 documento(s)</div>
    </div>

    <div id="listaDocs"></div>
  </div>

  <!-- ‚úÖ Modal valida√ß√£o -->
  <div class="modal-backdrop" id="modalValidar">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalValidarTitulo">
      <div class="modal-header" id="modalValidarTitulo">Valida√ß√£o do Bono</div>
      <div class="modal-body" id="modalValidarTexto"></div>
      <div class="modal-actions">
        <button class="btn-modal btn-nao" id="btnModalNao" type="button">N√£o</button>
        <button class="btn-modal btn-sim" id="btnModalSim" type="button">Sim</button>
      </div>
    </div>
  </div>

  <script>
    const ROTAS = { menu: "/menu.html", login: "/login.html" };

    const ENDPOINT_CANDIDATOS = [
      "/api/bono-listar.js"
    ];

    let sessaoAtual = null;
    let linhas = [];
    let ENDPOINT_LISTAR_RESOLVIDO = "";

    // (interno) endpoint de valida√ß√£o (precisa existir no backend)
    const ENDPOINT_VALIDAR = "/api/bono-validar.js";

    const LOJAS = [
      "BIG 01 - 106 NORTE","BIG 02 - 402 NORTE","BIG 03 - 413 SUL","BIG 04 - 301 SW","BIG 05 - 408 NORTE",
      "BIG 06 - SIBERIA","BIG 08 - 503 SUL","BIG 09 - PEN√çNSULA","BIG 10 - PAINEIRAS","BIG 11 - 310 NORTE",
      "BIG 12 - 208 NORTE","BIG 13 - QI-05 L. NORTE","BIG 14 - 508 SUL","BIG 15 - 105 SW","BIG 16 - 512 SUL",
      "BIG 17 - QI-11 LAGO SUL","BIG 18 - 211 NORTE","BIG 19 - CASTANHEIRA","BIG 20 - TAGUATINGA C1","BIG 21 - CNB12",
      "BIG 22 - 102 NOROESTE","BIG 23 - QI-23 LAGO SUL","BIG 24 - 314 NORTE","BIG 25 - 410 SUL",
      "ULT 01 - PLANALTINA","ULT 02 - GAMA","ULT 03 - COLORADO","ULT 04 - CEI SUL","ULT 05 - POLO JK",
      "ULT 06 - SOBRADINHO","ULT 07 - ADE","ULT 08 - ARAPOANGA","ULT 09 - CEI NORTE","ULT 10 - ESTRUTURAL",
      "ULT 11 - ITAPOA","ULT 12 - SAO SEBASTIAO","ULT 13 - RECANTO","ULT 14 - AGUAS LINDAS","ULT 15 - SOL NASCENTE",
      "ULT 16 - PARANOA PARK","ULT 17 - SAMAMBAIA","ULT 18 - BRAZLANDIA","ULT 19 - VIA PARK","ULT 20 - TAGUATINGA",
      "ULT 22 - VICENTE PIRES","ULT 23 - SANTA MARIA","ULT 24 - PAUL BRASIL","ULT 25 - BRASILINHA",
      "TOTAL DISTRIBUICAO","INDUSPAN","MATRIZ"
    ];

    function setTexto(id, txt) {
      const el = document.getElementById(id);
      if (el) el.textContent = txt;
    }

    function setMsg(txt, ok=false){
      const el = document.getElementById("msg");
      el.textContent = txt || "";
      el.classList.toggle("ok", !!ok);
    }

    function normStr(s){
      return String(s ?? "").trim();
    }

    function normKey(s){
      return normStr(s).toUpperCase().replace(/\s+/g, " ");
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function perfilEhAdmin(perfil){
      return normKey(perfil).includes("ADMIN");
    }
    function perfilEhGerentePPP(perfil){
      const p = normKey(perfil);
      return p.includes("GERENTE_PPP") || (p.includes("GERENTE") && p.includes("PPP"));
    }
    function perfilEhBasePPP(perfil){
      const p = normKey(perfil);
      return p.includes("BASE_PPP") || (p.includes("BASE") && p.includes("PPP"));
    }

    function extrairDataISO(dataHoraBR){
      const t = normStr(dataHoraBR);
      if (!t) return "";
      const parteData = t.split(" ")[0];
      const [dd,mm,aa] = parteData.split("/");
      if (!dd || !mm || !aa) return "";
      const d = String(dd).padStart(2,"0");
      const m = String(mm).padStart(2,"0");
      const a = String(aa).padStart(4,"0");
      return `${a}-${m}-${d}`;
    }

    function tipoToCanon(tipo){
      const t = normKey(tipo);
      if (t.includes("MOV") && (t.includes("INTERNA") || t.includes("INTERNO") || t.includes("MOV_INTERNA"))) return "MOVIMENTACAO_INTERNA";
      if (t.includes("RECEB") || t.includes("MERCADORIA")) return "RECEBIMENTO_MERCADORIAS";
      return "";
    }

    function statusToCanon(status){
      const s = normKey(status);
      if (s.includes("VALID")) return "VALIDADO";
      if (s.includes("PEND")) return "PENDENTE";
      return "";
    }

    async function obterSessaoDoBackend() {
      try {
        const resp = await fetch("/api/session", {
          method: "GET",
          credentials: "include",
          headers: { "Accept": "application/json" }
        });
        if (!resp.ok) return null;

        const ct = (resp.headers.get("content-type") || "").toLowerCase();
        if (!ct.includes("application/json")) return null;

        const dados = await resp.json().catch(() => null);
        if (!dados) return null;

        const ok = !!(dados.sucesso ?? dados.success ?? dados.ok);
        if (!ok || !dados.usuario || !dados.loja || !dados.perfil) return null;

        return dados;
      } catch {
        return null;
      }
    }

    function redirecionarParaLogin(motivo) {
      if (motivo) setMsg(motivo, false);
      window.location.href = ROTAS.login;
    }

    function preencherSelectComLojas(selId, incluirTodas = true){
      const sel = document.getElementById(selId);
      if (!sel) return;

      const atual = sel.value;

      sel.innerHTML = "";
      if (incluirTodas){
        const op = document.createElement("option");
        op.value = "";
        op.textContent = "Todas";
        sel.appendChild(op);
      }

      LOJAS.forEach(lj => {
        const op = document.createElement("option");
        op.value = lj;
        op.textContent = lj;
        sel.appendChild(op);
      });

      if (atual) sel.value = atual;
    }

    function aplicarVisibilidadeFiltroLoja(){
      const wrap = document.getElementById("wrapFiltroLoja");
      if (!sessaoAtual || !wrap) return;

      const podeVer = perfilEhAdmin(sessaoAtual.perfil) || perfilEhGerentePPP(sessaoAtual.perfil);
      wrap.classList.toggle("hidden", !podeVer);

      if (podeVer){
        preencherSelectComLojas("fLoja", true);
      } else {
        const sel = document.getElementById("fLoja");
        if (sel) sel.innerHTML = '<option value="">Todas</option>';
      }
    }

    async function resolverEndpointListar(){
      if (ENDPOINT_LISTAR_RESOLVIDO) return ENDPOINT_LISTAR_RESOLVIDO;

      for (const ep of ENDPOINT_CANDIDATOS){
        try{
          const r = await fetch(ep, {
            method: "GET",
            credentials: "include",
            headers: { "Accept": "application/json" }
          });

          if (r.status === 404) continue;

          ENDPOINT_LISTAR_RESOLVIDO = ep;
          return ep;
        } catch {
          continue;
        }
      }

      ENDPOINT_LISTAR_RESOLVIDO = ENDPOINT_CANDIDATOS[0];
      return ENDPOINT_LISTAR_RESOLVIDO;
    }

    async function buscarDados() {
      setMsg("Carregando dados...", true);

      try {
        const endpoint = await resolverEndpointListar();

        const resp = await fetch(endpoint, {
          method: "GET",
          credentials: "include",
          headers: { "Accept": "application/json" }
        });

        const ct = (resp.headers.get("content-type") || "").toLowerCase();

        if (resp.status === 404) {
          console.error("Falha no endpoint (404):", endpoint);
          setMsg("Falha ao carregar dados (endpoint n√£o encontrado).", false);
          linhas = [];
          render();
          return;
        }

        if (!ct.includes("application/json")) {
          const txt = await resp.text().catch(() => "");
          console.error("Endpoint n√£o retornou JSON:", { endpoint, status: resp.status, ct, body: (txt || "").slice(0, 600) });
          setMsg("Falha ao carregar dados (endpoint).", false);
          linhas = [];
          render();
          return;
        }

        const dados = await resp.json().catch(() => null);
        const ok = !!(dados && (dados.sucesso ?? dados.success ?? dados.ok));

        if (!resp.ok || !ok) {
          console.error("Falha no endpoint:", { endpoint, status: resp.status, dados });
          setMsg("Falha ao carregar dados (endpoint).", false);
          linhas = [];
          render();
          return;
        }

        const arr =
          Array.isArray(dados.dados) ? dados.dados :
          (Array.isArray(dados.data) ? dados.data :
          (Array.isArray(dados.rows) ? dados.rows : []));

        linhas = arr.map((row) => {
          if (Array.isArray(row)) {
            return {
              A: row[0] ?? "", B: row[1] ?? "", C: row[2] ?? "", D: row[3] ?? "",
              E: row[4] ?? "", F: row[5] ?? "", G: row[6] ?? "", H: row[7] ?? "",
              I: row[8] ?? "", J: row[9] ?? "", K: row[10] ?? "", L: row[11] ?? "",
              M: row[12] ?? ""
            };
          }
          if (row && typeof row === "object") {
            return {
              A: row.A ?? row.a ?? row.dataHoraRede ?? "",
              B: row.B ?? row.b ?? row.dataHora ?? row.dataHoraFiltro ?? "",
              C: row.C ?? row.c ?? row.lojaOrigem ?? "",
              D: row.D ?? row.d ?? row.usuario ?? "",
              E: row.E ?? row.e ?? row.responsavel ?? "",
              F: row.F ?? row.f ?? row.descricao ?? "",
              G: row.G ?? row.g ?? row.quantidade ?? "",
              H: row.H ?? row.h ?? row.embalagem ?? "",
              I: row.I ?? row.i ?? row.lojaDestino ?? "",
              J: row.J ?? row.j ?? row.tipo ?? "",
              K: row.K ?? row.k ?? row.status ?? "",
              L: row.L ?? row.l ?? row.documento ?? "",
              M: row.M ?? row.m ?? row.fornecedor ?? ""
            };
          }
          return {A:"",B:"",C:"",D:"",E:"",F:"",G:"",H:"",I:"",J:"",K:"",L:"",M:""};
        });

        setMsg(`Dados carregados: ${linhas.length} itens.`, true);
        render();

      } catch (e) {
        console.error(e);
        setMsg("Erro de rede ao carregar dados.", false);
        linhas = [];
        render();
      }
    }

    function lerFiltros(){
      const elLoja = document.getElementById("fLoja");
      return {
        loja: normStr(elLoja ? elLoja.value : ""),
        data: normStr(document.getElementById("fData").value),
        tipo: normStr(document.getElementById("fTipo").value),
        status: normStr(document.getElementById("fStatus").value)
      };
    }

    function lojaSelecionadaEfetiva(){
      if (!sessaoAtual) return "";
      if (perfilEhBasePPP(sessaoAtual.perfil)) return normStr(sessaoAtual.loja);
      const f = lerFiltros();
      return f.loja;
    }

    function aplicarFiltrosNasLinhas(){
      const f = lerFiltros();
      const lojaEfetiva = lojaSelecionadaEfetiva();

      return linhas.filter(r => {
        const dataISO = extrairDataISO(r.B);
        const lojaOrigem = normStr(r.C);
        const lojaDestino = normStr(r.I);
        const tipoCanon = tipoToCanon(r.J);
        const statusCanon = statusToCanon(r.K);

        if (f.data && dataISO !== f.data) return false;

        if (lojaEfetiva) {
          const okLoja =
            (normKey(lojaOrigem) === normKey(lojaEfetiva)) ||
            (normKey(lojaDestino) === normKey(lojaEfetiva));
          if (!okLoja) return false;
        }

        if (f.tipo && f.tipo !== tipoCanon) return false;
        if (f.status && f.status !== statusCanon) return false;

        return true;
      });
    }

    function agruparPorDocumento(linhasFiltradas){
      const map = new Map();
      linhasFiltradas.forEach(r => {
        const doc = normStr(r.L) || "SEM_DOCUMENTO";
        if (!map.has(doc)) map.set(doc, []);
        map.get(doc).push(r);
      });

      const itens = Array.from(map.entries()).map(([documento, items]) => {
        const primeiro = items[0] || {};
        const dataISO = extrairDataISO(primeiro.B);
        return { documento, items, dataISO };
      });

      itens.sort((a,b) => (b.dataISO || "").localeCompare(a.dataISO || ""));
      return itens;
    }

    // ===== Modal =====
    const modal = {
      el: null,
      txt: null,
      btnSim: null,
      btnNao: null,
      documento: "",
      onConfirm: null
    };

    function abrirModalValidar(documento){
      modal.documento = documento;
      modal.txt.textContent = "Esse Bono est√° pendente de valida√ß√£o, deseja valida-lo? Ressalto que a valida√ß√£o deve ser efetuada somente ap√≥s a conferencia f√≠sica e somente se todos dos produtos estiverem constando de acordo com este documento.";
      modal.el.classList.add("show");
    }
    function fecharModalValidar(){
      modal.el.classList.remove("show");
      modal.documento = "";
      modal.onConfirm = null;
    }

    function podeVerBotaoValidar({ statusCanon, tipoCanon, lojaDestino }){
      if (!sessaoAtual) return false;
      if (statusCanon !== "PENDENTE") return false;
      if (tipoCanon !== "MOVIMENTACAO_INTERNA") return false;
      if (!normStr(lojaDestino)) return false;
      return normKey(lojaDestino) === normKey(sessaoAtual.loja);
    }

    async function validarDocumentoNoBackend(documento){
      const payload = { documento: documento, status: "VALIDADO" };

      const resp = await fetch(ENDPOINT_VALIDAR, {
        method: "POST",
        credentials: "include",
        headers: { "Accept": "application/json", "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const ct = (resp.headers.get("content-type") || "").toLowerCase();
      if (!ct.includes("application/json")) {
        const t = await resp.text().catch(() => "");
        throw new Error(`Backend n√£o retornou JSON (${resp.status}): ${(t || "").slice(0, 200)}`);
      }

      const dados = await resp.json().catch(() => null);
      const ok = !!(dados && (dados.sucesso ?? dados.success ?? dados.ok));

      if (!resp.ok || !ok) {
        throw new Error(`Falha ao validar (${resp.status})`);
      }

      return true;
    }

    function aplicarValidacaoLocal(documento){
      linhas = linhas.map(r => {
        const doc = normStr(r.L) || "SEM_DOCUMENTO";
        if (doc !== documento) return r;
        return { ...r, K: "VALIDADO" };
      });
    }

    // ===== √çcones (SVG) =====
    function svgInfo(){
      return `
        <svg class="ic ic-blue" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="12" r="9" stroke-width="2"></circle>
          <line x1="12" y1="10" x2="12" y2="17" stroke-width="2" stroke-linecap="round"></line>
          <circle cx="12" cy="7" r="1" fill="#1f4f95"></circle>
        </svg>
      `;
    }

    function svgClock(){
      return `
        <svg class="ic ic-blue" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <rect x="4" y="5" width="16" height="15" rx="3" stroke-width="2"></rect>
          <line x1="8" y1="3.5" x2="8" y2="7" stroke-width="2" stroke-linecap="round"></line>
          <line x1="16" y1="3.5" x2="16" y2="7" stroke-width="2" stroke-linecap="round"></line>
          <line x1="4" y1="10" x2="20" y2="10" stroke-width="2" stroke-linecap="round"></line>
        </svg>
      `;
    }

    function svgStore(){
      return `
        <svg class="ic ic-blue" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <rect x="4" y="4" width="16" height="16" rx="3" stroke-width="2"></rect>
          <rect x="7.2" y="7.2" width="3.2" height="3.2" stroke-width="2"></rect>
          <rect x="13.6" y="7.2" width="3.2" height="3.2" stroke-width="2"></rect>
          <rect x="7.2" y="13.6" width="9.6" height="3.2" stroke-width="2"></rect>
        </svg>
      `;
    }

    function svgTruck(){
      return `
        <svg class="ic ic-blue" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <rect x="3" y="7" width="11" height="10" rx="2" stroke-width="2"></rect>
          <path d="M14 10h4l3 3v4h-7" stroke-width="2" stroke-linejoin="round"></path>
          <circle cx="7" cy="18" r="1.8" stroke-width="2"></circle>
          <circle cx="18" cy="18" r="1.8" stroke-width="2"></circle>
        </svg>
      `;
    }

    function svgHourglass(){
      return `
        <svg class="ic" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7 3h10M7 21h10" stroke="#a85d10" stroke-width="2" stroke-linecap="round"></path>
          <path d="M8 3c0 4 4 5 4 9s-4 5-4 9" stroke="#a85d10" stroke-width="2" stroke-linecap="round"></path>
          <path d="M16 3c0 4-4 5-4 9s4 5 4 9" stroke="#a85d10" stroke-width="2" stroke-linecap="round"></path>
        </svg>
      `;
    }

    function svgCheck(){
      return `
        <svg class="ic" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M20 7L10 17l-4-4" stroke="#0b6b2f" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
      `;
    }

    function svgPerson(){
      return `
        <svg class="ic ic-blue" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="8" r="3.2" stroke-width="2"></circle>
          <path d="M5.5 20c1.4-3.8 11.6-3.8 13 0" stroke-width="2" stroke-linecap="round"></path>
        </svg>
      `;
    }

    function svgShield(){
      return `
        <svg class="ic ic-blue" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3l7 4v6c0 5-3.5 8.5-7 9-3.5-.5-7-4-7-9V7l7-4z" stroke-width="2" stroke-linejoin="round"></path>
          <path d="M9 12l2 2 4-5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
      `;
    }

    function render(){
      const linhasFiltradas = aplicarFiltrosNasLinhas();
      const docs = agruparPorDocumento(linhasFiltradas);

      setTexto("contador", `${docs.length} documento(s)`);

      const wrap = document.getElementById("listaDocs");
      wrap.innerHTML = "";

      if (!docs.length){
        wrap.innerHTML = `<div class="filtros" style="font-weight:900;color:#444;">Nenhum documento encontrado.</div>`;
        return;
      }

      docs.forEach(({documento, items}) => {
        const x = items[0];

        const dataHora = normStr(x.B) || "‚Äî";
        const lojaOrigem = normStr(x.C) || "‚Äî";
        const lojaDestino = normStr(x.I);
        const destinoVazio = !normStr(lojaDestino);

        const tipoCanon = tipoToCanon(x.J);
        const tituloTopo = (tipoCanon === "MOVIMENTACAO_INTERNA")
          ? "MOVIMENTA√á√ÉO INTERNA"
          : (tipoCanon === "RECEBIMENTO_MERCADORIAS" ? "RECEBIMENTO DE MERCADORIAS" : (normStr(x.J) || "‚Äî").toUpperCase());

        const statusCanon = statusToCanon(x.K);

        /* ‚úÖ Recebimento: mostrar VALIDADO (n√£o RECEBIDO) */
        const statusTxtTopo = (tipoCanon === "RECEBIMENTO_MERCADORIAS")
          ? "VALIDADO"
          : (statusCanon === "VALIDADO" ? "VALIDADO" : (statusCanon === "PENDENTE" ? "PENDENTE" : (normStr(x.K) || "‚Äî")));

        const responsavel = normStr(x.E) || "‚Äî";
        const usuario = normStr(x.D) || "‚Äî";
        const fornecedor = normStr(x.M) || "‚Äî";

        const rowsHtml = items.map(it => {
          const desc = escapeHtml(normStr(it.F) || "‚Äî");
          const qtd  = escapeHtml(normStr(it.G) || "‚Äî");
          const emb  = escapeHtml(normStr(it.H) || "‚Äî");

          return `
            <tr>
              <td class="col-desc">${desc}</td>
              <td class="col-qtd">${qtd}</td>
              <td class="col-emb">${emb}</td>
            </tr>
          `;
        }).join("");

        const card = document.createElement("div");
        card.className = "doc-card";

        const linhaLojaHtml = destinoVazio
          ? `
            <div class="info-row">
              ${svgStore()}
              <div class="txt"><span class="k">Loja Recep√ß√£o:</span> <span class="v">${escapeHtml(lojaOrigem)}</span></div>
            </div>
          `
          : `
            <div class="info-row">
              ${svgStore()}
              <div class="txt"><span class="k">Loja Origem:</span> <span class="v">${escapeHtml(lojaOrigem)}</span></div>
            </div>
            <div class="info-row">
              ${svgStore()}
              <div class="txt"><span class="k">Loja Destino:</span> <span class="v">${escapeHtml(lojaDestino)}</span></div>
            </div>
          `;

        const fornecedorHtml = (tipoCanon === "RECEBIMENTO_MERCADORIAS")
          ? `
            <div class="info-row">
              ${svgTruck()}
              <div class="txt"><span class="k">Fornecedor:</span> <span class="v">${escapeHtml(fornecedor)}</span></div>
            </div>
          `
          : ``;

        const mostrarBtnValidar = podeVerBotaoValidar({ statusCanon, tipoCanon, lojaDestino });

        const badgeClass = (statusTxtTopo === "PENDENTE") ? "badge-pendente" : "badge-validado";
        const badgeIcon  = (statusTxtTopo === "PENDENTE") ? svgHourglass() : svgCheck();

        card.innerHTML = `
          <div class="doc-head">
            <div class="doc-head-title">${escapeHtml(tituloTopo)}</div>

            <div class="doc-head-body">
              <!-- ============================================================
                   ‚úÖ (2) + (3) + (4)
                   - Linha √∫nica de status acima da Data/Hora
                   - √çcone + "Status:" √† direita do √≠cone
                   - Bot√£o VALIDAR laranja (sem emoji) quando permitido
                   - Badge permanece √† direita
              ============================================================ -->
              <div class="doc-topline">
                <div class="doc-topline-left">
                  ${svgInfo()}
                  <span class="status-title">Status:</span>
                </div>

                <div class="doc-topline-right">
                  ${
                    mostrarBtnValidar
                      ? `<button class="btn-validar" type="button" title="Validar pend√™ncia" aria-label="Validar pend√™ncia" data-acao="validar" data-doc="${escapeHtml(documento)}">VALIDAR</button>`
                      : ``
                  }

                  <div class="doc-badge ${badgeClass}">
                    ${badgeIcon}
                    <span>${escapeHtml(statusTxtTopo)}</span>
                  </div>
                </div>
              </div>

              <!-- ‚úÖ linha divis√≥ria acima da Data/Hora -->
              <hr class="head-sep" />

              <div class="info-row">
                ${svgClock()}
                <div class="txt"><span class="k">Data/Hora:</span> <span class="v">${escapeHtml(dataHora)}</span></div>
              </div>

              ${linhaLojaHtml}
              ${fornecedorHtml}
            </div>
          </div>

          <div class="doc-table-wrap">
            <div class="doc-table-head">
              <div>DESCRI√á√ÉO</div>
              <div class="h-right">QTD</div>
              <div class="h-right">Embalagem</div>
            </div>

            <table class="doc-table" aria-label="Itens do documento">
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
          </div>

          <div class="assinaturas">
            <!-- ============================================================
                 ‚úÖ (5) UM √öNICO CART√ÉO COM DIVIS√ÉO VERTICAL
                 - Substitui dois cards separados por um card s√≥ (ass-join)
            ============================================================ -->
            <div class="ass-join">
              <div class="ass-side">
                ${svgPerson()}
                <div class="ass-txt">
                  <div class="ass-k">Respons√°vel</div>
                  <div class="ass-v">${escapeHtml(responsavel)}</div>
                </div>
              </div>

              <div class="ass-divider" aria-hidden="true"></div>

              <div class="ass-side">
                ${svgShield()}
                <div class="ass-txt">
                  <div class="ass-k">Valida√ß√£o PPP</div>
                  <div class="ass-v">${escapeHtml(usuario)}</div>
                </div>
              </div>
            </div>
          </div>
        `;

        const btn = card.querySelector('button[data-acao="validar"]');
        if (btn){
          btn.addEventListener("click", () => {
            const doc = btn.getAttribute("data-doc") || "";
            abrirModalValidar(doc);
          });
        }

        wrap.appendChild(card);
      });
    }

    function limparFiltros(){
      const elLoja = document.getElementById("fLoja");
      if (elLoja) elLoja.value = "";

      document.getElementById("fData").value = "";
      document.getElementById("fTipo").value = "";
      document.getElementById("fStatus").value = "";

      render();
      setMsg("Filtros limpos.", true);
    }

    function setDataHojeNoFiltro(){
      const el = document.getElementById("fData");
      if (!el) return;
      const hoje = new Date();
      const yyyy = String(hoje.getFullYear()).padStart(4,"0");
      const mm = String(hoje.getMonth()+1).padStart(2,"0");
      const dd = String(hoje.getDate()).padStart(2,"0");
      el.value = `${yyyy}-${mm}-${dd}`;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      modal.el = document.getElementById("modalValidar");
      modal.txt = document.getElementById("modalValidarTexto");
      modal.btnSim = document.getElementById("btnModalSim");
      modal.btnNao = document.getElementById("btnModalNao");

      modal.btnNao.addEventListener("click", () => fecharModalValidar());
      modal.el.addEventListener("click", (e) => { if (e.target === modal.el) fecharModalValidar(); });

      modal.btnSim.addEventListener("click", async () => {
        const doc = modal.documento;
        if (!doc) return fecharModalValidar();

        setMsg("Validando...", true);

        try{
          await validarDocumentoNoBackend(doc);
          aplicarValidacaoLocal(doc);
          fecharModalValidar();
          setMsg("Bono validado com sucesso.", true);
          render();
        } catch (err){
          console.error(err);
          fecharModalValidar();
          setMsg("Falha ao validar no servidor.", false);
        }
      });

      document.getElementById("btnVoltarMenu").addEventListener("click", () => {
        window.location.href = ROTAS.menu;
      });

      document.getElementById("btnAtualizar").addEventListener("click", async () => {
        await buscarDados();
      });

      document.getElementById("btnLimpar").addEventListener("click", () => {
        limparFiltros();
      });

      const sessao = await obterSessaoDoBackend();
      if (!sessao) return redirecionarParaLogin("Sess√£o inv√°lida. Fa√ßa login novamente.");

      sessaoAtual = sessao;

      aplicarVisibilidadeFiltroLoja();

      if (perfilEhAdmin(sessao.perfil) || perfilEhGerentePPP(sessao.perfil)) {
        preencherSelectComLojas("fLoja", true);
      }

      setDataHojeNoFiltro();

      ["fLoja","fData","fTipo","fStatus"].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("change", () => render());
        el.addEventListener("input", () => render());
      });

      await buscarDados();
    });
  </script>
</body>
</html>

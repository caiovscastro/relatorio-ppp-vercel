<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bono de Recepção/Movimentação</title>

  <style>
    html, body{ width:100%; max-width:100%; overflow-x:hidden; }
    body{
      background:#f3f3f3;
      font-family: Arial, sans-serif;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:100vh;
      margin:2px;
      color:#111;
    }

    .container{
      width: 92%;
      max-width: 1100px;
      background:#fff;
      padding: 22px 22px 18px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      box-sizing: border-box;
      margin-top: 10px;
    }

    .logo-menu{
      display:flex;
      justify-content:center;
      align-items:center;
      margin: 0 0 8px;
    }
    .logo-menu img{
      max-width: 220px;
      width: 70%;
      height: auto;
      display:block;
      user-select:none;
      -webkit-user-drag: none;
    }

    .linha-logo{
      border: none;
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(0,0,0,0.12), transparent);
      margin: 6px 0 14px;
    }

    .titulo{
      text-align:center;
      margin: 8px 0 12px;
      font-size: 20px;
      font-weight: 900;
    }

    /* ===== Filtros ===== */
    .filtros{
      border: 1px solid #ececec;
      border-radius: 12px;
      padding: 12px;
      background:#fff;
      margin-bottom: 14px;
    }

    .filtros-titulo{
      font-size: 14px;
      font-weight: 900;
      margin: 0 0 10px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 560px){
      .grid{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size: 12px;
      font-weight: 800;
      color:#333;
      margin-bottom: 6px;
    }
    input, select{
      width:100%;
      box-sizing:border-box;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
      outline:none;
      background:#fff;
    }

    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 560px){
      .actions{ grid-template-columns: 1fr; }
    }

    .btn{
      width:100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 800;
    }
    .btn-sec{ background:#e9e9e9; color:#111; }
    .btn-sec:hover{ background:#dedede; }
    .btn-pri{ background:#111; color:#fff; }
    .btn-pri:hover{ opacity:.92; }

    .mensagem{
      margin-top: 10px;
      text-align:center;
      font-weight:800;
      font-size: 13px;
      min-height: 18px;
      color:#b30000;
    }
    .ok{ color:#0b6b2f; }

    /* ===== Lista de cartões ===== */
    .resultados-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin: 10px 0 8px;
      flex-wrap: wrap;
    }
    .contador{
      font-weight: 900;
      font-size: 13px;
      color:#222;
    }

    /* ✅ Mais destaque/relevo */
    .doc-card{
      border: 1px solid #dfe6f2;
      border-radius: 14px;
      background: #f7f9ff;
      box-shadow: 0 14px 34px rgba(0,0,0,0.16);
      padding: 12px;
      margin-bottom: 14px;
      overflow:hidden;
    }

    .doc-top{
      background: #eef3ff;
      border: 1px solid #d8e2ff;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    }

    .doc-top .meta{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 12px;
      align-items:center;
      font-size: 12.5px;
      font-weight: 800;
      color:#243b6b;
    }

    @media (max-width: 650px){
      .doc-top .meta{ grid-template-columns: 1fr; }
    }

    .meta .row{
      display:flex;
      gap: 8px;
      align-items:baseline;
      min-width: 0;
    }
    .meta .lbl{
      color:#1f2f57;
      font-weight: 900;
      white-space: nowrap;
    }
    .meta .val{
      color:#111;
      font-weight: 900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space: nowrap;
    }

    /* ✅ Status cores */
    .status-pendente{ color:#b30000 !important; }
    .status-validado{ color:#0b6b2f !important; }

    /* ✅ Botão ícone de validação */
    .status-wrap{
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 0;
    }
    .btn-status{
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      font-size: 16px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btn-status:hover{ transform: translateY(-1px); }

    .doc-table-wrap{
      margin-top: 10px;
      border-radius: 12px;
      overflow:hidden;
      border: 1px solid #d8e2ff;
      background:#fff;
      box-shadow: 0 10px 22px rgba(0,0,0,0.10);
    }

    /* ✅ Só 3 colunas: DESCRIÇÃO, QTD, Embalagem (QTD e Embalagem à direita) */
    .doc-table-head{
      background: linear-gradient(to bottom, #1f4f95, #173f78);
      color:#fff;
      font-weight: 900;
      padding: 10px 12px;
      display:grid;
      grid-template-columns: 1fr 80px 120px;
      gap: 8px;
      font-size: 12.5px;
      align-items:center;
    }
    .doc-table-head .h-right{ text-align:right; }

    .doc-table{
      width:100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .doc-table td{
      border-top: 1px solid #e8eeff;
      padding: 10px 12px;
      font-size: 12.5px;
      font-weight: 800;
      color:#111;
      vertical-align: top;
      word-wrap: break-word;
    }
    .doc-table tr:nth-child(even) td{ background:#fafcff; }

    .col-desc{ width:auto; }
    .col-qtd{ width:80px; text-align:right; }
    .col-emb{ width:120px; text-align:right; }

    /* ✅ No celular: fonte menor para caber */
    @media (max-width: 560px){
      .doc-table-head{
        grid-template-columns: 1fr 66px 92px;
        font-size: 10.5px;
        padding: 9px 10px;
        gap: 6px;
      }
      .doc-table td{
        font-size: 10.5px;
        padding: 8px 10px;
      }
      .col-qtd{ width:66px; }
      .col-emb{ width:92px; }
    }

    .assinaturas{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .ass-box{
      background:#eef3ff;
      border: 1px solid #d8e2ff;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 12.5px;
      font-weight: 900;
      color:#1f2f57;
      display:flex;
      gap: 8px;
      align-items:baseline;
      min-width:0;
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    }
    .ass-box .val{
      color:#111;
      font-weight: 900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space: nowrap;
      flex: 1;
    }

    .hidden{ display:none !important; }

    /* ✅ Modal (popup) de validação */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      z-index: 9999;
    }
    .modal-backdrop.show{ display:flex; }

    .modal{
      width: 100%;
      max-width: 560px;
      background:#fff;
      border-radius: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.22);
      border: 1px solid #e9e9e9;
      overflow:hidden;
    }
    .modal-header{
      padding: 12px 14px;
      font-weight: 900;
      font-size: 14px;
      background: #f6f6f6;
      border-bottom: 1px solid #ededed;
    }
    .modal-body{
      padding: 14px;
      font-size: 13px;
      font-weight: 800;
      color:#222;
      line-height: 1.35;
    }
    .modal-actions{
      display:flex;
      gap: 10px;
      padding: 12px 14px 14px;
      border-top: 1px solid #ededed;
      justify-content:flex-end;
      flex-wrap: wrap;
    }
    .btn-modal{
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      cursor:pointer;
      font-weight: 900;
      font-size: 13px;
    }
    .btn-nao{ background:#e9e9e9; color:#111; }
    .btn-sim{ background:#111; color:#fff; }
    .btn-sim:hover{ opacity:.92; }
    .btn-nao:hover{ background:#dedede; }
  </style>
</head>

<body>
  <div class="container">
    <div class="logo-menu">
      <img src="https://i.ibb.co/prMfd6Fs/IMG-20260121-161142.png" alt="Logo PPP" />
    </div>

    <hr class="linha-logo" />

    <div class="titulo">Bono de Recepção/Movimentação</div>

    <!-- ===== Filtros ===== -->
    <div class="filtros">
      <div class="filtros-titulo">Filtros</div>

      <div class="grid">
        <div id="wrapFiltroLoja" class="hidden">
          <label for="fLoja">Loja</label>
          <select id="fLoja">
            <option value="">Todas</option>
          </select>
        </div>

        <div>
          <label for="fData">Data</label>
          <input type="date" id="fData" />
        </div>

        <div>
          <label for="fTipo">Tipo</label>
          <select id="fTipo">
            <option value="">Todos</option>
            <option value="MOVIMENTACAO_INTERNA">Movimentação interna</option>
            <option value="RECEBIMENTO_MERCADORIAS">Recebimento de mercadorias</option>
          </select>
        </div>

        <div>
          <label for="fStatus">Status</label>
          <select id="fStatus">
            <option value="">Todos</option>
            <option value="VALIDADO">Validado</option>
            <option value="PENDENTE">PENDENTE</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-sec" id="btnLimpar">Limpar filtros</button>
        <button class="btn btn-pri" id="btnAtualizar">Atualizar (refazer busca)</button>
        <button class="btn btn-sec" id="btnVoltarMenu">Voltar ao menu</button>
      </div>

      <div class="mensagem" id="msg"></div>
    </div>

    <div class="resultados-top">
      <div class="contador" id="contador">0 documento(s)</div>
    </div>

    <div id="listaDocs"></div>
  </div>

  <!-- ✅ Modal validação -->
  <div class="modal-backdrop" id="modalValidar">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalValidarTitulo">
      <div class="modal-header" id="modalValidarTitulo">Validação do Bono</div>
      <div class="modal-body" id="modalValidarTexto"></div>
      <div class="modal-actions">
        <button class="btn-modal btn-nao" id="btnModalNao" type="button">Não</button>
        <button class="btn-modal btn-sim" id="btnModalSim" type="button">Sim</button>
      </div>
    </div>
  </div>

  <script>
    const ROTAS = { menu: "/menu.html", login: "/login.html" };

    const ENDPOINT_CANDIDATOS = [
      "/api/bono-listar.js"
    ];

    let sessaoAtual = null;
    let linhas = [];
    let ENDPOINT_LISTAR_RESOLVIDO = "";

    // (interno) endpoint de validação (precisa existir no backend)
    const ENDPOINT_VALIDAR = "/api/bono-validar.js";

    const LOJAS = [
      "BIG 01 - 106 NORTE","BIG 02 - 402 NORTE","BIG 03 - 413 SUL","BIG 04 - 301 SW","BIG 05 - 408 NORTE",
      "BIG 06 - SIBERIA","BIG 08 - 503 SUL","BIG 09 - PENÍNSULA","BIG 10 - PAINEIRAS","BIG 11 - 310 NORTE",
      "BIG 12 - 208 NORTE","BIG 13 - QI-05 L. NORTE","BIG 14 - 508 SUL","BIG 15 - 105 SW","BIG 16 - 512 SUL",
      "BIG 17 - QI-11 LAGO SUL","BIG 18 - 211 NORTE","BIG 19 - CASTANHEIRA","BIG 20 - TAGUATINGA C1","BIG 21 - CNB12",
      "BIG 22 - 102 NOROESTE","BIG 23 - QI-23 LAGO SUL","BIG 24 - 314 NORTE","BIG 25 - 410 SUL",
      "ULT 01 - PLANALTINA","ULT 02 - GAMA","ULT 03 - COLORADO","ULT 04 - CEI SUL","ULT 05 - POLO JK",
      "ULT 06 - SOBRADINHO","ULT 07 - ADE","ULT 08 - ARAPOANGA","ULT 09 - CEI NORTE","ULT 10 - ESTRUTURAL",
      "ULT 11 - ITAPOA","ULT 12 - SAO SEBASTIAO","ULT 13 - RECANTO","ULT 14 - AGUAS LINDAS","ULT 15 - SOL NASCENTE",
      "ULT 16 - PARANOA PARK","ULT 17 - SAMAMBAIA","ULT 18 - BRAZLANDIA","ULT 19 - VIA PARK","ULT 20 - TAGUATINGA",
      "ULT 22 - VICENTE PIRES","ULT 23 - SANTA MARIA","ULT 24 - PAUL BRASIL","ULT 25 - BRASILINHA",
      "TOTAL DISTRIBUICAO","INDUSPAN","MATRIZ"
    ];

    function setTexto(id, txt) {
      const el = document.getElementById(id);
      if (el) el.textContent = txt;
    }

    function setMsg(txt, ok=false){
      const el = document.getElementById("msg");
      el.textContent = txt || "";
      el.classList.toggle("ok", !!ok);
    }

    function normStr(s){
      return String(s ?? "").trim();
    }

    function normKey(s){
      return normStr(s).toUpperCase().replace(/\s+/g, " ");
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function perfilEhAdmin(perfil){
      return normKey(perfil).includes("ADMIN");
    }
    function perfilEhGerentePPP(perfil){
      const p = normKey(perfil);
      return p.includes("GERENTE_PPP") || (p.includes("GERENTE") && p.includes("PPP"));
    }
    function perfilEhBasePPP(perfil){
      const p = normKey(perfil);
      return p.includes("BASE_PPP") || (p.includes("BASE") && p.includes("PPP"));
    }

    function extrairDataISO(dataHoraBR){
      const t = normStr(dataHoraBR);
      if (!t) return "";
      const parteData = t.split(" ")[0];
      const [dd,mm,aa] = parteData.split("/");
      if (!dd || !mm || !aa) return "";
      const d = String(dd).padStart(2,"0");
      const m = String(mm).padStart(2,"0");
      const a = String(aa).padStart(4,"0");
      return `${a}-${m}-${d}`;
    }

    function tipoToCanon(tipo){
      const t = normKey(tipo);
      if (t.includes("MOV") && (t.includes("INTERNA") || t.includes("INTERNO") || t.includes("MOV_INTERNA"))) return "MOVIMENTACAO_INTERNA";
      if (t.includes("RECEB") || t.includes("MERCADORIA")) return "RECEBIMENTO_MERCADORIAS";
      return "";
    }

    function statusToCanon(status){
      const s = normKey(status);
      if (s.includes("VALID")) return "VALIDADO";
      if (s.includes("PEND")) return "PENDENTE";
      return "";
    }

    function statusClasse(statusCanon){
      if (statusCanon === "PENDENTE") return "status-pendente";
      if (statusCanon === "VALIDADO") return "status-validado";
      return "";
    }

    async function obterSessaoDoBackend() {
      try {
        const resp = await fetch("/api/session", {
          method: "GET",
          credentials: "include",
          headers: { "Accept": "application/json" }
        });
        if (!resp.ok) return null;

        const ct = (resp.headers.get("content-type") || "").toLowerCase();
        if (!ct.includes("application/json")) return null;

        const dados = await resp.json().catch(() => null);
        if (!dados) return null;

        const ok = !!(dados.sucesso ?? dados.success ?? dados.ok);
        if (!ok || !dados.usuario || !dados.loja || !dados.perfil) return null;

        return dados;
      } catch {
        return null;
      }
    }

    function redirecionarParaLogin(motivo) {
      if (motivo) setMsg(motivo, false);
      window.location.href = ROTAS.login;
    }

    function preencherSelectComLojas(selId, incluirTodas = true){
      const sel = document.getElementById(selId);
      if (!sel) return;

      const atual = sel.value;

      sel.innerHTML = "";
      if (incluirTodas){
        const op = document.createElement("option");
        op.value = "";
        op.textContent = "Todas";
        sel.appendChild(op);
      }

      LOJAS.forEach(lj => {
        const op = document.createElement("option");
        op.value = lj;
        op.textContent = lj;
        sel.appendChild(op);
      });

      if (atual) sel.value = atual;
    }

    function aplicarVisibilidadeFiltroLoja(){
      const wrap = document.getElementById("wrapFiltroLoja");
      if (!sessaoAtual || !wrap) return;

      const podeVer = perfilEhAdmin(sessaoAtual.perfil) || perfilEhGerentePPP(sessaoAtual.perfil);
      wrap.classList.toggle("hidden", !podeVer);

      if (podeVer){
        preencherSelectComLojas("fLoja", true);
      } else {
        const sel = document.getElementById("fLoja");
        if (sel) sel.innerHTML = '<option value="">Todas</option>';
      }
    }

    async function resolverEndpointListar(){
      if (ENDPOINT_LISTAR_RESOLVIDO) return ENDPOINT_LISTAR_RESOLVIDO;

      for (const ep of ENDPOINT_CANDIDATOS){
        try{
          const r = await fetch(ep, {
            method: "GET",
            credentials: "include",
            headers: { "Accept": "application/json" }
          });

          if (r.status === 404) continue;

          ENDPOINT_LISTAR_RESOLVIDO = ep;
          return ep;
        } catch {
          continue;
        }
      }

      ENDPOINT_LISTAR_RESOLVIDO = ENDPOINT_CANDIDATOS[0];
      return ENDPOINT_LISTAR_RESOLVIDO;
    }

    async function buscarDados() {
      setMsg("Carregando dados...", true);

      try {
        const endpoint = await resolverEndpointListar();

        const resp = await fetch(endpoint, {
          method: "GET",
          credentials: "include",
          headers: { "Accept": "application/json" }
        });

        const ct = (resp.headers.get("content-type") || "").toLowerCase();

        if (resp.status === 404) {
          console.error("Falha no endpoint (404):", endpoint);
          setMsg("Falha ao carregar dados (endpoint não encontrado).", false);
          linhas = [];
          render();
          return;
        }

        if (!ct.includes("application/json")) {
          const txt = await resp.text().catch(() => "");
          console.error("Endpoint não retornou JSON:", { endpoint, status: resp.status, ct, body: (txt || "").slice(0, 600) });
          setMsg("Falha ao carregar dados (endpoint).", false);
          linhas = [];
          render();
          return;
        }

        const dados = await resp.json().catch(() => null);
        const ok = !!(dados && (dados.sucesso ?? dados.success ?? dados.ok));

        if (!resp.ok || !ok) {
          console.error("Falha no endpoint:", { endpoint, status: resp.status, dados });
          setMsg("Falha ao carregar dados (endpoint).", false);
          linhas = [];
          render();
          return;
        }

        const arr =
          Array.isArray(dados.dados) ? dados.dados :
          (Array.isArray(dados.data) ? dados.data :
          (Array.isArray(dados.rows) ? dados.rows : []));

        linhas = arr.map((row) => {
          if (Array.isArray(row)) {
            return {
              A: row[0] ?? "", B: row[1] ?? "", C: row[2] ?? "", D: row[3] ?? "",
              E: row[4] ?? "", F: row[5] ?? "", G: row[6] ?? "", H: row[7] ?? "",
              I: row[8] ?? "", J: row[9] ?? "", K: row[10] ?? "", L: row[11] ?? ""
            };
          }
          if (row && typeof row === "object") {
            return {
              A: row.A ?? row.a ?? row.dataHoraRede ?? "",
              B: row.B ?? row.b ?? row.dataHora ?? row.dataHoraFiltro ?? "",
              C: row.C ?? row.c ?? row.lojaOrigem ?? "",
              D: row.D ?? row.d ?? row.usuario ?? "",
              E: row.E ?? row.e ?? row.responsavel ?? "",
              F: row.F ?? row.f ?? row.descricao ?? "",
              G: row.G ?? row.g ?? row.quantidade ?? "",
              H: row.H ?? row.h ?? row.embalagem ?? "",
              I: row.I ?? row.i ?? row.lojaDestino ?? "",
              J: row.J ?? row.j ?? row.tipo ?? "",
              K: row.K ?? row.k ?? row.status ?? "",
              L: row.L ?? row.l ?? row.documento ?? ""
            };
          }
          return {A:"",B:"",C:"",D:"",E:"",F:"",G:"",H:"",I:"",J:"",K:"",L:""};
        });

        setMsg(`Dados carregados: ${linhas.length} linha(s).`, true);
        render();

      } catch (e) {
        console.error(e);
        setMsg("Erro de rede ao carregar dados.", false);
        linhas = [];
        render();
      }
    }

    function lerFiltros(){
      const elLoja = document.getElementById("fLoja");
      return {
        loja: normStr(elLoja ? elLoja.value : ""),
        data: normStr(document.getElementById("fData").value),
        tipo: normStr(document.getElementById("fTipo").value),
        status: normStr(document.getElementById("fStatus").value)
      };
    }

    function lojaSelecionadaEfetiva(){
      if (!sessaoAtual) return "";
      if (perfilEhBasePPP(sessaoAtual.perfil)) return normStr(sessaoAtual.loja);
      const f = lerFiltros();
      return f.loja;
    }

    function aplicarFiltrosNasLinhas(){
      const f = lerFiltros();
      const lojaEfetiva = lojaSelecionadaEfetiva();

      return linhas.filter(r => {
        const dataISO = extrairDataISO(r.B);
        const lojaOrigem = normStr(r.C);
        const lojaDestino = normStr(r.I);
        const tipoCanon = tipoToCanon(r.J);
        const statusCanon = statusToCanon(r.K);

        if (f.data && dataISO !== f.data) return false;

        if (lojaEfetiva) {
          const okLoja =
            (normKey(lojaOrigem) === normKey(lojaEfetiva)) ||
            (normKey(lojaDestino) === normKey(lojaEfetiva));
          if (!okLoja) return false;
        }

        if (f.tipo && f.tipo !== tipoCanon) return false;
        if (f.status && f.status !== statusCanon) return false;

        return true;
      });
    }

    function agruparPorDocumento(linhasFiltradas){
      const map = new Map();
      linhasFiltradas.forEach(r => {
        const doc = normStr(r.L) || "SEM_DOCUMENTO";
        if (!map.has(doc)) map.set(doc, []);
        map.get(doc).push(r);
      });

      const itens = Array.from(map.entries()).map(([documento, items]) => {
        const primeiro = items[0] || {};
        const dataISO = extrairDataISO(primeiro.B);
        return { documento, items, dataISO };
      });

      itens.sort((a,b) => (b.dataISO || "").localeCompare(a.dataISO || ""));
      return itens;
    }

    // ===== Modal =====
    const modal = {
      el: null,
      txt: null,
      btnSim: null,
      btnNao: null,
      documento: "",
      onConfirm: null
    };

    function abrirModalValidar(documento){
      modal.documento = documento;
      modal.txt.textContent = "Esse Bono está pendente de validação, deseja valida-lo? Ressalto que a validação deve ser efetuada somente após a conferencia física e somente se todos dos produtos estiverem constando de acordo com este documento.";
      modal.el.classList.add("show");
    }
    function fecharModalValidar(){
      modal.el.classList.remove("show");
      modal.documento = "";
      modal.onConfirm = null;
    }

    function podeVerBotaoValidar({ statusCanon, tipoCanon, lojaDestino }){
      if (!sessaoAtual) return false;
      if (statusCanon !== "PENDENTE") return false;
      if (tipoCanon !== "MOVIMENTACAO_INTERNA") return false; // “movimentação que recebi”
      if (!normStr(lojaDestino)) return false;
      return normKey(lojaDestino) === normKey(sessaoAtual.loja);
    }

    async function validarDocumentoNoBackend(documento){
      const payload = { documento: documento, status: "VALIDADO" };

      const resp = await fetch(ENDPOINT_VALIDAR, {
        method: "POST",
        credentials: "include",
        headers: { "Accept": "application/json", "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const ct = (resp.headers.get("content-type") || "").toLowerCase();
      if (!ct.includes("application/json")) {
        const t = await resp.text().catch(() => "");
        throw new Error(`Backend não retornou JSON (${resp.status}): ${(t || "").slice(0, 200)}`);
      }

      const dados = await resp.json().catch(() => null);
      const ok = !!(dados && (dados.sucesso ?? dados.success ?? dados.ok));

      if (!resp.ok || !ok) {
        throw new Error(`Falha ao validar (${resp.status})`);
      }

      return true;
    }

    function aplicarValidacaoLocal(documento){
      linhas = linhas.map(r => {
        const doc = normStr(r.L) || "SEM_DOCUMENTO";
        if (doc !== documento) return r;
        return { ...r, K: "VALIDADO" };
      });
    }

    function render(){
      const linhasFiltradas = aplicarFiltrosNasLinhas();
      const docs = agruparPorDocumento(linhasFiltradas);

      setTexto("contador", `${docs.length} documento(s)`);

      const wrap = document.getElementById("listaDocs");
      wrap.innerHTML = "";

      if (!docs.length){
        wrap.innerHTML = `<div class="filtros" style="font-weight:900;color:#444;">Nenhum documento encontrado com os filtros.</div>`;
        return;
      }

      docs.forEach(({documento, items}) => {
        const x = items[0];

        const dataHora = normStr(x.B) || "—";
        const lojaOrigem = normStr(x.C) || "—";
        const lojaDestino = normStr(x.I); // pode ser vazio
        const destinoVazio = !normStr(lojaDestino);

        const tipoCanon = tipoToCanon(x.J);
        const tipoTxt = tipoCanon === "MOVIMENTACAO_INTERNA"
          ? "Movimentação interna"
          : (tipoCanon === "RECEBIMENTO_MERCADORIAS" ? "Recebimento de mercadorias" : (normStr(x.J) || "—"));

        const statusCanon = statusToCanon(x.K);
        const statusTxt = statusCanon === "VALIDADO"
          ? "Validado"
          : (statusCanon === "PENDENTE" ? "PENDENTE" : (normStr(x.K) || "—"));

        const responsavel = normStr(x.E) || "—";
        const usuario = normStr(x.D) || "—";

        const rowsHtml = items.map(it => {
          const desc = escapeHtml(normStr(it.F) || "—");
          const qtd  = escapeHtml(normStr(it.G) || "—");
          const emb  = escapeHtml(normStr(it.H) || "—");

          return `
            <tr>
              <td class="col-desc">${desc}</td>
              <td class="col-qtd">${qtd}</td>
              <td class="col-emb">${emb}</td>
            </tr>
          `;
        }).join("");

        const card = document.createElement("div");
        card.className = "doc-card";

        const linhaLojaHtml = destinoVazio
          ? `<div class="row"><span class="lbl">LOJA RECEPÇÃO:</span> <span class="val">${escapeHtml(lojaOrigem)}</span></div>`
          : `
              <div class="row"><span class="lbl">LOJA ORIGEM:</span> <span class="val">${escapeHtml(lojaOrigem)}</span></div>
              <div class="row"><span class="lbl">LOJA DESTINO:</span> <span class="val">${escapeHtml(lojaDestino)}</span></div>
            `;

        // (5) Se tipo for Recebimento de mercadorias, ocultar status no card
        const ocultarStatusNoCard = (tipoCanon === "RECEBIMENTO_MERCADORIAS");

        // (6) Botão validar: só pendente + usuário logado na loja destino + movimentação interna
        const mostrarBtnValidar = podeVerBotaoValidar({ statusCanon, tipoCanon, lojaDestino });

        const statusHtml = ocultarStatusNoCard ? "" : `
          <div class="row">
            <span class="lbl">STATUS:</span>
            <span class="val ${statusClasse(statusCanon)}">
              <span class="status-wrap">
                <span>${escapeHtml(statusTxt)}</span>
                ${
                  mostrarBtnValidar
                    ? `<button class="btn-status" type="button" title="Validar" aria-label="Validar" data-acao="validar" data-doc="${escapeHtml(documento)}">✅</button>`
                    : ``
                }
              </span>
            </span>
          </div>
        `;

        card.innerHTML = `
          <div class="doc-top">
            <div class="meta">
              <div class="row"><span class="lbl">DATA/HORA:</span> <span class="val">${escapeHtml(dataHora)}</span></div>

              ${linhaLojaHtml}

              <div class="row"><span class="lbl">TIPO:</span> <span class="val">${escapeHtml(tipoTxt)}</span></div>
              ${statusHtml}
            </div>
          </div>

          <div class="doc-table-wrap">
            <div class="doc-table-head">
              <div>DESCRIÇÃO DO PRODUTO</div>
              <div class="h-right">QTD</div>
              <div class="h-right">Embalagem</div>
            </div>

            <table class="doc-table" aria-label="Itens do documento">
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
          </div>

          <div class="assinaturas">
            <div class="ass-box">
              <span>Nome Responsável Op:</span>
              <span class="val">${escapeHtml(responsavel)}</span>
            </div>

            <div class="ass-box">
              <span>Assinatura ppp:</span>
              <span class="val">${escapeHtml(usuario)}</span>
            </div>
          </div>
        `;

        // handler do botão validar (delegação simples por card)
        const btn = card.querySelector('button[data-acao="validar"]');
        if (btn){
          btn.addEventListener("click", () => {
            const doc = btn.getAttribute("data-doc") || "";
            abrirModalValidar(doc);
          });
        }

        wrap.appendChild(card);
      });
    }

    function limparFiltros(){
      const elLoja = document.getElementById("fLoja");
      if (elLoja) elLoja.value = "";

      // (4) Ao limpar, mantém a data vazia (você não pediu pra manter hoje aqui)
      document.getElementById("fData").value = "";
      document.getElementById("fTipo").value = "";
      document.getElementById("fStatus").value = "";

      render();
      setMsg("Filtros limpos.", true);
    }

    function setDataHojeNoFiltro(){
      const el = document.getElementById("fData");
      if (!el) return;
      const hoje = new Date();
      const yyyy = String(hoje.getFullYear()).padStart(4,"0");
      const mm = String(hoje.getMonth()+1).padStart(2,"0");
      const dd = String(hoje.getDate()).padStart(2,"0");
      el.value = `${yyyy}-${mm}-${dd}`;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // modal refs
      modal.el = document.getElementById("modalValidar");
      modal.txt = document.getElementById("modalValidarTexto");
      modal.btnSim = document.getElementById("btnModalSim");
      modal.btnNao = document.getElementById("btnModalNao");

      modal.btnNao.addEventListener("click", () => fecharModalValidar());
      modal.el.addEventListener("click", (e) => { if (e.target === modal.el) fecharModalValidar(); });

      modal.btnSim.addEventListener("click", async () => {
        const doc = modal.documento;
        if (!doc) return fecharModalValidar();

        setMsg("Validando...", true);

        try{
          await validarDocumentoNoBackend(doc);
          aplicarValidacaoLocal(doc);
          fecharModalValidar();
          setMsg("Bono validado com sucesso.", true);
          render();
        } catch (err){
          console.error(err);
          fecharModalValidar();
          setMsg("Falha ao validar no servidor.", false);
        }
      });

      document.getElementById("btnVoltarMenu").addEventListener("click", () => {
        window.location.href = ROTAS.menu;
      });

      document.getElementById("btnAtualizar").addEventListener("click", async () => {
        await buscarDados();
      });

      document.getElementById("btnLimpar").addEventListener("click", () => {
        limparFiltros();
      });

      const sessao = await obterSessaoDoBackend();
      if (!sessao) return redirecionarParaLogin("Sessão inválida. Faça login novamente.");

      sessaoAtual = sessao;

      aplicarVisibilidadeFiltroLoja();

      if (perfilEhAdmin(sessao.perfil) || perfilEhGerentePPP(sessao.perfil)) {
        preencherSelectComLojas("fLoja", true);
      }

      // (4) iniciar com a data atual no filtro
      setDataHojeNoFiltro();

      ["fLoja","fData","fTipo","fStatus"].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("change", () => render());
        el.addEventListener("input", () => render());
      });

      await buscarDados();
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <!-- ‚úÖ remove ‚Äúzoom‚Äù no celular ao abrir (viewport travado igual seus outros m√≥dulos) -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no" />
  <title>BONO DIGITAL</title>

  <style>
    html, body{ width:100%; max-width:100%; overflow-x:hidden; }
    html{ -webkit-text-size-adjust: 100%; } /* ‚úÖ evita ajuste/zoom de texto no mobile */
    body{
      background:#f3f3f3;
      font-family: Arial, sans-serif;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:100vh;
      margin:0;
      color:#111;
    }

    /* ‚úÖ cart√£o principal camuflado/invis√≠vel */
    .container{
      width: 97%;
      max-width: 1300px;
      background: transparent;
      padding: 0;
      border-radius: 0;
      box-shadow: none;
      box-sizing: border-box;
      margin-top: 20px;
    }

    @media (min-width: 901px){
      .container{ max-width: 910px; }
    }

    .logo-menu{
      display:flex;
      justify-content:center;
      align-items:center;
      margin: 0 0 8px;
    }
    .logo-menu img{
      max-width: 220px;
      width: 70%;
      height: auto;
      display:block;
      user-select:none;
      -webkit-user-drag: none;
    }

    .linha-logo{
      border: none;
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(0,0,0,0.12), transparent);
      margin: 6px 0 14px;
    }

    /* ===== Filtros ===== */
    .filtros{
      border: 1px solid #ececec;
      border-radius: 12px;
      padding: 12px;
      background:#fff;
      margin-bottom: 14px;
    }

    .filtros-titulo{
      font-size: 14px;
      font-weight: 900;
      margin: 0 0 10px;
    }

    .grid-top{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .grid-mid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .grid-datas{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 560px){
      .grid-top{ grid-template-columns: 1fr 1fr; gap: 8px; }
      .grid-mid{ grid-template-columns: 1fr; gap: 8px; }
      .grid-datas{ grid-template-columns: 1fr 1fr; gap: 8px; }
    }

    label{
      display:block;
      font-size: 12px;
      font-weight: 800;
      color:#333;
      margin-bottom: 6px;
    }
    input, select{
      width:100%;
      box-sizing:border-box;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
      outline:none;
      background:#fff;
    }

    /* ‚úÖ Busca com √≠cone */
    .search-wrap{
      position: relative;
      width:100%;
    }
    .search-wrap input{
      padding-left: 42px;
    }
    .search-ic{
      position:absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      pointer-events:none;
      opacity: .85;
    }
    .search-ic path, .search-ic circle, .search-ic line{
      stroke:#1f4f95;
    }

    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    @media (max-width: 560px){
      .actions{ grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
      .btn{ padding: 10px; font-size: 12.5px; border-radius: 10px; }
    }

    .btn{
      width:100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 800;
    }
    .btn-sec{ background:#e9e9e9; color:#111; }
    .btn-sec:hover{ background:#dedede; }
    .btn-pri{ background:#111; color:#fff; }
    .btn-pri:hover{ opacity:.92; }

    .mensagem{
      margin-top: 10px;
      text-align:center;
      font-weight:800;
      font-size: 13px;
      min-height: 18px;
      color:#b30000;
    }
    .ok{ color:#0b6b2f; }

    /* ===== Lista de cart√µes ===== */
    .resultados-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin: 6px 0 6px;
      flex-wrap: wrap;
    }

    /* ‚úÖ REQ #4: contador em verde e texto ‚ÄúQuantidade de documentos‚Äù */
    .contador{
      font-weight: 900;
      font-size: 13px;
      color:#0b6b2f;
    }

    .doc-card{
      border: 1px solid #e7e7e7;
      border-radius: 16px;
      background: #ffffff;
      box-shadow: 0 14px 34px rgba(0,0,0,0.16);
      padding: 5px;
      /* ‚úÖ REQ #3: 50% mais distante (15px -> 23px) */
      margin-bottom: 23px;
      overflow:hidden;
    }

    .doc-badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 900;
      letter-spacing: .2px;
      border: 1px solid transparent;
      white-space: nowrap;
      max-width: 100%;
      overflow:hidden;
      text-overflow: ellipsis;
      flex: 0 0 auto;
    }

    .badge-pendente{
      background:#f6eadc;
      border-color:#f0ddc1;
      color:#a85d10;
    }
    .badge-validado{
      background:#deefe3;
      border-color:#cfe6d6;
      color:#0b6b2f;
    }

    .doc-head-body{
      margin-top: 12px;
      background:#ffffff;
      border: 1px solid #ededed;
      border-radius: 14px 14px 0 0;
      padding: 12px 12px;
    }

    .doc-topline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background:#f2f2f2;
      border: 1px solid #e7e7e7;
      border-radius: 999px;
      padding: 10px 12px;
      min-width: 0;
    }

    .doc-topline-left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
      font-weight: 900;
      color:#1b2c55;
      flex: 0 0 auto;
    }

    .doc-topline-left .status-title{
      font-weight: 900;
      color:#1b2c55;
      white-space: nowrap;
    }

    /* no celular some ‚ÄúStatus:‚Äù */
    @media (max-width: 560px){
      .doc-topline-left .status-title{ display:none !important; }
    }

    .doc-topline-right{
      display:flex;
      align-items:center;
      gap: 10px;
      justify-content:flex-end;
      flex-wrap: nowrap;
      min-width: 0;
      max-width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .doc-topline-right::-webkit-scrollbar{ height: 0px; }

    .head-sep{
      border: none;
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(0,0,0,0.18), transparent);
      margin: 10px 0 8px;
    }

    .info-row{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 2px 2px;
      margin: 0;
      line-height: 1.05;
      font-size: 12.5px;
      font-weight: 800;
      color:#1b2c55;
    }

    .info-row svg{ display:block; }
    .info-row + .info-row{ margin-top: 2px; }

    .info-row .txt{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:baseline;
      min-width:0;
    }

    .info-row .k{
      color:#1b2c55;
      white-space: nowrap;
      font-weight: 800;
    }

    .info-row .v{
      color:#111;
      font-weight: 800;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space: nowrap;
      max-width: 100%;
    }

    .ic{
      width: 20px;
      height: 20px;
      flex: 0 0 20px;
      display:inline-block;
    }

    .ic-blue path, .ic-blue rect, .ic-blue circle, .ic-blue line, .ic-blue polyline{
      stroke:#1f4f95;
    }

    .btn-validar{
      border: none;
      cursor: pointer;
      padding: 9px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12.5px;
      letter-spacing: .2px;
      background: #f39c12;
      color: #ffffff;
      box-shadow: 0 8px 16px rgba(0,0,0,0.12);
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .btn-validar:hover{ filter: brightness(0.96); transform: translateY(-1px); }
    .btn-validar:active{ transform: translateY(0px); }

    .btn-excluir{
      border: none;
      cursor: pointer;
      padding: 9px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12.5px;
      letter-spacing: .2px;
      background: #b30000;
      color: #ffffff;
      box-shadow: 0 8px 16px rgba(0,0,0,0.12);
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .btn-excluir:hover{ filter: brightness(0.96); transform: translateY(-1px); }
    .btn-excluir:active{ transform: translateY(0px); }

    .doc-table-wrap{
      margin-top: 10px;
      border-radius: 0px;
      overflow: hidden;
      border: 1px solid #d8e2ff;
      background: #fff;
      box-shadow: 0 10px 22px rgba(0,0,0,0.10);
    }

    .doc-table-head{
      background: linear-gradient(to bottom, #1f4f95, #173f78);
      color:#fff;
      font-weight: 900;
      padding: 10px 12px;
      display: grid;
      grid-template-columns: 1fr 70px 95px;
      gap: 6px;
      font-size: 12.5px;
      align-items: center;
    }

    .doc-table-head .h-right{ text-align: right; }

    .doc-table{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .doc-table td{
      border-top: 1px solid #e8eeff;
      padding: 10px 12px;
      font-size: 12.5px;
      font-weight: 800;
      color:#111;
      vertical-align: top;
      word-wrap: break-word;
    }

    .doc-table tr:nth-child(even) td{ background:#fafcff; }

    .col-desc{ width: auto; }
    .col-qtd{
      width: 70px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .col-emb{
      width: 95px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    @media (max-width: 560px){
      .info-row{ font-size: 10.5px; }

      .doc-table-head{
        grid-template-columns: 1fr 58px 76px;
        font-size: 10.5px;
        padding: 9px 10px;
        gap: 5px;
      }

      .doc-table td{
        font-size: 10.5px;
        padding: 8px 10px;
      }

      .col-qtd{ width:58px; }
      .col-emb{ width:76px; }

      .btn-validar, .btn-excluir{ padding: 7px 10px; font-size: 10.5px; }
      .doc-topline{ padding: 9px 10px; }
      .doc-topline-left .status-title{ font-size: 10.5px; }
    }

    .hidden{ display:none !important; }

    /* ===== RODAP√â ===== */
    .assinaturas{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    @media (max-width: 650px){
      .assinaturas{ grid-template-columns: 1fr; gap: 8px; }
    }

    .ass-join{
      background:#ffffff;
      border: 1px solid #eeeeee;
      border-radius: 0 0 14px 14px;
      padding: 10px 12px;
      display:flex;
      align-items:stretch;
      gap: 12px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
      min-width: 0;
    }
    .ass-side{
      flex: 1 1 0;
      display:flex;
      align-items:flex-start;
      gap: 10px;
      min-width: 0;
    }
    .ass-divider{
      width: 1px;
      background: rgba(0,0,0,0.10);
      border-radius: 1px;
    }

    /* ‚úÖ REQ #1: Respons√°vel quebra linha e n√£o invade a coluna ‚ÄúValida√ß√£o‚Äù */
    .ass-resp{ flex: 1 1 58%; }
    .ass-val{  flex: 1 1 42%; }

    .ass-txt{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .ass-k{
      font-size: 12.5px;
      font-weight: 800;
      color:#1f4f95;
      line-height: 1.1;
    }
    .ass-v{
      font-size: 12.5px;
      font-weight: 800;
      color:#111;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space: nowrap;
      line-height: 1.1;
      min-width:0;
    }
    .ass-resp .ass-v{
      white-space: normal;       /* quebra linha */
      overflow: visible;         /* n√£o corta */
      text-overflow: clip;
      word-break: break-word;    /* garante quebra */
    }

    @media (max-width: 560px){
      .ass-join{ padding: 8px 8px; gap: 10px; }
      .ass-side{ gap: 8px; }
      .ass-divider{ background: rgba(0,0,0,0.12); }
      .ass-k{ font-size: 10.5px; }
      .ass-v{ font-size: 10.5px; }
      .ic{ width: 18px; height: 18px; flex: 0 0 18px; }
    }

    /* ‚úÖ Modal (popup) base */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      z-index: 9999;
    }
    .modal-backdrop.show{ display:flex; }

    .modal{
      width: 100%;
      max-width: 560px;
      background:#fff;
      border-radius: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.22);
      border: 1px solid #e9e9e9;
      overflow:hidden;
    }
    .modal-header{
      padding: 12px 14px;
      font-weight: 900;
      font-size: 14px;
      background: #f6f6f6;
      border-bottom: 1px solid #ededed;
    }
    .modal-body{
      padding: 14px;
      font-size: 13px;
      font-weight: 800;
      color:#222;
      line-height: 1.35;
    }
    .modal-actions{
      display:flex;
      gap: 10px;
      padding: 12px 14px 14px;
      border-top: 1px solid #ededed;
      justify-content:flex-end;
      flex-wrap: wrap;
    }
    .btn-modal{
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      cursor:pointer;
      font-weight: 900;
      font-size: 13px;
    }
    .btn-nao{ background:#e9e9e9; color:#111; }
    .btn-sim{ background:#111; color:#fff; }
    .btn-sim:hover{ opacity:.92; }
    .btn-nao:hover{ background:#dedede; }

    .danger-title{ color:#b30000; }
    .confirm-box{
      margin-top: 10px;
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .confirm-box input{
      border: 1px solid #d8d8d8;
      border-radius: 10px;
      padding: 10px;
      font-weight: 900;
    }
    .hint{
      font-size: 12px;
      color:#444;
      font-weight: 800;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="logo-menu">
      <img src="https://i.ibb.co/HpCwV5Dc/IMG-20260216-184703.png" alt="Logo PPP" />
    </div>

    <hr class="linha-logo" />

    <!-- ‚úÖ REQ #2: removido o t√≠tulo ‚ÄúBONO DIGITAL‚Äù (era este bloco) -->

    <div class="filtros">
      <div class="filtros-titulo">Filtros</div>

      <div class="grid-top">
        <div id="wrapFiltroLoja" class="hidden">
          <label for="fLoja">Loja</label>
          <select id="fLoja">
            <option value="">Todas</option>
          </select>
        </div>

        <div>
          <label for="fTipo">Tipo</label>
          <select id="fTipo">
            <option value="">Todos</option>
            <option value="MOVIMENTACAO_INTERNA">Movimenta√ß√£o interna</option>
            <option value="RECEBIMENTO_MERCADORIAS">Recebimento de mercadorias</option>
          </select>
        </div>

        <div>
          <label for="fStatus">Status</label>
          <select id="fStatus">
            <option value="">Todos</option>
            <option value="VALIDADO">Validado</option>
            <option value="PENDENTE">PENDENTE</option>
          </select>
        </div>
      </div>

      <!-- ‚úÖ REQ #5 + #6: novo seletor + busca -->
      <div class="grid-mid">
        <div>
          <label for="fDirecao">Documentos</label>
          <select id="fDirecao">
            <option value="">Todos</option>
            <option value="ENVIEI">Enviei</option>
            <option value="RECEBI">Recebi</option>
          </select>
        </div>

        <div>
          <label for="fBusca">Buscar por descri√ß√£o</label>
          <div class="search-wrap">
            <svg class="search-ic" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <circle cx="11" cy="11" r="7" stroke-width="2"></circle>
              <line x1="16.8" y1="16.8" x2="21" y2="21" stroke-width="2" stroke-linecap="round"></line>
            </svg>
            <input id="fBusca" type="text" placeholder="Digite parte da descri√ß√£o..." autocomplete="off" />
          </div>
        </div>
      </div>

      <div class="grid-datas">
        <div>
          <label for="fData">Data in√≠cio</label>
          <input type="date" id="fData" />
        </div>

        <div>
          <label for="fDataFim">Data fim</label>
          <input type="date" id="fDataFim" />
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-sec" id="btnLimpar">Limpar</button>
        <button class="btn btn-pri" id="btnAtualizar">Atualizar</button>
        <button class="btn btn-sec" id="btnVoltarMenu">Voltar</button>
      </div>

      <div class="mensagem" id="msg"></div>
    </div>

    <div class="resultados-top">
      <div class="contador" id="contador">Quantidade de documentos: 0</div>
    </div>

    <div id="listaDocs"></div>
  </div>

  <!-- ‚úÖ Modal valida√ß√£o -->
  <div class="modal-backdrop" id="modalValidar">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalValidarTitulo">
      <div class="modal-header" id="modalValidarTitulo">Valida√ß√£o do Bono</div>
      <div class="modal-body" id="modalValidarTexto"></div>
      <div class="modal-actions">
        <button class="btn-modal btn-nao" id="btnModalNao" type="button">N√£o</button>
        <button class="btn-modal btn-sim" id="btnModalSim" type="button">Sim</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Modal excluir -->
  <div class="modal-backdrop" id="modalExcluir">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalExcluirTitulo">
      <div class="modal-header danger-title" id="modalExcluirTitulo">Exclus√£o de Documento</div>
      <div class="modal-body">
        <div id="modalExcluirTexto"></div>

        <div class="confirm-box">
          <label for="confirmUser">Digite seu usu√°rio para confirmar</label>
          <input id="confirmUser" type="text" autocomplete="off" placeholder="O msm que vc efetuou login." />
          <div class="hint" id="hintUser"></div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-modal btn-nao" id="btnExcluirCancelar" type="button">Cancelar</button>
        <button class="btn-modal btn-sim" id="btnExcluirSim" type="button">Sim</button>
      </div>
    </div>
  </div>

  <script>
    const ROTAS = { menu: "/menu.html", login: "/login.html" };

    const ENDPOINT_CANDIDATOS = [
      "/api/bono-listar.js"
    ];

    let sessaoAtual = null;
    let linhas = [];
    let ENDPOINT_LISTAR_RESOLVIDO = "";

    /* tenta com .js e sem .js */
    const ENDPOINT_VALIDAR = ["/api/bono-validar.js", "/api/bono-validar"];
    const ENDPOINT_EXCLUIR = ["/api/bono-excluir.js", "/api/bono-excluir"];

    const LOJAS = [
      "BIG 01 - 106 NORTE","BIG 02 - 402 NORTE","BIG 03 - 413 SUL","BIG 04 - 301 SW","BIG 05 - 408 NORTE",
      "BIG 06 - SIBERIA","BIG 08 - 503 SUL","BIG 09 - PEN√çNSULA","BIG 10 - PAINEIRAS","BIG 11 - 310 NORTE",
      "BIG 12 - 208 NORTE","BIG 13 - QI-05 L. NORTE","BIG 14 - 508 SUL","BIG 15 - 105 SW","BIG 16 - 512 SUL",
      "BIG 17 - QI-11 LAGO SUL","BIG 18 - 211 NORTE","BIG 19 - CASTANHEIRA","BIG 20 - TAGUATINGA C1","BIG 21 - CNB12",
      "BIG 22 - 102 NOROESTE","BIG 23 - QI-23 LAGO SUL","BIG 24 - 314 NORTE","BIG 25 - 410 SUL",
      "ULT 01 - PLANALTINA","ULT 02 - GAMA","ULT 03 - COLORADO","ULT 04 - CEI SUL","ULT 05 - POLO JK",
      "ULT 06 - SOBRADINHO","ULT 07 - ADE","ULT 08 - ARAPOANGA","ULT 09 - CEI NORTE","ULT 10 - ESTRUTURAL",
      "ULT 11 - ITAPOA","ULT 12 - SAO SEBASTIAO","ULT 13 - RECANTO","ULT 14 - AGUAS LINDAS","ULT 15 - SOL NASCENTE",
      "ULT 16 - PARANOA PARK","ULT 17 - SAMAMBAIA","ULT 18 - BRAZLANDIA","ULT 19 - VIA PARK","ULT 20 - TAGUATINGA",
      "ULT 22 - VICENTE PIRES","ULT 23 - SANTA MARIA","ULT 24 - PAU BRASIL","ULT 25 - BRASILINHA",
      "TOTAL DISTRIBUICAO","INDUSPAN","MATRIZ"
    ];

    function setTexto(id, txt) {
      const el = document.getElementById(id);
      if (el) el.textContent = txt;
    }

    function setMsg(txt, ok=false){
      const el = document.getElementById("msg");
      el.textContent = txt || "";
      el.classList.toggle("ok", !!ok);
    }

    function normStr(s){
      return String(s ?? "").trim();
    }

    function normKey(s){
      return normStr(s).toUpperCase().replace(/\s+/g, " ");
    }

    function normSearch(s){
      return normStr(s)
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toUpperCase();
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function perfilEhAdmin(perfil){
      return normKey(perfil).includes("ADMIN");
    }
    function perfilEhGerentePPP(perfil){
      const p = normKey(perfil);
      return p.includes("GERENTE_PPP") || (p.includes("GERENTE") && p.includes("PPP"));
    }
    function perfilEhBasePPP(perfil){
      const p = normKey(perfil);
      return p.includes("BASE_PPP") || (p.includes("BASE") && p.includes("PPP"));
    }

    function extrairDataISO(dataHoraBR){
      const t = normStr(dataHoraBR);
      if (!t) return "";
      const parteData = t.split(" ")[0];
      const [dd,mm,aa] = parteData.split("/");
      if (!dd || !mm || !aa) return "";
      const d = String(dd).padStart(2,"0");
      const m = String(mm).padStart(2,"0");
      const a = String(aa).padStart(4,"0");
      return `${a}-${m}-${d}`;
    }

    function tipoToCanon(tipo){
      const t = normKey(tipo);
      if (t.includes("MOV") && (t.includes("INTERNA") || t.includes("INTERNO") || t.includes("MOV_INTERNA"))) return "MOVIMENTACAO_INTERNA";
      if (t.includes("RECEB") || t.includes("MERCADORIA")) return "RECEBIMENTO_MERCADORIAS";
      return "";
    }

    function statusToCanon(status){
      const s = normKey(status);
      if (s.includes("VALID")) return "VALIDADO";
      if (s.includes("PEND")) return "PENDENTE";
      return "";
    }

    async function obterSessaoDoBackend() {
      try {
        const resp = await fetch("/api/session", {
          method: "GET",
          credentials: "include",
          headers: { "Accept": "application/json" }
        });
        if (!resp.ok) return null;

        const ct = (resp.headers.get("content-type") || "").toLowerCase();
        if (!ct.includes("application/json")) return null;

        const dados = await resp.json().catch(() => null);
        if (!dados) return null;

        const ok = !!(dados.sucesso ?? dados.success ?? dados.ok);
        if (!ok || !dados.usuario || !dados.loja || !dados.perfil) return null;

        return dados;
      } catch {
        return null;
      }
    }

    function redirecionarParaLogin(motivo) {
      if (motivo) setMsg(motivo, false);
      window.location.href = ROTAS.login;
    }

    function preencherSelectComLojas(selId, incluirTodas = true){
      const sel = document.getElementById(selId);
      if (!sel) return;

      const atual = sel.value;

      sel.innerHTML = "";
      if (incluirTodas){
        const op = document.createElement("option");
        op.value = "";
        op.textContent = "Todas";
        sel.appendChild(op);
      }

      LOJAS.forEach(lj => {
        const op = document.createElement("option");
        op.value = lj;
        op.textContent = lj;
        sel.appendChild(op);
      });

      if (atual) sel.value = atual;
    }

    function aplicarVisibilidadeFiltroLoja(){
      const wrap = document.getElementById("wrapFiltroLoja");
      if (!sessaoAtual || !wrap) return;

      const podeVer = perfilEhAdmin(sessaoAtual.perfil) || perfilEhGerentePPP(sessaoAtual.perfil);
      wrap.classList.toggle("hidden", !podeVer);

      if (podeVer){
        preencherSelectComLojas("fLoja", true);
      } else {
        const sel = document.getElementById("fLoja");
        if (sel) sel.innerHTML = '<option value="">Todas</option>';
      }
    }

    async function resolverEndpointListar(){
      if (ENDPOINT_LISTAR_RESOLVIDO) return ENDPOINT_LISTAR_RESOLVIDO;

      for (const ep of ENDPOINT_CANDIDATOS){
        try{
          const r = await fetch(ep, {
            method: "GET",
            credentials: "include",
            headers: { "Accept": "application/json" }
          });

          if (r.status === 404) continue;

          ENDPOINT_LISTAR_RESOLVIDO = ep;
          return ep;
        } catch {
          continue;
        }
      }

      ENDPOINT_LISTAR_RESOLVIDO = ENDPOINT_CANDIDATOS[0];
      return ENDPOINT_LISTAR_RESOLVIDO;
    }

    async function buscarDados() {
      setMsg("Carregando dados...", true);

      try {
        const endpoint = await resolverEndpointListar();

        const resp = await fetch(endpoint, {
          method: "GET",
          credentials: "include",
          headers: { "Accept": "application/json" }
        });

        const ct = (resp.headers.get("content-type") || "").toLowerCase();

        if (resp.status === 404) {
          console.error("Falha no endpoint (404):", endpoint);
          setMsg("Falha ao carregar dados (endpoint n√£o encontrado).", false);
          linhas = [];
          render();
          return;
        }

        if (!ct.includes("application/json")) {
          const txt = await resp.text().catch(() => "");
          console.error("Endpoint n√£o retornou JSON:", { endpoint, status: resp.status, ct, body: (txt || "").slice(0, 600) });
          setMsg("Falha ao carregar dados (endpoint).", false);
          linhas = [];
          render();
          return;
        }

        const dados = await resp.json().catch(() => null);
        const ok = !!(dados && (dados.sucesso ?? dados.success ?? dados.ok));

        if (!resp.ok || !ok) {
          console.error("Falha no endpoint:", { endpoint, status: resp.status, dados });
          setMsg("Falha ao carregar dados (endpoint).", false);
          linhas = [];
          render();
          return;
        }

        const arr =
          Array.isArray(dados.dados) ? dados.dados :
          (Array.isArray(dados.data) ? dados.data :
          (Array.isArray(dados.rows) ? dados.rows : []));

        linhas = arr.map((row) => {
          if (Array.isArray(row)) {
            return {
              A: row[0] ?? "", B: row[1] ?? "", C: row[2] ?? "", D: row[3] ?? "",
              E: row[4] ?? "", F: row[5] ?? "", G: row[6] ?? "", H: row[7] ?? "",
              I: row[8] ?? "", J: row[9] ?? "", K: row[10] ?? "", L: row[11] ?? "",
              M: row[12] ?? "", N: row[13] ?? "",
              O: row[14] ?? ""
            };
          }
          if (row && typeof row === "object") {
            return {
              A: row.A ?? row.a ?? row.dataHoraRede ?? "",
              B: row.B ?? row.b ?? row.dataHora ?? row.dataHoraFiltro ?? "",
              C: row.C ?? row.c ?? row.lojaOrigem ?? "",
              D: row.D ?? row.d ?? row.usuario ?? "",
              E: row.E ?? row.e ?? row.responsavel ?? "",
              F: row.F ?? row.f ?? row.descricao ?? "",
              G: row.G ?? row.g ?? row.quantidade ?? "",
              H: row.H ?? row.h ?? row.embalagem ?? "",
              I: row.I ?? row.i ?? row.lojaDestino ?? "",
              J: row.J ?? row.j ?? row.tipo ?? "",
              K: row.K ?? row.k ?? row.status ?? "",
              L: row.L ?? row.l ?? row.documento ?? "",
              M: row.M ?? row.m ?? row.fornecedor ?? "",
              N: row.N ?? row.n ?? row.placaVeiculo ?? row.placa ?? "",
              O: row.O ?? row.o ?? row.validador ?? row.usuarioValidador ?? ""
            };
          }
          return {A:"",B:"",C:"",D:"",E:"",F:"",G:"",H:"",I:"",J:"",K:"",L:"",M:"",N:"",O:""};
        });

        setMsg(`Dados carregados: ${linhas.length} itens.`, true);
        render();

      } catch (e) {
        console.error(e);
        setMsg("Erro de rede ao carregar dados.", false);
        linhas = [];
        render();
      }
    }

    function lerFiltros(){
      const elLoja = document.getElementById("fLoja");
      return {
        loja: normStr(elLoja ? elLoja.value : ""),
        dataIni: normStr(document.getElementById("fData").value),
        dataFim: normStr(document.getElementById("fDataFim").value),
        tipo: normStr(document.getElementById("fTipo").value),
        status: normStr(document.getElementById("fStatus").value),
        direcao: normStr(document.getElementById("fDirecao").value),
        busca: normStr(document.getElementById("fBusca").value)
      };
    }

    function lojaSelecionadaEfetiva(){
      if (!sessaoAtual) return "";
      if (perfilEhBasePPP(sessaoAtual.perfil)) return normStr(sessaoAtual.loja);
      const f = lerFiltros();
      return f.loja;
    }

    /* ‚úÖ REQ #5: trava/destrava seletor (Todos/Enviei/Recebi) */
    function atualizarEstadoDirecao(){
      const sel = document.getElementById("fDirecao");
      if (!sel) return;

      const f = lerFiltros();
      const lojaEfetiva = lojaSelecionadaEfetiva();
      const tipoCanon = tipoToCanon(f.tipo);

      const deveTravar =
        !lojaEfetiva ||
        (tipoCanon === "RECEBIMENTO_MERCADORIAS");

      if (deveTravar){
        sel.value = "";
        sel.disabled = true;
      } else {
        sel.disabled = false;
      }
    }

    function aplicarFiltrosNasLinhas(){
      const f = lerFiltros();
      const lojaEfetiva = lojaSelecionadaEfetiva();

      const ini = f.dataIni;
      const fim = f.dataFim;
      const dtMin = (ini && fim) ? (ini <= fim ? ini : fim) : (ini || "");
      const dtMax = (ini && fim) ? (ini <= fim ? fim : ini) : (fim || "");

      const buscaKey = normSearch(f.busca);

      return linhas.filter(r => {
        const dataISO = extrairDataISO(r.B);
        const lojaOrigem = normStr(r.C);
        const lojaDestino = normStr(r.I);
        const tipoCanon = tipoToCanon(r.J);
        const statusCanon = statusToCanon(r.K);

        if (dtMin && (!dataISO || dataISO < dtMin)) return false;
        if (dtMax && (!dataISO || dataISO > dtMax)) return false;

        if (lojaEfetiva) {
          const okLoja =
            (normKey(lojaOrigem) === normKey(lojaEfetiva)) ||
            (normKey(lojaDestino) === normKey(lojaEfetiva));
          if (!okLoja) return false;
        }

        if (f.tipo && f.tipo !== tipoCanon) return false;
        if (f.status && f.status !== statusCanon) return false;

        /* ‚úÖ REQ #5: Enviei/Recebi (s√≥ quando liberado) */
        const direcaoCanon = normKey(f.direcao);
        if (lojaEfetiva && tipoCanon !== "RECEBIMENTO_MERCADORIAS") {
          if (direcaoCanon === "ENVIEI"){
            if (normKey(lojaOrigem) !== normKey(lojaEfetiva)) return false;
          }
          if (direcaoCanon === "RECEBI"){
            if (normKey(lojaDestino) !== normKey(lojaEfetiva)) return false;
          }
        }

        /* ‚úÖ REQ #6: busca por descri√ß√£o (coluna F) */
        if (buscaKey){
          const descKey = normSearch(r.F);
          if (!descKey.includes(buscaKey)) return false;
        }

        return true;
      });
    }

    function agruparPorDocumento(linhasFiltradas){
      const map = new Map();
      linhasFiltradas.forEach(r => {
        const doc = normStr(r.L) || "SEM_DOCUMENTO";
        if (!map.has(doc)) map.set(doc, []);
        map.get(doc).push(r);
      });

      const itens = Array.from(map.entries()).map(([documento, items]) => {
        const primeiro = items[0] || {};
        const dataISO = extrairDataISO(primeiro.B);
        return { documento, items, dataISO };
      });

      /* ‚úÖ sempre mais recente -> mais antigo */
      itens.sort((a,b) => (b.dataISO || "").localeCompare(a.dataISO || ""));
      return itens;
    }

    const modalValidar = { el: null, txt: null, btnSim: null, btnNao: null, documento: "" };

    function abrirModalValidar(documento){
      modalValidar.documento = documento;
      modalValidar.txt.textContent = `Este Bono encontra-se pendente de valida√ß√£o. Confirma a valida√ß√£o do documento?
A valida√ß√£o dever√° ser efetuada apenas ap√≥s a confer√™ncia f√≠sica integral, garantindo que 100% dos produtos estejam em total conformidade com este documento.`;
      modalValidar.el.classList.add("show");
    }
    function fecharModalValidar(){
      modalValidar.el.classList.remove("show");
      modalValidar.documento = "";
    }

    const modalExcluir = { el: null, txt: null, input: null, hint: null, btnSim: null, btnCancelar: null, documento: "" };

    function abrirModalExcluir(documento){
      modalExcluir.documento = documento;
      const u = normStr(sessaoAtual?.usuario || "");
      modalExcluir.txt.innerHTML = `
        <div style="font-weight:900;">
          Esta exclus√£o √© <span style="color:#b30000;">irrevers√≠vel</span>.
          Tem certeza que deseja excluir o documento <span style="color:#1f4f95;">${escapeHtml(documento)}</span>?
        </div>
      `;
      modalExcluir.input.value = "";
      modalExcluir.hint.textContent = u ? `Usu√°rio logado: ${u}` : "";
      modalExcluir.el.classList.add("show");
      setTimeout(() => modalExcluir.input.focus(), 50);
    }

    function fecharModalExcluir(){
      modalExcluir.el.classList.remove("show");
      modalExcluir.documento = "";
      modalExcluir.input.value = "";
    }

    function podeVerBotaoValidar({ statusCanon, tipoCanon, lojaDestino }){
      if (!sessaoAtual) return false;
      if (statusCanon !== "PENDENTE") return false;
      if (tipoCanon !== "MOVIMENTACAO_INTERNA") return false;
      if (!normStr(lojaDestino)) return false;
      return normKey(lojaDestino) === normKey(sessaoAtual.loja);
    }

    async function postComFallback(endpoints, payload){
      let lastErr = null;

      for (const ep of endpoints){
        try{
          const resp = await fetch(ep, {
            method: "POST",
            credentials: "include",
            headers: { "Accept": "application/json", "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          if (resp.status === 404) {
            lastErr = new Error(`Endpoint n√£o encontrado: ${ep}`);
            continue;
          }

          const ct = (resp.headers.get("content-type") || "").toLowerCase();
          if (!ct.includes("application/json")) {
            const t = await resp.text().catch(() => "");
            throw new Error(`Backend n√£o retornou JSON (${resp.status}): ${(t || "").slice(0, 200)}`);
          }

          const dados = await resp.json().catch(() => null);
          const ok = !!(dados && (dados.sucesso ?? dados.success ?? dados.ok));

          if (!resp.ok || !ok) {
            const msg = (dados && (dados.message || dados.mensagem)) ? String(dados.message || dados.mensagem) : `Falha (${resp.status})`;
            throw new Error(msg);
          }

          return dados;
        } catch (e){
          lastErr = e;
          continue;
        }
      }

      throw lastErr || new Error("Falha ao chamar endpoint.");
    }

    async function validarDocumentoNoBackend(documento){
      await postComFallback(ENDPOINT_VALIDAR, { documento: documento, status: "VALIDADO" });
      return true;
    }

    function aplicarValidacaoLocal(documento){
      const validador = normStr(sessaoAtual?.usuario || "");
      linhas = linhas.map(r => {
        const doc = normStr(r.L) || "SEM_DOCUMENTO";
        if (doc !== documento) return r;
        return { ...r, K: "VALIDADO", O: validador };
      });
    }

    async function excluirDocumentoNoBackend(documento, confirmUser){
      await postComFallback(ENDPOINT_EXCLUIR, { documento, confirmUser });
      return true;
    }

    function aplicarExclusaoLocal(documento){
      linhas = linhas.filter(r => normKey(normStr(r.L) || "SEM_DOCUMENTO") !== normKey(documento));
    }

    function svgInfo(){
      return `
        <svg class="ic ic-blue" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="12" r="9" stroke-width="2"></circle>
          <line x1="12" y1="10" x2="12" y2="17" stroke-width="2" stroke-linecap="round"></line>
          <circle cx="12" cy="7" r="1" fill="#1f4f95"></circle>
        </svg>
      `;
    }
    function svgClock(){
      return `
        <svg class="ic ic-blue" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <rect x="4" y="5" width="16" height="15" rx="3" stroke-width="2"></rect>
          <line x1="8" y1="3.5" x2="8" y2="7" stroke-width="2" stroke-linecap="round"></line>
          <line x1="16" y1="3.5" x2="16" y2="7" stroke-width="2" stroke-linecap="round"></line>
          <line x1="4" y1="10" x2="20" y2="10" stroke-width="2" stroke-linecap="round"></line>
        </svg>
      `;
    }
    function svgStore(){
      return `
        <svg class="ic ic-blue" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <rect x="4" y="4" width="16" height="16" rx="3" stroke-width="2"></rect>
          <rect x="7.2" y="7.2" width="3.2" height="3.2" stroke-width="2"></rect>
          <rect x="13.6" y="7.2" width="3.2" height="3.2" stroke-width="2"></rect>
          <rect x="7.2" y="13.6" width="9.6" height="3.2" stroke-width="2"></rect>
        </svg>
      `;
    }
    function svgTruck(){
      return `
        <svg class="ic ic-blue" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <rect x="3" y="7" width="11" height="10" rx="2" stroke-width="2"></rect>
          <path d="M14 10h4l3 3v4h-7" stroke-width="2" stroke-linejoin="round"></path>
          <circle cx="7" cy="18" r="1.8" stroke-width="2"></circle>
          <circle cx="18" cy="18" r="1.8" stroke-width="2"></circle>
        </svg>
      `;
    }
    function svgPlate(){
      return `
        <svg class="ic ic-blue" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <rect x="3.5" y="7" width="17" height="10" rx="2.2" stroke-width="2"></rect>
          <line x1="7" y1="10" x2="17" y2="10" stroke-width="2" stroke-linecap="round"></line>
          <line x1="7" y1="14" x2="12.5" y2="14" stroke-width="2" stroke-linecap="round"></line>
        </svg>
      `;
    }
    function svgHourglass(){
      return `
        <svg class="ic" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7 3h10M7 21h10" stroke="#a85d10" stroke-width="2" stroke-linecap="round"></path>
          <path d="M8 3c0 4 4 5 4 9s-4 5-4 9" stroke="#a85d10" stroke-width="2" stroke-linecap="round"></path>
          <path d="M16 3c0 4-4 5-4 9s4 5 4 9" stroke="#a85d10" stroke-width="2" stroke-linecap="round"></path>
        </svg>
      `;
    }
    function svgCheck(){
      return `
        <svg class="ic" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M20 7L10 17l-4-4" stroke="#0b6b2f" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
      `;
    }
    function svgPerson(){
      return `
        <svg class="ic ic-blue" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="8" r="3.2" stroke-width="2"></circle>
          <path d="M5.5 20c1.4-3.8 11.6-3.8 13 0" stroke-width="2" stroke-linecap="round"></path>
        </svg>
      `;
    }
    function svgShield(){
      return `
        <svg class="ic ic-blue" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3l7 4v6c0 5-3.5 8.5-7 9-3.5-.5-7-4-7-9V7l7-4z" stroke-width="2" stroke-linejoin="round"></path>
          <path d="M9 12l2 2 4-5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
      `;
    }

    function parseNumeroFlex(valor){
      const s0 = normStr(valor);
      if (!s0) return null;

      const s = s0.replace(/\s+/g, "");

      if (typeof valor === "number" && Number.isFinite(valor)) return valor;

      if (s.includes(",")){
        const semPontos = s.replace(/\./g, "");
        const dot = semPontos.replace(",", ".");
        const n = Number(dot);
        return Number.isFinite(n) ? n : null;
      }

      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function formatarQtdExibicao(qtdRaw, embRaw){
      const emb = normKey(embRaw);
      const n = parseNumeroFlex(qtdRaw);
      if (n == null) return normStr(qtdRaw) || "‚Äî";

      if (emb === "KG"){
        return new Intl.NumberFormat("pt-BR", { minimumFractionDigits: 3, maximumFractionDigits: 3 }).format(n);
      }

      return new Intl.NumberFormat("pt-BR", { maximumFractionDigits: 0 }).format(n);
    }

    function render(){
      atualizarEstadoDirecao();

      const linhasFiltradas = aplicarFiltrosNasLinhas();
      const docs = agruparPorDocumento(linhasFiltradas);

      setTexto("contador", `Quantidade de documentos: ${docs.length}`);

      const wrap = document.getElementById("listaDocs");
      wrap.innerHTML = "";

      if (!docs.length){
        wrap.innerHTML = `<div class="filtros" style="font-weight:900;color:#444;">Nenhum documento encontrado.</div>`;
        return;
      }

      docs.forEach(({documento, items}) => {
        const x = items[0];

        const dataHora = normStr(x.B) || "‚Äî";
        const lojaOrigem = normStr(x.C) || "‚Äî";
        const lojaDestino = normStr(x.I);
        const destinoVazio = !normStr(lojaDestino);

        const tipoCanon = tipoToCanon(x.J);
        const tituloTopo = (tipoCanon === "MOVIMENTACAO_INTERNA")
          ? "MOVIMENTA√á√ÉO INTERNA"
          : (tipoCanon === "RECEBIMENTO_MERCADORIAS" ? "RECEBIMENTO DE MERCADORIAS" : (normStr(x.J) || "‚Äî").toUpperCase());

        const statusCanon = statusToCanon(x.K);

        const responsavel = normStr(x.E) || "‚Äî";
        const usuarioOrigemRegistro = normStr(x.D) || "‚Äî";
        const fornecedor = normStr(x.M) || "‚Äî";
        const placaVeiculo = normStr(x.N) || "";
        const validador = normStr(x.O) || "";

        const statusTxtTopoBase = (tipoCanon === "RECEBIMENTO_MERCADORIAS")
          ? "VALIDADO"
          : (statusCanon === "VALIDADO" ? "VALIDADO" : (statusCanon === "PENDENTE" ? "PENDENTE" : (normStr(x.K) || "‚Äî")));

        const statusTxtTopo = (statusTxtTopoBase === "VALIDADO" && validador)
          ? `VALIDADO üë§${validador}`
          : statusTxtTopoBase;

        const rowsHtml = items.map(it => {
          const desc = escapeHtml(normStr(it.F) || "‚Äî");
          const qtdFmt = formatarQtdExibicao(it.G, it.H);
          const qtd  = escapeHtml(normStr(qtdFmt) || "‚Äî");
          const emb  = escapeHtml(normStr(it.H) || "‚Äî");

          return `
            <tr>
              <td class="col-desc">${desc}</td>
              <td class="col-qtd">${qtd}</td>
              <td class="col-emb">${emb}</td>
            </tr>
          `;
        }).join("");

        const card = document.createElement("div");
        card.className = "doc-card";

        const linhaLojaHtml = destinoVazio
          ? `
            <div class="info-row">
              ${svgStore()}
              <div class="txt"><span class="k">Loja Recep√ß√£o:</span> <span class="v">${escapeHtml(lojaOrigem)}</span></div>
            </div>
          `
          : `
            <div class="info-row">
              ${svgStore()}
              <div class="txt"><span class="k">Loja Origem:</span> <span class="v">${escapeHtml(lojaOrigem)}</span></div>
            </div>
            <div class="info-row">
              ${svgStore()}
              <div class="txt"><span class="k">Loja Destino:</span> <span class="v">${escapeHtml(lojaDestino)}</span></div>
            </div>
          `;

        const fornecedorHtml = (tipoCanon === "RECEBIMENTO_MERCADORIAS")
          ? `
            <div class="info-row">
              ${svgTruck()}
              <div class="txt"><span class="k">Fornecedor:</span> <span class="v">${escapeHtml(fornecedor)}</span></div>
            </div>
          `
          : ``;

        const placaHtml = (placaVeiculo)
          ? `
            <div class="info-row">
              ${svgPlate()}
              <div class="txt"><span class="k">Placa:</span> <span class="v">${escapeHtml(placaVeiculo)}</span></div>
            </div>
          `
          : ``;

        const mostrarBtnValidar = podeVerBotaoValidar({ statusCanon, tipoCanon, lojaDestino });
        const mostrarBtnExcluir = !!(sessaoAtual && perfilEhAdmin(sessaoAtual.perfil));

        const badgeClass = (statusTxtTopoBase === "PENDENTE") ? "badge-pendente" : "badge-validado";
        const badgeIcon  = (statusTxtTopoBase === "PENDENTE") ? svgHourglass() : svgCheck();

        card.innerHTML = `
          <div
            class="doc-title-plain"
            style="
              font-weight:900;
              color:#1f4f95;
              display:flex;
              align-items:center;
              padding-left:12px;
              min-height:40px;
            "
          >
            ${escapeHtml(tituloTopo)}
          </div>

          <div class="doc-head-body">
            <div class="doc-topline">
              <div class="doc-topline-left">
                ${svgInfo()}
                <span class="status-title">Status:</span>
              </div>

              <div class="doc-topline-right">
                ${
                  mostrarBtnValidar
                    ? `<button class="btn-validar" type="button" title="Validar pend√™ncia" aria-label="Validar pend√™ncia" data-acao="validar" data-doc="${escapeHtml(documento)}">VALIDAR</button>`
                    : ``
                }

                ${
                  mostrarBtnExcluir
                    ? `<button class="btn-excluir" type="button" title="Excluir documento" aria-label="Excluir documento" data-acao="excluir" data-doc="${escapeHtml(documento)}">EXCLUIR</button>`
                    : ``
                }

                <div class="doc-badge ${badgeClass}" title="${escapeHtml(statusTxtTopo)}">
                  ${badgeIcon}
                  <span>${escapeHtml(statusTxtTopo)}</span>
                </div>
              </div>
            </div>

            <hr class="head-sep" />

            <div class="info-row">
              ${svgClock()}
              <div class="txt"><span class="k">Data/Hora:</span> <span class="v">${escapeHtml(dataHora)}</span></div>
            </div>

            ${linhaLojaHtml}
            ${fornecedorHtml}
            ${placaHtml}
          </div>

          <div class="doc-table-wrap">
            <div class="doc-table-head">
              <div>DESCRI√á√ÉO</div>
              <div class="h-right">Qtd</div>
              <div class="h-right">Embalagem</div>
            </div>

            <table class="doc-table" aria-label="Itens do documento">
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
          </div>

          <div class="assinaturas">
            <div class="ass-join">
              <div class="ass-side ass-resp">
                ${svgPerson()}
                <div class="ass-txt">
                  <div class="ass-k">Respons√°vel</div>
                  <div class="ass-v">${escapeHtml(responsavel)}</div>
                </div>
              </div>

              <div class="ass-divider" aria-hidden="true"></div>

              <div class="ass-side ass-val">
                ${svgShield()}
                <div class="ass-txt">
                  <div class="ass-k">Valida√ß√£o</div>
                  <div class="ass-v">${escapeHtml(validador || usuarioOrigemRegistro)}</div>
                </div>
              </div>
            </div>
          </div>
        `;

        const btnValidar = card.querySelector('button[data-acao="validar"]');
        if (btnValidar){
          btnValidar.addEventListener("click", () => {
            const doc = btnValidar.getAttribute("data-doc") || "";
            abrirModalValidar(doc);
          });
        }

        const btnExcluir = card.querySelector('button[data-acao="excluir"]');
        if (btnExcluir){
          btnExcluir.addEventListener("click", () => {
            const doc = btnExcluir.getAttribute("data-doc") || "";
            abrirModalExcluir(doc);
          });
        }

        wrap.appendChild(card);
      });
    }

    function limparFiltros(){
      const elLoja = document.getElementById("fLoja");
      if (elLoja) elLoja.value = "";

      document.getElementById("fData").value = "";
      document.getElementById("fDataFim").value = "";
      document.getElementById("fTipo").value = "";
      document.getElementById("fStatus").value = "";

      document.getElementById("fDirecao").value = "";
      document.getElementById("fBusca").value = "";

      atualizarEstadoDirecao();
      render();
      setMsg("Filtros limpos.", true);
    }

    function setDatasHojeNosFiltros(){
      const elIni = document.getElementById("fData");
      const elFim = document.getElementById("fDataFim");
      if (!elIni || !elFim) return;

      const hoje = new Date();
      const yyyy = String(hoje.getFullYear()).padStart(4,"0");
      const mm = String(hoje.getMonth()+1).padStart(2,"0");
      const dd = String(hoje.getDate()).padStart(2,"0");
      const v = `${yyyy}-${mm}-${dd}`;

      elIni.value = v;
      elFim.value = v;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      modalValidar.el = document.getElementById("modalValidar");
      modalValidar.txt = document.getElementById("modalValidarTexto");
      modalValidar.btnSim = document.getElementById("btnModalSim");
      modalValidar.btnNao = document.getElementById("btnModalNao");

      modalValidar.btnNao.addEventListener("click", () => fecharModalValidar());
      modalValidar.el.addEventListener("click", (e) => { if (e.target === modalValidar.el) fecharModalValidar(); });

      modalValidar.btnSim.addEventListener("click", async () => {
        const doc = modalValidar.documento;
        if (!doc) return fecharModalValidar();

        setMsg("Validando...", true);

        try{
          await validarDocumentoNoBackend(doc);
          aplicarValidacaoLocal(doc);
          fecharModalValidar();
          setMsg("Bono validado com sucesso.", true);
          render();
        } catch (err){
          console.error(err);
          fecharModalValidar();
          setMsg("Falha ao validar no servidor.", false);
        }
      });

      modalExcluir.el = document.getElementById("modalExcluir");
      modalExcluir.txt = document.getElementById("modalExcluirTexto");
      modalExcluir.input = document.getElementById("confirmUser");
      modalExcluir.hint = document.getElementById("hintUser");
      modalExcluir.btnSim = document.getElementById("btnExcluirSim");
      modalExcluir.btnCancelar = document.getElementById("btnExcluirCancelar");

      modalExcluir.btnCancelar.addEventListener("click", () => fecharModalExcluir());
      modalExcluir.el.addEventListener("click", (e) => { if (e.target === modalExcluir.el) fecharModalExcluir(); });

      modalExcluir.btnSim.addEventListener("click", async () => {
        if (!sessaoAtual || !perfilEhAdmin(sessaoAtual.perfil)) {
          fecharModalExcluir();
          return setMsg("Perfil sem permiss√£o para exclus√£o.", false);
        }

        const doc = modalExcluir.documento;
        const typed = normStr(modalExcluir.input.value);
        const logged = normStr(sessaoAtual.usuario);

        if (!doc) return fecharModalExcluir();

        if (!typed || normKey(typed) !== normKey(logged)) {
          return setMsg("Usu√°rio digitado n√£o confere com o usu√°rio logado.", false);
        }

        setMsg("Excluindo documento...", true);

        try{
          await excluirDocumentoNoBackend(doc, typed);
          aplicarExclusaoLocal(doc);
          fecharModalExcluir();
          setMsg("Documento exclu√≠do com sucesso.", true);
          render();
        } catch (err){
          console.error(err);
          setMsg(err?.message ? String(err.message) : "Falha ao excluir no servidor.", false);
        }
      });

      document.getElementById("btnVoltarMenu").addEventListener("click", () => {
        window.location.href = ROTAS.menu;
      });

      document.getElementById("btnAtualizar").addEventListener("click", async () => {
        await buscarDados();
      });

      document.getElementById("btnLimpar").addEventListener("click", () => {
        limparFiltros();
      });

      const sessao = await obterSessaoDoBackend();
      if (!sessao) return redirecionarParaLogin("Sess√£o inv√°lida. Fa√ßa login novamente.");

      sessaoAtual = sessao;

      aplicarVisibilidadeFiltroLoja();

      if (perfilEhAdmin(sessao.perfil) || perfilEhGerentePPP(sessao.perfil)) {
        preencherSelectComLojas("fLoja", true);
      }

      setDatasHojeNosFiltros();
      atualizarEstadoDirecao();

      ["fLoja","fData","fDataFim","fTipo","fStatus","fDirecao"].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("change", () => { atualizarEstadoDirecao(); render(); });
      });

      /* busca em tempo real */
      const fBusca = document.getElementById("fBusca");
      if (fBusca){
        fBusca.addEventListener("input", () => render());
      }

      await buscarDados();
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PAINEL GERENTE PPP</title>

  <style>
    /* ========= ESTILO GERAL DA PÁGINA ========= */
    body {
      background: #f3f3f3;
      font-family: Arial, sans-serif;
      margin: 2px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* ========= CARD PRINCIPAL (CONTAINER DO PAINEL) ========= */
    .container {
      width: 85%;
      max-width: 1100px;
      background: #ffffff;
      padding: 24px 28px 28px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
    }

    /* ========= CABEÇALHO ========= */
    .cabecalho {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      border-bottom: 1px solid #e1e1e1;
      padding-bottom: 14px;
      margin-bottom: 12px;
    }

    .titulo {
      margin: 0;
      font-size: 22px;
    }

    /* ========= CARDS DE RESUMO (QTD / VALOR / OCORRÊNCIAS) ========= */
    .resumo-cards {
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      margin: 10px 0 14px;
      justify-content: space-between;
    }

    .card-resumo {
      flex: 1 1 33%;
      min-width: 0;
      background: #f9fafc;
      border-radius: 12px;
      padding: 10px 12px;

      border: 1px solid #d0d6e2;
      box-shadow:
        0 4px 10px rgba(0, 0, 0, 0.18),
        0 -2px 4px rgba(255, 255, 255, 0.75) inset,
        0 2px 4px rgba(0, 0, 0, 0.05) inset;

      font-size: 13px;
    }

    .resumo-titulo {
      font-weight: 600;
      color: #555;
      margin-bottom: 4px;
    }

    .resumo-valor {
      font-size: 18px;
      font-weight: 700;
      color: #1a1a1a;
    }

    /* ========= BLOCO DOS FILTROS ========= */
    .bloco-filtros {
      margin: 0 -4px 16px;
      padding: 14px;
      border-radius: 10px;
      background: #f7f8ff;
      border: 1px solid #e0e3ff;
    }

    .bloco-filtros h3 {
      margin: 0 0 10px;
      font-size: 16px;
    }

    .filtros-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      grid-template-areas:
        "loja usuario departamento"
        "documento dataInicio dataFim";
      gap: 8px 10px;
    }

    .campo-filtro {
      display: flex;
      flex-direction: column;
      font-size: 13px;
      min-width: 0;
    }

    .campo-filtro label {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .campo-filtro input,
    .campo-filtro select {
      border-radius: 6px;
      border: 1px solid #c3c3c3;
      padding: 6px 8px;
      font-size: 13px;
      box-sizing: border-box;
      background: #fff;
      width: 100%;
      max-width: 100%;
    }

    .campo-loja        { grid-area: loja; }
    .campo-usuario     { grid-area: usuario; }
    .campo-departamento{ grid-area: departamento; }
    .campo-documento   { grid-area: documento; }
    .campo-data-inicio { grid-area: dataInicio; }
    .campo-data-fim    { grid-area: dataFim; }

    /* ========= BOTÕES DOS FILTROS ========= */
    .botoes-filtro {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px 10px;
      justify-content: stretch;
    }

    .btn {
      padding: 7px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
    }

    .botoes-filtro .btn {
      width: 100%;
      font-size: 12px;
      padding: 6px 8px;
    }

    .btn-aplicar {
      background: #0066ff;
      color: #fff;
    }

    .btn-limpar {
      background: #e0e0e0;
      color: #333;
    }

    .btn-exportar {
      background: #4caf50;
      color: #fff;
    }

    /* ========= STATUS E LISTA DE CARTÕES ========= */
    .status {
      font-size: 13px;
      margin-bottom: 8px;
      text-align: left;
      color: #333;
    }

    .lista-cartoes {
      max-height: 60vh;
      overflow-y: auto;
    }

    /* ========= CARTÃO DE CADA REGISTRO ========= */
    .cartao {
      background: #ffffff;
      border: 2px solid #3c9c46;
      border-radius: 10px;

      box-shadow:
        0 4px 10px rgba(0, 0, 0, 0.18),
        0 -2px 4px rgba(255, 255, 255, 0.75) inset,
        0 2px 4px rgba(0, 0, 0, 0.05) inset;

      padding: 0;
      margin-bottom: 12px;
      font-size: 12px;
      overflow: hidden;
    }

    .cartao-pares {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      border-bottom: 1px solid #c7c7c7;
    }

    /* =========================
       LAYOUT (PARES TOPO/BASE)
       =========================
       Ajuste fino de distâncias entre "título" (rotulo) e "valor".
       - Base (padrão): --gap-pareado: 6px
       - Você pode customizar INDIVIDUALMENTE por bloco:
         .pareado-usuario { --gap-pareado: 2px; }
         .pareado-loja    { --gap-pareado: 1px; }
         .pareado-doc     { --gap-pareado: 2px; --doc-margin-left: 2px; }
    */
    .cartao-pareado {
      display: grid;
      grid-template-columns: 38% 62%;
      align-items: center;
      padding: 8px 10px;
      border-right: 1px solid #c7c7c7;

      /* Gap controlável via variável (editável individualmente por classe) */
      gap: var(--gap-pareado, 6px);

      min-width: 0;
    }

    .cartao-pareado-loja {
      grid-template-columns: 30% 70%;
    }

    /* Ajustes individuais solicitados (você pode mexer aqui sem afetar os outros) */
    .pareado-usuario { --gap-pareado: 2px; }  /* Usuário mais perto do título */
    .pareado-loja    { --gap-pareado: 1px; }  /* Loja mais perto do título */
    .pareado-doc     { --gap-pareado: 2px; --doc-margin-left: 2px; } /* Doc mais perto do título */

    .cartao-pareado:nth-child(2n) {
      border-right: none;
    }

    .cartao-pares-superior .cartao-pareado,
    .cartao-pares-inferior .cartao-pareado {
      background: #e9fbe9;
    }

    .cartao-pares-superior .cartao-pareado {
      padding: 6px 10px;
    }

    .cartao-pares-inferior .cartao-pareado {
      padding: 4px 10px;
    }

    .rotulo {
      font-weight: 700;
      color: #111;
      white-space: nowrap;
    }

    .valor {
      color: #111;
      word-break: break-word;
    }

    .valor-compacto {
      font-size: 10px;
      white-space: nowrap;
      line-height: 1.1;
    }

    /* Distância específica do valor do Documento (controlável individualmente via --doc-margin-left) */
    .valor-documento {
      margin-left: var(--doc-margin-left, 4px);
      display: inline-block;
    }

    .cartao-linha {
      display: grid;
      grid-template-columns: 38% 62%;
      padding: 4px 10px;
      border-bottom: 1px solid #d6d6d6;
      gap: 4px;
    }

    .cartao-linha:last-of-type {
      border-bottom: none;
    }

    .cartao-linha-produto {
      background: #f5f5f5;
      font-weight: 700;
    }

    .cartao-separador {
      border-top: 1px solid #c7c7c7;
    }

    .cartao-divisoria {
      border-top: 1px solid #c7c7c7;
    }

    .cartao-observacao {
      padding: 10px 12px 10px;
      background: #ffffff;
      line-height: 1.45;
      color: #111;
    }

    .cartao-observacao .obs-titulo {
      font-weight: 700;
      margin-bottom: 6px;
      color: #111;
    }

    .cartao-observacao .obs-texto {
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* ==== ÁREA DOS BOTÕES (EDITAR/EXCLUIR) NO CARTÃO ====
       Pedido: "Excluir está colado na linha acima" -> aumentamos o padding-top.
    */
    .cartao-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;               /* espaço entre Editar e Excluir */
      padding: 10px 12px 10px;/* <-- descola da linha acima */
      background: #ffffff;
      border-top: 1px solid #e0e0e0;
    }

    .btn-excluir {
      padding: 5px 10px;
      border-radius: 6px;
      border: none;
      background: #f44336;
      color: #fff;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-excluir:hover {
      background: #d32f2f;
    }

    /* Botão Editar ao lado do Excluir */
    .btn-editar {
      padding: 5px 10px;
      border-radius: 6px;
      border: none;
      background: #ff9800;
      color: #fff;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-editar:hover {
      background: #e68900;
    }

    /* ==== VALOR TOTAL (Qtd x Unit) AO LADO DO VALOR UNITÁRIO ==== */
    .valor-total-linha {
      margin-left: 18px;
      font-weight: 700;
      color: #1b5e20;
      text-shadow: 0 0 6px rgba(129, 199, 132, 0.9);
      white-space: nowrap;
    }

    /* ========= RODAPÉ DO PAINEL ========= */
    .rodape {
      margin-top: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }

    .btn-voltar {
      padding: 6px 10px;
      background: #0066ff;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      font-size: 12px;
      font-weight: 600;
    }

    /* ========= TELA DE ERRO (ACESSO SEM LOGIN) ========= */
    .tela-erro {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #f3f3f3;
      font-family: Arial, sans-serif;
    }

    .card-erro {
      background: #fff;
      padding: 26px 30px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      max-width: 420px;
      text-align: center;
    }

    .card-erro h1 {
      color: #c00000;
      margin-top: 0;
    }

    /* ========= MODAL DE CONFIRMAÇÃO (DOWNLOAD E EXCLUSÃO) ========= */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(220, 220, 220, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-content {
      background: #ffffff;
      border-radius: 10px;
      padding: 20px 22px 16px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
      max-width: 360px;
      width: 90%;
      text-align: center;
      font-size: 14px;
    }

    .modal-titulo {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 16px;
    }

    .modal-texto {
      margin-bottom: 18px;
      color: #333;
    }

    .modal-botoes {
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .btn-modal-sim,
    .btn-modal-cancelar {
      background: #e0e0e0;
      color: #333;
      border: none;
      border-radius: 6px;
      padding: 7px 14px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      flex: 1;
      text-align: center;
    }

    .btn-modal-sim {
      background: #4caf50;
      color: #fff;
    }

    .btn-modal-cancelar {
      background: #e0e0e0;
      color: #333;
    }

    /* ========= OVERLAY DE CARREGAMENTO 0–100% ========= */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(243, 243, 243, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .loading-box {
      background: #ffffff;
      border-radius: 8px;
      padding: 16px 22px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      text-align: center;
      font-size: 14px;
    }

    .loading-bar-container {
      width: 220px;
      height: 8px;
      border-radius: 4px;
      background: #eeeeee;
      margin-top: 8px;
      overflow: hidden;
    }

    .loading-bar {
      height: 100%;
      width: 0%;
      background: #0066ff;
      transition: width 0.15s linear;
    }

    .loading-percent {
      margin-top: 6px;
      font-weight: 600;
    }

    /* ========= MODAL DE EDIÇÃO (NOVO) ========= */

    /* Conteúdo do modal de formulário de edição (mantém o mesmo padrão visual dos modais atuais) */
    .modal-form {
      text-align: left;
      margin-top: 10px;
    }

    .modal-form .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .modal-form label {
      font-weight: 700;
      color: #111;
    }

    .modal-form input,
    .modal-form textarea {
      border-radius: 6px;
      border: 1px solid #c3c3c3;
      padding: 8px 10px;
      font-size: 13px;
      box-sizing: border-box;
      width: 100%;
      background: #fff;
    }

    .modal-form textarea {
      resize: vertical;
      min-height: 90px;
      white-space: pre-wrap;
    }

    /* Botão "Salvar" destacado e "Descartar" neutro */
    .btn-modal-salvar {
      background: #0066ff;
      color: #fff;
    }

    .btn-modal-descartar {
      background: #e0e0e0;
      color: #333;
    }
  </style>
</head>
<body>
  <!-- ========= TELA DE ERRO SE ACESSAR SEM LOGIN DO GESTOR ========= -->
  <div id="erroAcesso" class="tela-erro" style="display:none;">
    <div class="card-erro">
      <h1>Acesso inválido</h1>
      <p>Parâmetros de login do gerente não encontrados.</p>
      <p>Volte para a tela inicial e realize o login novamente.</p>
      <a href="/index.html" class="btn-voltar">Voltar</a>
    </div>
  </div>

  <!-- ========= CONTEÚDO PRINCIPAL DO PAINEL ========= -->
  <div id="appRoot" class="container" style="display:none;">
    <div class="cabecalho">
      <div>
        <h1 class="titulo">PAINEL GERENTE PPP</h1>
      </div>
    </div>

    <!-- Cards de resumo: Qtd. Itens, Valor total e Ocorrências -->
    <div class="resumo-cards">
      <div class="card-resumo">
        <div class="resumo-titulo">Quantidade</div>
        <div id="resumoQtdTotal" class="resumo-valor">0</div>
      </div>
      <div class="card-resumo">
        <div class="resumo-titulo">Valor total</div>
        <div id="resumoValorTotal" class="resumo-valor">0,00</div>
      </div>
      <div class="card-resumo">
        <div class="resumo-titulo">Ocorrências</div>
        <div id="resumoOcorrencias" class="resumo-valor">0</div>
      </div>
    </div>

    <!-- Bloco de filtros com inputs e botões -->
    <div class="bloco-filtros">
      <h3>Filtros</h3>

      <div class="filtros-grid">
        <div class="campo-filtro campo-loja">
          <label for="filtroLoja">Loja (texto)</label>
          <input id="filtroLoja" type="text" placeholder="Ex.: ULT 01" />
        </div>

        <div class="campo-filtro campo-usuario">
          <label for="filtroUsuario">Usuário</label>
          <input id="filtroUsuario" type="text" placeholder="Login / nome" />
        </div>

        <div class="campo-filtro campo-departamento">
          <label for="filtroDepartamento">Departamento</label>
          <select id="filtroDepartamento">
            <option value="">Todos</option>
            <option value="MERCEARIA">MERCEARIA</option>
            <option value="PERECIVEIS">PERECIVEIS</option>
            <option value="HIGIENE E LIMPEZA">HIGIENE E LIMPEZA</option>
            <option value="BAZAR">BAZAR</option>
            <option value="DESPESAS">DESPESAS</option>
            <option value="GASTRONOMIA">GASTRONOMIA</option>
          </select>
        </div>

        <div class="campo-filtro campo-documento">
          <label for="filtroDocumento">Nº Documento</label>
          <input id="filtroDocumento" type="text" placeholder="Número exato" />
        </div>

        <div class="campo-filtro campo-data-inicio">
          <label for="dataInicio">Data início</label>
          <input id="dataInicio" type="date" />
        </div>

        <div class="campo-filtro campo-data-fim">
          <label for="dataFim">Data fim</label>
          <input id="dataFim" type="date" />
        </div>
      </div>

      <div class="botoes-filtro">
        <button class="btn btn-limpar" onclick="limparFiltros()">Limpar filtros</button>
        <button class="btn btn-exportar" onclick="abrirModalDownload()">Exportar XLSX</button>
        <button class="btn btn-aplicar" onclick="aplicarFiltrosLocal()">Aplicar filtros</button>
      </div>
    </div>

    <div class="status" id="status">Carregando relatórios...</div>

    <div class="lista-cartoes" id="listaCartoes"></div>

    <div class="rodape">
      <a href="/index.html" class="btn-voltar" onclick="logoutGestor()">Voltar à tela inicial</a>
      <span id="resumoQtd"></span>
    </div>
  </div>

  <!-- ========= MODAL DE CONFIRMAÇÃO DO DOWNLOAD ========= -->
  <div id="modalDownload" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-titulo">Confirmar download</div>
      <div class="modal-texto">
        Você deseja mesmo fazer o download do arquivo?
      </div>
      <div class="modal-botoes">
        <button class="btn-modal-cancelar" onclick="fecharModalDownload()">Cancelar</button>
        <button class="btn-modal-sim" onclick="confirmarDownload()">Sim</button>
      </div>
    </div>
  </div>

  <!-- ========= MODAL DE CONFIRMAÇÃO DE EXCLUSÃO ========= -->
  <div id="modalExcluir" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-titulo">Confirmar exclusão</div>
      <div class="modal-texto">
        Você tem certeza que deseja excluir esse registro?
      </div>
      <div class="modal-botoes">
        <button class="btn-modal-cancelar" onclick="fecharModalExcluir()">Cancelar</button>
        <button class="btn-modal-sim" onclick="confirmarExclusaoRegistro()">Sim</button>
      </div>
    </div>
  </div>

  <!-- ========= MODAL DE CONFIRMAÇÃO DE EDIÇÃO (NOVO) ========= -->
  <div id="modalEditarConfirm" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-titulo">Confirmar edição</div>
      <div class="modal-texto">
        Deseja mesmo editar esse registro?
      </div>
      <div class="modal-botoes">
        <button class="btn-modal-cancelar" onclick="fecharModalEditarConfirm()">Não</button>
        <button class="btn-modal-sim" onclick="confirmarEditarConfirm()">Sim</button>
      </div>
    </div>
  </div>

  <!-- ========= MODAL FORMULÁRIO DE EDIÇÃO (NOVO) ========= -->
  <div id="modalEditarForm" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-titulo">Editar registro</div>

      <!--
        FORMULÁRIO: você pediu para editar SOMENTE:
        - Quantidade
        - Valor unitário
        - Relatório / Observação
      -->
      <div class="modal-form">
        <div class="form-group">
          <label for="editQuantidade">Quantidade</label>
          <input id="editQuantidade" type="text" inputmode="decimal" placeholder="Ex.: 1" />
        </div>

        <div class="form-group">
          <label for="editValorUnitario">Valor unitário</label>
          <input id="editValorUnitario" type="text" inputmode="decimal" placeholder="Ex.: 10,50" />
        </div>

        <div class="form-group">
          <label for="editRelatorio">Relatório / Observação</label>
          <textarea id="editRelatorio" placeholder="Digite o relatório..."></textarea>
        </div>
      </div>

      <div class="modal-botoes">
        <button class="btn-modal-cancelar btn-modal-descartar" onclick="fecharModalEditarForm()">Descartar</button>
        <button class="btn-modal-sim btn-modal-salvar" onclick="salvarEdicaoRegistro()">Salvar</button>
      </div>
    </div>
  </div>

  <!-- ========= OVERLAY DE CARREGAMENTO 0–100% ========= -->
  <div id="loadingOverlay">
    <div class="loading-box">
      <div>Carregando relatórios...</div>
      <div class="loading-bar-container">
        <div id="loadingBar" class="loading-bar"></div>
      </div>
      <div id="loadingPercent" class="loading-percent">0%</div>
    </div>
  </div>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const STORAGE_KEY_GESTOR = "PPP_LOGIN_GESTOR";
    let usuarioLogado = null;
    let registrosBase = [];
    let registrosAtuais = [];

    let loadingInterval = null;
    let loadingProgress = 0;

    // Registro atualmente selecionado para exclusão (objeto completo retornado da API)
    let registroParaExcluir = null;

    // ========= NOVO: registro atualmente selecionado para edição =========
    let registroParaEditar = null;

    /* ========= CONTROLE DO CARREGAMENTO (0–100%) ========= */
    function iniciarProgresso() {
      const overlay = document.getElementById("loadingOverlay");
      const bar = document.getElementById("loadingBar");
      const percentEl = document.getElementById("loadingPercent");

      loadingProgress = 0;
      bar.style.width = "0%";
      percentEl.textContent = "0%";
      overlay.style.display = "flex";

      if (loadingInterval) clearInterval(loadingInterval);

      loadingInterval = setInterval(() => {
        if (loadingProgress >= 95) return;
        loadingProgress += 5;
        bar.style.width = loadingProgress + "%";
        percentEl.textContent = loadingProgress + "%";
      }, 120);
    }

    function finalizarProgresso() {
      const overlay = document.getElementById("loadingOverlay");
      const bar = document.getElementById("loadingBar");
      const percentEl = document.getElementById("loadingPercent");

      if (loadingInterval) {
        clearInterval(loadingInterval);
        loadingInterval = null;
      }

      loadingProgress = 100;
      bar.style.width = "100%";
      percentEl.textContent = "100%";

      setTimeout(() => {
        overlay.style.display = "none";
      }, 200);
    }

    /* ========= PARSE DE DATA (STRING -> Date) ========= */
    function parseDataDaPlanilha(dataHoraStr) {
      if (!dataHoraStr) return null;
      try {
        const limpo = String(dataHoraStr).replace(/,/g, "");
        const [parteData] = limpo.split(" ");
        const [dia, mes, ano] = (parteData || "").split("/");
        if (!dia || !mes || !ano) return null;
        return new Date(Number(ano), Number(mes) - 1, Number(dia));
      } catch (e) {
        return null;
      }
    }

    /* ========= FILTRAGEM LOCAL (SEM NOVA CHAMADA À API) ========= */
    function filtrarLocal() {
      const lojaFiltro = document.getElementById("filtroLoja").value.trim().toLowerCase();
      const usuarioFiltro = document.getElementById("filtroUsuario").value.trim().toLowerCase();
      const docFiltro = document.getElementById("filtroDocumento").value.trim();
      const depFiltro = document.getElementById("filtroDepartamento").value.trim().toUpperCase();
      const dataInicio = document.getElementById("dataInicio").value;
      const dataFim = document.getElementById("dataFim").value;

      const iniDate = dataInicio ? new Date(`${dataInicio}T00:00:00`) : null;
      const fimDate = dataFim ? new Date(`${dataFim}T23:59:59`) : null;

      return registrosBase.filter((reg) => {
        if (lojaFiltro && !reg.loja.toLowerCase().includes(lojaFiltro)) return false;
        if (usuarioFiltro && !reg.usuario.toLowerCase().includes(usuarioFiltro)) return false;
        if (docFiltro && reg.documento !== docFiltro) return false;
        if (depFiltro && reg.departamento.toUpperCase() !== depFiltro) return false;

        if (iniDate || fimDate) {
          const dataReg = parseDataDaPlanilha(reg.dataHora);
          if (!dataReg) return false;
          if (iniDate && dataReg < iniDate) return false;
          if (fimDate && dataReg > fimDate) return false;
        }

        return true;
      });
    }

    /* ========= INICIALIZAÇÃO (VALIDA LOGIN DO GESTOR) ========= */
    document.addEventListener("DOMContentLoaded", () => {
      const raw = sessionStorage.getItem(STORAGE_KEY_GESTOR);

      if (!raw) {
        document.getElementById("erroAcesso").style.display = "flex";
        return;
      }

      let dadosGestor;
      try {
        dadosGestor = JSON.parse(raw);
      } catch (e) {
        console.error("Erro ao ler STORAGE_KEY_GESTOR:", e);
        document.getElementById("erroAcesso").style.display = "flex";
        return;
      }

      if (!dadosGestor || !dadosGestor.usuario) {
        document.getElementById("erroAcesso").style.display = "flex";
        return;
      }

      usuarioLogado = dadosGestor.usuario;

      document.getElementById("appRoot").style.display = "block";
      carregarBaseInicial();
    });

    function logoutGestor() {
      sessionStorage.removeItem(STORAGE_KEY_GESTOR);
    }

    /* ========= PARSE DE NÚMERO EM FORMATO BR ========= */
    function parseNumeroBr(valor) {
      if (valor === null || valor === undefined) return 0;
      let s = String(valor).trim();
      if (!s) return 0;

      s = s.replace(/\s+/g, "");
      s = s.replace(/\./g, "").replace(",", ".");
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    }

    /* ========= CARREGA BASE INICIAL (CHAMA /api/relatorios) =========
       IMPORTANTE: para usar o ID de forma plena, a rota /api/relatorios
       deve retornar um campo como "idRegistro" (lido da coluna P).
    */
    async function carregarBaseInicial() {
      const statusEl = document.getElementById("status");

      iniciarProgresso();
      try {
        statusEl.textContent = "Carregando relatórios...";
        const resp = await fetch("/api/relatorios");
        const dados = await resp.json();

        if (!resp.ok || !dados.sucesso) {
          statusEl.textContent = dados.message || "Erro ao carregar relatórios.";
          finalizarProgresso();
          return;
        }

        // Espera-se que cada registro possa trazer, opcionalmente, "idRegistro"
        registrosBase = Array.isArray(dados.registros) ? dados.registros : [];
        aplicarFiltrosLocal();
      } catch (erro) {
        console.error("Erro ao carregar relatórios:", erro);
        statusEl.textContent = "Erro de conexão ao buscar relatórios.";
        registrosBase = [];
      } finally {
        finalizarProgresso();
      }
    }

    /* ========= CONTA OCORRÊNCIAS ========= */
    function contarOcorrencias(registros) {
      const setOcorrencias = new Set();

      registros.forEach((r) => {
        const documento = (r.documento || "").trim();
        if (!documento) return;

        const usuario = (r.usuario || "").trim();
        const loja = (r.loja || "").trim();
        const dataStr = (r.dataHora || "").split(" ")[0] || "";

        const chave = `${documento}||${usuario}||${loja}||${dataStr}`;
        setOcorrencias.add(chave);
      });

      return setOcorrencias.size;
    }

    /* ========= COMPARA REGISTROS PARA REMOVER/ATUALIZAR NA BASE LOCAL =========
       NOVO: Se houver idRegistro nos dois registros, usamos apenas o ID.
       Caso contrário, caímos no comparador antigo (todas as colunas).
    */
    function registrosIguais(a, b) {
      const idA = a.idRegistro || a.ID_REGISTRO || a.id;
      const idB = b.idRegistro || b.ID_REGISTRO || b.id;

      if (idA && idB) {
        return idA === idB;
      }

      // Fallback legado: compara todos os campos conhecidos (A:O)
      return (
        (a.dataHora || "") === (b.dataHora || "") &&
        (a.loja || "") === (b.loja || "") &&
        (a.usuario || "") === (b.usuario || "") &&
        (a.ean || "") === (b.ean || "") &&
        (a.codConsinco || "") === (b.codConsinco || "") &&
        (a.produto || "") === (b.produto || "") &&
        (a.departamento || "") === (b.departamento || "") &&
        (a.secao || "") === (b.secao || "") &&
        (a.grupo || "") === (b.grupo || "") &&
        (a.subgrupo || "") === (b.subgrupo || "") &&
        (a.categoria || "") === (b.categoria || "") &&
        (a.relatorio || "") === (b.relatorio || "") &&
        (a.quantidade || "") === (b.quantidade || "") &&
        (a.valorUnitario || "") === (b.valorUnitario || "") &&
        (a.documento || "") === (b.documento || "")
      );
    }

    /* ========= APLICA FILTROS LOCALMENTE E MONTA TELA ========= */
    function aplicarFiltrosLocal() {
      const statusEl = document.getElementById("status");
      const listaEl = document.getElementById("listaCartoes");
      const resumoQtd = document.getElementById("resumoQtd");
      const resumoQtdTotal = document.getElementById("resumoQtdTotal");
      const resumoValorTotal = document.getElementById("resumoValorTotal");
      const resumoOcorrencias = document.getElementById("resumoOcorrencias");

      if (!registrosBase.length) {
        statusEl.textContent = "Base ainda não carregada ou vazia.";
        listaEl.innerHTML = "";
        resumoQtd.textContent = "";
        resumoQtdTotal.textContent = "0";
        resumoValorTotal.textContent = "0,00";
        resumoOcorrencias.textContent = "0";
        return;
      }

      const registros = filtrarLocal();

      if (!registros.length) {
        statusEl.textContent = "Nenhum registro encontrado com os filtros atuais.";
        resumoQtd.textContent = "";
        listaEl.innerHTML = "";
        registrosAtuais = [];
        resumoQtdTotal.textContent = "0";
        resumoValorTotal.textContent = "0,00";
        resumoOcorrencias.textContent = "0";
        return;
      }

      registrosAtuais = registros;

      let totalQtd = 0;
      let totalValor = 0;

      registros.forEach((r) => {
        const qtd = parseNumeroBr(r.quantidade);
        const vUnit = parseNumeroBr(r.valorUnitario);
        totalQtd += qtd;
        totalValor += qtd * vUnit;
      });

      const qtdOcorrencias = contarOcorrencias(registros);

      statusEl.textContent = `${registros.length} registro(s) encontrado(s).`;
      resumoQtd.textContent = `Total de registros retornados: ${registros.length}`;

      resumoQtdTotal.textContent = totalQtd.toLocaleString("pt-BR");
      resumoValorTotal.textContent = totalValor.toLocaleString("pt-BR", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
      resumoOcorrencias.textContent = qtdOcorrencias.toLocaleString("pt-BR");

      listaEl.innerHTML = registros
        .map((r, index) => {
          const relatorioFormatado = r.relatorio || "-";

          let totalLinhaFormatado = "";
          if (r.quantidade && r.valorUnitario) {
            const qtdNum = parseNumeroBr(r.quantidade);
            const vUnitNum = parseNumeroBr(r.valorUnitario);
            const totalNum = qtdNum * vUnitNum;
            totalLinhaFormatado = totalNum.toLocaleString("pt-BR", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            });
          }

          return `
            <div class="cartao">
              <div class="cartao-pares cartao-pares-superior">
                <div class="cartao-pareado">
                  <span class="rotulo">Data/Hora:</span>
                  <span class="valor valor-compacto">${r.dataHora || "-"}</span>
                </div>
                <div class="cartao-pareado pareado-usuario">
                  <span class="rotulo">Usuário:</span>
                  <span class="valor">${r.usuario || "-"}</span>
                </div>
              </div>
              <div class="cartao-pares cartao-pares-inferior">
                <div class="cartao-pareado cartao-pareado-loja pareado-loja">
                  <span class="rotulo">Loja:</span>
                  <span class="valor valor-compacto">${r.loja || "-"}</span>
                </div>
                <div class="cartao-pareado pareado-doc">
                  <span class="rotulo">Doc:</span>
                  <span class="valor valor-documento">${r.documento || "-"}</span>
                </div>
              </div>
              <div class="cartao-separador"></div>
              <div class="cartao-linha">
                <span class="rotulo">EAN</span>
                <span class="valor">${r.ean || "-"}</span>
              </div>
              <div class="cartao-linha cartao-linha-produto">
                <span class="rotulo">Produto</span>
                <span class="valor">${r.produto || "-"}</span>
              </div>

              <!--
                PEDIDO #4:
                - "Departamento e seu valor pode ficar oculto na lista"
                - MAS: filtro e importação continuam (não mexemos em filtrarLocal nem na base)
                Portanto: removemos apenas a renderização do bloco Departamento aqui.
              -->

              <div class="cartao-linha">
                <span class="rotulo">Seção</span>
                <span class="valor">${r.secao || "-"}</span>
              </div>
              <div class="cartao-linha">
                <span class="rotulo">Quantidade</span>
                <span class="valor">${r.quantidade || "-"}</span>
              </div>
              <div class="cartao-linha">
                <span class="rotulo">Valor Unitário</span>
                <span class="valor">
                  ${r.valorUnitario || "-"}
                  ${
                    totalLinhaFormatado
                      ? `<span class="valor-total-linha">Total: ${totalLinhaFormatado}</span>`
                      : ""
                  }
                </span>
              </div>
              <div class="cartao-divisoria"></div>
              <div class="cartao-observacao">
                <div class="obs-titulo">Relatório:</div>
                <div class="obs-texto">${relatorioFormatado}</div>
              </div>
              <div class="cartao-actions">
                <button class="btn-editar" onclick="abrirModalEditar(${index})">
                  Editar
                </button>
                <button class="btn-excluir" onclick="abrirModalExcluir(${index})">
                  Excluir
                </button>
              </div>
            </div>
          `;
        })
        .join("");
    }

    /* ========= LIMPAR FILTROS ========= */
    function limparFiltros() {
      document.getElementById("filtroLoja").value = "";
      document.getElementById("filtroUsuario").value = "";
      document.getElementById("filtroDocumento").value = "";
      document.getElementById("filtroDepartamento").value = "";
      document.getElementById("dataInicio").value = "";
      document.getElementById("dataFim").value = "";

      aplicarFiltrosLocal();
    }

    /* ========= MODAL DE DOWNLOAD ========= */
    function abrirModalDownload() {
      if (!registrosAtuais || !registrosAtuais.length) {
        alert("Não há registros carregados para exportar. Aplique um filtro primeiro.");
        return;
      }
      document.getElementById("modalDownload").style.display = "flex";
    }

    function fecharModalDownload() {
      document.getElementById("modalDownload").style.display = "none";
    }

    function confirmarDownload() {
      fecharModalDownload();
      exportarParaXlsx(registrosAtuais);
    }

    /* ========= MODAL DE EXCLUSÃO ========= */
    function abrirModalExcluir(index) {
      registroParaExcluir = registrosAtuais[index] || null;
      if (!registroParaExcluir) return;
      document.getElementById("modalExcluir").style.display = "flex";
    }

    function fecharModalExcluir() {
      registroParaExcluir = null;
      document.getElementById("modalExcluir").style.display = "none";
    }

    /* ========= CONFIRMAR EXCLUSÃO (CHAMA /api/relatorios-excluir) ========= */
    async function confirmarExclusaoRegistro() {
      const statusEl = document.getElementById("status");

      if (!registroParaExcluir) {
        fecharModalExcluir();
        return;
      }

      const payload = { registro: registroParaExcluir };

      try {
        statusEl.textContent = "Excluindo registro...";
        const resp = await fetch("/api/relatorios-excluir", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const dados = await resp.json().catch(() => ({}));

        if (!resp.ok || !dados.sucesso) {
          statusEl.textContent = dados.message || "Erro ao excluir registro.";
          fecharModalExcluir();
          return;
        }

        // Remove da base em memória (registrosBase e registrosAtuais) usando o comparador com ID
        registrosBase = registrosBase.filter((reg) => !registrosIguais(reg, registroParaExcluir));
        registrosAtuais = registrosAtuais.filter((reg) => !registrosIguais(reg, registroParaExcluir));

        statusEl.textContent = "Registro excluído com sucesso.";
        fecharModalExcluir();

        aplicarFiltrosLocal();
      } catch (erro) {
        console.error("Erro ao excluir registro:", erro);
        statusEl.textContent = "Erro de conexão ao excluir registro.";
        fecharModalExcluir();
      }
    }

    /* =========================
       ========= EDIÇÃO (NOVO) =========
       =========================
       Fluxo solicitado:
       1) Clicar em Editar -> abrir modal de confirmação "Deseja mesmo editar esse registro?"
       2) Se SIM -> abrir modal com campos para editar:
          - Quantidade
          - Valor unitário
          - Relatório
          e botões Salvar / Descartar
       3) Salvar -> persistir na MESMA linha do ID, via servidor
    */

    // Abre confirmação de edição e guarda o registro selecionado
    function abrirModalEditar(index) {
      registroParaEditar = registrosAtuais[index] || null;
      if (!registroParaEditar) return;

      document.getElementById("modalEditarConfirm").style.display = "flex";
    }

    function fecharModalEditarConfirm() {
      document.getElementById("modalEditarConfirm").style.display = "none";
      // NÃO limpamos registroParaEditar aqui para permitir o "Sim" abrir o form
    }

    // Confirmação "Sim" -> abre modal do formulário já com valores atuais
    function confirmarEditarConfirm() {
      fecharModalEditarConfirm();

      if (!registroParaEditar) return;

      // Preenche inputs com valores atuais (mantendo exatamente o que já existe no registro)
      document.getElementById("editQuantidade").value = (registroParaEditar.quantidade || "").toString();
      document.getElementById("editValorUnitario").value = (registroParaEditar.valorUnitario || "").toString();
      document.getElementById("editRelatorio").value = (registroParaEditar.relatorio || "").toString();

      document.getElementById("modalEditarForm").style.display = "flex";
    }

    function fecharModalEditarForm() {
      document.getElementById("modalEditarForm").style.display = "none";
      // Ao descartar, limpamos a seleção (não deixa "vazamento" de estado)
      registroParaEditar = null;
    }

    // Salva no servidor e atualiza na base local a mesma linha (via ID quando existir)
    async function salvarEdicaoRegistro() {
      const statusEl = document.getElementById("status");

      if (!registroParaEditar) {
        fecharModalEditarForm();
        return;
      }

      // Coleta valores editados
      const novaQtd = document.getElementById("editQuantidade").value.trim();
      const novoValorUnit = document.getElementById("editValorUnitario").value.trim();
      const novoRelatorio = document.getElementById("editRelatorio").value;

      // Monta payload: enviamos registro original + campos alteráveis
      // Observação:
      // - Para "salvar exatamente na linha do id", sua API precisa usar idRegistro (ou equivalente).
      // - Se idRegistro não vier, você ainda consegue salvar via comparador legado (mais arriscado).
      const payload = {
        registroOriginal: registroParaEditar,
        edicoes: {
          quantidade: novaQtd,
          valorUnitario: novoValorUnit,
          relatorio: novoRelatorio
        }
      };

      try {
        statusEl.textContent = "Salvando edição...";

        // Endpoint proposto:
        // - Você precisa ter no backend um /api/relatorios-editar que:
        //   1) localiza pela chave idRegistro (coluna P) e
        //   2) atualiza SOMENTE as colunas de Quantidade, Valor Unitário e Relatório
        // Se o seu backend ainda não tem, eu implemento quando você mandar o código da API.
        const resp = await fetch("/api/relatorios-editar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const dados = await resp.json().catch(() => ({}));

        if (!resp.ok || !dados.sucesso) {
          statusEl.textContent = dados.message || "Erro ao editar registro.";
          return;
        }

        // Atualiza em memória: substitui o registro correspondente (por ID se existir)
        const registroAtualizado = {
          ...registroParaEditar,
          quantidade: novaQtd,
          valorUnitario: novoValorUnit,
          relatorio: novoRelatorio
        };

        // Atualiza registrosBase
        registrosBase = registrosBase.map((reg) => {
          return registrosIguais(reg, registroParaEditar) ? registroAtualizado : reg;
        });

        // Atualiza registrosAtuais
        registrosAtuais = registrosAtuais.map((reg) => {
          return registrosIguais(reg, registroParaEditar) ? registroAtualizado : reg;
        });

        statusEl.textContent = dados.message || "Registro editado com sucesso.";

        // Fecha modal e re-renderiza para refletir mudanças (inclusive totais)
        fecharModalEditarForm();
        aplicarFiltrosLocal();
      } catch (erro) {
        console.error("Erro ao editar registro:", erro);
        statusEl.textContent = "Erro de conexão ao editar registro.";
      }
    }

    /* ==== EXPORTAÇÃO COM VALOR TOTAL E DOCUMENTO (SEM ID) ==== */
    /* ==== EXPORTAÇÃO (NÚMEROS REAIS NO XLSX) ==== */
    function exportarParaXlsx(registros) {
      const cabecalho = [
        "Data/Hora",
        "Loja",
        "Usuário",
        "EAN",
        "Cod Consinco",
        "Produto",
        "Departamento",
        "Seção",
        "Grupo",
        "Subgrupo",
        "Categoria",
        "Relatório / Observação",
        "Quantidade",
        "Valor unitário",
        "Valor total (Qtd x Unit)",
        "Documento",
      ];

      // Monta linhas garantindo que:
      // - Quantidade = number
      // - Valor unitário = number
      // - Valor total = number
      // Isso permite formatação no Excel (moeda, número, etc.)
      const linhas = registros.map((r) => {
        const qtdNum = parseNumeroBr(r.quantidade);      // number
        const vUnitNum = parseNumeroBr(r.valorUnitario); // number
        const totalNum = qtdNum * vUnitNum;              // number

        return [
          r.dataHora || "",
          r.loja || "",
          r.usuario || "",
          r.ean || "",
          r.codConsinco || "",
          r.produto || "",
          r.departamento || "",
          r.secao || "",
          r.grupo || "",
          r.subgrupo || "",
          r.categoria || "",
          r.relatorio || "",
          qtdNum,                 // <-- NÚMERO (não texto)
          vUnitNum,               // <-- NÚMERO (não texto)
          totalNum || 0,          // <-- NÚMERO (não texto)
          r.documento || "",
        ];
      });

      const dados = [cabecalho, ...linhas];

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(dados);

      // (Opcional, mas recomendado) define formato numérico nas colunas:
      // M = Quantidade (13ª), N = Valor Unitário (14ª), O = Valor Total (15ª)
      // Isso já faz o Excel abrir com cara de número/moeda.
      // Não altera nada além da exportação.
      const range = XLSX.utils.decode_range(ws["!ref"]);

      for (let R = 1; R <= range.e.r; R++) { // começa em 1 para pular o cabeçalho
        const cellQtd  = ws[XLSX.utils.encode_cell({ r: R, c: 12 })]; // M
        const cellUnit = ws[XLSX.utils.encode_cell({ r: R, c: 13 })]; // N
        const cellTot  = ws[XLSX.utils.encode_cell({ r: R, c: 14 })]; // O

        if (cellQtd && typeof cellQtd.v === "number")  cellQtd.z  = "#,##0";
        if (cellUnit && typeof cellUnit.v === "number") cellUnit.z = '"R$" #,##0.00';
        if (cellTot && typeof cellTot.v === "number")  cellTot.z  = '"R$" #,##0.00';
      }

      XLSX.utils.book_append_sheet(wb, ws, "Relatorios PPP");
      XLSX.writeFile(wb, "relatorios_ppp.xlsx");
    }
  </script>
</body>
</html>

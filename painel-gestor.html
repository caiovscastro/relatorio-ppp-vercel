<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PAINEL DE OCORRÊNCIAS</title>
<link rel="icon" type="image/png" href="/LogoBigUltra.png">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#030712">

  <style>
    body {
      background: #f3f3f3;
      font-family: Arial, sans-serif;
      margin: 3px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      width: 85%;
      max-width: 1100px;
      background: #ffffff;
      padding: 24px 28px 28px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
    }

    .cabecalho {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      border-bottom: 1px solid #e1e1e1;
      padding-bottom: 14px;
      margin-bottom: 12px;
    }

    .titulo {
      margin: 0;
      font-size: 22px;
    }

    .resumo-cards {
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      margin: 10px 0 14px;
      justify-content: space-between;
    }

    .card-resumo {
      flex: 1 1 33%;
      min-width: 0;
      background: #f9fafc;
      border-radius: 12px;
      padding: 10px 12px;

      border: 1px solid #d0d6e2;
      box-shadow:
        0 4px 10px rgba(0, 0, 0, 0.18),
        0 -2px 4px rgba(255, 255, 255, 0.75) inset,
        0 2px 4px rgba(0, 0, 0, 0.05) inset;

      font-size: 13px;
    }

    .resumo-titulo {
      font-weight: 600;
      color: #555;
      margin-bottom: 4px;
    }

    .resumo-valor {
      font-size: 18px;
      font-weight: 700;
      color: #1a1a1a;
    }

    .bloco-filtros {
      margin: 0 -4px 16px;
      padding: 14px;
      border-radius: 10px;
      background: #f7f8ff;
      border: 1px solid #e0e3ff;
    }

    .bloco-filtros h3 {
      margin: 0 0 10px;
      font-size: 16px;
    }

    .filtros-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      grid-template-areas:
        "loja usuario departamento"
        "documento dataInicio dataFim";
      gap: 8px 10px;
    }

    .campo-filtro {
      display: flex;
      flex-direction: column;
      font-size: 13px;
      min-width: 0;
    }

    .campo-filtro label {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .campo-filtro input,
    .campo-filtro select {
      border-radius: 6px;
      border: 1px solid #c3c3c3;
      padding: 6px 8px;
      font-size: 13px;
      box-sizing: border-box;
      background: #fff;
      width: 100%;
      max-width: 100%;
    }

    .campo-loja        { grid-area: loja; }
    .campo-usuario     { grid-area: usuario; }
    .campo-departamento{ grid-area: departamento; }
    .campo-documento   { grid-area: documento; }
    .campo-data-inicio { grid-area: dataInicio; }
    .campo-data-fim    { grid-area: dataFim; }

    .botoes-filtro {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px 10px;
      justify-content: stretch;
    }

    .btn {
      padding: 7px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
    }

    .botoes-filtro .btn {
      width: 100%;
      font-size: 11px;
      padding: 6px 6px;
      letter-spacing: 0;
    }

    @media (max-width: 480px) {
      .botoes-filtro .btn {
        font-size: 10px;
        padding: 6px 4px;
      }
    }

    .btn-aplicar { background: #0066ff; color: #fff; }
    .btn-limpar  { background: #e0e0e0; color: #333; }
    .btn-exportar{ background: #4caf50; color: #fff; }
    .btn-dashboard{ background: #6a5acd; color: #fff; }
    .btn-dashboard:hover { filter: brightness(0.95); }

    .status {
      font-size: 13px;
      margin-bottom: 8px;
      text-align: left;
      color: #333;
    }

    .lista-cartoes {
      max-height: 60vh;
      overflow-y: auto;
    }

    .cartao {
      background: #ffffff;
      border: 2px solid #3c9c46;
      border-radius: 10px;

      box-shadow:
        0 4px 10px rgba(0, 0, 0, 0.18),
        0 -2px 4px rgba(255, 255, 255, 0.75) inset,
        0 2px 4px rgba(0, 0, 0, 0.05) inset;

      padding: 0;
      margin-bottom: 12px;
      font-size: 12px;
      overflow: hidden;

      cursor: pointer;
    }

    .cartao-pares {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      border-bottom: 1px solid #c7c7c7;
    }

    .cartao-pareado {
      display: grid;
      grid-template-columns: 38% 62%;
      align-items: center;
      padding: 5px 7px;
      border-right: 1px solid #c7c7c7;
      gap: var(--gap-pareado, 6px);
      min-width: 0;
    }

    .cartao-pareado-loja { grid-template-columns: 30% 70%; }

    .pareado-usuario { --gap-pareado: 1px; }
    .pareado-loja    { --gap-pareado: 1px; }
    .pareado-doc     { --gap-pareado: 0px; --doc-margin-left: 0px; }

    .cartao-pareado:nth-child(2n) { border-right: none; }

    .cartao-pares-superior .cartao-pareado,
    .cartao-pares-inferior .cartao-pareado {
      background: #e9fbe9;
    }

    .cartao-pares-superior .cartao-pareado { padding: 6px 10px; }
    .cartao-pares-inferior .cartao-pareado { padding: 4px 10px; }
    .cartao-pares-inferior .pareado-doc { padding-left: 9px; }

    .rotulo { font-weight: 700; color: #111; white-space: nowrap; }
    .valor  { color: #111; word-break: break-word; }

    .valor-compacto { font-size: 10px; white-space: nowrap; line-height: 1.1; }

    .valor-documento {
      margin-left: var(--doc-margin-left, 2px);
      display: inline-block;
    }

    .cartao-divisoria { border-top: 1px solid #c7c7c7; }

    .cartao-observacao {
      padding: 10px 12px 10px;
      background: #ffffff;
      line-height: 1.45;
      color: #111;
      cursor: default;
    }

    .cartao-observacao .obs-titulo { font-weight: 700; margin-bottom: 6px; color: #111; }
    .cartao-observacao .obs-texto  { white-space: pre-wrap; word-break: break-word; }

    .rodape {
      margin-top: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }

    .btn-voltar {
      padding: 6px 10px;
      background: #0066ff;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      font-size: 12px;
      font-weight: 600;
    }

    .tela-erro {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #f3f3f3;
      font-family: Arial, sans-serif;
    }

    .card-erro {
      background: #fff;
      padding: 26px 30px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      max-width: 420px;
      text-align: center;
    }

    .card-erro h1 { color: #c00000; margin-top: 0; }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(220, 220, 220, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-content {
      background: #ffffff;
      border-radius: 10px;
      padding: 20px 22px 16px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
      max-width: 360px;
      width: 90%;
      text-align: center;
      font-size: 14px;
    }

    .modal-titulo { font-weight: 600; margin-bottom: 8px; font-size: 16px; }
    .modal-texto  { margin-bottom: 18px; color: #333; }

    .modal-botoes {
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .btn-modal-sim,
    .btn-modal-cancelar {
      background: #e0e0e0;
      color: #333;
      border: none;
      border-radius: 6px;
      padding: 7px 14px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      flex: 1;
      text-align: center;
    }

    .btn-modal-sim { background: #4caf50; color: #fff; }
    .btn-modal-cancelar { background: #e0e0e0; color: #333; }

    /* Overlay de carregamento (já existia) */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(243, 243, 243, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .loading-box {
      background: #ffffff;
      border-radius: 8px;
      padding: 16px 22px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      text-align: center;
      font-size: 14px;
    }

    .loading-bar-container {
      width: 220px;
      height: 8px;
      border-radius: 4px;
      background: #eeeeee;
      margin-top: 8px;
      overflow: hidden;
    }

    .loading-bar {
      height: 100%;
      width: 0%;
      background: #0066ff;
      transition: width 0.15s linear;
    }

    .loading-percent { margin-top: 6px; font-weight: 600; }

    .modal-form { text-align: left; margin-top: 10px; }

    .modal-form .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .modal-form label { font-weight: 700; color: #111; }

    .modal-form input,
    .modal-form textarea {
      border-radius: 6px;
      border: 1px solid #c3c3c3;
      padding: 8px 10px;
      font-size: 13px;
      box-sizing: border-box;
      width: 100%;
      background: #fff;
    }

    .modal-form textarea {
      resize: vertical;
      min-height: 90px;
      white-space: pre-wrap;
    }

    .btn-modal-salvar { background: #0066ff; color: #fff; }
    .btn-modal-descartar { background: #e0e0e0; color: #333; }

    .imagem-mini-wrap {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-right: 6px;
    }

    .imagem-mini {
      width: 38px;
      height: 38px;
      border-radius: 6px;
      border: 1px solid #d0d0d0;
      object-fit: cover;
      display: inline-block;
      background: #f2f2f2;
      cursor: pointer;
    }

    .link-abrir-imagem {
      font-size: 12px;
      font-weight: 600;
      color: #0066ff;
      text-decoration: underline;
      cursor: pointer;
      background: transparent;
      border: none;
      padding: 0;
    }

    /* ==============================
       Modal Cupom Fiscal
       ============================== */
    .modal-cupom {
      max-width: 460px;
      width: 92%;
      text-align: left;
      font-family: "Courier New", Courier, monospace;
      padding: 16px 16px 14px;
    }

    /* ✅ AJUSTE 1: margem no CUPOM/DOCUMENTO no celular (não encosta nas bordas) */
    #modalCupom{
      padding: 12px;
      box-sizing: border-box;
    }
    @media (max-width: 480px){
      #modalCupom{
        padding: 14px;
      }
    }

    .cupom-titulo {
      font-weight: 800;
      text-align: center;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .cupom-sub {
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .cupom-sep {
      border-top: 1px dashed #777;
      margin: 10px 0;
    }

    /* ✅ AJUSTE 2: Qtd/V.un/V.total mais próximos à direita e sobrando mais espaço pro Produto */
    .cupom-cab {
      display: grid;
      grid-template-columns: 26px 1fr 48px 72px 78px;
      gap: 4px;
      font-size: 12px;
      font-weight: 800;
      padding-bottom: 6px;
      border-bottom: 1px dashed #777;
      margin-bottom: 6px;
      align-items: center;
    }

    .cupom-itens {
      max-height: 44vh;
      overflow: auto;
      padding-right: 4px;
    }

    .cupom-row {
      display: grid;
      grid-template-columns: 26px 1fr 48px 72px 78px;
      gap: 4px;
      font-size: 12px;
      padding: 6px 0;
      border-bottom: 1px dotted #bbb;
      align-items: start;
    }

    @media (max-width: 480px){
      .cupom-cab{
        grid-template-columns: 26px 1fr 44px 66px 70px;
        gap: 4px;
      }
      .cupom-row{
        grid-template-columns: 26px 1fr 44px 66px 70px;
        gap: 4px;
      }
    }

    .cupom-prod {
      word-break: break-word;
    }

    .cupom-num {
      text-align: right;
      white-space: nowrap;
    }

    .cupom-totais {
      font-size: 12px;
      font-weight: 800;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      white-space: nowrap;
    }

    .cupom-obs {
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .cupom-img {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .cupom-img img {
      width: 54px;
      height: 54px;
      border-radius: 8px;
      border: 1px solid #d0d0d0;
      object-fit: cover;
      background: #f2f2f2;
      cursor: pointer;
    }

    .btn-danger {
      background: #f44336 !important;
      color: #fff !important;
    }

    .btn-editar-item {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 1px solid #c9c9c9;
      background: #fff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      line-height: 1;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }
    .btn-editar-item:hover { filter: brightness(0.97); }

    /* ✅ AJUSTE 1 (SOLICITADO AGORA):
       Na lista de ocorrências, rótulo + valor ficam "colados" com apenas 1 espaço visual.
       (Remove o layout em colunas só nesses campos) */
    .pareado-inline {
      display: block !important; /* sobrescreve display:grid do .cartao-pareado */
    }
    .pareado-inline .rotulo,
    .pareado-inline .valor {
      display: inline;
      white-space: normal;
    }
  </style>
</head>

<body>
  <div id="erroAcesso" class="tela-erro" style="display:none;">
    <div class="card-erro">
      <h1>Acesso inválido</h1>
      <p>Você precisa fazer login para acessar o Painel Gerencial.</p>
      <p>Clique em “Voltar para login” e realize o login novamente.</p>
      <a href="/login.html" class="btn-voltar">Voltar para login</a>
    </div>
  </div>

  <div id="appRoot" class="container" style="display:none;">
    <div class="cabecalho">
      <div>
        <h1 class="titulo">PAINEL DE OCORRÊNCIAS</h1>
      </div>
    </div>

    <div class="resumo-cards">
      <div class="card-resumo">
        <div class="resumo-titulo">Quantidade</div>
        <div id="resumoQtdTotal" class="resumo-valor">0</div>
      </div>
      <div class="card-resumo">
        <div class="resumo-titulo">Valor total</div>
        <div id="resumoValorTotal" class="resumo-valor">0,00</div>
      </div>
      <div class="card-resumo">
        <div class="resumo-titulo">Ocorrências</div>
        <div id="resumoOcorrencias" class="resumo-valor">0</div>
      </div>
    </div>

    <div class="bloco-filtros">
      <h3>Filtros</h3>

      <div class="filtros-grid">
        <div class="campo-filtro campo-loja">
          <label for="filtroLoja">Loja (texto)</label>
          <input id="filtroLoja" type="text" placeholder="Ex.: ULT 01" />
        </div>

        <div class="campo-filtro campo-usuario">
          <label for="filtroUsuario">Usuário</label>
          <input id="filtroUsuario" type="text" placeholder="Login / nome" />
        </div>

        <div class="campo-filtro campo-departamento">
          <label for="filtroDepartamento">Departamento</label>
          <select id="filtroDepartamento">
            <option value="">Todos</option>
            <option value="MERCEARIA">MERCEARIA</option>
            <option value="PERECIVEIS">PERECIVEIS</option>
            <option value="HIGIENE E LIMPEZA">HIGIENE E LIMPEZA</option>
            <option value="BAZAR">BAZAR</option>
            <option value="DESPESAS">DESPESAS</option>
            <option value="GASTRONOMIA">GASTRONOMIA</option>
          </select>
        </div>

        <div class="campo-filtro campo-documento">
          <label for="filtroDocumento">Nº Documento</label>
          <input id="filtroDocumento" type="text" placeholder="Número exato" />
        </div>

        <div class="campo-filtro campo-data-inicio">
          <label for="dataInicio">Data início</label>
          <input id="dataInicio" type="date" />
        </div>

        <div class="campo-filtro campo-data-fim">
          <label for="dataFim">Data fim</label>
          <input id="dataFim" type="date" />
        </div>
      </div>

      <div class="botoes-filtro">
        <button class="btn btn-limpar" onclick="limparFiltros()">Limpar filtros</button>
        <button class="btn btn-dashboard" onclick="abrirDashboard()">Dashboard</button>
        <button class="btn btn-exportar" onclick="abrirModalDownload()">Exportar XLSX</button>
        <button class="btn btn-aplicar" onclick="aplicarFiltrosLocal()">Aplicar filtros</button>
      </div>
    </div>

    <div class="status" id="status">Carregando relatórios...</div>
    <div class="lista-cartoes" id="listaCartoes"></div>

    <div class="rodape">
      <a href="/menu.html" class="btn-voltar" onclick="logoutGestor()">Voltar ao menu</a>
      <span id="resumoQtd"></span>
    </div>
  </div>

  <!-- Modal Download (mantido) -->
  <div id="modalDownload" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-titulo">Confirmar download</div>
      <div class="modal-texto">Você deseja mesmo fazer o download do arquivo?</div>
      <div class="modal-botoes">
        <button class="btn-modal-cancelar" onclick="fecharModalDownload()">Cancelar</button>
        <button class="btn-modal-sim" onclick="confirmarDownload()">Sim</button>
      </div>
    </div>
  </div>

  <!-- Modal Excluir Documento (mantido) -->
  <div id="modalExcluirDocumento" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-titulo">Confirmar exclusão</div>
      <div class="modal-texto">Você tem certeza que deseja excluir este documento e todos os seus produtos?</div>
      <div class="modal-botoes">
        <button class="btn-modal-cancelar" onclick="fecharModalExcluirDocumento()">Cancelar</button>
        <button class="btn-modal-sim btn-danger" onclick="confirmarExclusaoDocumento()">Sim</button>
      </div>
    </div>
  </div>

  <!-- Modal Editar Observação Documento (mantido) -->
  <div id="modalEditarObs" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-titulo">Editar observação do documento</div>
      <div class="modal-form">
        <div class="form-group">
          <label for="editObsTexto">Observação</label>
          <textarea id="editObsTexto" placeholder="Digite a observação..."></textarea>
        </div>
      </div>
      <div class="modal-botoes">
        <button class="btn-modal-cancelar" onclick="fecharModalEditarObs()">Cancelar</button>
        <button class="btn-modal-sim btn-modal-salvar" onclick="salvarEdicaoObservacaoDocumento()">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal Editar Item (Qtd e Valor Un.) -->
  <div id="modalEditarItem" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-titulo">Editar item</div>
      <div class="modal-form">
        <div class="form-group">
          <label for="editItemProduto">Produto</label>
          <input id="editItemProduto" type="text" disabled />
        </div>

        <div class="form-group">
          <label for="editItemQtd">Qtd.</label>
          <input id="editItemQtd" type="text" placeholder="Ex.: 2" />
        </div>

        <div class="form-group">
          <label for="editItemValorUnit">Valor un.</label>
          <input id="editItemValorUnit" type="text" placeholder="Ex.: 12,99" />
        </div>
      </div>

      <div class="modal-botoes" style="margin-bottom:10px;">
        <button class="btn-modal-cancelar btn-modal-descartar" onclick="fecharModalEditarItem()">Descartar</button>
        <button class="btn-modal-sim btn-modal-salvar" onclick="salvarEdicaoItem()">Salvar</button>
      </div>

      <div class="modal-botoes">
        <button class="btn-modal-sim btn-danger" onclick="eliminarItem()">Eliminar registro</button>
      </div>
    </div>
  </div>

  <!-- Modal Cupom Fiscal (ajustado: qualquer botão fecha o CUPOM antes) -->
  <div id="modalCupom" class="modal-overlay">
    <div class="modal-content modal-cupom">
      <div class="cupom-titulo">CUPOM / DOCUMENTO</div>
      <div id="cupomSub" class="cupom-sub"></div>

      <div class="cupom-sep"></div>

      <div class="cupom-cab">
        <div></div>
        <div>Produto</div>
        <div class="cupom-num">Qtd.</div>
        <div class="cupom-num">V. un.</div>
        <div class="cupom-num">V. total</div>
      </div>

      <div id="cupomItens" class="cupom-itens"></div>

      <div class="cupom-sep"></div>

      <div id="cupomTotais" class="cupom-totais"></div>

      <div class="cupom-sep"></div>

      <div id="cupomObsWrap" class="cupom-obs"></div>
      <div id="cupomImgWrap" class="cupom-img"></div>

      <div class="cupom-sep"></div>

      <div class="modal-botoes">
        <button class="btn-modal-cancelar" onclick="cupomAcaoFechar()">Fechar</button>
        <button class="btn-modal-sim" onclick="cupomAcaoEditarObs()">Editar observação</button>
        <button class="btn-modal-sim btn-danger" onclick="cupomAcaoExcluirDocumento()">Excluir documento</button>
      </div>
    </div>
  </div>

  <!-- Overlay de carregamento (0 a 100% de 5 em 5, finaliza ao concluir) -->
  <div id="loadingOverlay">
    <div class="loading-box">
      <div id="loadingTitle">Carregando relatórios...</div>
      <div class="loading-bar-container">
        <div id="loadingBar" class="loading-bar"></div>
      </div>
      <div id="loadingPercent" class="loading-percent">0%</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const STORAGE_KEY_GESTOR = "PPP_LOGIN_GESTOR";
    const STORAGE_DASH_OK = "PPP_DASH_OK";
    const STORAGE_DASH_TS  = "PPP_DASH_TS";

    let usuarioLogado = null;
    let registrosBase = [];

    let registrosAtuaisItens = [];
    let documentosAtuais = [];
    let documentoSelecionado = null;

    let itemSelecionado = null;
    let itemSelecionadoIndex = -1;

    let loadingInterval = null;
    let loadingProgress = 0;

    function b64EncodeUnicode(str) {
      try { return btoa(unescape(encodeURIComponent(str))); }
      catch (e) { return btoa(str); }
    }

    function getAuthHeaders() {
      try {
        const raw = sessionStorage.getItem(STORAGE_KEY_GESTOR);
        if (!raw) return {};
        const obj = JSON.parse(raw);
        if (!obj || !obj.usuario) return {};
        return { "X-PPP-Session": b64EncodeUnicode(JSON.stringify(obj)) };
      } catch (e) {
        return {};
      }
    }

    function abrirDashboard() {
      const u = String(usuarioLogado || "").trim().toLowerCase();

      const usuariosPermitidos = new Set([
        "gaspar.silva",
        "caio.castro"
      ]);

      if (!usuariosPermitidos.has(u)) {
        alert("Acesso negado: você não tem permissão para abrir o Dashboard.");
        return;
      }

      try {
        sessionStorage.setItem(STORAGE_DASH_OK, "1");
        sessionStorage.setItem(STORAGE_DASH_TS, String(Date.now()));
      } catch (e) {}

      window.location.href = "/dashboard.html";
    }

    function iniciarProgresso(titulo = "Carregando relatórios...") {
      const overlay = document.getElementById("loadingOverlay");
      const bar = document.getElementById("loadingBar");
      const percentEl = document.getElementById("loadingPercent");
      const titleEl = document.getElementById("loadingTitle");

      titleEl.textContent = titulo;

      loadingProgress = 0;
      bar.style.width = "0%";
      percentEl.textContent = "0%";
      overlay.style.display = "flex";

      if (loadingInterval) clearInterval(loadingInterval);

      loadingInterval = setInterval(() => {
        if (loadingProgress >= 95) return;
        loadingProgress += 5;
        bar.style.width = loadingProgress + "%";
        percentEl.textContent = loadingProgress + "%";
      }, 120);
    }

    function finalizarProgresso() {
      const overlay = document.getElementById("loadingOverlay");
      const bar = document.getElementById("loadingBar");
      const percentEl = document.getElementById("loadingPercent");

      if (loadingInterval) {
        clearInterval(loadingInterval);
        loadingInterval = null;
      }

      loadingProgress = 100;
      bar.style.width = "100%";
      percentEl.textContent = "100%";

      setTimeout(() => {
        overlay.style.display = "none";
      }, 200);
    }

    function escapeHtml(v) {
      const s = String(v ?? "");
      return s
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function dataBRParaISO(dataBR) {
      const s = String(dataBR || "").trim();
      if (!s) return "";
      const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (!m) return "";
      const dd = m[1], mm = m[2], yyyy = m[3];
      return `${yyyy}-${mm}-${dd}`;
    }

    function normalizarHoraHHMM(horaStr) {
      const s = String(horaStr || "").trim();
      if (!s) return "";
      const m = s.match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/);
      if (!m) return s;
      const hh = String(parseInt(m[1], 10)).padStart(2, "0");
      const mm = String(parseInt(m[2], 10)).padStart(2, "0");
      return `${hh}:${mm}`;
    }

    function dataHoraOcorridoConcatenada(reg) {
      const dataBR = String(reg?.dataOcorrido || "").trim();
      const hora = normalizarHoraHHMM(reg?.horaOcorrido || "");
      if (!dataBR && !hora) return "-";
      if (!dataBR) return `- ${hora}`.trim();
      if (!hora) return dataBR;
      return `${dataBR} ${hora}`;
    }

    function filtrarLocal() {
      const lojaFiltro = document.getElementById("filtroLoja").value.trim().toLowerCase();
      const usuarioFiltro = document.getElementById("filtroUsuario").value.trim().toLowerCase();
      const docFiltro = document.getElementById("filtroDocumento").value.trim();
      const depFiltro = document.getElementById("filtroDepartamento").value.trim().toUpperCase();

      const dataInicio = document.getElementById("dataInicio").value;
      const dataFim = document.getElementById("dataFim").value;

      return registrosBase.filter((reg) => {
        if (lojaFiltro && !String(reg.loja || "").toLowerCase().includes(lojaFiltro)) return false;
        if (usuarioFiltro && !String(reg.usuario || "").toLowerCase().includes(usuarioFiltro)) return false;
        if (docFiltro && String(reg.documento || "") !== docFiltro) return false;
        if (depFiltro && String(reg.departamento || "").toUpperCase() !== depFiltro) return false;

        if (dataInicio || dataFim) {
          const isoReg = dataBRParaISO(reg.dataOcorrido);
          if (!isoReg) return false;

          if (dataInicio && isoReg < dataInicio) return false;
          if (dataFim && isoReg > dataFim) return false;
        }

        return true;
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const raw = sessionStorage.getItem(STORAGE_KEY_GESTOR);

      if (!raw) {
        document.getElementById("erroAcesso").style.display = "flex";
        return;
      }

      let dadosGestor;
      try {
        dadosGestor = JSON.parse(raw);
      } catch (e) {
        console.error("Erro ao ler STORAGE_KEY_GESTOR:", e);
        document.getElementById("erroAcesso").style.display = "flex";
        return;
      }

      if (!dadosGestor || !dadosGestor.usuario) {
        document.getElementById("erroAcesso").style.display = "flex";
        return;
      }

      usuarioLogado = dadosGestor.usuario;

      document.getElementById("appRoot").style.display = "block";
      carregarBaseInicial();
    });

    function logoutGestor() {
      sessionStorage.removeItem(STORAGE_KEY_GESTOR);
      try { sessionStorage.removeItem(STORAGE_DASH_OK); } catch (e) {}
      try { sessionStorage.removeItem(STORAGE_DASH_TS); } catch (e) {}
    }

    function parseNumeroBr(valor) {
      if (valor === null || valor === undefined) return 0;
      let s = String(valor).trim();
      if (!s) return 0;

      s = s.replace(/\s+/g, "");
      s = s.replace(/\./g, "").replace(",", ".");
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    }

    async function carregarBaseInicial() {
      const statusEl = document.getElementById("status");

      iniciarProgresso("Carregando relatórios...");
      try {
        statusEl.textContent = "Carregando relatórios...";

        const resp = await fetch("/api/relatorios", {
          method: "GET",
          headers: { ...getAuthHeaders() },
          credentials: "include"
        });

        const dados = await resp.json();

        if (!resp.ok || !dados.sucesso) {
          statusEl.textContent = dados.message || "Erro ao carregar relatórios.";
          finalizarProgresso();
          return;
        }

        registrosBase = Array.isArray(dados.registros) ? dados.registros : [];
        aplicarFiltrosLocal();
      } catch (erro) {
        console.error("Erro ao carregar relatórios:", erro);
        statusEl.textContent = "Erro de conexão ao buscar relatórios.";
        registrosBase = [];
      } finally {
        finalizarProgresso();
      }
    }

    function chaveDocumento(reg) {
      const documento = (reg.documento || "").trim();
      const usuario = (reg.usuario || "").trim();
      const loja = (reg.loja || "").trim();
      const dataStr = String(reg.dataOcorrido || "").trim();
      return `${documento}||${usuario}||${loja}||${dataStr}`;
    }

    function agruparDocumentos(itens) {
      const map = new Map();

      itens.forEach((r) => {
        const doc = (r.documento || "").trim();
        if (!doc) return;

        const key = chaveDocumento(r);

        if (!map.has(key)) {
          map.set(key, {
            key,
            documento: doc,
            usuario: r.usuario || "",
            loja: r.loja || "",
            dataOcorrido: r.dataOcorrido || "",
            horaOcorrido: r.horaOcorrido || "",
            relatorio: r.relatorio || "",
            imageUrl: (r.imageUrl || r.imagemUrl || r.urlImagem || "").toString().trim(),
            itens: []
          });
        }

        const g = map.get(key);
        g.itens.push(r);

        const rel = String(r.relatorio || "").trim();
        if (rel && !String(g.relatorio || "").trim()) g.relatorio = rel;

        const img = (r.imageUrl || r.imagemUrl || r.urlImagem || "").toString().trim();
        if (img && !g.imageUrl) g.imageUrl = img;

        if (!g.horaOcorrido && r.horaOcorrido) g.horaOcorrido = r.horaOcorrido;
      });

      const arr = Array.from(map.values());

      arr.sort((a, b) => {
        const aIso = dataBRParaISO(a.dataOcorrido);
        const bIso = dataBRParaISO(b.dataOcorrido);

        if (aIso && bIso && aIso !== bIso) return aIso < bIso ? 1 : -1;

        const ah = normalizarHoraHHMM(a.horaOcorrido);
        const bh = normalizarHoraHHMM(b.horaOcorrido);
        if (ah !== bh) return ah < bh ? 1 : -1;

        return String(a.documento).localeCompare(String(b.documento));
      });

      return arr;
    }

    function aplicarFiltrosLocal() {
      const statusEl = document.getElementById("status");
      const listaEl = document.getElementById("listaCartoes");
      const resumoQtd = document.getElementById("resumoQtd");
      const resumoQtdTotal = document.getElementById("resumoQtdTotal");
      const resumoValorTotal = document.getElementById("resumoValorTotal");
      const resumoOcorrencias = document.getElementById("resumoOcorrencias");

      if (!registrosBase.length) {
        statusEl.textContent = "Base ainda não carregada ou vazia.";
        listaEl.innerHTML = "";
        resumoQtd.textContent = "";
        resumoQtdTotal.textContent = "0";
        resumoValorTotal.textContent = "0,00";
        resumoOcorrencias.textContent = "0";
        registrosAtuaisItens = [];
        documentosAtuais = [];
        return;
      }

      const itens = filtrarLocal();
      registrosAtuaisItens = itens;

      if (!itens.length) {
        statusEl.textContent = "Nenhum registro encontrado com os filtros atuais.";
        resumoQtd.textContent = "";
        listaEl.innerHTML = "";
        resumoQtdTotal.textContent = "0";
        resumoValorTotal.textContent = "0,00";
        resumoOcorrencias.textContent = "0";
        documentosAtuais = [];
        return;
      }

      documentosAtuais = agruparDocumentos(itens);

      let totalQtd = 0;
      let totalValor = 0;

      itens.forEach((r) => {
        const qtd = parseNumeroBr(r.quantidade);
        const vUnit = parseNumeroBr(r.valorUnitario);
        totalQtd += qtd;
        totalValor += qtd * vUnit;
      });

      statusEl.textContent = `${documentosAtuais.length} documento(s) encontrado(s).`;
      resumoQtd.textContent = `Itens retornados: ${itens.length} | Documentos: ${documentosAtuais.length}`;

      resumoQtdTotal.textContent = totalQtd.toLocaleString("pt-BR");
      resumoValorTotal.textContent = totalValor.toLocaleString("pt-BR", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
      resumoOcorrencias.textContent = documentosAtuais.length.toLocaleString("pt-BR");

      listaEl.innerHTML = documentosAtuais.map((d, index) => {
        const dataHoraExibicao = dataHoraOcorridoConcatenada(d);
        const relatorioFormatado = String(d.relatorio || "-");

        return `
          <div class="cartao" onclick="abrirCupom(${index})">
            <div class="cartao-pares cartao-pares-superior">
              <div class="cartao-pareado pareado-inline">
                <span class="rotulo">Data/Hora:</span><span class="valor valor-compacto"> ${escapeHtml(dataHoraExibicao)}</span>
              </div>
              <div class="cartao-pareado pareado-usuario pareado-inline">
                <span class="rotulo">Usuário:</span><span class="valor"> ${escapeHtml(d.usuario || "-")}</span>
              </div>
            </div>

            <div class="cartao-pares cartao-pares-inferior">
              <div class="cartao-pareado cartao-pareado-loja pareado-loja pareado-inline">
                <span class="rotulo">Loja:</span><span class="valor valor-compacto"> ${escapeHtml(d.loja || "-")}</span>
              </div>
              <div class="cartao-pareado pareado-doc pareado-inline">
                <span class="rotulo">Doc:</span><span class="valor valor-documento"> ${escapeHtml(d.documento || "-")}</span>
              </div>
            </div>

            <div class="cartao-divisoria"></div>

            <div class="cartao-observacao">
              <div class="obs-titulo">Observação:</div>
              <div class="obs-texto">${escapeHtml(relatorioFormatado)}</div>
            </div>
          </div>
        `;
      }).join("");
    }

    function limparFiltros() {
      document.getElementById("filtroLoja").value = "";
      document.getElementById("filtroUsuario").value = "";
      document.getElementById("filtroDocumento").value = "";
      document.getElementById("filtroDepartamento").value = "";
      document.getElementById("dataInicio").value = "";
      document.getElementById("dataFim").value = "";
      aplicarFiltrosLocal();
    }

    function abrirModalDownload() {
      if (!registrosAtuaisItens || !registrosAtuaisItens.length) {
        alert("Não há registros carregados para exportar. Aplique um filtro primeiro.");
        return;
      }
      document.getElementById("modalDownload").style.display = "flex";
    }

    function fecharModalDownload() {
      document.getElementById("modalDownload").style.display = "none";
    }

    function confirmarDownload() {
      fecharModalDownload();
      exportarParaXlsx(registrosAtuaisItens);
    }

    function abrirCupom(indexDoc) {
      const d = documentosAtuais[indexDoc] || null;
      if (!d) return;

      documentoSelecionado = d;

      const sub = document.getElementById("cupomSub");
      const itensEl = document.getElementById("cupomItens");
      const totaisEl = document.getElementById("cupomTotais");
      const obsEl = document.getElementById("cupomObsWrap");
      const imgWrap = document.getElementById("cupomImgWrap");

      const dataHora = dataHoraOcorridoConcatenada(d);

      sub.textContent =
        `Loja: ${d.loja || "-"}\n` +
        `Usuário: ${d.usuario || "-"}\n` +
        `Data/Hora: ${dataHora}\n` +
        `Documento: ${d.documento || "-"}`;

      let totalDoc = 0;

      const linhas = (d.itens || []).map((r, idx) => {
        const produto = escapeHtml(r.produto || "-");
        const qtdNum = parseNumeroBr(r.quantidade);
        const unitNum = parseNumeroBr(r.valorUnitario);
        const totNum = qtdNum * unitNum;
        totalDoc += totNum;

        const qtdFmt = qtdNum.toLocaleString("pt-BR");
        const unitFmt = unitNum.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const totFmt = totNum.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        return `
          <div class="cupom-row">
            <div>
              <button class="btn-editar-item" type="button" title="Editar item"
                onclick="cupomAcaoEditarItem(${idx}); event.stopPropagation();">
                ✎
              </button>
            </div>
            <div class="cupom-prod">${produto}</div>
            <div class="cupom-num">${escapeHtml(qtdFmt)}</div>
            <div class="cupom-num">R$ ${escapeHtml(unitFmt)}</div>
            <div class="cupom-num">R$ ${escapeHtml(totFmt)}</div>
          </div>
        `;
      }).join("");

      itensEl.innerHTML = linhas || `<div style="font-size:12px;">Nenhum item encontrado para este documento.</div>`;

      totaisEl.innerHTML = `
        <div>Total de itens:</div>
        <div>${(d.itens || []).length}</div>
      `;

      const totalFmt = totalDoc.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      totaisEl.innerHTML += `
        <div style="margin-left:auto;">Total do doc:</div>
        <div>R$ ${escapeHtml(totalFmt)}</div>
      `;

      const obsTxt = String(d.relatorio || "").trim() || "-";
      obsEl.textContent = `Observação: ${obsTxt}`;

      imgWrap.innerHTML = "";
      const img = String(d.imageUrl || "").trim();
      if (img) {
        const safeImg = escapeHtml(img);
        imgWrap.innerHTML = `
          <img src="${safeImg}" alt="Imagem" onclick="cupomAcaoAbrirImagem('${safeImg}')" />
          <button class="link-abrir-imagem" type="button" onclick="cupomAcaoAbrirImagem('${safeImg}')">Abrir imagem</button>
        `;
      }

      document.getElementById("modalCupom").style.display = "flex";
    }

    function fecharModalCupom(limparSelecao = true) {
      document.getElementById("modalCupom").style.display = "none";
      if (limparSelecao) documentoSelecionado = null;
    }

    function abrirImagemEmNovaGuia(url) {
      if (!url) return;
      window.open(url, "_blank", "noopener,noreferrer");
    }

    function cupomAcaoFechar() { fecharModalCupom(); }
    function cupomAcaoEditarObs() { fecharModalCupom(false); abrirModalEditarObs(); }
    function cupomAcaoExcluirDocumento() { fecharModalCupom(false); abrirModalExcluirDocumento(); }
    function cupomAcaoEditarItem(indexItem) { fecharModalCupom(false); abrirModalEditarItem(indexItem); }
    function cupomAcaoAbrirImagem(url) { fecharModalCupom(false); abrirImagemEmNovaGuia(url); }

    function abrirModalEditarObs() {
      if (!documentoSelecionado) return;
      document.getElementById("editObsTexto").value = String(documentoSelecionado.relatorio || "");
      document.getElementById("modalEditarObs").style.display = "flex";
    }

    function fecharModalEditarObs() {
      document.getElementById("modalEditarObs").style.display = "none";
    }

    async function salvarEdicaoObservacaoDocumento() {
      const statusEl = document.getElementById("status");
      if (!documentoSelecionado) {
        fecharModalEditarObs();
        return;
      }

      const novoRelatorio = document.getElementById("editObsTexto").value;
      const itens = Array.isArray(documentoSelecionado.itens) ? documentoSelecionado.itens : [];

      if (!itens.length) {
        fecharModalEditarObs();
        return;
      }

      iniciarProgresso("Salvando...");

      try {
        statusEl.textContent = "Salvando observação do documento...";

        for (const item of itens) {
          const payload = {
            registroOriginal: item,
            edicoes: {
              quantidade: (item.quantidade || "").toString(),
              valorUnitario: (item.valorUnitario || "").toString(),
              relatorio: novoRelatorio
            }
          };

          const resp = await fetch("/api/relatorios-editar", {
            method: "POST",
            headers: { "Content-Type": "application/json", ...getAuthHeaders() },
            credentials: "include",
            body: JSON.stringify(payload),
          });

          const dados = await resp.json().catch(() => ({}));
          if (!resp.ok || !dados.sucesso) {
            throw new Error(dados.message || "Erro ao editar registro.");
          }

          const atualizado = { ...item, relatorio: novoRelatorio };
          registrosBase = registrosBase.map((r) => (registrosIguais(r, item) ? atualizado : r));
        }

        statusEl.textContent = "Observação do documento atualizada com sucesso.";
        fecharModalEditarObs();

        const key = documentoSelecionado.key;
        aplicarFiltrosLocal();
        const idx = documentosAtuais.findIndex(d => d.key === key);
        if (idx >= 0) abrirCupom(idx);
        else fecharModalCupom();

      } catch (e) {
        console.error(e);
        statusEl.textContent = e.message || "Erro ao salvar observação do documento.";
      } finally {
        finalizarProgresso();
      }
    }

    function abrirModalEditarItem(indexItem) {
      if (!documentoSelecionado) return;

      const itens = Array.isArray(documentoSelecionado.itens) ? documentoSelecionado.itens : [];
      const item = itens[indexItem] || null;
      if (!item) return;

      itemSelecionado = item;
      itemSelecionadoIndex = indexItem;

      document.getElementById("editItemProduto").value = String(item.produto || "");
      document.getElementById("editItemQtd").value = String(item.quantidade ?? "");
      document.getElementById("editItemValorUnit").value = String(item.valorUnitario ?? "");

      document.getElementById("modalEditarItem").style.display = "flex";
    }

    function fecharModalEditarItem() {
      document.getElementById("modalEditarItem").style.display = "none";
      itemSelecionado = null;
      itemSelecionadoIndex = -1;
    }

    async function salvarEdicaoItem() {
      const statusEl = document.getElementById("status");
      if (!itemSelecionado) return;

      const ok = confirm("Você tem certeza que deseja salvar a edição?");
      if (!ok) return;

      const novaQtd = document.getElementById("editItemQtd").value;
      const novoValorUnit = document.getElementById("editItemValorUnit").value;

      iniciarProgresso("Salvando...");

      try {
        statusEl.textContent = "Salvando edição do item...";

        const payload = {
          registroOriginal: itemSelecionado,
          edicoes: {
            relatorio: (itemSelecionado.relatorio || "").toString(),
            quantidade: (novaQtd ?? "").toString(),
            valorUnitario: (novoValorUnit ?? "").toString()
          }
        };

        const resp = await fetch("/api/relatorios-editar", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...getAuthHeaders() },
          credentials: "include",
          body: JSON.stringify(payload),
        });

        const dados = await resp.json().catch(() => ({}));
        if (!resp.ok || !dados.sucesso) {
          throw new Error(dados.message || "Erro ao editar registro.");
        }

        const atualizado = { ...itemSelecionado, quantidade: novaQtd, valorUnitario: novoValorUnit };
        registrosBase = registrosBase.map((r) => (registrosIguais(r, itemSelecionado) ? atualizado : r));

        statusEl.textContent = "Item editado com sucesso.";
        fecharModalEditarItem();

        const key = documentoSelecionado?.key;
        aplicarFiltrosLocal();
        const idx = documentosAtuais.findIndex(d => d.key === key);
        if (idx >= 0) abrirCupom(idx);
        else fecharModalCupom();

      } catch (e) {
        console.error(e);
        statusEl.textContent = e.message || "Erro ao salvar edição do item.";
      } finally {
        finalizarProgresso();
      }
    }

    async function eliminarItem() {
      const statusEl = document.getElementById("status");
      if (!itemSelecionado) return;

      const ok = confirm("Você tem certeza que deseja eliminar definitivamente o registro?");
      if (!ok) return;

      try {
        statusEl.textContent = "Eliminando registro...";

        const resp = await fetch("/api/relatorios-excluir", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...getAuthHeaders() },
          credentials: "include",
          body: JSON.stringify({ registro: itemSelecionado }),
        });

        const dados = await resp.json().catch(() => ({}));
        if (!resp.ok || !dados.sucesso) {
          throw new Error(dados.message || "Erro ao excluir registro.");
        }

        registrosBase = registrosBase.filter((r) => !registrosIguais(r, itemSelecionado));

        statusEl.textContent = "Registro eliminado com sucesso.";
        fecharModalEditarItem();

        const key = documentoSelecionado?.key;
        aplicarFiltrosLocal();
        const idx = documentosAtuais.findIndex(d => d.key === key);
        if (idx >= 0) abrirCupom(idx);
        else fecharModalCupom();

      } catch (e) {
        console.error(e);
        statusEl.textContent = e.message || "Erro ao eliminar registro.";
      }
    }

    function abrirModalExcluirDocumento() {
      if (!documentoSelecionado) return;
      document.getElementById("modalExcluirDocumento").style.display = "flex";
    }

    function fecharModalExcluirDocumento() {
      document.getElementById("modalExcluirDocumento").style.display = "none";
    }

    async function confirmarExclusaoDocumento() {
      const statusEl = document.getElementById("status");

      if (!documentoSelecionado) {
        fecharModalExcluirDocumento();
        return;
      }

      const itens = Array.isArray(documentoSelecionado.itens) ? documentoSelecionado.itens : [];
      if (!itens.length) {
        fecharModalExcluirDocumento();
        return;
      }

      try {
        statusEl.textContent = "Excluindo documento...";

        for (const item of itens) {
          const payload = { registro: item };

          const resp = await fetch("/api/relatorios-excluir", {
            method: "POST",
            headers: { "Content-Type": "application/json", ...getAuthHeaders() },
            credentials: "include",
            body: JSON.stringify(payload),
          });

          const dados = await resp.json().catch(() => ({}));
          if (!resp.ok || !dados.sucesso) {
            throw new Error(dados.message || "Erro ao excluir registro.");
          }

          registrosBase = registrosBase.filter((r) => !registrosIguais(r, item));
        }

        statusEl.textContent = "Documento excluído com sucesso.";

        fecharModalExcluirDocumento();
        fecharModalCupom();
        aplicarFiltrosLocal();
      } catch (e) {
        console.error(e);
        statusEl.textContent = e.message || "Erro ao excluir documento.";
        fecharModalExcluirDocumento();
      }
    }

    function registrosIguais(a, b) {
      const idA = a.idRegistro || a.ID_REGISTRO || a.id;
      const idB = b.idRegistro || b.ID_REGISTRO || b.id;

      if (idA && idB) return idA === idB;

      return (
        (a.dataHora || "") === (b.dataHora || "") &&
        (a.loja || "") === (b.loja || "") &&
        (a.usuario || "") === (b.usuario || "") &&
        (a.ean || "") === (b.ean || "") &&
        (a.codConsinco || "") === (b.codConsinco || "") &&
        (a.produto || "") === (b.produto || "") &&
        (a.departamento || "") === (b.departamento || "") &&
        (a.secao || "") === (b.secao || "") &&
        (a.grupo || "") === (b.grupo || "") &&
        (a.subgrupo || "") === (b.subgrupo || "") &&
        (a.categoria || "") === (b.categoria || "") &&
        (a.relatorio || "") === (b.relatorio || "") &&
        (a.quantidade || "") === (b.quantidade || "") &&
        (a.valorUnitario || "") === (b.valorUnitario || "") &&
        (a.documento || "") === (b.documento || "")
      );
    }

    function exportarParaXlsx(registros) {
      const cabecalho = [
        "Loja",
        "Usuário",
        "EAN",
        "Cod Consinco",
        "Produto",
        "Departamento",
        "Seção",
        "Grupo",
        "Subgrupo",
        "Categoria",
        "Relatório / Observação",
        "Quantidade",
        "Valor unitário",
        "Valor total (Qtd x Unit)",
        "Documento",
        "Data ocorrido",
        "Hora ocorrido"
      ];

      const linhas = registros.map((r) => {
        const qtdNum = parseNumeroBr(r.quantidade);
        const vUnitNum = parseNumeroBr(r.valorUnitario);
        const totalNum = qtdNum * vUnitNum;

        return [
          r.loja || "",
          r.usuario || "",
          r.ean || "",
          r.codConsinco || "",
          r.produto || "",
          r.departamento || "",
          r.secao || "",
          r.grupo || "",
          r.subgrupo || "",
          r.categoria || "",
          r.relatorio || "",
          qtdNum,
          vUnitNum,
          totalNum || 0,
          r.documento || "",
          r.dataOcorrido || "",
          r.horaOcorrido || ""
        ];
      });

      const dados = [cabecalho, ...linhas];

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(dados);

      const range = XLSX.utils.decode_range(ws["!ref"]);

      for (let R = 1; R <= range.e.r; R++) {
        const cellQtd  = ws[XLSX.utils.encode_cell({ r: R, c: 11 })];
        const cellUnit = ws[XLSX.utils.encode_cell({ r: R, c: 12 })];
        const cellTot  = ws[XLSX.utils.encode_cell({ r: R, c: 13 })];

        if (cellQtd && typeof cellQtd.v === "number")  cellQtd.z  = "#,##0";
        if (cellUnit && typeof cellUnit.v === "number") cellUnit.z = '"R$" #,##0.00';
        if (cellTot && typeof cellTot.v === "number")  cellTot.z  = '"R$" #,##0.00';
      }

      XLSX.utils.book_append_sheet(wb, ws, "Relatorios PPP");
      XLSX.writeFile(wb, "relatorios_ppp.xlsx");
    }
  </script>
</body>
</html>

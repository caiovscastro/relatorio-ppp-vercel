<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Gestor – Relatórios PPP</title>

  <style>
    /* =========================
       ESTILO GERAL / LAYOUT
       ========================= */
    body {
      background: #f3f3f3;
      font-family: Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      width: 95%;
      max-width: 1100px;
      background: #ffffff;
      padding: 24px 28px 28px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
    }

    .cabecalho {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      border-bottom: 1px solid #e1e1e1;
      padding-bottom: 10px;
      margin-bottom: 14px;
    }

    .titulo {
      margin: 0;
      font-size: 22px;
    }

    /* =========================
       CARTÕES DE RESUMO (TOP)
       ========================= */
    .cards-resumo {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0 16px;
    }

    .card-resumo {
      flex: 1;
      min-width: 180px;
      background: #f7f8ff;
      border-radius: 10px;
      padding: 10px 14px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.10);
      font-size: 13px;
    }

    .card-resumo-titulo {
      font-size: 12px;
      color: #555;
      margin-bottom: 4px;
    }

    .card-resumo-valor {
      font-size: 18px;
      font-weight: 700;
      color: #0044aa;
    }

    /* =========================
       BLOCO DE FILTROS
       ========================= */
    .bloco-filtros {
      margin-bottom: 16px;
      padding: 14px 18px;
      border-radius: 10px;
      background: #f7f8ff;
      border: 1px solid #e0e3ff;
    }

    .bloco-filtros h3 {
      margin: 0 0 10px;
      font-size: 16px;
    }

    /* Grid de filtros:
       - 3 colunas em telas médias/grandes
       - quebra automático em telas menores */
    .filtros-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px 10px;
    }

    @media (max-width: 720px) {
      .filtros-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 520px) {
      .filtros-grid {
        grid-template-columns: 1fr;
      }
    }

    .campo-filtro {
      display: flex;
      flex-direction: column;
      font-size: 13px;
    }

    .campo-filtro label {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .campo-filtro input,
    .campo-filtro select {
      border-radius: 6px;
      border: 1px solid #c3c3c3;
      padding: 6px 8px;
      font-size: 13px;
      box-sizing: border-box;
      background: #fff;
      width: 100%;
    }

    .botoes-filtro {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
    }

    .btn {
      padding: 7px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
    }

    .btn-aplicar {
      background: #0066ff;
      color: #fff;
    }

    .btn-limpar {
      background: #e0e0e0;
      color: #333;
    }

    /* =========================
       STATUS / LISTA DE CARTÕES
       ========================= */
    .status {
      font-size: 13px;
      margin-bottom: 8px;
      text-align: left;
      color: #333;
    }

    .lista-cartoes {
      max-height: 60vh;
      overflow-y: auto;
    }

    .cartao {
      background: #fff;
      border-radius: 10px;
      /* sombra um pouco mais forte, como você pediu */
      box-shadow: 0 5px 14px rgba(0, 0, 0, 0.16);
      padding: 12px 14px;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .cartao-linha {
      margin: 2px 0;
    }

    .cartao-linha strong {
      font-weight: 600;
    }

    .cartao-topo {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
      border-bottom: 1px dashed #ddd;
      padding-bottom: 4px;
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: #f0f0ff;
      color: #333;
      margin-left: 4px;
    }

    /* Quebra de linha do texto da observação
       (mantém \n do texto vindo da planilha) */
    .cartao-linha.obs-texto {
      white-space: pre-line;
    }

    /* Rodapé com botão voltar + resumo */
    .rodape {
      margin-top: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      flex-wrap: wrap;
      gap: 6px;
    }

    .btn-voltar {
      padding: 6px 10px;
      background: #0066ff;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      font-size: 12px;
      font-weight: 600;
    }

    /* =========================
       TELA DE ERRO (ACESSO DIRETO)
       ========================= */
    .tela-erro {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #f3f3f3;
      font-family: Arial, sans-serif;
    }

    .card-erro {
      background: #fff;
      padding: 26px 30px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      max-width: 420px;
      text-align: center;
    }

    .card-erro h1 {
      color: #c00000;
      margin-top: 0;
    }
  </style>
</head>
<body>
  <!-- Tela de erro se acessar painel sem passar pelo login-gestor -->
  <div id="erroAcesso" class="tela-erro" style="display:none;">
    <div class="card-erro">
      <h1>Acesso inválido</h1>
      <p>Parâmetros do login do gestor não encontrados.</p>
      <p>Volte para a tela inicial e realize o login novamente.</p>
      <a href="/index.html" class="btn-voltar">Voltar</a>
    </div>
  </div>

  <!-- Conteúdo principal -->
  <div id="appRoot" class="container" style="display:none;">
    <div class="cabecalho">
      <h1 class="titulo">Painel Gestor – Relatórios PPP</h1>
    </div>

    <!-- Cartões de resumo: quantidade total e valor total do filtro atual -->
    <div class="cards-resumo">
      <div class="card-resumo">
        <div class="card-resumo-titulo">Quantidade total registrada (filtro atual)</div>
        <div class="card-resumo-valor" id="cardQtdTotal">0</div>
      </div>
      <div class="card-resumo">
        <div class="card-resumo-titulo">Valor total (Quantidade × Valor) – filtro atual</div>
        <div class="card-resumo-valor" id="cardValorTotal">R$ 0,00</div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="bloco-filtros">
      <h3>Filtros</h3>
      <div class="filtros-grid">
        <!-- Linha 1: Loja / Usuário / Departamento -->
        <div class="campo-filtro">
          <label for="filtroLoja">Loja (texto)</label>
          <input id="filtroLoja" type="text" placeholder="Ex.: ULT 01" />
        </div>

        <div class="campo-filtro">
          <label for="filtroUsuario">Usuário</label>
          <input id="filtroUsuario" type="text" placeholder="Login / nome" />
        </div>

        <div class="campo-filtro">
          <label for="filtroDepartamento">Departamento</label>
          <select id="filtroDepartamento">
            <option value="">Todos</option>
            <option value="MERCEARIA">MERCEARIA</option>
            <option value="PERECIVEIS">PERECIVEIS</option>
            <option value="HIGIENE E LIMPEZA">HIGIENE E LIMPEZA</option>
            <option value="BAZAR">BAZAR</option>
            <option value="DESPESAS">DESPESAS</option>
            <option value="GASTRONOMIA">GASTRONOMIA</option>
          </select>
        </div>

        <!-- Linha 2: Nº Documento / Data início / Data fim -->
        <div class="campo-filtro">
          <label for="filtroDocumento">Nº Documento</label>
          <input id="filtroDocumento" type="text" placeholder="Número exato" />
        </div>

        <div class="campo-filtro">
          <label for="dataInicio">Data início</label>
          <input id="dataInicio" type="date" />
        </div>

        <div class="campo-filtro">
          <label for="dataFim">Data fim</label>
          <input id="dataFim" type="date" />
        </div>
      </div>

      <div class="botoes-filtro">
        <button class="btn btn-limpar" onclick="limparFiltros()">Limpar filtros</button>
        <button class="btn btn-aplicar" onclick="carregarRelatorios()">Aplicar filtros</button>
      </div>
    </div>

    <!-- Status + lista de cartões -->
    <div class="status" id="status">Carregando relatórios...</div>

    <div class="lista-cartoes" id="listaCartoes"></div>

    <div class="rodape">
      <a href="/index.html" class="btn-voltar">Voltar à tela inicial</a>
      <span id="resumoQtd"></span>
    </div>
  </div>

  <script>
    let usuarioLogado = null;

    /* ==============================
       FUNÇÕES AUXILIARES NUMÉRICAS
       ============================== */

    // Converte "1.234,56" para 1234.56 (number)
    function parseNumeroBR(valor) {
      if (!valor) return 0;
      if (typeof valor === "number") return valor;

      const limpo = String(valor).trim().replace(/\./g, "").replace(",", ".");
      const n = Number(limpo);
      return isNaN(n) ? 0 : n;
    }

    // Formata número como moeda BR "R$ 1.234,56"
    function formatarMoedaBR(valor) {
      const n = parseNumeroBR(valor);
      return n.toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL",
        minimumFractionDigits: 2
      });
    }

    /* ==============================
       CONTROLE DE ACESSO BÁSICO
       ============================== */

    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const usuario = params.get("usuario");

      // Se não vier parâmetro de usuário, bloqueia acesso
      if (!usuario) {
        document.getElementById("erroAcesso").style.display = "flex";
        return;
      }

      usuarioLogado = usuario;

      // Exibe o app
      document.getElementById("appRoot").style.display = "block";

      // Carrega relatórios iniciais (sem filtro)
      carregarRelatorios();
    });

    /* ==============================
       CARREGAMENTO / FILTROS
       ============================== */

    async function carregarRelatorios() {
      const statusEl = document.getElementById("status");
      const listaEl = document.getElementById("listaCartoes");
      const resumoQtd = document.getElementById("resumoQtd");
      const cardQtdTotal = document.getElementById("cardQtdTotal");
      const cardValorTotal = document.getElementById("cardValorTotal");

      statusEl.textContent = "Carregando relatórios...";
      listaEl.innerHTML = "";
      resumoQtd.textContent = "";
      cardQtdTotal.textContent = "0";
      cardValorTotal.textContent = "R$ 0,00";

      // Lê filtros da tela
      const loja = document.getElementById("filtroLoja").value.trim();
      const usuario = document.getElementById("filtroUsuario").value.trim();
      const documento = document.getElementById("filtroDocumento").value.trim();
      const departamento = document.getElementById("filtroDepartamento").value;
      const dataInicio = document.getElementById("dataInicio").value;
      const dataFim = document.getElementById("dataFim").value;

      // Monta query string
      const params = new URLSearchParams();

      if (loja) params.append("loja", loja);
      if (usuario) params.append("usuario", usuario);
      if (documento) params.append("documento", documento);
      if (departamento) params.append("departamento", departamento);
      if (dataInicio) params.append("dataInicio", dataInicio);
      if (dataFim) params.append("dataFim", dataFim);

      const url =
        "/api/relatorios" + (params.toString() ? `?${params.toString()}` : "");

      try {
        const resp = await fetch(url);
        const dados = await resp.json();

        if (!resp.ok || !dados.sucesso) {
          statusEl.textContent =
            dados.message || "Erro ao carregar relatórios.";
          return;
        }

        const registros = Array.isArray(dados.registros)
          ? dados.registros
          : [];

        if (!registros.length) {
          statusEl.textContent =
            "Nenhum registro encontrado com os filtros atuais.";
          resumoQtd.textContent = "";
          listaEl.innerHTML = "";
          return;
        }

        // Calcula somatórios (quantidade total e valor total)
        let somaQtd = 0;
        let somaValorTotal = 0;

        registros.forEach((r) => {
          const qtd = parseNumeroBR(r.quantidade);
          const valorUnit = parseNumeroBR(r.valorUnitario);
          somaQtd += qtd;
          somaValorTotal += qtd * valorUnit;
        });

        // Atualiza textos de resumo / cartões de topo
        statusEl.textContent = `${registros.length} registro(s) encontrado(s).`;
        resumoQtd.textContent = `Quantidade total: ${somaQtd} | Valor total: ${formatarMoedaBR(
          somaValorTotal
        )}`;
        cardQtdTotal.textContent = somaQtd;
        cardValorTotal.textContent = formatarMoedaBR(somaValorTotal);

        // Renderiza cartões
        listaEl.innerHTML = registros
          .map((r) => {
            return `
              <div class="cartao">
                <div class="cartao-topo">
                  <div>
                    <div class="cartao-linha">
                      <strong>Data/Hora:</strong> ${r.dataHora || "-"}
                    </div>
                    <div class="cartao-linha">
                      <strong>Loja:</strong> ${r.loja || "-"}
                    </div>
                  </div>
                  <div>
                    <div class="cartao-linha">
                      <strong>Usuário:</strong> ${r.usuario || "-"}
                    </div>
                    <div class="cartao-linha">
                      <strong>Documento:</strong> ${r.documento || "-"}
                    </div>
                  </div>
                </div>

                <div class="cartao-linha">
                  <strong>EAN:</strong> ${r.ean || "-"}
                </div>

                <div class="cartao-linha">
                  <strong>Produto:</strong> ${r.produto || "-"}
                </div>

                <div class="cartao-linha">
                  <strong>Departamento:</strong> ${r.departamento || "-"}
                  <span class="tag">${r.secao || ""}</span>
                </div>

                <div class="cartao-linha">
                  <strong>Quantidade:</strong> ${r.quantidade || "-"}
                  &nbsp;&nbsp;|&nbsp;&nbsp;
                  <strong>Valor unitário (R$):</strong> ${r.valorUnitario || "-"}
                </div>

                <div class="cartao-linha">
                  <strong>Relatório / Observação:</strong>
                </div>
                <div class="cartao-linha obs-texto">
                  ${r.relatorio || "-"}
                </div>
              </div>
            `;
          })
          .join("");
      } catch (erro) {
        console.error("Erro ao carregar relatórios:", erro);
        statusEl.textContent = "Erro de conexão ao buscar relatórios.";
      }
    }

    /* ==============================
       LIMPAR FILTROS
       ============================== */

    function limparFiltros() {
      document.getElementById("filtroLoja").value = "";
      document.getElementById("filtroUsuario").value = "";
      document.getElementById("filtroDocumento").value = "";
      document.getElementById("filtroDepartamento").value = "";
      document.getElementById("dataInicio").value = "";
      document.getElementById("dataFim").value = "";

      carregarRelatorios();
    }
  </script>
</body>
</html>

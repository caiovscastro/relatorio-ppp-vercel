<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel PPP</title>
<link rel="icon" type="image/png" href="/LogoBigUltra.png">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#030712">

  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    body {
      background: #f3f3f3;
      font-family: Arial, sans-serif;
      margin: 2;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container {
      width: 95%;
      max-width: 900px;
      background: #ffffff;
      padding: 24px 28px 30px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
    }

    .cabecalho {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 10px;
      border-bottom: 1px solid #e1e1e1;
      padding-bottom: 14px;
      margin-bottom: 16px;
    }

    .titulo {
      margin: 0;
      font-size: 22px;
    }

    .subtitulo {
      margin: 4px 0 0;
      font-size: 14px;
      color: #555;
    }

    .info-usuario {
      text-align: right;
      font-size: 10px;
    }

    .info-usuario strong {
      display: block;
    }

    .conteudo {
      margin-top: 12px;
      font-size: 14px;
    }

    .bloco {
      margin-bottom: 16px;
      padding: 14px;
      border-radius: 8px;
      background: #f7f8ff;
      border: 1px solid #e0e3ff;
    }

    .bloco h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .btn-voltar {
      display: inline-block;
      padding: 8px 14px;
      background: #0066ff;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      text-align: center;
      user-select: none;
    }

    .btn-voltar:hover {
      background: #0050cc;
    }

    .tela-erro {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #f3f3f3;
      font-family: Arial, sans-serif;
    }

    .card-erro {
      background: #fff;
      padding: 26px 30px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      max-width: 420px;
      text-align: center;
    }

    .card-erro h1 {
      color: #c00000;
      margin-top: 0;
    }

    .search-container {
      width: 100%;
      position: relative;
      margin-top: 8px;
      margin-bottom: 12px;
    }

    #campoBusca {
      width: 100%;
      padding: 14px 48px 14px 56px;
      font-size: 14px;
      border: 1px solid #c3c3c3;
      border-radius: 999px;
      outline: none;
      background: white;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      box-sizing: border-box;
    }

    #campoBusca:focus {
      border-color: #0066ff;
      box-shadow: 0 0 0 1px #0066ff33;
    }

    .btnBarcodeLeft {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: 26px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-barcode-small {
      width: 100%;
      height: 100%;
      border-radius: 4px;
      background:
        repeating-linear-gradient(
          90deg,
          #333 0px,
          #333 2px,
          #fff 2px,
          #fff 4px
        );
    }

    .btnBuscarIcone {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .linha-infos {
      width: 100%;
      display: flex;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 8px;
      flex-wrap: nowrap;
    }

    .campo-inline {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .campo-inline label {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .input-inline {
      width: 100%;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1px solid #c3c3c3;
      padding: 8px 10px;
      font-size: 14px;
      background: #fff;
    }

    .input-readonly {
      background: #f3f3f3;
      cursor: not-allowed;
    }

    .linha-botoes {
      width: 100%;
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .linha-botoes .btn-voltar,
    .linha-botoes .btn-nova-ocorrencia {
      flex: 1 1 0;
    }

    .btn-nova-ocorrencia {
      white-space: nowrap;
      border: none;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      background: #4caf50;
      color: #fff;
    }

    .btn-nova-ocorrencia:hover {
      background: #3d8f41;
    }

    .btn-nova-ocorrencia:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    #status {
      font-size: 13px;
      margin-top: 4px;
      text-align: center;
      color: #333;
    }

    #resultado {
      margin-top: 8px;
    }

    .cartao {
      width: 90%;
      background: white;
      padding: 14px 16px;
      margin: 10px auto;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      cursor: pointer;
      opacity: 0;
      transform: translateY(8px);
      animation: entrarCartao 0.22s ease-out forwards;
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out;
    }

    .cartao:hover {
      transform: translateY(2px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.14);
    }

    .cartao-linha {
      display: grid;
      grid-template-columns: 34% 66%;
      align-items: center;
      font-size: 13px;
      padding: 4px 0;
      border-bottom: 1px solid #e4e4e4;
      column-gap: 6px;
    }

    .cartao-linha:last-child {
      border-bottom: none;
    }

    .cartao-linha-label {
      font-weight: 700;
      color: #111;
      white-space: nowrap;
    }

    .cartao-linha-valor {
      color: #111;
      word-break: break-word;
    }

    .cartao-linha-produto {
      background: #f5f5f5;
      font-weight: 700;
    }

    .produto-guardado {
      color: #1b5e20 !important;
      font-weight: 800;
    }

    @keyframes entrarCartao {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    #cameraArea {
      margin-top: 12px;
      display: none;
      width: 100%;
    }

    #cameraArea video {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-top: 6px;
      background: white;
    }

    .btnFechar {
      width: 100%;
      max-width: 280px;
      padding: 8px 10px;
      font-size: 13px;
      border: none;
      border-radius: 8px;
      cursor: button;
      margin-top: 8px;
      background: #777;
      color: white;
    }

    #overlayCarregando {
      position: fixed;
      inset: 0;
      background: #f3f3f3;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loader {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 6px solid #ddd;
      border-top-color: #0066ff;
      animation: girar 0.9s linear infinite;
      margin-bottom: 10px;
    }

    @keyframes girar {
      to { transform: rotate(360deg); }
    }

    .texto-carregando {
      font-size: 16px;
      text-align: center;
      color: #333;
      margin-bottom: 4px;
    }

    #percentualCarregando {
      font-size: 18px;
      font-weight: bold;
      color: #0066ff;
    }

    .overlay-popup {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .confirm-box {
      background: #fff;
      padding: 18px 16px;
      border-radius: 10px;
      max-width: 360px;
      width: 90%;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
      text-align: center;
      font-size: 14px;
    }

    .confirm-box p {
      margin-bottom: 12px;
    }

    .confirm-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btnConfirmar,
    .btnCancelar {
      flex: 1 1 0;
      padding: 8px 6px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      min-width: 120px;
    }

    .btnConfirmar {
      background: #4caf50;
      color: #fff;
    }

    .btnCancelar {
      background: #e0e0e0;
      color: #333;
    }

    .finalizar-textarea {
      width: 100%;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1px solid #c3c3c3;
      padding: 10px 12px;
      font-size: 14px;
      resize: vertical;
      min-height: 90px;
      background: #fff;
      margin-bottom: 10px;
      text-align: left;
    }

    .finalizar-erro {
      font-size: 12px;
      color: #c00000;
      margin: 6px 0 10px;
      display: none;
      text-align: left;
    }

    .finalizar-foto {
      width: 100%;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1px solid #c3c3c3;
      padding: 10px 12px;
      font-size: 13px;
      background: #fff;
      margin-bottom: 10px;
      text-align: left;
    }

    .finalizar-foto small {
      display: block;
      margin-top: 6px;
      color: #555;
      font-size: 12px;
      line-height: 1.35;
    }

    .finalizar-foto .foto-status {
      margin-top: 6px;
      font-size: 12px;
      color: #333;
      word-break: break-word;
    }

    .btn-iniciar-ocorrencia {
      width: 100%;
      border: none;
      border-radius: 10px;
      padding: 14px 12px;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
      background: #0066ff;
      color: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .btn-iniciar-ocorrencia:hover {
      background: #0050cc;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 600px) {
      .linha-infos { gap: 8px; }
      .input-inline { font-size: 13px; }
    }

    .input-file-hidden {
      position: absolute;
      left: -9999px;
      width: 1px;
      height: 1px;
      opacity: 0;
    }

    .btn-abrir-camera {
      display: inline-block;
      width: 100%;
      box-sizing: border-box;
      text-align: center;
      border: none;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      background: #0066ff;
      color: #fff;
      user-select: none;
    }

    .btn-abrir-camera:hover {
      background: #0050cc;
    }

    #fotoOcorrencia:disabled + .btn-abrir-camera {
      opacity: 0.55;
      cursor: not-allowed;
      pointer-events: none;
    }

    .finalizar-dtrow{
      display:flex;
      gap:10px;
      margin-bottom: 10px;
    }

    .finalizar-dtcol{
      flex: 1 1 0;
      display:flex;
      flex-direction: column;
      gap:6px;
      min-width: 0;
      text-align: left;
    }

    .finalizar-dtcol label{
      font-weight: 700;
      font-size: 13px;
      color:#111;
    }

    .finalizar-dtinput{
      width:100%;
      box-sizing:border-box;
      border-radius: 8px;
      border: 1px solid #c3c3c3;
      padding: 10px 12px;
      font-size: 14px;
      background:#fff;
      outline:none;
    }
  </style>
</head>

<body>
  <div id="erroAcesso" class="tela-erro" style="display: none;">
    <div class="card-erro">
      <h1>Acesso inv√°lido</h1>
      <p id="erroAcessoMsg">Sess√£o expirada ou inexistente.</p>
      <p>Volte para a tela de acesso e realize o login novamente.</p>
      <a href="/login.html" class="btn-voltar">Voltar para o Login</a>
    </div>
  </div>

  <div id="overlayCarregando">
    <div class="loader"></div>
    <div class="texto-carregando" id="textoCarregando">Carregando base de produtos...</div>
    <div id="percentualCarregando">0%</div>
  </div>

  <div id="overlayProdutoDuplicado" class="overlay-popup">
    <div class="confirm-box">
      <p>Este produto j√° est√° na ocorr√™ncia.</p>
      <div class="confirm-buttons">
        <button class="btnConfirmar" onclick="fecharPopupProdutoDuplicado()">OK</button>
      </div>
    </div>
  </div>
  <div id="confirmOverlayAdicionar" class="overlay-popup">
    <div class="confirm-box">
      <p>Deseja adicionar este produto na ocorr√™ncia atual?</p>
      <div class="confirm-buttons">
        <button class="btnConfirmar" onclick="confirmarAdicionarProduto(true)">Sim</button>
        <button class="btnCancelar" onclick="confirmarAdicionarProduto(false)">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="overlayOcorrenciaPendente" class="overlay-popup" style="z-index:10002;">
    <div class="confirm-box">
      <p>Ocorr√™ncia ainda n√£o finalizada, deseja finalizar ou continuar registrando?</p>
      <div class="confirm-buttons">
        <button class="btnCancelar" onclick="resolverOcorrenciaPendente('continuar')">Continuar registrando</button>
        <button class="btnConfirmar" onclick="resolverOcorrenciaPendente('finalizar')">Finalizar ocorr√™ncia</button>
      </div>
    </div>
  </div>

  <div id="overlaySairConfirm" class="overlay-popup" style="z-index:10003;">
    <div class="confirm-box">
      <p>Deseja mesmo voltar para o menu?</p>
      <div class="confirm-buttons">
        <button class="btnConfirmar" onclick="confirmarSair(true)">Sim</button>
        <button class="btnCancelar" onclick="confirmarSair(false)">N√£o</button>
      </div>
    </div>
  </div>
  <div id="overlaySairPendente" class="overlay-popup" style="z-index:10004;">
    <div class="confirm-box">
      <p>Ocorr√™ncia pendente de finaliza√ß√£o</p>
      <div class="confirm-buttons">
        <button class="btnCancelar" onclick="acaoSairPendente('continuar')">Continuar registros</button>
        <button class="btnConfirmar" onclick="acaoSairPendente('finalizar')">Finalizar ocorr√™ncia</button>
        <button class="btnCancelar" onclick="acaoSairPendente('descartar')" style="background:#ffdddd;color:#900;">
          Descartar ocorr√™ncia
        </button>
      </div>
    </div>
  </div>
  <div id="overlayFinalizar" class="overlay-popup" style="z-index:10005;">
    <div class="confirm-box">
      <textarea id="finalizarRelatorio" class="finalizar-textarea" placeholder="Relat√≥rio (obrigat√≥rio)"></textarea>
      <div class="finalizar-dtrow" aria-label="Data e Hora do ocorrido (obrigat√≥rios)">
        <div class="finalizar-dtcol">
          <label for="dataOcorrido">Data do ocorrido (obrigat√≥rio):</label>
          <input id="dataOcorrido" class="finalizar-dtinput" type="date" />
        </div>
        <div class="finalizar-dtcol">
          <label for="horaOcorrido">Hora do ocorrido (obrigat√≥rio):</label>
          <input id="horaOcorrido" class="finalizar-dtinput" type="time" />
        </div>
      </div>
      <div class="finalizar-dtcol" style="margin-bottom:10px;">
        <label for="tipoAbordagem" style="font-weight:700; font-size:13px; color:#111;">
          Tipo de abordagem (obrigat√≥rio):
        </label>
        <select id="tipoAbordagem" class="finalizar-dtinput">
          <option value="Nenhum">Nenhum</option>
          <option value="Reativa">Reativa</option>
          <option value="Preventiva">Preventiva</option>
        </select>
      </div>
      <div class="finalizar-foto">
        <label for="fotoOcorrencia" style="font-weight:700; display:block; margin-bottom:6px;">
          Foto (opcional):
        </label>
        <input id="fotoOcorrencia" class="input-file-hidden" type="file" accept="image/*" capture="environment" />
        <label for="fotoOcorrencia" class="btn-abrir-camera">Abrir c√¢meraüì∏</label>
        <small>√â possivel enviar apenas uma imagem por ocorr√™ncia.</small>
        <div id="fotoStatus" class="foto-status"></div>
      </div>
      <div id="finalizarErro" class="finalizar-erro">Preencha o relat√≥rio para finalizar.</div>
      <p>Deseja msm Enviar a ocorr√™ncia?</p>
      <div class="confirm-buttons">
        <button class="btnConfirmar" onclick="confirmarFinalizarOcorrencia(true)">Sim</button>
        <button class="btnCancelar" onclick="confirmarFinalizarOcorrencia(false)">N√£o</button>
      </div>
    </div>
  </div>
  <div id="appRoot" class="container" style="display: none;">
    <div class="cabecalho">
      <div>
        <h1 class="titulo">PAINEL PPP</h1>
        <p class="subtitulo"></p>
      </div>
      <div class="info-usuario">
        <strong>Usu√°rio: <span id="usuarioSpan"></span></strong>
        <span>Loja: <span id="lojaSpan"></span></span>
      </div>
    </div>
    <div class="conteudo">
      <div id="blocoIniciar" class="bloco">
        <button id="btnIniciarOcorrencia" class="btn-iniciar-ocorrencia" type="button" onclick="iniciarOcorrencia()">
          Iniciar ocorr√™ncia
        </button>
        <div id="statusIniciar" style="text-align:center; font-size:13px; margin-top:10px; color:#333;"></div>
      </div>
      <div id="blocoOperacao" class="bloco hidden">
        <h3>Campo de pesquisa</h3>
        <div class="search-container">
          <button type="button" class="btnBarcodeLeft" onclick="abrirCamera()" aria-label="Ler c√≥digo de barras com a c√¢mera">
            <span class="icon-barcode-small"></span>
          </button>
          <input
            id="campoBusca"
            type="text"
            placeholder="Pesquisar produto"
            onkeydown="if(event.key === 'Enter'){buscar();}"
          />

          <button type="button" class="btnBuscarIcone" onclick="buscar()" aria-label="Buscar produto">
            <svg width="22" height="22" viewBox="0 0 24 24"
                 fill="none" stroke="#444" stroke-width="2.2"
                 stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="7"></circle>
              <line x1="16.65" y1="16.65" x2="21" y2="21"></line>
            </svg>
          </button>
        </div>
        <div class="linha-infos">
          <div class="campo-inline">
            <label for="quantidade">Qtd:</label>
            <input
              id="quantidade"
              class="input-inline"
              type="text"
              inputmode="decimal"
              placeholder="Qtd"
              oninput="this.value = this.value.replace(/[^0-9,]/g, '');"
            />
          </div>
          <div class="campo-inline">
            <label for="valorUnitario">Valor Un. R$:</label>
            <input
              id="valorUnitario"
              class="input-inline"
              type="text"
              inputmode="decimal"
              placeholder="0,00"
              oninput="mascaraValorUnitario(this)"
            />
          </div>
          <div class="campo-inline">
            <label for="numeroDocumento">Doc:</label>
            <input
              id="numeroDocumento"
              class="input-inline input-readonly"
              type="text"
              placeholder="Gerado automaticamente"
              readonly
              aria-readonly="true"
            />
          </div>
        </div>
        <div class="linha-botoes">
          <button id="btnFinalizar" type="button" class="btn-nova-ocorrencia" onclick="finalizarOcorrencia()" disabled>
            Finalizar ocorr√™ncia
          </button>

          <button type="button" class="btn-voltar" onclick="solicitarSair()">
            Sair
          </button>
        </div>
        <div id="status"></div>
        <div id="cameraArea">
          <p style="font-size: 13px;">Aponte para o c√≥digo de barras:</p>
          <video id="video" autoplay playsinline></video>
          <p id="msgCamera" style="font-size: 12px;"></p>
          <button class="btnFechar" onclick="fecharCamera()">Fechar c√¢mera</button>
        </div>
      </div>
      <div id="resultado" class="hidden"></div>
    </div>
  </div>
<script>

  let dbProdutos = [];
  let baseCarregada = false;
  let lojaLogada = null;
  let usuarioLogado = null;
  let ultimosResultados = [];
  let produtoPendente = null;

  let percentual = 0;
  let timerPercent = null;
  let modoOverlay = "base";
  let envioEmAndamento = false;
  let streamAtual = null;
  let lendo = false;

  const STORAGE_OCORRENCIA_ATIVA = "PPP_OCORRENCIA_ATIVA";
  const STORAGE_DOC_ATUAL        = "PPP_DOC_ATUAL";
  const STORAGE_ITENS_OCORRENCIA = "PPP_ITENS_OCORRENCIA";
  const STORAGE_IMG_URL          = "PPP_IMG_URL";
  let ocorrenciaAtiva = false;
  let docAtual = "";
  let itensOcorrencia = [];
  let sessaoAtual = null;
  let timerExpiracao = null;
  let timerRevalidacao = null;

  async function fetchAuth(url, options = {}) {
    const opt = {
      method: options.method || "GET",
      headers: { ...(options.headers || {}) },
      body: options.body,
      credentials: "include",
      cache: "no-store"
    };

    if (opt.body && !opt.headers["Content-Type"]) {
      opt.headers["Content-Type"] = "application/json";
    }

    if (!opt.headers["Accept"]) opt.headers["Accept"] = "application/json";

    const resp = await fetch(url, opt);

    if (resp.status === 401 || resp.status === 403) {
      await mostrarTelaSessaoInvalida("Sua sess√£o expirou ou voc√™ n√£o tem permiss√£o. Fa√ßa login novamente.");
      throw new Error("Sess√£o inv√°lida (401/403).");
    }

    return resp;
  }

  async function obterSessaoDoBackend() {
    try {
      const resp = await fetchAuth("/api/session", { method: "GET" });
      if (!resp.ok) return null;

      const dados = await resp.json().catch(() => null);
      if (!dados || !dados.sucesso || !dados.usuario || !dados.loja) return null;

      return dados;
    } catch (e) {
      console.error("Falha ao validar sess√£o via /api/session:", e);
      return null;
    }
  }

  function limparTimersSessao() {
    if (timerExpiracao) { clearTimeout(timerExpiracao); timerExpiracao = null; }
    if (timerRevalidacao) { clearInterval(timerRevalidacao); timerRevalidacao = null; }
  }

  function agendarExpiracaoSessao(sessao) {
    limparTimersSessao();

    const expSec = Number(sessao?.exp || 0);
    const agoraMs = Date.now();

    if (expSec > 0) {
      const expMs = expSec * 1000;
      const msRestantes = expMs - agoraMs;

      if (msRestantes <= 0) {
        mostrarTelaSessaoInvalida("Sess√£o expirada. Fa√ßa login novamente.");
        return;
      }

      timerExpiracao = setTimeout(() => {
        mostrarTelaSessaoInvalida("Sess√£o expirada. Fa√ßa login novamente.");
      }, msRestantes + 500);
    }

    timerRevalidacao = setInterval(async () => {
      const s = await obterSessaoDoBackend();
      if (!s) {
        mostrarTelaSessaoInvalida("Sess√£o inv√°lida ou encerrada. Fa√ßa login novamente.");
      }
    }, 120000);
  }

  async function mostrarTelaSessaoInvalida(mensagem) {
    try {
      limparTimersSessao();

      const overlays = [
        "overlayCarregando",
        "overlayProdutoDuplicado",
        "confirmOverlayAdicionar",
        "overlayOcorrenciaPendente",
        "overlaySairConfirm",
        "overlaySairPendente",
        "overlayFinalizar"
      ];
      overlays.forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.style.display = "none";
      });

      const msg = document.getElementById("erroAcessoMsg");
      if (msg) msg.textContent = mensagem || "Sess√£o expirada ou inexistente.";

      const app = document.getElementById("appRoot");
      if (app) app.style.display = "none";

      document.getElementById("erroAcesso").style.display = "flex";
    } catch (e) {}
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const sessao = await obterSessaoDoBackend();

    if (!sessao) {
      document.getElementById("erroAcesso").style.display = "flex";
      return;
    }

    sessaoAtual = sessao;
    agendarExpiracaoSessao(sessaoAtual);

    usuarioLogado = sessao.usuario;
    lojaLogada    = sessao.loja;

    document.getElementById("usuarioSpan").textContent = usuarioLogado;
    document.getElementById("lojaSpan").textContent    = lojaLogada;

    document.getElementById("appRoot").style.display = "block";

    const inputFoto = document.getElementById("fotoOcorrencia");
    if (inputFoto) {
      inputFoto.addEventListener("change", () => {
        const fotoStatus = document.getElementById("fotoStatus");
        const file = inputFoto.files && inputFoto.files[0] ? inputFoto.files[0] : null;

        if (!file) {
          if (fotoStatus) fotoStatus.textContent = "";
          return;
        }

        const urlJaEnviada = (localStorage.getItem(STORAGE_IMG_URL) || "").trim();
        if (urlJaEnviada) {
          if (fotoStatus) fotoStatus.textContent = "Uma imagem j√° foi anexada nesta ocorr√™ncia.";
          inputFoto.value = "";
          return;
        }

        if (fotoStatus) fotoStatus.textContent = `Arquivo selecionado: ${file.name}`;
      });
    }

    carregarBase();
  });

  function aplicarModoTela() {
    const blocoIniciar = document.getElementById("blocoIniciar");
    const blocoOperacao = document.getElementById("blocoOperacao");
    const resultado = document.getElementById("resultado");

    if (!baseCarregada) {
      document.getElementById("btnIniciarOcorrencia").disabled = true;
      document.getElementById("statusIniciar").textContent = "Carregando base de produtos...";
      blocoIniciar.classList.remove("hidden");
      blocoOperacao.classList.add("hidden");
      resultado.classList.add("hidden");
      return;
    }

    document.getElementById("btnIniciarOcorrencia").disabled = false;
    document.getElementById("statusIniciar").textContent = "Base carregada. Inicie uma ocorr√™ncia para registrar itens.";

    if (ocorrenciaAtiva) {
      blocoIniciar.classList.add("hidden");
      blocoOperacao.classList.remove("hidden");
      resultado.classList.remove("hidden");
    } else {
      blocoIniciar.classList.remove("hidden");
      blocoOperacao.classList.add("hidden");
      resultado.classList.add("hidden");
      document.getElementById("resultado").innerHTML = "";
      ultimosResultados = [];
    }

    setarDocumentoNoInput(docAtual);
    atualizarBotaoFinalizar();
  }

  function atualizarBotaoFinalizar() {
    const btn = document.getElementById("btnFinalizar");
    if (!btn) return;
    const temItens = Array.isArray(itensOcorrencia) && itensOcorrencia.length > 0;
    btn.disabled = !temItens;
  }

  function salvarEstadoOcorrencia() {
    try {
      localStorage.setItem(STORAGE_OCORRENCIA_ATIVA, ocorrenciaAtiva ? "1" : "");
      localStorage.setItem(STORAGE_DOC_ATUAL, String(docAtual || ""));
      localStorage.setItem(STORAGE_ITENS_OCORRENCIA, JSON.stringify(itensOcorrencia || []));
    } catch (e) {
      console.warn("Falha ao persistir ocorr√™ncia:", e);
    }
  }

  function carregarEstadoOcorrencia() {
    try {
      const ativa = (localStorage.getItem(STORAGE_OCORRENCIA_ATIVA) || "").trim() === "1";
      const doc = (localStorage.getItem(STORAGE_DOC_ATUAL) || "").trim();
      const itensRaw = localStorage.getItem(STORAGE_ITENS_OCORRENCIA);

      let itens = [];
      if (itensRaw) {
        try { itens = JSON.parse(itensRaw) || []; } catch(e) { itens = []; }
      }

      ocorrenciaAtiva = ativa && !!doc;
      docAtual = doc || "";
      itensOcorrencia = Array.isArray(itens) ? itens : [];
    } catch (e) {
      ocorrenciaAtiva = false;
      docAtual = "";
      itensOcorrencia = [];
    }
  }

  function limparEstadoOcorrencia() {
    ocorrenciaAtiva = false;
    docAtual = "";
    itensOcorrencia = [];

    try { localStorage.removeItem(STORAGE_IMG_URL); } catch (e) {}

    salvarEstadoOcorrencia();
  }

  function descartarOcorrencia() {
    try {
      localStorage.removeItem(STORAGE_OCORRENCIA_ATIVA);
      localStorage.removeItem(STORAGE_DOC_ATUAL);
      localStorage.removeItem(STORAGE_ITENS_OCORRENCIA);
      localStorage.removeItem(STORAGE_IMG_URL);
    } catch (e) {}
    ocorrenciaAtiva = false;
    docAtual = "";
    itensOcorrencia = [];
  }

  function iniciarOverlayPercentual({ mensagem, modo }) {
    const overlay = document.getElementById("overlayCarregando");
    const txtPerc = document.getElementById("percentualCarregando");
    const txtMsg = document.getElementById("textoCarregando");

    modoOverlay = modo || "base";

    if (txtMsg) txtMsg.textContent = mensagem || "Carregando...";
    overlay.style.display = "flex";

    percentual = 0;
    txtPerc.textContent = "0%";

    if (timerPercent) clearInterval(timerPercent);

    timerPercent = setInterval(() => {
      if (percentual < 95) {
        percentual += 5;
        txtPerc.textContent = percentual + "%";
      }
    }, 120);
  }

  function finalizarOverlayPercentual() {
    const overlay = document.getElementById("overlayCarregando");
    const txtPerc = document.getElementById("percentualCarregando");

    if (timerPercent) clearInterval(timerPercent);

    percentual = 100;
    txtPerc.textContent = "100%";

    setTimeout(() => {
      overlay.style.display = "none";
    }, 300);
  }

  function mascaraValorUnitario(campo) {
    let v = campo.value.replace(/\D/g, "");

    if (!v) {
      campo.value = "";
      return;
    }

    v = v.replace(/^0+/, "");
    if (!v) v = "0";

    while (v.length < 3) {
      v = "0" + v;
    }

    const inteiro = v.slice(0, -2);
    const centavos = v.slice(-2);
    const inteiroFormatado = inteiro.replace(/\B(?=(\d{3})+(?!\d))/g, ".");

    campo.value = inteiroFormatado + "," + centavos;
  }

  async function carregarBase() {
    const statusIniciar = document.getElementById("statusIniciar");
    iniciarOverlayPercentual({ mensagem: "Carregando base de produtos...", modo: "base" });

    try {
      statusIniciar.textContent = "Carregando base de produtos...";

      const resp = await fetchAuth("/api/produtos", { method: "GET" });
      const dados = await resp.json();

      if (!resp.ok || !dados.sucesso || !Array.isArray(dados.produtos)) {
        console.error("Resposta inesperada da API /api/produtos:", dados);
        throw new Error(dados.message || "Falha ao carregar produtos.");
      }

      dbProdutos = dados.produtos;
      baseCarregada = true;

      finalizarOverlayPercentual();

      carregarEstadoOcorrencia();

      const temItensGuardados = Array.isArray(itensOcorrencia) && itensOcorrencia.length > 0;
      if (temItensGuardados) {
        document.getElementById("overlayOcorrenciaPendente").style.display = "flex";
      }

      aplicarModoTela();
    } catch (err) {
      console.error("Erro ao carregar base:", err);
      baseCarregada = false;
      finalizarOverlayPercentual();
      statusIniciar.textContent = "Erro ao carregar base de produtos.";
      aplicarModoTela();
    }
  }

  function resolverOcorrenciaPendente(acao) {
    document.getElementById("overlayOcorrenciaPendente").style.display = "none";

    if (acao === "continuar") {
      if (!ocorrenciaAtiva) {
        docAtual = docAtual || gerarNumeroDocumento();
        ocorrenciaAtiva = true;
        salvarEstadoOcorrencia();
      }
      aplicarModoTela();
      return;
    }

    if (acao === "finalizar") {
      if (!itensOcorrencia.length) {
        limparEstadoOcorrencia();
        aplicarModoTela();
        return;
      }
      finalizarOcorrencia();
    }
  }

  function iniciarOcorrencia() {
    const status = document.getElementById("status");
    if (!baseCarregada) return;

    docAtual = gerarNumeroDocumento();
    ocorrenciaAtiva = true;

    itensOcorrencia = [];
    try { localStorage.removeItem(STORAGE_IMG_URL); } catch (e) {}

    salvarEstadoOcorrencia();

    setarDocumentoNoInput(docAtual);
    atualizarBotaoFinalizar();
    if (status) status.textContent = "Ocorr√™ncia iniciada. Pesquise e selecione produtos para registrar itens.";
    aplicarModoTela();
  }

  function finalizarOcorrencia() {
    const status = document.getElementById("status");

    if (!ocorrenciaAtiva) {
      aplicarModoTela();
      return;
    }

    if (!itensOcorrencia.length) {
      if (status) status.textContent = "N√£o h√° itens guardados para lan√ßar.";
      atualizarBotaoFinalizar();
      return;
    }

    abrirPopupFinalizar();
  }

  function abrirPopupFinalizar() {
    document.getElementById("finalizarRelatorio").value = "";
    document.getElementById("finalizarErro").style.display = "none";

    const dataEl = document.getElementById("dataOcorrido");
    const horaEl = document.getElementById("horaOcorrido");
    if (dataEl) dataEl.value = "";
    if (horaEl) horaEl.value = "";

    const tipoEl = document.getElementById("tipoAbordagem");
    if (tipoEl) tipoEl.value = "Nenhum";

    const fotoStatus = document.getElementById("fotoStatus");
    if (fotoStatus) fotoStatus.textContent = "";

    const urlJaEnviada = (localStorage.getItem(STORAGE_IMG_URL) || "").trim();
    const inputFoto = document.getElementById("fotoOcorrencia");

    if (inputFoto) {
      inputFoto.value = "";
      inputFoto.disabled = !!urlJaEnviada;
    }

    if (urlJaEnviada && fotoStatus) {
      fotoStatus.textContent = "Uma imagem j√° foi anexada nesta ocorr√™ncia.";
    }

    document.getElementById("overlayFinalizar").style.display = "flex";
  }

  async function confirmarFinalizarOcorrencia(confirmado) {
    const overlay = document.getElementById("overlayFinalizar");
    const erroEl = document.getElementById("finalizarErro");
    const status = document.getElementById("status");

    if (!confirmado) {
      overlay.style.display = "none";
      return;
    }

    if (envioEmAndamento) return;

    const rel = document.getElementById("finalizarRelatorio").value.trim();
    const dataOcorrido = (document.getElementById("dataOcorrido")?.value || "").trim();
    const horaOcorrido = (document.getElementById("horaOcorrido")?.value || "").trim();
    const tipoAbordagem = (document.getElementById("tipoAbordagem")?.value || "Nenhum").trim();
    const tipoValido = (tipoAbordagem === "Reativa" || tipoAbordagem === "Preventiva");

    if (!rel || !dataOcorrido || !horaOcorrido || !tipoValido) {
      if (erroEl) {
        if (!rel && (!dataOcorrido || !horaOcorrido) && !tipoValido) {
          erroEl.textContent = "Preencha o relat√≥rio, selecione a data, a hora do ocorrido e escolha o Tipo de abordagem (Reativa ou Preventiva) para finalizar.";
        } else if (!rel && !tipoValido) {
          erroEl.textContent = "Preencha o relat√≥rio e escolha o Tipo de abordagem (Reativa ou Preventiva) para finalizar.";
        } else if ((!dataOcorrido || !horaOcorrido) && !tipoValido) {
          erroEl.textContent = "Selecione a data, a hora do ocorrido e escolha o Tipo de abordagem (Reativa ou Preventiva) para finalizar.";
        } else if (!tipoValido) {
          erroEl.textContent = "Escolha o Tipo de abordagem (Reativa ou Preventiva) para finalizar.";
        } else if (!rel && (!dataOcorrido || !horaOcorrido)) {
          erroEl.textContent = "Preencha o relat√≥rio e selecione a data e a hora do ocorrido para finalizar.";
        } else if (!rel) {
          erroEl.textContent = "Preencha o relat√≥rio para finalizar.";
        } else {
          erroEl.textContent = "Selecione a data e a hora do ocorrido para finalizar.";
        }
        erroEl.style.display = "block";
      }
      return;
    }

    erroEl.style.display = "none";
    overlay.style.display = "none";

    envioEmAndamento = true;
    iniciarOverlayPercentual({ mensagem: "Enviando ocorr√™ncia...", modo: "envio" });

    let imagemUrl = (localStorage.getItem(STORAGE_IMG_URL) || "").trim();

    try {
      const file = document.getElementById("fotoOcorrencia")?.files?.[0] || null;

      if (file && !imagemUrl) {
        if (status) status.textContent = "Enviando foto (opcional)...";
        imagemUrl = await enviarFotoParaDriveRetornarUrl(file);
        localStorage.setItem(STORAGE_IMG_URL, imagemUrl);
      }
    } catch (e) {
      console.error("Falha ao enviar foto:", e);
      // Foto √© opcional
    }
    await enviarLoteFinalizacao(rel, imagemUrl, dataOcorrido, horaOcorrido, tipoAbordagem);
  }

  function comprimirImagemParaBase64(file, opts = {}) {
    const {
      maxWidth = 1280,
      maxHeight = 1280,
      quality = 0.78,
      outputMime = "image/jpeg",
    } = opts;

    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error("Falha ao ler arquivo da foto."));
      reader.onload = () => {
        const img = new Image();
        img.onerror = () => reject(new Error("Falha ao carregar imagem para compress√£o."));
        img.onload = () => {
          let { width, height } = img;

          const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
          width = Math.round(width * ratio);
          height = Math.round(height * ratio);

          const canvas = document.createElement("canvas");
          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);

          const dataUrl = canvas.toDataURL(outputMime, quality);
          const base64 = dataUrl.split(",")[1] || "";

          const safeName = (file.name || "foto.jpg").replace(/[^\w.\-]+/g, "_");
          resolve({ base64, mimeType: outputMime, filename: safeName });
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });
  }

  async function enviarFotoParaDriveRetornarUrl(file) {
    const fotoStatus = document.getElementById("fotoStatus");
    const status = document.getElementById("status");

    if (fotoStatus) fotoStatus.textContent = "Enviando foto...";

    const { base64, mimeType, filename } = await comprimirImagemParaBase64(file);

    const payload = {
      base64,
      mimeType,
      filename,
      doc: docAtual || ""
    };

    const resp = await fetchAuth("/api/upload-imagem", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const dados = await resp.json().catch(() => ({}));
    console.log("[PPP] Resposta /api/upload-imagem:", { httpOk: resp.ok, dados });

    if (!resp.ok || !dados.sucesso || !dados.imageUrl) {
      const msg = dados.message || "Falha ao enviar imagem.";
      if (fotoStatus) fotoStatus.textContent = msg;
      if (status) status.textContent = msg;
      throw new Error(msg);
    }

    if (fotoStatus) {
      const fileId = dados.fileId ? ` (ID: ${dados.fileId})` : "";
      fotoStatus.textContent = "Foto anexada com sucesso." + fileId;
    }

    if (status) {
      const fileId = dados.fileId || "";
      status.innerHTML = `Foto enviada. ID: <b>${fileId}</b>`;
    }

    return String(dados.imageUrl || "");
  }

  async function enviarLoteFinalizacao(relatorioTexto, imagemUrl, dataOcorrido, horaOcorrido, tipoAbordagem) {
    const status = document.getElementById("status");

    const lote = itensOcorrencia.map((item, idx) => ({
      produto: item.produto,
      loja: item.loja,
      usuario: item.usuario,
      observacao: (idx === itensOcorrencia.length - 1) ? relatorioTexto : "",
      imagemUrl: (idx === itensOcorrencia.length - 1) ? (imagemUrl || "") : "",
      quantidade: item.quantidade,
      valorUnitario: item.valorUnitario,
      numeroDocumento: item.numeroDocumento,
      dataOcorrido: dataOcorrido,
      horaOcorrido: horaOcorrido,
      tipoAbordagem: tipoAbordagem,
    }));

    try {
      if (status) status.textContent = "Finalizando ocorr√™ncia... enviando registros em lote.";

      const resp = await fetchAuth("/api/relatorio", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lote }),
      });

      const dados = await resp.json().catch(() => ({}));

      if (!resp.ok || !dados.sucesso) {
        if (status) status.textContent = dados.message || "Erro ao finalizar ocorr√™ncia.";
        return;
      }

      if (status) status.textContent = dados.message || "Ocorr√™ncia finalizada com sucesso.";

      document.getElementById("quantidade").value = "";
      document.getElementById("valorUnitario").value = "";
      document.getElementById("campoBusca").value = "";

      try {
        const inputFoto = document.getElementById("fotoOcorrencia");
        if (inputFoto) {
          inputFoto.value = "";
          inputFoto.disabled = false;
        }
        const fotoStatus = document.getElementById("fotoStatus");
        if (fotoStatus) fotoStatus.textContent = "";
      } catch (e) {}

      limparEstadoOcorrencia();
      aplicarModoTela();
    } catch (e) {
      console.error("Erro ao finalizar ocorr√™ncia:", e);
      if (status) status.textContent = "Erro de conex√£o ao finalizar ocorr√™ncia.";
    } finally {
      finalizarOverlayPercentual();
      envioEmAndamento = false;
    }
  }
  
  function buscar() {
    const campo      = document.getElementById("campoBusca");
    const termoBruto = campo.value.trim();
    const status     = document.getElementById("status");

    try {
      if (!ocorrenciaAtiva) {
        if (status) status.textContent = "Inicie uma ocorr√™ncia para buscar e registrar produtos.";
        return;
      }

      if (!termoBruto) {
        if (status) status.textContent = "Digite ou leia um c√≥digo para buscar.";
        return;
      }

      if (!baseCarregada) {
        if (status) status.textContent = "Aguarde a base terminar de carregar.";
        return;
      }

      const termo = termoBruto.toLowerCase();
      const resultados = dbProdutos.filter((linha) => {
        const ean      = String(linha[0] ?? "").toLowerCase();
        const consinco = String(linha[1] ?? "").toLowerCase();
        const produto  = String(linha[2] ?? "").toLowerCase();

        return (ean === termo || consinco === termo || produto.includes(termo));
      });

      mostrarResultados(resultados);

      if (status) status.textContent = `${resultados.length} produto(s) encontrado(s).`;
    } catch (err) {
      console.error("Erro na fun√ß√£o buscar:", err);
      if (status) status.textContent = "Erro ao realizar a busca.";
    }
  }

  function chaveProduto(linhaProduto) {
    const ean = String(linhaProduto?.[0] ?? "").trim();
    const cod = String(linhaProduto?.[1] ?? "").trim();
    return (ean + "||" + cod).toLowerCase();
  }

  function produtoJaNaOcorrencia(linhaProduto) {
    const chave = chaveProduto(linhaProduto);
    return itensOcorrencia.some((it) => chaveProduto(it.produto) === chave);
  }

  function mostrarResultados(lista) {
    const container = document.getElementById("resultado");
    ultimosResultados = Array.isArray(lista) ? lista : [];

    if (!ultimosResultados.length) {
      container.innerHTML =
        '<p style="font-size: 14px; text-align:center; margin-top: 12px;">Nenhum resultado encontrado.</p>';
      return;
    }

    const html = ultimosResultados
      .map((linha, idx) => {
        const guardado = produtoJaNaOcorrencia(linha);
        const classeProduto = guardado ? "produto-guardado" : "";

        return `
          <div class="cartao" onclick="selecionarProduto(${idx})">
            <div class="cartao-linha cartao-linha-produto">
              <span class="cartao-linha-label">Produto:</span>
              <span class="cartao-linha-valor ${classeProduto}">${linha[2] ?? ""}</span>
            </div>
            <div class="cartao-linha">
              <span class="cartao-linha-label">EAN:</span>
              <span class="cartao-linha-valor">${linha[0] ?? ""}</span>
            </div>
            <div class="cartao-linha">
              <span class="cartao-linha-label">C√≥d Consinco:</span>
              <span class="cartao-linha-valor">${linha[1] ?? ""}</span>
            </div>
            <div class="cartao-linha">
              <span class="cartao-linha-label">Departamento:</span>
              <span class="cartao-linha-valor">${linha[3] ?? ""}</span>
            </div>
            <div class="cartao-linha">
              <span class="cartao-linha-label">Se√ß√£o:</span>
              <span class="cartao-linha-valor">${linha[4] ?? ""}</span>
            </div>
            <div class="cartao-linha">
              <span class="cartao-linha-label">Grupo:</span>
              <span class="cartao-linha-valor">${linha[5] ?? ""}</span>
            </div>
            <div class="cartao-linha">
              <span class="cartao-linha-label">Subgrupo:</span>
              <span class="cartao-linha-valor">${linha[6] ?? ""}</span>
            </div>
            <div class="cartao-linha">
              <span class="cartao-linha-label">Categoria:</span>
              <span class="cartao-linha-valor">${linha[7] ?? ""}</span>
            </div>
          </div>
        `;
      })
      .join("");

    container.innerHTML = html;
  }

  function selecionarProduto(idx) {
    const status = document.getElementById("status");

    if (!ocorrenciaAtiva) {
      if (status) status.textContent = "Inicie uma ocorr√™ncia antes de registrar produtos.";
      return;
    }

    if (!ultimosResultados || !ultimosResultados[idx]) {
      if (status) status.textContent = "N√£o foi poss√≠vel identificar o produto selecionado.";
      return;
    }

    const linhaProduto = ultimosResultados[idx];

    if (produtoJaNaOcorrencia(linhaProduto)) {
      document.getElementById("overlayProdutoDuplicado").style.display = "flex";
      return;
    }

    const qtd = document.getElementById("quantidade").value.trim();
    const valor = document.getElementById("valorUnitario").value.trim();

    if (!qtd)   { if (status) status.textContent = "Preencha a quantidade antes de adicionar."; return; }
    if (!valor) { if (status) status.textContent = "Preencha o valor unit√°rio antes de adicionar."; return; }

    if (!docAtual) {
      if (status) status.textContent = "Documento n√£o foi gerado. Inicie uma ocorr√™ncia novamente.";
      return;
    }

    if (navigator.vibrate) navigator.vibrate(80);

    produtoPendente = {
      produto: linhaProduto,
      quantidade: qtd,
      valorUnitario: valor,
      numeroDocumento: docAtual,
      loja: lojaLogada,
      usuario: usuarioLogado,
    };

    document.getElementById("confirmOverlayAdicionar").style.display = "flex";
  }

  function confirmarAdicionarProduto(confirmado) {
    const overlay = document.getElementById("confirmOverlayAdicionar");
    const status = document.getElementById("status");

    overlay.style.display = "none";

    if (!confirmado) {
      produtoPendente = null;
      if (status) status.textContent = "Registro n√£o adicionado.";
      return;
    }

    if (!produtoPendente) return;

    itensOcorrencia.push(produtoPendente);
    produtoPendente = null;

    salvarEstadoOcorrencia();

    atualizarBotaoFinalizar();
    if (status) status.textContent = `Item adicionado na ocorr√™ncia. Total de itens: ${itensOcorrencia.length}.`;

    document.getElementById("quantidade").value = "";
    document.getElementById("valorUnitario").value = "";

    mostrarResultados(ultimosResultados);
  }

  function fecharPopupProdutoDuplicado() {
    document.getElementById("overlayProdutoDuplicado").style.display = "none";
  }

  function ultimos6(doc) {
    const s = String(doc || "");
    return s.length <= 6 ? s : s.slice(-6);
  }

  function setarDocumentoNoInput(doc) {
    const el = document.getElementById("numeroDocumento");
    if (!el) return;
    el.value = ultimos6(doc);
  }

  function nowSaoPaulo() {
    const agora = new Date();
    const dataSP = new Date(agora.toLocaleString("en-US", { timeZone: "America/Sao_Paulo" }));
    return dataSP;
  }

  function gerarPrefixoLoja(lojaStr) {
    const loja = String(lojaStr || "").trim().toUpperCase();

    let m = loja.match(/^ULT\s+(\d{1,2})\b/);
    if (m && m[1]) {
      const n = String(parseInt(m[1], 10));
      return "U" + n;
    }

    m = loja.match(/^BIG\s+(\d{1,2})\b/);
    if (m && m[1]) {
      const n = String(parseInt(m[1], 10));
      return "B" + n;
    }

    const primeira = loja ? loja[0] : "X";
    return primeira + "0";
  }

  function gerarPrefixoUsuario(usuarioStr) {
    const u = String(usuarioStr || "").trim().toLowerCase();
    const apenas = u.replace(/[^a-z0-9]/g, "");
    if (!apenas) return "xx";
    const first = apenas[0] || "x";
    const last = apenas[apenas.length - 1] || "x";
    return (first + last);
  }

  function pad2(n) { return String(n).padStart(2, "0"); }

  function gerarNumeroDocumento() {
    const dt = nowSaoPaulo();

    const dd = pad2(dt.getDate());
    const mm = pad2(dt.getMonth() + 1);
    const yy = String(dt.getFullYear()).slice(-2);

    const HH = pad2(dt.getHours());
    const MI = pad2(dt.getMinutes());
    const SS = pad2(dt.getSeconds());

    const prefixLoja = gerarPrefixoLoja(lojaLogada);
    const prefixUser = gerarPrefixoUsuario(usuarioLogado);

    return `${prefixLoja}${prefixUser}${dd}${mm}${yy}${HH}${MI}${SS}`;
  }

  function abrirCamera() {
    const area = document.getElementById("cameraArea");
    const msg = document.getElementById("msgCamera");
    const video = document.getElementById("video");

    area.style.display = "block";
    msg.textContent = "Abrindo c√¢mera...";

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      msg.textContent = "Este dispositivo ou navegador n√£o permite acesso √† c√¢mera neste contexto.";
      return;
    }

    navigator.mediaDevices
      .getUserMedia({ video: { facingMode: "environment" } })
      .then((stream) => {
        streamAtual = stream;
        video.srcObject = stream;
        video.play();
        msg.textContent = "Aponte para o c√≥digo de barras...";
        iniciarLeitura(video, msg);
      })
      .catch((err) => {
        msg.textContent = "Erro ao acessar c√¢mera: " + err.message;
      });
  }

  async function iniciarLeitura(video, msg) {
    if (!("BarcodeDetector" in window)) {
      msg.textContent = "Leitura autom√°tica n√£o suportada neste navegador. Digite o c√≥digo manualmente.";
      return;
    }

    const detector = new BarcodeDetector({ formats: ["ean_13", "ean_8", "code_128"] });
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    lendo = true;

    async function scan() {
      if (!lendo) return;

      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        try {
          const codes = await detector.detect(canvas);
          if (codes.length > 0) {
            const code = codes[0].rawValue;
            msg.textContent = "Detectado: " + code;
            document.getElementById("campoBusca").value = code;
            fecharCamera();
            buscar();
            return;
          }
        } catch (e) {}
      }

      requestAnimationFrame(scan);
    }

    scan();
  }

  function fecharCamera() {
    lendo = false;

    if (streamAtual) {
      streamAtual.getTracks().forEach((t) => t.stop());
    }

    document.getElementById("video").srcObject = null;
    document.getElementById("cameraArea").style.display = "none";
  }

  function solicitarSair() {
    document.getElementById("overlaySairConfirm").style.display = "flex";
  }

  function confirmarSair(confirmado) {
    document.getElementById("overlaySairConfirm").style.display = "none";
    if (!confirmado) return;

    const temPendente = Array.isArray(itensOcorrencia) && itensOcorrencia.length > 0;

    if (temPendente) {
      document.getElementById("overlaySairPendente").style.display = "flex";
      return;
    }

    sairDoApp();
  }

  function acaoSairPendente(acao) {
    document.getElementById("overlaySairPendente").style.display = "none";

    if (acao === "continuar") {
      aplicarModoTela();
      return;
    }

    if (acao === "finalizar") {
      finalizarOcorrencia();
      return;
    }

    if (acao === "descartar") {
      descartarOcorrencia();
      sairDoApp();
    }
  }

  function sairDoApp() {
    window.location.href = "/menu.html";
  }
</script>
</body>
</html>

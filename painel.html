<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel PPP</title>

  <style>
    /* ======== ESTILO GERAL DA PÁGINA ======== */
    body {
      background: #f3f3f3;
      font-family: Arial, sans-serif;
      margin: 2;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      /* Card centralizado horizontalmente e encostado no topo da tela */
      align-items: flex-start; /* antes: center */
    }

    /* Card principal do painel */
    .container {
      width: 95%;
      max-width: 900px;
      background: #ffffff;
      padding: 24px 28px 30px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
    }

    .cabecalho {
      display: flex;
      justify-content: space-between;
      align-items: flex-start; /* já ajustado antes para alinhar topo */
      flex-wrap: wrap;
      gap: 10px;
      border-bottom: 1px solid #e1e1e1;
      padding-bottom: 14px;
      margin-bottom: 16px;
    }

    .titulo {
      margin: 0;
      font-size: 22px;
    }

    .subtitulo {
      margin: 4px 0 0;
      font-size: 14px;
      color: #555;
    }

    /* Fonte do bloco Usuário/Loja ~30% menor */
    .info-usuario {
      text-align: right;
      font-size: 10px;  /* antes: 14px */
    }

    .info-usuario strong {
      display: block;
    }

    .conteudo {
      margin-top: 12px;
      font-size: 14px;
    }

    .bloco {
      margin-bottom: 16px;
      padding: 14px;
      border-radius: 8px;
      background: #f7f8ff;
      border: 1px solid #e0e3ff;
    }

    .bloco h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .btn-voltar {
      margin-top: 10px;
      display: inline-block;
      padding: 8px 14px;
      background: #0066ff;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      font-size: 14px;
      font-weight: 600;
    }

    .btn-voltar:hover {
      background: #0050cc;
    }

    /* Estilo da tela de acesso inválido */
    .tela-erro {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #f3f3f3;
      font-family: Arial, sans-serif;
    }

    .card-erro {
      background: #fff;
      padding: 26px 30px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      max-width: 420px;
      text-align: center;
    }

    .card-erro h1 {
      color: #c00000;
      margin-top: 0;
    }

    /* ======== BUSCA E CAMPOS ======== */

    .search-container {
      width: 100%;
      position: relative;
      margin-top: 8px;
      margin-bottom: 12px;
    }

    #campoBusca {
      width: 100%;
      padding: 14px 48px 14px 56px;
      font-size: 14px;
      border: 1px solid #c3c3c3;
      border-radius: 999px;
      outline: none;
      background: white;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      box-sizing: border-box;
    }

    #campoBusca:focus {
      border-color: #0066ff;
      box-shadow: 0 0 0 1px #0066ff33;
    }

    .btnBarcodeLeft {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: 26px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-barcode-small {
      width: 100%;
      height: 100%;
      border-radius: 4px;
      background:
        repeating-linear-gradient(
          90deg,
          #333 0px,
          #333 2px,
          #fff 2px,
          #fff 4px
        );
    }

    .btnBuscarIcone {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .obs-label {
      font-weight: 600;
      margin-top: 8px;
      margin-bottom: 4px;
    }

    .obs-textarea {
      width: 100%;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1px solid #c3c3c3;
      padding: 10px 12px;
      font-size: 14px;
      resize: vertical;
      min-height: 80px;
      background: #fff;
    }

    .linha-infos {
      width: 100%;
      display: flex;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .campo-inline {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .campo-inline label {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .input-inline {
      width: 100%;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1px solid #c3c3c3;
      padding: 8px 10px;
      font-size: 14px;
      background: #fff;
    }

    /* ===================== NOVO (Documento + botão na mesma linha) ===================== */
    .doc-row {
      display: flex;
      gap: 8px;
      align-items: center;
      width: 100%;
    }

    .btn-nova-ocorrencia {
      white-space: nowrap;
      border: none;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      background: #4caf50;
      color: #fff;
    }

    .btn-nova-ocorrencia:hover {
      background: #3d8f41;
    }

    /* Campo documento não editável com aparência sutil */
    .input-readonly {
      background: #f3f3f3;
      cursor: not-allowed;
    }
    /* ================================================================================ */

    #status {
      font-size: 13px;
      margin-top: 4px;
      text-align: center;
      color: #333;
    }

    /* ======== RESULTADOS EM CARTÕES ======== */

    #resultado {
      margin-top: 8px;
    }

    .cartao {
      width: 90%;
      background: white;
      padding: 14px 16px;
      margin: 10px auto;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      cursor: pointer;
      opacity: 0;
      transform: translateY(8px);
      animation: entrarCartao 0.22s ease-out forwards;
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out;
    }

    .cartao:hover {
      transform: translateY(2px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.14);
    }

    .cartao p {
      margin: 4px 0;
      font-size: 13px;
      line-height: 1.4;
    }

    .cartao strong {
      font-size: 13px;
      color: #111;
    }

    .cartao-linha {
      display: grid;
      grid-template-columns: 34% 66%;
      align-items: center;
      font-size: 13px;
      padding: 4px 0;
      border-bottom: 1px solid #e4e4e4;
      column-gap: 6px;
    }

    .cartao-linha:last-child {
      border-bottom: none;
    }

    .cartao-linha-label {
      font-weight: 700;
      color: #111;
      white-space: nowrap;
    }

    .cartao-linha-valor {
      color: #111;
      word-break: break-word;
    }

    .cartao-linha-produto {
      background: #f5f5f5;
      font-weight: 700;
    }

    @keyframes entrarCartao {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ======== CÂMERA ======== */

    #cameraArea {
      margin-top: 12px;
      display: none;
      width: 100%;
    }

    #cameraArea video {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-top: 6px;
      background: white;
    }

    .btnFechar {
      width: 100%;
      max-width: 280px;
      padding: 8px 10px;
      font-size: 13px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 8px;
      background: #777;
      color: white;
    }

    /* ======== OVERLAY DE CARREGAMENTO ======== */

    #overlayCarregando {
      position: fixed;
      inset: 0;
      background: #f3f3f3;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loader {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 6px solid #ddd;
      border-top-color: #0066ff;
      animation: girar 0.9s linear infinite;
      margin-bottom: 10px;
    }

    @keyframes girar {
      to { transform: rotate(360deg); }
    }

    .texto-carregando {
      font-size: 16px;
      text-align: center;
      color: #333;
      margin-bottom: 4px;
    }

    #percentualCarregando {
      font-size: 18px;
      font-weight: bold;
      color: #0066ff;
    }

    /* ======== POPUP CONFIRMAÇÃO ======== */

    #confirmOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .confirm-box {
      background: #fff;
      padding: 18px 16px;
      border-radius: 10px;
      max-width: 360px;
      width: 90%;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
      text-align: center;
      font-size: 14px;
    }

    .confirm-box p {
      margin-bottom: 12px;
    }

    .confirm-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .btnConfirmar,
    .btnCancelar {
      flex: 1;
      padding: 8px 6px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }

    .btnConfirmar {
      background: #4caf50;
      color: #fff;
    }

    .btnCancelar {
      background: #e0e0e0;
      color: #333;
    }

    /* ===================== NOVO (Popup "Nova ocorrência") ===================== */
    #confirmOverlayNovaOcorrencia {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10001; /* acima do outro overlay */
    }
    /* ======================================================================== */
  </style>
</head>

<body>
  <!-- TELA DE ERRO QUANDO NÃO VIER USUÁRIO/LOJA NA URL -->
  <div id="erroAcesso" class="tela-erro" style="display: none;">
    <div class="card-erro">
      <h1>Acesso inválido</h1>
      <p>Parâmetros do login não encontrados.</p>
      <p>Volte para a tela de acesso e realize o login novamente.</p>
      <a href="/login.html" class="btn-voltar">Voltar para o Login</a>
    </div>
  </div>

  <!-- OVERLAY DE CARREGAMENTO DA BASE (0→100%) -->
  <div id="overlayCarregando">
    <div class="loader"></div>
    <div class="texto-carregando">Carregando base de produtos...</div>
    <div id="percentualCarregando">0%</div>
  </div>

  <!-- POPUP DE CONFIRMAÇÃO DE ENVIO -->
  <div id="confirmOverlay">
    <div class="confirm-box">
      <p>Você deseja mesmo enviar o Relatório?</p>
      <div class="confirm-buttons">
        <button class="btnConfirmar" onclick="confirmarEnvio(true)">Sim</button>
        <button class="btnCancelar" onclick="confirmarEnvio(false)">Cancelar envio</button>
      </div>
    </div>
  </div>

  <!-- ===================== NOVO: POPUP CONFIRMAÇÃO "NOVA OCORRÊNCIA" ===================== -->
  <div id="confirmOverlayNovaOcorrencia">
    <div class="confirm-box">
      <p>Você realmente quer lançar uma nova ocorrência?</p>
      <div class="confirm-buttons">
        <button class="btnConfirmar" onclick="confirmarNovaOcorrencia(true)">Sim</button>
        <button class="btnCancelar" onclick="confirmarNovaOcorrencia(false)">Não</button>
      </div>
    </div>
  </div>
  <!-- ================================================================================ -->

  <!-- CONTEÚDO PRINCIPAL DO PAINEL -->
  <div id="appRoot" class="container" style="display: none;">
    <div class="cabecalho">
      <div>
        <h1 class="titulo">PAINEL PPP</h1>
        <p class="subtitulo"></p>
      </div>
      <div class="info-usuario">
        <strong>Usuário: <span id="usuarioSpan"></span></strong>
        <span>Loja: <span id="lojaSpan"></span></span>
      </div>
    </div>

    <div class="conteudo">
      <div class="bloco">
        <h3>Campo de pesquisa</h3>

        <!-- Campo de busca -->
        <div class="search-container">
          <button
            type="button"
            class="btnBarcodeLeft"
            onclick="abrirCamera()"
            aria-label="Ler código de barras com a câmera"
          >
            <span class="icon-barcode-small"></span>
          </button>

          <input
            id="campoBusca"
            type="text"
            placeholder="Pesquisar produto"
            onkeydown="if(event.key === 'Enter'){buscar();}"
          />

          <button
            type="button"
            class="btnBuscarIcone"
            onclick="buscar()"
            aria-label="Buscar produto"
          >
            <svg width="22" height="22" viewBox="0 0 24 24"
                 fill="none" stroke="#444" stroke-width="2.2"
                 stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="7"></circle>
              <line x1="16.65" y1="16.65" x2="21" y2="21"></line>
            </svg>
          </button>
        </div>

        <!-- Relatório / Observação -->
        <div class="obs-label">Relatório / Observação:</div>
        <textarea
          id="observacao"
          class="obs-textarea"
          placeholder="Digite aqui a observação..."
        ></textarea>

        <!-- Quantidade | Valor Unitário | Nº Documento -->
        <div class="linha-infos">
          <div class="campo-inline">
            <label for="quantidade">Quantidade:</label>
            <input
              id="quantidade"
              class="input-inline"
              type="text"
              inputmode="decimal"
              placeholder="Qtd"
              oninput="this.value = this.value.replace(/[^0-9,]/g, '');"
            />
          </div>

          <div class="campo-inline">
            <label for="valorUnitario">Valor Un. R$:</label>
            <input
              id="valorUnitario"
              class="input-inline"
              type="text"
              inputmode="decimal"
              placeholder="0,00"
              oninput="mascaraValorUnitario(this)"
            />
          </div>

          <div class="campo-inline">
            <label for="numeroDocumento">Nº de Doc:</label>

            <!-- ===================== NOVO: input readonly + botão "Nova ocorrência" ===================== -->
            <div class="doc-row">
              <input
                id="numeroDocumento"
                class="input-inline input-readonly"
                type="text"
                placeholder="Gerado automaticamente"
                readonly
                aria-readonly="true"
              />
              <button
                type="button"
                class="btn-nova-ocorrencia"
                onclick="abrirModalNovaOcorrencia()"
              >
                Nova ocorrência
              </button>
            </div>
            <!-- ======================================================================================= -->
          </div>
        </div>

        <div id="status"></div>

        <!-- Área da câmera -->
        <div id="cameraArea">
          <p style="font-size: 13px;">Aponte para o código de barras:</p>
          <video id="video" autoplay playsinline></video>
          <p id="msgCamera" style="font-size: 12px;"></p>
          <button class="btnFechar" onclick="fecharCamera()">Fechar câmera</button>
        </div>
      </div>

      <!-- Resultados da busca -->
      <div id="resultado"></div>

      <!-- Botão para voltar a tela inicial -->
      <a href="/index.html" class="btn-voltar" onclick="limparSessao()">Sair</a>
    </div>
  </div>

  <script>
    let dbProdutos = [];
    let baseCarregada = false;
    let lojaLogada = null;
    let usuarioLogado = null;
    let ultimosResultados = [];
    let envioPendente = null;

    let percentual = 0;
    let timerPercent = null;

    let streamAtual = null;
    let lendo = false;

    document.addEventListener("DOMContentLoaded", () => {
      let sessao = null;

      try {
        const raw = localStorage.getItem("pppSession");
        if (raw) {
          sessao = JSON.parse(raw);
        }
      } catch (e) {
        console.error("Erro ao ler sessão do localStorage:", e);
      }

      if (!sessao || !sessao.usuario || !sessao.loja) {
        document.getElementById("erroAcesso").style.display = "flex";
        return;
      }

      usuarioLogado = sessao.usuario;
      lojaLogada    = sessao.loja;

      document.getElementById("usuarioSpan").textContent = usuarioLogado;
      document.getElementById("lojaSpan").textContent    = lojaLogada;

      document.getElementById("appRoot").style.display = "block";

      /* ===================== NOVO: gera Nº de Doc automaticamente no login =====================
         Formato solicitado:
           U4gs131225181337
           - U4  => loja (ULT 04 -> U4)
           - gs  => primeira e última letra do usuário (gabriela.alves -> g + s)
           - 131225 => data ddMMyy
           - 181337 => hora HHmmss
      ========================================================================================== */
      setarNumeroDocumentoGerado();

      carregarBase();
    });

    function iniciarLoadingPercentual() {
      const overlay = document.getElementById("overlayCarregando");
      const txt = document.getElementById("percentualCarregando");

      overlay.style.display = "flex";
      percentual = 0;
      txt.textContent = "0%";

      if (timerPercent) clearInterval(timerPercent);

      timerPercent = setInterval(() => {
        if (percentual < 95) {
          percentual += 5;
          txt.textContent = percentual + "%";
        }
      }, 120);
    }

    function finalizarLoadingPercentual() {
      const txt = document.getElementById("percentualCarregando");
      const overlay = document.getElementById("overlayCarregando");

      if (timerPercent) clearInterval(timerPercent);

      percentual = 100;
      txt.textContent = "100%";

      setTimeout(() => {
        overlay.style.display = "none";
      }, 300);
    }

    function mascaraValorUnitario(campo) {
      let v = campo.value.replace(/\D/g, "");

      if (!v) {
        campo.value = "";
        return;
      }

      v = v.replace(/^0+/, "");
      if (!v) v = "0";

      while (v.length < 3) {
        v = "0" + v;
      }

      const inteiro = v.slice(0, -2);
      const centavos = v.slice(-2);
      const inteiroFormatado = inteiro.replace(/\B(?=(\d{3})+(?!\d))/g, ".");

      campo.value = inteiroFormatado + "," + centavos;
    }

    async function carregarBase() {
      const status = document.getElementById("status");

      iniciarLoadingPercentual();

      try {
        status.textContent = "Carregando base de produtos...";

        const resp = await fetch("/api/produtos");
        const dados = await resp.json();

        if (!resp.ok || !dados.sucesso || !Array.isArray(dados.produtos)) {
          console.error("Resposta inesperada da API /api/produtos:", dados);
          throw new Error(dados.message || "Falha ao carregar produtos.");
        }

        dbProdutos = dados.produtos;
        baseCarregada = true;

        finalizarLoadingPercentual();

        status.textContent = `Base carregada com ${dbProdutos.length} produtos.`;
      } catch (err) {
        console.error("Erro ao carregar base:", err);
        baseCarregada = false;
        finalizarLoadingPercentual();
        status.textContent = "Erro ao carregar base de produtos.";
      }
    }

    function buscar() {
      const campo      = document.getElementById("campoBusca");
      const termoBruto = campo.value.trim();
      const status     = document.getElementById("status");

      try {
        if (!termoBruto) {
          status.textContent = "Digite ou leia um código para buscar.";
          return;
        }

        if (!baseCarregada) {
          status.textContent = "Aguarde a base terminar de carregar.";
          return;
        }

        const termo = termoBruto.toLowerCase();

        const resultados = dbProdutos.filter((linha) => {
          const ean      = String(linha[0] ?? "").toLowerCase();
          const consinco = String(linha[1] ?? "").toLowerCase();
          const produto  = String(linha[2] ?? "").toLowerCase();

          return (
            ean === termo ||
            consinco === termo ||
            produto.includes(termo)
          );
        });

        mostrarResultados(resultados);

        status.textContent = `${resultados.length} produto(s) encontrado(s).`;
      } catch (err) {
        console.error("Erro na função buscar:", err);
        status.textContent = "Erro ao realizar a busca.";
      }
    }

    function mostrarResultados(lista) {
      const container = document.getElementById("resultado");

      ultimosResultados = Array.isArray(lista) ? lista : [];

      if (!ultimosResultados.length) {
        container.innerHTML =
          '<p style="font-size: 14px; text-align:center; margin-top: 12px;">Nenhum resultado encontrado.</p>';
        return;
      }

      const html = ultimosResultados
        .map((linha, idx) => `
          <div class="cartao" onclick="enviarRelatorio(${idx})">
            <div class="cartao-linha cartao-linha-produto">
              <span class="cartao-linha-label">Produto:</span>
              <span class="cartao-linha-valor">${linha[2] ?? ""}</span>
            </div>
            <div class="cartao-linha">
              <span class="cartao-linha-label">EAN:</span>
              <span class="cartao-linha-valor">${linha[0] ?? ""}</span>
            </div>
            <div class="cartao-linha">
              <span class="cartao-linha-label">Cód Consinco:</span>
              <span class="cartao-linha-valor">${linha[1] ?? ""}</span>
            </div>
            <div class="cartao-linha">
              <span class="cartao-linha-label">Departamento:</span>
              <span class="cartao-linha-valor">${linha[3] ?? ""}</span>
            </div>
            <div class="cartao-linha">
              <span class="cartao-linha-label">Seção:</span>
              <span class="cartao-linha-valor">${linha[4] ?? ""}</span>
            </div>
            <div class="cartao-linha">
              <span class="cartao-linha-label">Grupo:</span>
              <span class="cartao-linha-valor">${linha[5] ?? ""}</span>
            </div>
            <div class="cartao-linha">
              <span class="cartao-linha-label">Subgrupo:</span>
              <span class="cartao-linha-valor">${linha[6] ?? ""}</span>
            </div>
            <div class="cartao-linha">
              <span class="cartao-linha-label">Categoria:</span>
              <span class="cartao-linha-valor">${linha[7] ?? ""}</span>
            </div>
          </div>
        `)
        .join("");

      container.innerHTML = html;
    }

    function enviarRelatorio(idx) {
      const status = document.getElementById("status");

      if (!ultimosResultados || !ultimosResultados[idx]) {
        status.textContent =
          "Não foi possível identificar o produto selecionado.";
        return;
      }

      const linhaProduto = ultimosResultados[idx];
      const obs = document.getElementById("observacao").value.trim();
      const qtd = document.getElementById("quantidade").value.trim();
      const valor = document.getElementById("valorUnitario").value.trim();

      /* ===================== NOVO: doc vem automático e não editável ===================== */
      const doc = document.getElementById("numeroDocumento").value.trim();
      /* ================================================================================ */

      if (!obs) {
        status.textContent =
          "Preencha o relatório antes de enviar.";
        return;
      }

      if (!qtd) {
        status.textContent = "Preencha a quantidade antes de enviar.";
        return;
      }

      if (!valor) {
        status.textContent = "Preencha o valor unitário antes de enviar.";
        return;
      }

      if (!doc) {
        status.textContent = "Nº de Documento não foi gerado. Clique em 'Nova ocorrência'.";
        return;
      }

      if (!lojaLogada || !usuarioLogado) {
        status.textContent = "Sessão inválida. Faça login novamente.";
        return;
      }

      if (navigator.vibrate) {
        navigator.vibrate(80);
      }

      envioPendente = {
        linhaProduto,
        observacao: obs,
        quantidade: qtd,
        valorUnitario: valor,
        numeroDocumento: doc,
      };

      document.getElementById("confirmOverlay").style.display = "flex";
    }

    async function confirmarEnvio(confirmado) {
      const overlay = document.getElementById("confirmOverlay");
      const status = document.getElementById("status");

      if (!confirmado) {
        overlay.style.display = "none";
        envioPendente = null;
        status.textContent = "Envio cancelado.";
        return;
      }

      if (!envioPendente) {
        overlay.style.display = "none";
        return;
      }

      const {
        linhaProduto,
        observacao,
        quantidade,
        valorUnitario,
        numeroDocumento,
      } = envioPendente;

      envioPendente = null;
      overlay.style.display = "none";

      status.textContent = "Enviando relatório...";

      try {
        const resposta = await fetch("/api/relatorio", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            produto: linhaProduto,
            loja: lojaLogada,
            usuario: usuarioLogado,
            observacao,
            quantidade,
            valorUnitario,
            numeroDocumento,
          }),
        });

        const dados = await resposta.json().catch(() => ({}));

        if (!resposta.ok || !dados.sucesso) {
          status.textContent =
            dados.message || "Erro ao registrar relatório.";
          return;
        }

        status.textContent =
          dados.message || "Relatório registrado com sucesso.";

        document.getElementById("observacao").value = "";
        document.getElementById("quantidade").value = "";
        document.getElementById("valorUnitario").value = "";

        /* ===================== OPCIONAL (não solicitado): manter o mesmo doc após envio =====================
           Você não pediu para trocar automaticamente depois do envio, então NÃO troquei.
           Se quiser que após enviar ele gere um novo doc automaticamente, eu ajusto.
        ================================================================================================ */
      } catch (erro) {
        console.error("Erro ao enviar relatório:", erro);
        status.textContent =
          "Erro de conexão ao enviar relatório.";
      }
    }

    function abrirCamera() {
      const area = document.getElementById("cameraArea");
      const msg = document.getElementById("msgCamera");
      const video = document.getElementById("video");

      area.style.display = "block";
      msg.textContent = "Abrindo câmera...";

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        msg.textContent =
          "Este dispositivo ou navegador não permite acesso à câmera neste contexto.";
        return;
      }

      navigator.mediaDevices
        .getUserMedia({ video: { facingMode: "environment" } })
        .then((stream) => {
          streamAtual = stream;
          video.srcObject = stream;
          video.play();
          msg.textContent = "Aponte para o código de barras...";
          iniciarLeitura(video, msg);
        })
        .catch((err) => {
          msg.textContent = "Erro ao acessar câmera: " + err.message;
        });
    }

    async function iniciarLeitura(video, msg) {
      if (!("BarcodeDetector" in window)) {
        msg.textContent =
          "Leitura automática não suportada neste navegador. Digite o código manualmente.";
        return;
      }

      const detector = new BarcodeDetector({
        formats: ["ean_13", "ean_8", "code_128"],
      });

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      lendo = true;

      async function scan() {
        if (!lendo) return;

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          try {
            const codes = await detector.detect(canvas);

            if (codes.length > 0) {
              const code = codes[0].rawValue;
              msg.textContent = "Detectado: " + code;

              document.getElementById("campoBusca").value = code;

              fecharCamera();
              buscar();
              return;
            }
          } catch (e) {
            // Silencia erros do detector
          }
        }

        requestAnimationFrame(scan);
      }

      scan();
    }

    function fecharCamera() {
      lendo = false;

      if (streamAtual) {
        streamAtual.getTracks().forEach((t) => t.stop());
      }

      document.getElementById("video").srcObject = null;
      document.getElementById("cameraArea").style.display = "none";
    }

    function limparSessao() {
      try {
        localStorage.removeItem("pppSession");
      } catch (e) {
        console.warn("Não foi possível limpar a sessão:", e);
      }
    }

    /* =========================================================================================
       ===================== NOVO: GERAÇÃO DO NÚMERO DE DOCUMENTO =====================

       Regras:
       - Prefixo loja:
         * "ULT 04 - CEI SUL" -> "U4"
         * "BIG 01 - 106 NORTE" -> "B1" (se você usar BIG nesse painel)
         Caso não bata no padrão, usa primeira letra da loja + "0".

       - Prefixo usuário:
         * primeira letra + última letra do usuário (apenas alfanumérico)
         * "gabriela.alves" -> "gs"

       - Data/hora:
         * ddMMyy + HHmmss no fuso America/Sao_Paulo
    ========================================================================================= */

    // Converte data/hora para o fuso de São Paulo de forma estável (sem depender do relógio do navegador “em UTC”)
    function nowSaoPaulo() {
      const agora = new Date();
      // Converte para string no fuso desejado e reinterpreta como Date local
      // (é a técnica mais compatível para browser puro, sem libs)
      const dataSP = new Date(agora.toLocaleString("en-US", { timeZone: "America/Sao_Paulo" }));
      return dataSP;
    }

    // Extrai "U4" de "ULT 04 - CEI SUL" e "B1" de "BIG 01 - ..."
    function gerarPrefixoLoja(lojaStr) {
      const loja = String(lojaStr || "").trim().toUpperCase();

      // Padrão ULT NN
      let m = loja.match(/^ULT\s+(\d{1,2})\b/);
      if (m && m[1]) {
        const n = String(parseInt(m[1], 10)); // remove zero à esquerda
        return "U" + n;
      }

      // Padrão BIG NN (caso você use Big Box aqui também)
      m = loja.match(/^BIG\s+(\d{1,2})\b/);
      if (m && m[1]) {
        const n = String(parseInt(m[1], 10));
        return "B" + n;
      }

      // Fallback (não esperado): primeira letra da loja + "0"
      const primeira = loja ? loja[0] : "X";
      return primeira + "0";
    }

    // "gabriela.alves" -> "gs" (primeira e última letra alfanumérica)
    function gerarPrefixoUsuario(usuarioStr) {
      const u = String(usuarioStr || "").trim().toLowerCase();
      const apenas = u.replace(/[^a-z0-9]/g, ""); // remove pontos, espaços etc.
      if (!apenas) return "xx";
      const first = apenas[0] || "x";
      const last = apenas[apenas.length - 1] || "x";
      return (first + last);
    }

    function pad2(n) { return String(n).padStart(2, "0"); }

    function gerarNumeroDocumento() {
      const dt = nowSaoPaulo();

      const dd = pad2(dt.getDate());
      const mm = pad2(dt.getMonth() + 1);
      const yy = String(dt.getFullYear()).slice(-2);

      const HH = pad2(dt.getHours());
      const MI = pad2(dt.getMinutes());
      const SS = pad2(dt.getSeconds());

      const prefixLoja = gerarPrefixoLoja(lojaLogada);
      const prefixUser = gerarPrefixoUsuario(usuarioLogado);

      // Ex: U4 + gs + 131225 + 181337
      return `${prefixLoja}${prefixUser}${dd}${mm}${yy}${HH}${MI}${SS}`;
    }

    // Seta o valor no input (sempre pelo JS, já que é readonly)
    function setarNumeroDocumentoGerado() {
      const el = document.getElementById("numeroDocumento");
      if (!el) return;
      el.value = gerarNumeroDocumento();
    }

    // Abre modal "Nova ocorrência"
    function abrirModalNovaOcorrencia() {
      document.getElementById("confirmOverlayNovaOcorrencia").style.display = "flex";
    }

    // Confirma/nega gerar novo documento
    function confirmarNovaOcorrencia(confirmado) {
      const overlay = document.getElementById("confirmOverlayNovaOcorrencia");
      overlay.style.display = "none";

      if (!confirmado) return;

      // Gera novo documento com data/hora do clique
      setarNumeroDocumentoGerado();
    }
    /* ===================== FIM DO BLOCO NOVO ===================== */
  </script>
</body>
</html>

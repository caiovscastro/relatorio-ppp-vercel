<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BONO DIGITAL</title>

  <style>
    body{
      background:#f3f3f3;
      font-family: Arial, sans-serif;
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:100vh;
      margin:2px;
      color:#111;
    }

    .container{
      width: 98%;
      max-width: 640px;
      background:#fff;
      padding: 22px 22px 18px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      box-sizing: border-box;
    }

    .titulo{
      text-align:center;
      margin: 10px 0 10px;
      font-size: 24px;
      font-weight: 800;
      letter-spacing: .2px;
    }

    /* ‚úÖ logo + linha discreta */
    .logo-wrap{
      display:flex;
      flex-direction: column;
      align-items:center;
      margin: 6px 0 0;
    }
    .logo-wrap img{
      max-width: 220px;
      width: 70%;
      height: auto;
      display:block;
    }
    .logo-line{
      width: 100%;
      border: none;
      border-top: 1px solid #ededed;
      margin: 10px 0 0;
    }

    .card-info{
      background: #f7f7f7;
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      padding: 12px 12px;
      margin-bottom: 14px;
      font-size: 13px;
      line-height: 1.45;
    }

    /* =========================================================
       ‚úÖ NOVO PADR√ÉO (igual print): usu√°rio | loja | perfil (1 linha)
    ========================================================= */
    .info-line{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      white-space: nowrap;
      overflow: hidden;
    }
    .info-item{
      display:flex;
      align-items:center;
      gap: 7px;
      min-width: 0;
      overflow: hidden;
    }
    .info-icon{
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
      opacity: .85;
      color: #0066ff; /* üîµ azul */
    }
    .info-text{
      font-weight: 900;
      font-size: 13px;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    /* Mantidos (n√£o removidos para n√£o quebrar nada) */
    .linha{
      display:flex;
      justify-content: space-between;
      gap: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .k{ color:#555; font-weight:700; }
    .v{ font-weight:800; overflow:hidden; text-overflow:ellipsis; }

    .secao{
      margin-top: 12px;
      border: 1px solid #ececec;
      border-radius: 12px;
      padding: 12px;
      background: #fff;
    }

    .secao-titulo{
      font-size: 14px;
      font-weight: 900;
      margin: 0 0 10px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .grid-1{ grid-template-columns: 1fr; }

    .grid-2-fixo{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .grid-3-fixo{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }

    .btn-row-2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .btn-row-2 .btn{ margin-top: 0; }

    label{
      display:block;
      font-size: 12px;
      font-weight: 800;
      color:#333;
      margin-bottom: 6px;
    }

    input, select, textarea{
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
      outline: none;
      background:#fff;
    }

    textarea{ min-height: 44px; resize: vertical; }

    .btn{
      width:100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 800;
      margin-top: 10px;
    }

    .btn-sec{ background:#e9e9e9; color:#111; }
    .btn-sec:hover{ background:#dedede; }

    .btn-pri{ background:#111; color:#fff; }
    .btn-pri:hover{ opacity:.92; }

    .btn-warn{ background:#b30000; color:#fff; }
    .btn-warn:hover{ opacity:.92; }

    .mensagem{
      margin-top: 12px;
      text-align:center;
      font-weight:800;
      font-size: 13px;
      min-height: 18px;
      color:#b30000;
    }

    .ok{ color:#0b6b2f; }

    .lista{
      margin-top: 10px;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }

    .item{
      display:flex;
      justify-content: space-between;
      align-items:flex-start;
      gap: 10px;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 10px;
      margin-bottom: 8px;
      background:#fafafa;
    }

    .item .txt{
      flex: 1;
      font-size: 13px;
      line-height: 1.35;
    }

    .item .txt b{ font-size: 13px; }

    .btn-mini{
      border: none;
      border-radius: 10px;
      padding: 10px 10px;
      cursor: pointer;
      font-weight: 900;
      font-size: 12px;
      background:#e9e9e9;
    }
    .btn-mini:hover{ background:#dedede; }

    .hidden{ display:none !important; }

    /* ===== Modais ===== */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.45);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 9999;
      padding: 14px;
    }

    .modal{
      width: 100%;
      max-width: 420px;
      background:#fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }

    .modal h3{
      margin:0 0 8px;
      font-size: 16px;
      font-weight: 900;
    }

    .modal p{
      margin:0 0 12px;
      font-size: 13px;
      font-weight: 700;
      color:#222;
      line-height: 1.35;
    }

    .row-btn{
      display:flex;
      gap: 10px;
    }
    .row-btn .btn{ margin-top: 0; }

    /* ‚úÖ overlay de carregamento com barra */
    .load-overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.45);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 10050;
      padding: 14px;
    }
    .load-box{
      width: 100%;
      max-width: 420px;
      background:#fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .load-title{
      margin:0 0 10px;
      font-size: 14px;
      font-weight: 900;
      text-align:center;
    }
    .load-bar{
      width: 100%;
      height: 12px;
      border-radius: 999px;
      background: #eee;
      overflow:hidden;
      border: 1px solid #e3e3e3;
    }
    .load-fill{
      height: 100%;
      width: 0%;
      background: #111;
      transition: width .18s ease;
    }
    .load-pct{
      margin-top: 10px;
      text-align:center;
      font-weight: 900;
      font-size: 13px;
      color:#111;
    }

    /* ‚úÖ Pr√©via do WhatsApp dentro do modal */
    .prewa{
      margin-top: 10px;
      border: 1px solid #ececec;
      border-radius: 12px;
      background: #fafafa;
      padding: 10px;
      max-height: 280px;
      overflow:auto;
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* ‚úÖ Caixa de confirma√ß√£o (Documento + Qtd) no mesmo popup */
    .confirm-box{
      border: 1px solid #ececec;
      border-radius: 12px;
      background:#fff;
      padding: 10px;
      font-size: 12px;
      font-weight: 900;
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .confirm-box.wait{
      color:#111;
      opacity:.9;
    }
    .confirm-box.ok{
      color:#0b6b2f;
      border-color: rgba(11,107,47,.25);
      background: rgba(11,107,47,.06);
    }
    .confirm-box.err{
      color:#b30000;
      border-color: rgba(179,0,0,.25);
      background: rgba(179,0,0,.06);
    }

    /* ‚úÖ Bot√£o desabilitado */
    .btn[disabled]{
      opacity:.55;
      cursor:not-allowed;
    }

    @media (max-width: 520px){
      .grid{ grid-template-columns: 1fr; }
      .grid-2-fixo{ grid-template-columns: 1fr 1fr; }
      .grid-3-fixo{ grid-template-columns: 1fr 1fr 1fr; }
      .btn-row-2{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="logo-wrap">
      <img src="https://i.ibb.co/prMfd6Fs/IMG-20260121-161142.png" alt="Logo" />
      <hr class="logo-line" />
    </div>

    <h2 class="titulo">BONO DIGITAL</h2>

    <!-- ‚úÖ (1) Card padr√£o print -->
    <div class="card-info" id="cardInfo">
      <div class="info-line">
        <div class="info-item" title="Usu√°rio">
          <span class="info-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21a8 8 0 0 0-16 0"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          <span class="info-text" id="infoUsuario">‚Äî</span>
        </div>

        <div class="info-item" title="Loja">
          <span class="info-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9l1-5h16l1 5"></path>
              <path d="M5 9v10h14V9"></path>
              <path d="M9 19v-6h6v6"></path>
            </svg>
          </span>
          <span class="info-text" id="infoLoja">‚Äî</span>
        </div>

        <div class="info-item" title="Perfil">
          <span class="info-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
          </span>
          <span class="info-text" id="infoPerfil">‚Äî</span>
        </div>
      </div>
    </div>

    <div class="secao">
      <div class="secao-titulo">Dados do lan√ßamento</div>

      <div class="grid-2-fixo">
        <div>
          <label for="dataEscolhida">Data</label>
          <input type="date" id="dataEscolhida" />
        </div>

        <div>
          <label for="horaEscolhida">Hor√°rio</label>
          <input type="time" id="horaEscolhida" />
        </div>
      </div>

      <div class="grid grid-1" style="margin-top:10px;">
        <div>
          <label for="encarregado">Responsavel (Opera√ß√£o)</label>
          <input type="text" id="encarregado" placeholder="Nome e sobrenome." maxlength="80" />
        </div>
      </div>

      <div class="grid grid-1" style="margin-top:10px;">
        <div>
          <label for="produto">Descri√ß√£o</label>
          <textarea id="produto" placeholder="Ex: Arroz flora 5kg" maxlength="200"></textarea>
        </div>
      </div>

      <div class="grid-3-fixo" style="margin-top:10px;">
        <div>
          <label for="embalagem">Embalagem</label>
          <select id="embalagem">
            <option value="">Embalagem</option>
            <option value="KG">KG</option>
            <option value="UND">UND</option>
          </select>
        </div>

        <div>
          <label for="quantidade">Qtd.</label>
          <input
            type="text"
            id="quantidade"
            inputmode="numeric"
            autocomplete="off"
            placeholder="Ex: 2"
          />
        </div>

        <div>
          <label for="tipoLancamento">Tipo</label>
          <select id="tipoLancamento">
            <option value="">Tipo</option>
            <option value="RECEBIMENTO">Recebimento de mercadorias</option>
            <option value="MOV_INTERNA">Movimenta√ß√£o interna</option>
          </select>
        </div>
      </div>

      <!-- ‚úÖ (2) Destino em MOV + Placa ao lado -->
      <div class="grid-2-fixo hidden" style="margin-top:10px;" id="wrapDestinoLinha">
        <div>
          <label for="lojaDestino">Loja Destino</label>
          <select id="lojaDestino">
            <option value="">Selecione</option>

            <option value="BIG 01 - 106 NORTE">BIG 01 - 106 NORTE</option>
            <option value="BIG 02 - 402 NORTE">BIG 02 - 402 NORTE</option>
            <option value="BIG 03 - 413 SUL">BIG 03 - 413 SUL</option>
            <option value="BIG 04 - 301 SW">BIG 04 - 301 SW</option>
            <option value="BIG 05 - 408 NORTE">BIG 05 - 408 NORTE</option>
            <option value="BIG 06 - SIBERIA">BIG 06 - SIBERIA</option>
            <option value="BIG 08 - 503 SUL">BIG 08 - 503 SUL</option>
            <option value="BIG 09 - PEN√çNSULA">BIG 09 - PEN√çNSULA</option>
            <option value="BIG 10 - PAINEIRAS">BIG 10 - PAINEIRAS</option>
            <option value="BIG 11 - 310 NORTE">BIG 11 - 310 NORTE</option>
            <option value="BIG 12 - 208 NORTE">BIG 12 - 208 NORTE</option>
            <option value="BIG 13 - QI-05 L. NORTE">BIG 13 - QI-05 L. NORTE</option>
            <option value="BIG 14 - 508 SUL">BIG 14 - 508 SUL</option>
            <option value="BIG 15 - 105 SW">BIG 15 - 105 SW</option>
            <option value="BIG 16 - 512 SUL">BIG 16 - 512 SUL</option>
            <option value="BIG 17 - QI-11 LAGO SUL">BIG 17 - QI-11 LAGO SUL</option>
            <option value="BIG 18 - 211 NORTE">BIG 18 - 211 NORTE</option>
            <option value="BIG 19 - CASTANHEIRA">BIG 19 - CASTANHEIRA</option>
            <option value="BIG 20 - TAGUATINGA C1">BIG 20 - TAGUATINGA C1</option>
            <option value="BIG 21 - CNB12">BIG 21 - CNB12</option>
            <option value="BIG 22 - 102 NOROESTE">BIG 22 - 102 NOROESTE</option>
            <option value="BIG 23 - QI-23 LAGO SUL">BIG 23 - QI-23 LAGO SUL</option>
            <option value="BIG 24 - 314 NORTE">BIG 24 - 314 NORTE</option>
            <option value="BIG 25 - 410 SUL">BIG 25 - 410 SUL</option>

            <option value="ULT 01 - PLANALTINA">ULT 01 - PLANALTINA</option>
            <option value="ULT 02 - GAMA">ULT 02 - GAMA</option>
            <option value="ULT 03 - COLORADO">ULT 03 - COLORADO</option>
            <option value="ULT 04 - CEI SUL">ULT 04 - CEI SUL</option>
            <option value="ULT 05 - POLO JK">ULT 05 - POLO JK</option>
            <option value="ULT 06 - SOBRADINHO">ULT 06 - SOBRADINHO</option>
            <option value="ULT 07 - ADE">ULT 07 - ADE</option>
            <option value="ULT 08 - ARAPOANGA">ULT 08 - ARAPOANGA</option>
            <option value="ULT 09 - CEI NORTE">ULT 09 - CEI NORTE</option>
            <option value="ULT 10 - ESTRUTURAL">ULT 10 - ESTRUTURAL</option>
            <option value="ULT 11 - ITAPOA">ULT 11 - ITAPOA</option>
            <option value="ULT 12 - SAO SEBASTIAO">ULT 12 - SAO SEBASTIAO</option>
            <option value="ULT 13 - RECANTO">ULT 13 - RECANTO</option>
            <option value="ULT 14 - AGUAS LINDAS">ULT 14 - AGUAS LINDAS</option>
            <option value="ULT 15 - SOL NASCENTE">ULT 15 - SOL NASCENTE</option>
            <option value="ULT 16 - PARANOA PARK">ULT 16 - PARANOA PARK</option>
            <option value="ULT 17 - SAMAMBAIA">ULT 17 - SAMAMBAIA</option>
            <option value="ULT 18 - BRAZLANDIA">ULT 18 - BRAZLANDIA</option>
            <option value="ULT 19 - VIA PARK">ULT 19 - VIA PARK</option>
            <option value="ULT 20 - TAGUATINGA">ULT 20 - TAGUATINGA</option>
            <option value="ULT 22 - VICENTE PIRES">ULT 22 - VICENTE PIRES</option>
            <option value="ULT 23 - SANTA MARIA">ULT 23 - SANTA MARIA</option>
            <option value="ULT 24 - PAU BRASIL">ULT 24 - PAU BRASIL</option>
            <option value="ULT 25 - BRASILINHA">ULT 25 - BRASILINHA</option>

            <option value="TOTAL DISTRIBUICAO">TOTAL DISTRIBUICAO</option>
            <option value="INDUSPAN">INDUSPAN</option>
            <option value="MATRIZ">MATRIZ</option>
          </select>
        </div>

        <!-- ‚úÖ Placa (mesmo input, muda de lugar conforme tipo) -->
        <div id="wrapPlacaMov"></div>
      </div>

      <!-- ‚úÖ (2) Fornecedor em RECEB + Placa ao lado -->
      <div class="grid-2-fixo hidden" style="margin-top:10px;" id="wrapFornecedorLinha">
        <div>
          <label for="fornecedor">Fornecedor</label>
          <input type="text" id="fornecedor" placeholder="Informe o fornecedor" maxlength="80" />
        </div>

        <div id="wrapPlacaRec"></div>
      </div>

      <!-- ‚úÖ Input de Placa (um s√≥). Ele √© ‚Äúmovido‚Äù para o lado correto via JS -->
      <div class="hidden" id="placaNode">
        <label for="placaVeiculo">Placa do ve√≠culo</label>
        <input
          type="text"
          id="placaVeiculo"
          placeholder="Ex: ABC1D23"
          inputmode="text"
          autocomplete="off"
          maxlength="7"
        />
      </div>

      <div class="btn-row-2">
        <button class="btn btn-sec" id="btnAdicionar">Adicionar item</button>
        <button class="btn btn-pri" id="btnSalvar">Salvar Bono</button>
      </div>

      <button class="btn btn-sec" id="btnVoltarMenu">Voltar ao menu</button>

      <div class="mensagem" id="msg"></div>

      <div class="lista hidden" id="listaWrap">
        <div class="secao-titulo" style="margin:0 0 8px;">Itens adicionados</div>
        <div id="listaItens"></div>
      </div>
    </div>
  </div>

  <div class="overlay hidden" id="modalPendente">
    <div class="modal">
      <h3>Bono pendente de finaliza√ß√£o</h3>
      <p>Foi encontrado um bono n√£o finalizado. Deseja continuar de onde parou ou descartar e iniciar um novo?</p>
      <div class="row-btn">
        <button class="btn btn-pri" id="btnContinuar">Continuar</button>
        <button class="btn btn-warn" id="btnDescartar">Descartar</button>
      </div>
    </div>
  </div>

  <div class="overlay hidden" id="modalConfirmar">
    <div class="modal">
      <h3>Finalizar Bono</h3>
      <p>Tem certeza que deseja finalizar o Bono?</p>
      <div class="row-btn">
        <button class="btn btn-pri" id="btnConfirmarSim">Sim</button>
        <button class="btn btn-sec" id="btnConfirmarNao">N√£o</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Modal (reutilizado): MOV = Whats + pr√©via | RECEB = s√≥ Confirma√ß√£o -->
  <div class="overlay hidden" id="modalWhatsPreview">
    <div class="modal">
      <!-- üîß t√≠tulo din√¢mico -->
      <h3 id="waModalTitle">Pr√©-visualiza√ß√£o da notifica√ß√£o.</h3>

      <!-- üîß pergunta (s√≥ em MOV_INTERNA) -->
      <p id="waModalQuestion">Deseja notificar o respons√°vel da loja destino?</p>

      <div class="confirm-box wait" id="confirmBox">Aguardando confirma√ß√£o da base de dados...</div>

      <!-- üîß pr√©via (s√≥ em MOV_INTERNA) -->
      <div class="prewa" id="waPreviewText"></div>

      <div class="row-btn" style="margin-top:12px;">
        <!-- üîß bot√£o s√≥ em MOV_INTERNA -->
        <button class="btn btn-pri" id="btnAbrirWhats" disabled>Abrir WhatsApp</button>

        <!-- üîß muda texto para OK em RECEBIMENTO -->
        <button class="btn btn-sec" id="btnCancelarWhats" disabled>Cancelar</button>
      </div>
    </div>
  </div>

  <div class="load-overlay hidden" id="loadingOverlay" aria-live="polite">
    <div class="load-box">
      <!-- ‚úÖ AJUSTE #2 (opcional): id para trocar texto ap√≥s 2,5s -->
      <div class="load-title" id="loadTitle">Enviando informa√ß√µes...</div>
      <div class="load-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div class="load-fill" id="loadFill"></div>
      </div>
      <div class="load-pct" id="loadPct">0%</div>
    </div>
  </div>

  <script>
    /* =========================================================
       ‚úÖ CONFIGURA√á√ÉO √öNICA DO DOM√çNIO P√öBLICO
    ========================================================= */
    const DOMINIO_PUBLICO = "https://ubppp.xyz";

    const ROTAS = { menu: "/menu.html", login: "/login.html" };
    const LS_KEY = "PPP_BONO_PENDENTE_V1";

    let sessaoAtual = null;
    let expTimerId = null;

    // ‚úÖ inclui placa no estado
    let estado = { data: "", hora: "", encarregado: "", fornecedor: "", placaVeiculo: "", itens: [] };

    // ‚úÖ draft Whats (modal)
    let waDraft = { telefone: "", mensagem: "" };

    // ‚úÖ modo do popup: "MOV_INTERNA" ou "RECEBIMENTO"
    let waModalMode = "MOV_INTERNA";

    function setTexto(id, txt) {
      const el = document.getElementById(id);
      if (el) el.textContent = txt;
    }

    function setMsg(txt, ok=false){
      const el = document.getElementById("msg");
      el.textContent = txt || "";
      el.classList.toggle("ok", !!ok);
    }

    async function obterSessaoDoBackend() {
      try {
        const resp = await fetch("/api/session", {
          method: "GET",
          credentials: "include",
          headers: { "Accept": "application/json" }
        });
        if (!resp.ok) return null;

        const dados = await resp.json().catch(() => null);
        if (!dados || !dados.sucesso || !dados.usuario || !dados.loja) return null;
        return dados;
      } catch (e) {
        console.error("[BONO] Falha ao consultar /api/session:", e);
        return null;
      }
    }

    function normalizarExpParaMs(exp) {
      const n = Number(exp);
      if (!Number.isFinite(n) || n <= 0) return null;
      if (n < 10_000_000_000) return n * 1000;
      return n;
    }

    function limparTimerExpiracao() {
      if (expTimerId) {
        clearTimeout(expTimerId);
        expTimerId = null;
      }
    }

    function redirecionarParaLogin(motivo) {
      if (motivo) setMsg(motivo, false);
      window.location.href = ROTAS.login;
    }

    function agendarRedirecionamentoNaExpiracao(expMs) {
      limparTimerExpiracao();
      if (!expMs) return;

      const msRestante = expMs - Date.now();
      if (msRestante <= 0) {
        redirecionarParaLogin("Sess√£o expirada. Fa√ßa login novamente.");
        return;
      }
      expTimerId = setTimeout(() => {
        redirecionarParaLogin("Sess√£o expirada. Fa√ßa login novamente.");
      }, msRestante);
    }

    function normalizarLojaComparacao(s){
      return String(s || "").trim().toUpperCase().replace(/\s+/g, " ");
    }

    function bloquearLojaOrigemNoDestino(){
      const sel = document.getElementById("lojaDestino");
      if (!sel || !sessaoAtual || !sessaoAtual.loja) return;

      const origemN = normalizarLojaComparacao(sessaoAtual.loja);

      Array.from(sel.options).forEach(opt => {
        if (!opt.value) return;
        const optN = normalizarLojaComparacao(opt.value);
        opt.disabled = (optN === origemN);
      });

      if (sel.value && normalizarLojaComparacao(sel.value) === origemN) {
        sel.value = "";
      }
    }

    function aplicarSessaoNaTela(sessao) {
      sessaoAtual = sessao;

      setTexto("infoLoja", sessao.loja || "‚Äî");
      setTexto("infoUsuario", sessao.usuario || "‚Äî");
      setTexto("infoPerfil", sessao.perfil || "‚Äî");

      const expMs = normalizarExpParaMs(sessao.exp);
      if (expMs) agendarRedirecionamentoNaExpiracao(expMs);

      bloquearLojaOrigemNoDestino();
    }

    function salvarLocal() {
      try {
        localStorage.setItem(LS_KEY, JSON.stringify(estado));
      } catch (e) {
        console.warn("[BONO] N√£o foi poss√≠vel salvar no localStorage:", e);
      }
    }

    function carregarLocal() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || typeof obj !== "object") return null;
        if (!Array.isArray(obj.itens)) obj.itens = [];
        if (typeof obj.fornecedor !== "string") obj.fornecedor = "";
        if (typeof obj.placaVeiculo !== "string") obj.placaVeiculo = "";
        return obj;
      } catch (e) {
        return null;
      }
    }

    function limparLocal() {
      try { localStorage.removeItem(LS_KEY); } catch(e) {}
    }

    function temPendenciaValida(obj) {
      if (!obj) return false;
      const temAlgo = (obj.data || obj.hora || obj.encarregado || obj.fornecedor || obj.placaVeiculo || (obj.itens && obj.itens.length));
      return !!temAlgo;
    }

    function pad2(n){ return String(n).padStart(2, "0"); }

    function formatarDataHoraParaPlanilha(dataYYYYMMDD, horaHHMM) {
      if (!dataYYYYMMDD || !horaHHMM) return "";
      const [y,m,d] = dataYYYYMMDD.split("-");
      if (!y || !m || !d) return "";
      const [hh,mm] = horaHHMM.split(":");
      if (hh == null || mm == null) return "";
      return `${pad2(d)}/${pad2(m)}/${y} ${pad2(hh)}:${pad2(mm)}`;
    }

    function normalizarTexto(t) {
      return String(t || "").trim();
    }

    // ‚úÖ placa: 7 chars, A-Z0-9, mai√∫sculo
    function normalizarPlaca(s){
      const up = String(s || "").toUpperCase();
      const alnum = up.replace(/[^A-Z0-9]/g, "");
      return alnum.slice(0, 7);
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function abrirModal(id) { document.getElementById(id).classList.remove("hidden"); }
    function fecharModal(id) { document.getElementById(id).classList.add("hidden"); }

    let loadTimer = null;
    function showLoading(){
      document.getElementById("loadingOverlay").classList.remove("hidden");
      setLoadingPct(0);
      // ‚úÖ AJUSTE #2: garante texto inicial
      const t = document.getElementById("loadTitle");
      if (t) t.textContent = "Enviando informa√ß√µes...";
    }
    function hideLoading(){
      document.getElementById("loadingOverlay").classList.add("hidden");
      stopLoadingTimer();
    }
    function setLoadingPct(pct){
      const p = Math.max(0, Math.min(100, Number(pct) || 0));
      document.getElementById("loadFill").style.width = p + "%";
      document.getElementById("loadPct").textContent = p + "%";
      const bar = document.querySelector(".load-bar");
      if (bar) bar.setAttribute("aria-valuenow", String(p));
    }
    function stopLoadingTimer(){
      if (loadTimer) { clearInterval(loadTimer); loadTimer = null; }
    }

    // ‚úÖ AJUSTE #2 (opcional): ap√≥s 2,5s troca o texto para "Confirmando na base de dados..."
    function startLoadingTimer(){
      stopLoadingTimer();
      let p = 0;
      const t0 = Date.now();

      setLoadingPct(p);

      loadTimer = setInterval(() => {
        const elapsed = Date.now() - t0;

        const title = document.getElementById("loadTitle");
        if (title) {
          title.textContent = elapsed > 2500 ? "Confirmando na base de dados..." : "Enviando informa√ß√µes...";
        }

        if (p < 95) {
          p += 5;
          if (p > 95) p = 95;
          setLoadingPct(p);
        }
      }, 180);
    }

    function atualizarCamposNaTela() {
      document.getElementById("dataEscolhida").value = estado.data || "";
      document.getElementById("horaEscolhida").value = estado.hora || "";
      document.getElementById("encarregado").value = estado.encarregado || "";
      document.getElementById("fornecedor").value = estado.fornecedor || "";
      document.getElementById("placaVeiculo").value = estado.placaVeiculo || "";
    }

    function renderLista() {
      const wrap = document.getElementById("listaWrap");
      const lista = document.getElementById("listaItens");

      lista.innerHTML = "";

      if (!estado.itens.length) {
        wrap.classList.add("hidden");
        return;
      }
      wrap.classList.remove("hidden");

      estado.itens.forEach((it, idx) => {
        const div = document.createElement("div");
        div.className = "item";

        const txt = document.createElement("div");
        txt.className = "txt";

        const tipoLabel =
          it.tipoLancamento === "MOV_INTERNA"
            ? "Movimenta√ß√£o interna"
            : (it.tipoLancamento === "RECEBIMENTO" ? "Recebimento de mercadorias" : "");

        const destinoTxt = (it.tipoLancamento === "MOV_INTERNA" && it.lojaDestino)
          ? `<br/>Para onde: <b>${escapeHtml(it.lojaDestino)}</b>`
          : "";

        txt.innerHTML = `
          <b>Item ${idx + 1}</b><br/>
          Produto: <b>${escapeHtml(it.produto)}</b><br/>
          Quantidade: <b>${escapeHtml(String(it.quantidadeFmt || ""))}</b><br/>
          Embalagem: <b>${escapeHtml(it.embalagem)}</b><br/>
          Tipo: <b>${escapeHtml(tipoLabel)}</b>
          ${destinoTxt}
        `;

        const btn = document.createElement("button");
        btn.className = "btn-mini";
        btn.textContent = "Retirar";
        btn.addEventListener("click", () => {
          estado.itens.splice(idx, 1);
          salvarLocal();
          renderLista();
          setMsg("Item removido da lista.", true);
        });

        div.appendChild(txt);
        div.appendChild(btn);
        lista.appendChild(div);
      });
    }

    function formatIntPtBR(n) {
      return new Intl.NumberFormat("pt-BR", { maximumFractionDigits: 0 }).format(n);
    }

    function formatKgFromDigits(digits) {
      if (!digits) return "";
      if (digits.length <= 3) {
        const n = Number(digits);
        if (!Number.isFinite(n)) return "";
        return formatIntPtBR(n);
      }
      const intPart = digits.slice(0, -3);
      const decPart = digits.slice(-3);
      const nInt = Number(intPart);
      if (!Number.isFinite(nInt)) return "";
      const intFmt = new Intl.NumberFormat("pt-BR", { maximumFractionDigits: 0 }).format(nInt);
      return `${intFmt},${decPart}`;
    }

    function quantidadeParaNumero(embalagem, digits) {
      if (!digits) return null;

      if (embalagem === "UND") {
        const n = Number(digits);
        if (!Number.isFinite(n) || n <= 0) return null;
        return n;
      }

      if (embalagem === "KG") {
        if (digits.length <= 3) {
          const n = Number(digits);
          if (!Number.isFinite(n) || n <= 0) return null;
          return n;
        }
        const intPart = digits.slice(0, -3);
        const decPart = digits.slice(-3);
        const n = Number(`${intPart}.${decPart}`);
        if (!Number.isFinite(n) || n <= 0) return null;
        return n;
      }

      return null;
    }

    function bloquearPontuacao(e){
      const k = e.key;
      if (k === "." || k === "," || k === ";" || k === "-" || k === "+" ) {
        e.preventDefault();
      }
    }

    function limparParaDigitos(value){
      return String(value || "").replace(/\D/g, "");
    }

    function aplicarMascaraQuantidade() {
      const el = document.getElementById("quantidade");
      const emb = document.getElementById("embalagem").value;

      const digits = limparParaDigitos(el.value);
      el.dataset.digits = digits;

      if (!digits) {
        el.value = "";
        return;
      }

      if (emb === "UND") {
        el.value = formatIntPtBR(Number(digits));
      } else if (emb === "KG") {
        el.value = formatKgFromDigits(digits);
      } else {
        el.value = digits;
      }
    }

    function atualizarHabilitacaoQuantidade() {
      const emb = document.getElementById("embalagem").value;
      const elQtd = document.getElementById("quantidade");

      const pode = (emb === "KG" || emb === "UND");

      elQtd.disabled = !pode;

      if (!pode) {
        elQtd.value = "";
        elQtd.dataset.digits = "";
      }
    }

    // ‚úÖ mover o input de placa para o lado correto conforme tipo
    function posicionarPlacaConformeTipo(){
      const tipo = document.getElementById("tipoLancamento").value;
      const placaNode = document.getElementById("placaNode");
      const wrapMov = document.getElementById("wrapPlacaMov");
      const wrapRec = document.getElementById("wrapPlacaRec");

      placaNode.classList.remove("hidden");

      if (tipo === "MOV_INTERNA") {
        wrapMov.appendChild(placaNode);
      } else if (tipo === "RECEBIMENTO") {
        wrapRec.appendChild(placaNode);
      } else {
        placaNode.classList.add("hidden");
      }
    }

    function atualizarVisibilidadeDestinoFornecedorEPlaca() {
      const tipo = document.getElementById("tipoLancamento").value;

      const wrapDestinoLinha = document.getElementById("wrapDestinoLinha");
      const wrapFornecedorLinha = document.getElementById("wrapFornecedorLinha");

      const selDestino = document.getElementById("lojaDestino");
      const inpFornecedor = document.getElementById("fornecedor");

      if (tipo === "MOV_INTERNA") {
        wrapDestinoLinha.classList.remove("hidden");
        wrapFornecedorLinha.classList.add("hidden");

        inpFornecedor.value = "";
        estado.fornecedor = "";
        salvarLocal();
      } else if (tipo === "RECEBIMENTO") {
        wrapFornecedorLinha.classList.remove("hidden");
        wrapDestinoLinha.classList.add("hidden");

        selDestino.value = "";
      } else {
        wrapDestinoLinha.classList.add("hidden");
        wrapFornecedorLinha.classList.add("hidden");

        selDestino.value = "";
        inpFornecedor.value = "";
        estado.fornecedor = "";
        salvarLocal();
      }

      posicionarPlacaConformeTipo();
    }

    function aplicarTipoEDestinoNosItens() {
      if (!estado.itens.length) return;

      const tipoAtual = document.getElementById("tipoLancamento").value;
      const destinoAtual = document.getElementById("lojaDestino").value;

      estado.itens = estado.itens.map(it => {
        const novo = { ...it, tipoLancamento: tipoAtual || it.tipoLancamento };

        if (tipoAtual === "MOV_INTERNA") {
          novo.lojaDestino = destinoAtual || it.lojaDestino || "";
        } else if (tipoAtual === "RECEBIMENTO") {
          novo.lojaDestino = "";
        }
        return novo;
      });

      salvarLocal();
      renderLista();
      setMsg("Itens atualizados com o Tipo/Destino selecionados.", true);
    }

    function normalizarTelefoneParaWa(dado) {
      const digits = String(dado || "").replace(/\D/g, "");
      if (!digits) return "";

      if (digits.startsWith("55") && (digits.length === 12 || digits.length === 13)) return digits;
      if (digits.length === 10 || digits.length === 11) return "55" + digits;
      return digits;
    }

    function montarLinkLoginAbsoluto() {
      return `${DOMINIO_PUBLICO}/login.html`;
    }

    // ‚úÖ inclui placa na mensagem
    function montarMensagemWhats({
      lojaOrigem,
      lojaDestino,
      usuario,
      dataHora,
      linkLogin,
      placaVeiculo,
      itens = []
    }) {
      const linhas = [];

      linhas.push("üßæ *BONO DE MOVIMENTA√á√ÉO INTERNA AGUARDANDO APROVA√á√ÉO*");
      linhas.push("");

      linhas.push(`üìç *Destino:* ${lojaDestino || "‚Äî"}`);
      linhas.push(`üè™ *Origem:* ${lojaOrigem || "‚Äî"}`);
      linhas.push(`üë§ *Usu√°rio:* ${usuario || "‚Äî"}`);
      linhas.push(`üïí *Data/Hora:* ${dataHora || "‚Äî"}`);
      linhas.push(`üöó *Placa:* ${placaVeiculo ? placaVeiculo : "N√£o informada"}`);
      linhas.push("");

      linhas.push("üì¶ *Itens do Bono:*");

      if (Array.isArray(itens) && itens.length) {
        itens.forEach((it, idx) => {
          const qtd = (it && (it.quantidadeFmt || it.quantidade)) ? (it.quantidadeFmt || it.quantidade) : "‚Äî";
          const emb = (it && it.embalagem) ? it.embalagem : "";
          const prod = (it && it.produto) ? it.produto : "‚Äî";
          linhas.push(`‚Ä¢ ${idx + 1}. ${prod} ‚Äî ${qtd} ${emb}`.trim());
        });
      } else {
        linhas.push("‚Ä¢ Nenhum item informado");
      }

      linhas.push("");
      linhas.push("üîó *Acesso ao sistema interno para valida√ß√£o:*");
      linhas.push(linkLogin || "‚Äî");

      return linhas.join("\n");
    }

    async function buscarTelefoneResponsavel(lojaDestino) {
      const loja = normalizarTexto(lojaDestino);
      if (!loja) return "";

      try {
        const resp = await fetch(`/api/bono-contato?loja=${encodeURIComponent(loja)}`, {
          method: "GET",
          credentials: "include",
          headers: { "Accept": "application/json" }
        });
        if (!resp.ok) return "";

        const dados = await resp.json().catch(() => null);
        if (!dados || !dados.sucesso) return "";

        return String(dados.whatsapp || "");
      } catch (e) {
        console.error("[BONO] Falha ao buscar contato:", e);
        return "";
      }
    }

    function abrirWhatsAppComMensagem(telefone55, mensagem) {
      const tel = normalizarTelefoneParaWa(telefone55);
      if (!tel) return false;

      const urlApp = `whatsapp://send?phone=${tel}&text=${encodeURIComponent(mensagem)}`;
      const urlWeb = `https://wa.me/${tel}?text=${encodeURIComponent(mensagem)}`;

      const opened = window.open(urlApp, "_blank");

      if (!opened) {
        window.open(urlWeb, "_blank");
      } else {
        setTimeout(() => {
          try { window.open(urlWeb, "_blank"); } catch(e) {}
        }, 500);
      }

      return true;
    }

    function setConfirmBox(status, texto){
      const box = document.getElementById("confirmBox");
      box.classList.remove("wait", "ok", "err");
      box.classList.add(status);
      box.textContent = texto || "";
    }

    function habilitarBotoesWhats({ podeAbrirWhats, podeCancelar }){
      document.getElementById("btnAbrirWhats").disabled = !podeAbrirWhats;
      document.getElementById("btnCancelarWhats").disabled = !podeCancelar;
    }

    // =========================================================
    // ‚úÖ AJUSTE SOLICITADO:
    // - RECEBIMENTO: s√≥ "Confirma√ß√£o" + bot√£o OK
    // - MOV_INTERNA: mant√©m pr√©via + pergunta + abrir Whats
    // =========================================================
    function setModoModalWhats(modo){
      waModalMode = (modo === "RECEBIMENTO") ? "RECEBIMENTO" : "MOV_INTERNA";

      const titleEl = document.getElementById("waModalTitle");
      const questionEl = document.getElementById("waModalQuestion");
      const previewEl = document.getElementById("waPreviewText");
      const btnAbrir = document.getElementById("btnAbrirWhats");
      const btnCancel = document.getElementById("btnCancelarWhats");

      if (waModalMode === "RECEBIMENTO") {
        // üîß texto/visibilidade
        if (titleEl) titleEl.textContent = "Confirma√ß√£o";
        if (questionEl) questionEl.classList.add("hidden");
        if (previewEl) previewEl.classList.add("hidden");
        if (btnAbrir) btnAbrir.classList.add("hidden");
        if (btnCancel) btnCancel.textContent = "OK";
      } else {
        if (titleEl) titleEl.textContent = "Pr√©-visualiza√ß√£o da notifica√ß√£o.";
        if (questionEl) questionEl.classList.remove("hidden");
        if (previewEl) previewEl.classList.remove("hidden");
        if (btnAbrir) btnAbrir.classList.remove("hidden");
        if (btnCancel) btnCancel.textContent = "Cancelar";
      }
    }

    function abrirModalPreviewWhats(telefone, mensagem, modo = "MOV_INTERNA"){
      setModoModalWhats(modo);

      waDraft = { telefone: String(telefone || ""), mensagem: String(mensagem || "") };

      const box = document.getElementById("waPreviewText");
      if (box) box.textContent = waDraft.mensagem || "";

      setConfirmBox("wait", "Aguardando confirma√ß√£o da base de dados...");
      habilitarBotoesWhats({ podeAbrirWhats:false, podeCancelar:false });

      abrirModal("modalWhatsPreview");
    }

    function limparTelaAposConfirmacao(){
      limparLocal();
      estado = { data: "", hora: "", encarregado: "", fornecedor: "", placaVeiculo: "", itens: [] };

      atualizarCamposNaTela();
      renderLista();

      document.getElementById("produto").value = "";
      document.getElementById("quantidade").value = "";
      document.getElementById("quantidade").dataset.digits = "";
      document.getElementById("embalagem").value = "";
      document.getElementById("tipoLancamento").value = "";
      document.getElementById("lojaDestino").value = "";
      document.getElementById("fornecedor").value = "";
      document.getElementById("placaVeiculo").value = "";

      atualizarVisibilidadeDestinoFornecedorEPlaca();
      atualizarHabilitacaoQuantidade();
    }

    function capturarBaseDoFormulario() {
      estado.data = document.getElementById("dataEscolhida").value || "";
      estado.hora = document.getElementById("horaEscolhida").value || "";
      estado.encarregado = normalizarTexto(document.getElementById("encarregado").value);

      const tipoAtual = document.getElementById("tipoLancamento").value;

      if (tipoAtual === "RECEBIMENTO") {
        estado.fornecedor = normalizarTexto(document.getElementById("fornecedor").value);
      } else {
        estado.fornecedor = "";
      }

      const placaRaw = document.getElementById("placaVeiculo").value;
      const placaNorm = normalizarPlaca(placaRaw);
      estado.placaVeiculo = placaNorm;
      if (placaRaw !== placaNorm) document.getElementById("placaVeiculo").value = placaNorm;

      salvarLocal();
    }

    function validarParaAdicionarItem() {
      capturarBaseDoFormulario();

      const dataHoraPlanilha = formatarDataHoraParaPlanilha(estado.data, estado.hora);
      if (!dataHoraPlanilha) { setMsg("Preencha a Data e o Hor√°rio do bono.", false); return false; }
      if (!estado.encarregado) { setMsg("Informe o nome do responsavel que fez o acompanhamento.", false); return false; }

      const produto = normalizarTexto(document.getElementById("produto").value);
      const embalagem = document.getElementById("embalagem").value;
      const tipoLancamento = document.getElementById("tipoLancamento").value;
      const lojaDestino = document.getElementById("lojaDestino").value;

      if (tipoLancamento === "RECEBIMENTO" && !estado.fornecedor) {
        setMsg('Informe o "Fornecedor" (obrigat√≥rio para Recebimento de mercadorias).', false);
        return false;
      }

      const digits = String(document.getElementById("quantidade").dataset.digits || "");
      const quantidadeNum = quantidadeParaNumero(embalagem, digits);
      const quantidadeFmt = document.getElementById("quantidade").value;

      if (!produto) { setMsg("Informe a descri√ß√£o.", false); return false; }
      if (embalagem !== "KG" && embalagem !== "UND") { setMsg("Selecione a embalagem (KG ou UND).", false); return false; }
      if (!tipoLancamento) { setMsg("Selecione um tipo", false); return false; }
      if (tipoLancamento === "MOV_INTERNA" && !lojaDestino) { setMsg("Selecione a loja de destino (Para onde est√° transferindo).", false); return false; }
      if (!quantidadeNum) { setMsg("Informe uma quantidade v√°lida (maior que 0).", false); return false; }

      return {
        produto,
        embalagem,
        tipoLancamento,
        lojaDestino: (tipoLancamento === "MOV_INTERNA" ? lojaDestino : ""),
        quantidadeNum,
        quantidadeFmt,
        fornecedor: (tipoLancamento === "RECEBIMENTO" ? estado.fornecedor : "")
      };
    }

    // ‚úÖ Confirma√ß√£o baseada no retorno do backend (doc + qtd)
    function confirmarGravacaoPlanilha(dadosRetorno, fallbackQtd){
      const doc =
        (dadosRetorno && (dadosRetorno.documento || dadosRetorno.numeroDocumento || dadosRetorno.doc || dadosRetorno.documentNumber)) || "";

      // ‚úÖ ajuste importante: sua API devolve totalItens (e antes n√£o era lido)
      const qtd =
        Number(
          dadosRetorno && (
            dadosRetorno.qtdItens ||
            dadosRetorno.totalItens ||
            dadosRetorno.qtd ||
            dadosRetorno.itens ||
            dadosRetorno.count
          )
        ) || Number(fallbackQtd || 0);

      if (doc && qtd > 0) return { ok:true, documento: String(doc), qtdItens: qtd };
      return { ok:false, documento:"", qtdItens:0 };
    }

    async function finalizarBono() {
      capturarBaseDoFormulario();

      const dataHoraPlanilha = formatarDataHoraParaPlanilha(estado.data, estado.hora);
      if (!dataHoraPlanilha) { setMsg("Preencha a Data e o Hor√°rio do bono.", false); return; }
      if (!estado.encarregado) { setMsg("Informe o nome do respons√°vel que fez o acompanhamento.", false); return; }

      const tipoAtual = document.getElementById("tipoLancamento").value;
      if (!tipoAtual) { setMsg("Selecione um tipo", false); return; }

      if (tipoAtual === "RECEBIMENTO" && !estado.fornecedor) {
        setMsg('Informe o "Fornecedor" (obrigat√≥rio para Recebimento de mercadorias).', false);
        return;
      }

      if (!estado.itens.length) { setMsg("A lista est√° vazia. Adicione item's.", false); return; }

      aplicarTipoEDestinoNosItens();

      const destinoAtual = document.getElementById("lojaDestino").value;
      if (tipoAtual === "MOV_INTERNA" && !destinoAtual) {
        setMsg("Selecione a loja de destino (Movimenta√ß√£o interna).", false);
        return;
      }

      const tipoNoEnvio = tipoAtual;
      const destinoNoEnvio = destinoAtual;
      const itensNoEnvio = Array.isArray(estado.itens) ? estado.itens.map(it => ({ ...it })) : [];

      const payload = {
        dataHoraEscolhida: dataHoraPlanilha,
        encarregado: estado.encarregado,
        fornecedor: (tipoAtual === "RECEBIMENTO" ? estado.fornecedor : ""),
        placaVeiculo: (estado.placaVeiculo || ""),
        itens: estado.itens.map(x => ({
          produto: x.produto,
          quantidade: x.quantidadeFmt,
          embalagem: x.embalagem,
          tipoLancamento: x.tipoLancamento,
          lojaDestino: x.lojaDestino || "",
          fornecedor: (tipoAtual === "RECEBIMENTO" ? estado.fornecedor : "")
        }))
      };

      setMsg("Salvando... aguarde.", true);

      showLoading();
      startLoadingTimer();

      try {
        const resp = await fetch("/api/bono-salvar", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json", "Accept": "application/json" },
          body: JSON.stringify(payload)
        });

        const dados = await resp.json().catch(() => null);

        // ‚úÖ AJUSTE #1: diferenciar ‚Äúfalha ao salvar‚Äù vs ‚Äúsalvou mas n√£o confirmou‚Äù
        if (!resp.ok || !dados || !dados.sucesso) {
          const m =
            (dados && (dados.message || dados.mensagem)) ? (dados.message || dados.mensagem) :
            "Falha ao salvar o bono.";

          stopLoadingTimer();
          setLoadingPct(100);
          hideLoading();

          const texto = String(m || "");
          const pareceConfirmacao =
            /n√£o foi poss√≠vel confirmar/i.test(texto) ||
            /confirmar a leitura/i.test(texto) ||
            /verifique na tela de visualiza√ß√£o/i.test(texto);

          if (pareceConfirmacao) {
            setMsg("Bono registrado, mas n√£o foi poss√≠vel confirmar na base de dados em at√© 10s. Verifique na tela de visualiza√ß√£o.", false);
          } else {
            setMsg(texto, false);
          }
          return;
        }

        stopLoadingTimer();
        setLoadingPct(100);
        setTimeout(() => hideLoading(), 250);

        const conf = confirmarGravacaoPlanilha(dados, payload.itens.length);
        if (!conf.ok) {
          setMsg("Bono salvo, mas a confirma√ß√£o (Documento + Qtd) n√£o veio do backend. Verifique a API.", false);
          return;
        }

        const textoConfirmacaoBase =
          `‚úÖ Confirmado na base de dados\nDocumento: ${conf.documento}\nQtd de itens: ${conf.qtdItens}`;

        // ==========================================
        // ‚úÖ RECEBIMENTO: popup s√≥ de confirma√ß√£o (sem Whats, sem pr√©via, sem pergunta, Cancelar vira OK)
        // ==========================================
        if (tipoNoEnvio === "RECEBIMENTO") {
          abrirModalPreviewWhats("", "", "RECEBIMENTO"); // üîß modo RECEBIMENTO
          setConfirmBox("ok", textoConfirmacaoBase);
          habilitarBotoesWhats({ podeAbrirWhats:false, podeCancelar:true });

          limparTelaAposConfirmacao();
          setMsg("Bono finalizado e confirmado.", true);
          return;
        }

        // ==========================================
        // ‚úÖ MOVIMENTA√á√ÉO INTERNA: mant√©m popup com pr√©via + Whats
        // ==========================================
        if (tipoNoEnvio === "MOV_INTERNA" && destinoNoEnvio) {
          const telefoneResp = await buscarTelefoneResponsavel(destinoNoEnvio);

          const linkLogin = montarLinkLoginAbsoluto();
          const msgWhats = montarMensagemWhats({
            lojaOrigem: (sessaoAtual && sessaoAtual.loja) ? sessaoAtual.loja : "",
            lojaDestino: destinoNoEnvio,
            usuario: (sessaoAtual && sessaoAtual.usuario) ? sessaoAtual.usuario : "",
            dataHora: dataHoraPlanilha,
            linkLogin,
            placaVeiculo: (estado.placaVeiculo || ""),
            itens: itensNoEnvio
          });

          abrirModalPreviewWhats(telefoneResp || "", msgWhats, "MOV_INTERNA");

          const temTelValido = !!normalizarTelefoneParaWa(telefoneResp);

          if (!temTelValido) {
            setConfirmBox("ok", `${textoConfirmacaoBase}\n\n‚ö† N√£o foi encontrado o n√∫mero de WhatsApp da loja destino.`);
            habilitarBotoesWhats({ podeAbrirWhats:false, podeCancelar:true });
            setMsg("Bono confirmado. WhatsApp da loja destino n√£o encontrado.", false);
          } else {
            setConfirmBox("ok", textoConfirmacaoBase);
            habilitarBotoesWhats({ podeAbrirWhats:true, podeCancelar:true });
            setMsg("Bono finalizado, confirmado e pronto para notificar.", true);
          }

          limparTelaAposConfirmacao();
          return;
        }

        setMsg("Bono confirmado.", true);
        limparTelaAposConfirmacao();

      } catch (e) {
        console.error(e);

        stopLoadingTimer();
        setLoadingPct(100);
        hideLoading();

        setMsg("Erro de rede ao salvar. Tente novamente.", false);
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("btnVoltarMenu").addEventListener("click", () => {
        window.location.href = ROTAS.menu;
      });

      document.getElementById("btnContinuar").addEventListener("click", () => {
        fecharModal("modalPendente");
        atualizarCamposNaTela();
        atualizarVisibilidadeDestinoFornecedorEPlaca();
        renderLista();
      });

      document.getElementById("btnDescartar").addEventListener("click", () => {
        limparLocal();
        estado = { data:"", hora:"", encarregado:"", fornecedor:"", placaVeiculo:"", itens:[] };
        fecharModal("modalPendente");
        atualizarCamposNaTela();
        atualizarVisibilidadeDestinoFornecedorEPlaca();
        renderLista();
        setMsg("Pend√™ncia descartada. Voc√™ pode iniciar um novo bono.", true);
      });

      document.getElementById("btnConfirmarNao").addEventListener("click", () => {
        fecharModal("modalConfirmar");
      });

      document.getElementById("btnConfirmarSim").addEventListener("click", async () => {
        fecharModal("modalConfirmar");
        await finalizarBono();
      });

      // ‚úÖ Bot√µes do modal
      document.getElementById("btnCancelarWhats").addEventListener("click", () => {
        fecharModal("modalWhatsPreview");
        waDraft = { telefone: "", mensagem: "" };
      });

      document.getElementById("btnAbrirWhats").addEventListener("click", () => {
        const okAbrir = abrirWhatsAppComMensagem(waDraft.telefone, waDraft.mensagem);
        if (!okAbrir) {
          setMsg("N√£o foi poss√≠vel abrir o WhatsApp (telefone inv√°lido).", false);
        }
      });

      ["dataEscolhida","horaEscolhida","encarregado"].forEach(id => {
        document.getElementById(id).addEventListener("change", capturarBaseDoFormulario);
        document.getElementById(id).addEventListener("input", capturarBaseDoFormulario);
      });

      document.getElementById("fornecedor").addEventListener("change", capturarBaseDoFormulario);
      document.getElementById("fornecedor").addEventListener("input", capturarBaseDoFormulario);

      // ‚úÖ placa: normaliza em tempo real
      document.getElementById("placaVeiculo").addEventListener("input", (e) => {
        const el = e.target;
        const norm = normalizarPlaca(el.value);
        if (el.value !== norm) el.value = norm;
        capturarBaseDoFormulario();
      });

      document.getElementById("tipoLancamento").addEventListener("change", () => {
        atualizarVisibilidadeDestinoFornecedorEPlaca();
        capturarBaseDoFormulario();
        aplicarTipoEDestinoNosItens();
      });

      document.getElementById("lojaDestino").addEventListener("change", () => {
        capturarBaseDoFormulario();
        aplicarTipoEDestinoNosItens();
      });

      const elQtd = document.getElementById("quantidade");
      elQtd.addEventListener("keydown", bloquearPontuacao);
      elQtd.addEventListener("input", () => {
        aplicarMascaraQuantidade();
        capturarBaseDoFormulario();
      });

      document.getElementById("embalagem").addEventListener("change", () => {
        atualizarHabilitacaoQuantidade();
        aplicarMascaraQuantidade();
        capturarBaseDoFormulario();
      });

      document.getElementById("btnAdicionar").addEventListener("click", () => {
        const dadosItem = validarParaAdicionarItem();
        if (!dadosItem) return;

        estado.itens.push({
          produto: dadosItem.produto,
          quantidade: dadosItem.quantidadeNum,
          quantidadeFmt: dadosItem.quantidadeFmt,
          embalagem: dadosItem.embalagem,
          tipoLancamento: dadosItem.tipoLancamento,
          lojaDestino: dadosItem.lojaDestino,
          fornecedor: dadosItem.fornecedor || ""
        });

        salvarLocal();
        renderLista();

        document.getElementById("produto").value = "";
        document.getElementById("quantidade").value = "";
        document.getElementById("quantidade").dataset.digits = "";

        setMsg("Item adicionado na lista.", true);
      });

      document.getElementById("btnSalvar").addEventListener("click", () => {
        const tipoAtual = document.getElementById("tipoLancamento").value;
        if (!tipoAtual) {
          setMsg("Selecione um tipo", false);
          return;
        }

        if (tipoAtual === "RECEBIMENTO") {
          capturarBaseDoFormulario();
          if (!estado.fornecedor) {
            setMsg('Informe o "Fornecedor" (obrigat√≥rio para Recebimento de mercadorias).', false);
            return;
          }
        }

        if (!estado.itens.length) {
          setMsg("N√£o √© poss√≠vel salvar lista vazia. Adicione item's antes.", false);
          return;
        }

        abrirModal("modalConfirmar");
      });

      const sessao = await obterSessaoDoBackend();
      if (!sessao) return redirecionarParaLogin("Sess√£o inv√°lida. Fa√ßa login para acessar.");

      aplicarSessaoNaTela(sessao);

      atualizarVisibilidadeDestinoFornecedorEPlaca();

      const pendente = carregarLocal();
      if (temPendenciaValida(pendente)) {
        estado = pendente;
        atualizarCamposNaTela();
        atualizarVisibilidadeDestinoFornecedorEPlaca();
        abrirModal("modalPendente");
      } else {
        atualizarCamposNaTela();
        atualizarVisibilidadeDestinoFornecedorEPlaca();
        renderLista();
      }

      atualizarHabilitacaoQuantidade();
    });

    // (mantido) - fun√ß√µes usadas antes e ainda necess√°rias
    function redirecionarParaLogin(motivo) {
      if (motivo) setMsg(motivo, false);
      window.location.href = ROTAS.login;
    }

    function bloquearPontuacao(e){
      const k = e.key;
      if (k === "." || k === "," || k === ";" || k === "-" || k === "+" ) {
        e.preventDefault();
      }
    }
  </script>
</body>
</html>

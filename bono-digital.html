<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BONO DIGITAL</title>

  <style>
    body{
      background:#f3f3f3;
      font-family: Arial, sans-serif;
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:100vh;
      margin:2px;
      color:#111;
    }

    .container{
      width: 92%;
      max-width: 640px;
      background:#fff;
      padding: 22px 22px 18px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      box-sizing: border-box;
    }

    .titulo{
      text-align:center;
      margin: 10px 0 10px; /* ‚úÖ t√≠tulo abaixo da linha */
      font-size: 24px;
      font-weight: 800;
      letter-spacing: .2px;
    }

    /* ‚úÖ logo + linha discreta */
    .logo-wrap{
      display:flex;
      flex-direction: column;
      align-items:center;
      margin: 6px 0 0;
    }
    .logo-wrap img{
      max-width: 220px;
      width: 70%;
      height: auto;
      display:block;
    }
    .logo-line{
      width: 100%;
      border: none;
      border-top: 1px solid #ededed;
      margin: 10px 0 0;
    }

    .card-info{
      background: #f7f7f7;
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      padding: 12px 12px;
      margin-bottom: 14px;
      font-size: 13px;
      line-height: 1.45;
    }

    .linha{
      display:flex;
      justify-content: space-between;
      gap: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .k{ color:#555; font-weight:700; }
    .v{ font-weight:800; overflow:hidden; text-overflow:ellipsis; }

    .secao{
      margin-top: 12px;
      border: 1px solid #ececec;
      border-radius: 12px;
      padding: 12px;
      background: #fff;
    }

    .secao-titulo{
      font-size: 14px;
      font-weight: 900;
      margin: 0 0 10px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .grid-1{ grid-template-columns: 1fr; }

    .grid-2-fixo{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .grid-3-fixo{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }

    .btn-row-2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .btn-row-2 .btn{ margin-top: 0; }

    label{
      display:block;
      font-size: 12px;
      font-weight: 800;
      color:#333;
      margin-bottom: 6px;
    }

    input, select, textarea{
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
      outline: none;
      background:#fff;
    }

    textarea{ min-height: 44px; resize: vertical; }

    .btn{
      width:100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 800;
      margin-top: 10px;
    }

    .btn-sec{ background:#e9e9e9; color:#111; }
    .btn-sec:hover{ background:#dedede; }

    .btn-pri{ background:#111; color:#fff; }
    .btn-pri:hover{ opacity:.92; }

    .btn-warn{ background:#b30000; color:#fff; }
    .btn-warn:hover{ opacity:.92; }

    .mensagem{
      margin-top: 12px;
      text-align:center;
      font-weight:800;
      font-size: 13px;
      min-height: 18px;
      color:#b30000;
    }

    .ok{ color:#0b6b2f; }

    .lista{
      margin-top: 10px;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }

    .item{
      display:flex;
      justify-content: space-between;
      align-items:flex-start;
      gap: 10px;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 10px;
      margin-bottom: 8px;
      background:#fafafa;
    }

    .item .txt{
      flex: 1;
      font-size: 13px;
      line-height: 1.35;
    }

    .item .txt b{ font-size: 13px; }

    .btn-mini{
      border: none;
      border-radius: 10px;
      padding: 10px 10px;
      cursor: pointer;
      font-weight: 900;
      font-size: 12px;
      background:#e9e9e9;
    }
    .btn-mini:hover{ background:#dedede; }

    .hidden{ display:none !important; }

    /* ===== Modais ===== */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.45);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 9999;
      padding: 14px;
    }

    .modal{
      width: 100%;
      max-width: 420px;
      background:#fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }

    .modal h3{
      margin:0 0 8px;
      font-size: 16px;
      font-weight: 900;
    }

    .modal p{
      margin:0 0 12px;
      font-size: 13px;
      font-weight: 700;
      color:#222;
      line-height: 1.35;
    }

    .row-btn{
      display:flex;
      gap: 10px;
    }
    .row-btn .btn{ margin-top: 0; }

    /* ‚úÖ overlay de carregamento com barra */
    .load-overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.45);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 10050;
      padding: 14px;
    }
    .load-box{
      width: 100%;
      max-width: 420px;
      background:#fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .load-title{
      margin:0 0 10px;
      font-size: 14px;
      font-weight: 900;
      text-align:center;
    }
    .load-bar{
      width: 100%;
      height: 12px;
      border-radius: 999px;
      background: #eee;
      overflow:hidden;
      border: 1px solid #e3e3e3;
    }
    .load-fill{
      height: 100%;
      width: 0%;
      background: #111;
      transition: width .18s ease;
    }
    .load-pct{
      margin-top: 10px;
      text-align:center;
      font-weight: 900;
      font-size: 13px;
      color:#111;
    }

    @media (max-width: 520px){
      .grid{ grid-template-columns: 1fr; }
      .grid-2-fixo{ grid-template-columns: 1fr 1fr; }
      .grid-3-fixo{ grid-template-columns: 1fr 1fr 1fr; }
      .btn-row-2{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="logo-wrap">
      <img src="https://i.ibb.co/prMfd6Fs/IMG-20260121-161142.png" alt="Logo" />
      <hr class="logo-line" />
    </div>

    <h2 class="titulo">BONO DIGITAL</h2>

    <div class="card-info" id="cardInfo">
      <div class="linha"><span class="k">Loja:</span> <span class="v" id="infoLoja">‚Äî</span></div>
      <div class="linha"><span class="k">Usu√°rio:</span> <span class="v" id="infoUsuario">‚Äî</span></div>
    </div>

    <div class="secao">
      <div class="secao-titulo">Dados do lan√ßamento</div>

      <div class="grid-2-fixo">
        <div>
          <label for="dataEscolhida">Data</label>
          <input type="date" id="dataEscolhida" />
        </div>

        <div>
          <label for="horaEscolhida">Hor√°rio</label>
          <input type="time" id="horaEscolhida" />
        </div>
      </div>

      <div class="grid grid-1" style="margin-top:10px;">
        <div>
          <label for="encarregado">Responsavel (Opera√ß√£o)</label>
          <input type="text" id="encarregado" placeholder="Nome e sobrenome do responsavel que acompanhou." maxlength="80" />
        </div>
      </div>

      <div class="grid grid-1" style="margin-top:10px;">
        <div>
          <label for="produto">Descri√ß√£o</label>
          <textarea id="produto" placeholder="Ex: Arroz flora 5kg" maxlength="200"></textarea>
        </div>
      </div>

      <div class="grid-3-fixo" style="margin-top:10px;">
        <!-- ‚úÖ (1) TROCA: Embalagem vem antes da Qtd. -->
        <div>
          <label for="embalagem">Embalagem</label>
          <select id="embalagem">
            <option value="">Embalagem</option>
            <option value="KG">KG</option>
            <option value="UND">UND</option>
          </select>
        </div>

        <div>
          <label for="quantidade">Qtd.</label>
          <input
            type="text"
            id="quantidade"
            inputmode="numeric"
            autocomplete="off"
            placeholder="Ex: 2"
          />
        </div>

        <div>
          <label for="tipoLancamento">Tipo</label>
          <select id="tipoLancamento">
            <option value="">Tipo</option>
            <option value="RECEBIMENTO">Recebimento de mercadorias</option>
            <option value="MOV_INTERNA">Movimenta√ß√£o interna</option>
          </select>
        </div>
      </div>

      <div class="grid grid-1 hidden" style="margin-top:10px;" id="wrapDestino">
        <div>
          <label for="lojaDestino">Para onde est√° transferindo?</label>
          <select id="lojaDestino">
            <option value="">Selecione</option>
            <option value="BIG 01 - 106 NORTE">BIG 01 - 106 NORTE</option>
            <option value="BIG 02 - 402 NORTE">BIG 02 - 402 NORTE</option>
            <option value="BIG 03 - 413 SUL">BIG 03 - 413 SUL</option>
            <option value="BIG 04 - 301 SW">BIG 04 - 301 SW</option>
            <option value="BIG 05 - 408 NORTE">BIG 05 - 408 NORTE</option>
            <option value="BIG 06 - SIBERIA">BIG 06 - SIBERIA</option>
            <option value="BIG 08 - 503 SUL">BIG 08 - 503 SUL</option>
            <option value="BIG 09 - PEN√çNSULA">BIG 09 - PEN√çNSULA</option>
            <option value="BIG 10 - PAINEIRAS">BIG 10 - PAINEIRAS</option>
            <option value="BIG 11 - 310 NORTE">BIG 11 - 310 NORTE</option>
            <option value="BIG 12 - 208 NORTE">BIG 12 - 208 NORTE</option>
            <option value="BIG 13 - QI-05 L. NORTE">BIG 13 - QI-05 L. NORTE</option>
            <option value="BIG 14 - 508 SUL">BIG 14 - 508 SUL</option>
            <option value="BIG 15 - 105 SW">BIG 15 - 105 SW</option>
            <option value="BIG 16 - 512 SUL">BIG 16 - 512 SUL</option>
            <option value="BIG 17 - QI-11 LAGO SUL">BIG 17 - QI-11 LAGO SUL</option>
            <option value="BIG 18 - 211 NORTE">BIG 18 - 211 NORTE</option>
            <option value="BIG 19 - CASTANHEIRA">BIG 19 - CASTANHEIRA</option>
            <option value="BIG 20 - TAGUATINGA C1">BIG 20 - TAGUATINGA C1</option>
            <option value="BIG 21 - CNB12">BIG 21 - CNB12</option>
            <option value="BIG 22 - 102 NOROESTE">BIG 22 - 102 NOROESTE</option>
            <option value="BIG 23 - QI-23 LAGO SUL">BIG 23 - QI-23 LAGO SUL</option>
            <option value="BIG 24 - 314 NORTE">BIG 24 - 314 NORTE</option>
            <option value="BIG 25 - 410 SUL">BIG 25 - 410 SUL</option>

            <option value="ULT 01 - PLANALTINA">ULT 01 - PLANALTINA</option>
            <option value="ULT 02 - GAMA">ULT 02 - GAMA</option>
            <option value="ULT 03 - COLORADO">ULT 03 - COLORADO</option>
            <option value="ULT 04 - CEI SUL">ULT 04 - CEI SUL</option>
            <option value="ULT 05 - POLO JK">ULT 05 - POLO JK</option>
            <option value="ULT 06 - SOBRADINHO">ULT 06 - SOBRADINHO</option>
            <option value="ULT 07 - ADE">ULT 07 - ADE</option>
            <option value="ULT 08 - ARAPOANGA">ULT 08 - ARAPOANGA</option>
            <option value="ULT 09 - CEI NORTE">ULT 09 - CEI NORTE</option>
            <option value="ULT 10 - ESTRUTURAL">ULT 10 - ESTRUTURAL</option>
            <option value="ULT 11 - ITAPOA">ULT 11 - ITAPOA</option>
            <option value="ULT 12 - SAO SEBASTIAO">ULT 12 - SAO SEBASTIAO</option>
            <option value="ULT 13 - RECANTO">ULT 13 - RECANTO</option>
            <option value="ULT 14 - AGUAS LINDAS">ULT 14 - AGUAS LINDAS</option>
            <option value="ULT 15 - SOL NASCENTE">ULT 15 - SOL NASCENTE</option>
            <option value="ULT 16 - PARANOA PARK">ULT 16 - PARANOA PARK</option>
            <option value="ULT 17 - SAMAMBAIA">ULT 17 - SAMAMBAIA</option>
            <option value="ULT 18 - BRAZLANDIA">ULT 18 - BRAZLANDIA</option>
            <option value="ULT 19 - VIA PARK">ULT 19 - VIA PARK</option>
            <option value="ULT 20 - TAGUATINGA">ULT 20 - TAGUATINGA</option>
            <option value="ULT 22 - VICENTE PIRES">ULT 22 - VICENTE PIRES</option>
            <option value="ULT 23 - SANTA MARIA">ULT 23 - SANTA MARIA</option>
            <option value="ULT 24 - PAUL BRASIL">ULT 24 - PAUL BRASIL</option>
            <option value="ULT 25 - BRASILINHA">ULT 25 - BRASILINHA</option>

            <option value="TOTAL DISTRIBUICAO">TOTAL DISTRIBUICAO</option>
            <option value="INDUSPAN">INDUSPAN</option>
            <option value="MATRIZ">MATRIZ</option>
          </select>
        </div>
      </div>

      <!-- ‚úÖ NOVO: Fornecedor (s√≥ aparece quando Tipo = RECEBIMENTO) -->
      <div class="grid grid-1 hidden" style="margin-top:10px;" id="wrapFornecedor">
        <div>
          <label for="fornecedor">Fornecedor</label>
          <input type="text" id="fornecedor" placeholder="Informe o fornecedor" maxlength="80" />
        </div>
      </div>

      <div class="btn-row-2">
        <button class="btn btn-sec" id="btnAdicionar">Adicionar item</button>
        <button class="btn btn-pri" id="btnSalvar">Salvar Bono</button>
      </div>

      <button class="btn btn-sec" id="btnVoltarMenu">Voltar ao menu</button>

      <div class="mensagem" id="msg"></div>

      <div class="lista hidden" id="listaWrap">
        <div class="secao-titulo" style="margin:0 0 8px;">Itens adicionados</div>
        <div id="listaItens"></div>
      </div>
    </div>
  </div>

  <div class="overlay hidden" id="modalPendente">
    <div class="modal">
      <h3>Bono pendente de finaliza√ß√£o</h3>
      <p>Foi encontrado um bono n√£o finalizado. Deseja continuar de onde parou ou descartar e iniciar um novo?</p>
      <div class="row-btn">
        <button class="btn btn-pri" id="btnContinuar">Continuar</button>
        <button class="btn btn-warn" id="btnDescartar">Descartar</button>
      </div>
    </div>
  </div>

  <div class="overlay hidden" id="modalConfirmar">
    <div class="modal">
      <h3>Finalizar Bono</h3>
      <p>Tem certeza que deseja finalizar o Bono?</p>
      <div class="row-btn">
        <button class="btn btn-pri" id="btnConfirmarSim">Sim</button>
        <button class="btn btn-sec" id="btnConfirmarNao">N√£o</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ overlay de carregamento -->
  <div class="load-overlay hidden" id="loadingOverlay" aria-live="polite">
    <div class="load-box">
      <div class="load-title">Enviando informa√ß√µes...</div>
      <div class="load-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div class="load-fill" id="loadFill"></div>
      </div>
      <div class="load-pct" id="loadPct">0%</div>
    </div>
  </div>

  <script>
    const ROTAS = { menu: "/menu.html", login: "/login.html" };
    const LS_KEY = "PPP_BONO_PENDENTE_V1";

    let sessaoAtual = null;
    let expTimerId = null;

    // ‚úÖ NOVO: fornecedor no estado (persist√™ncia)
    let estado = { data: "", hora: "", encarregado: "", fornecedor: "", itens: [] };

    function setTexto(id, txt) {
      const el = document.getElementById(id);
      if (el) el.textContent = txt;
    }

    function setMsg(txt, ok=false){
      const el = document.getElementById("msg");
      el.textContent = txt || "";
      el.classList.toggle("ok", !!ok);
    }

    async function obterSessaoDoBackend() {
      try {
        const resp = await fetch("/api/session", {
          method: "GET",
          credentials: "include",
          headers: { "Accept": "application/json" }
        });
        if (!resp.ok) return null;

        const dados = await resp.json().catch(() => null);
        if (!dados || !dados.sucesso || !dados.usuario || !dados.loja) return null;
        return dados;
      } catch (e) {
        console.error("[BONO] Falha ao consultar /api/session:", e);
        return null;
      }
    }

    function normalizarExpParaMs(exp) {
      const n = Number(exp);
      if (!Number.isFinite(n) || n <= 0) return null;
      if (n < 10_000_000_000) return n * 1000;
      return n;
    }

    function limparTimerExpiracao() {
      if (expTimerId) {
        clearTimeout(expTimerId);
        expTimerId = null;
      }
    }

    function redirecionarParaLogin(motivo) {
      if (motivo) setMsg(motivo, false);
      window.location.href = ROTAS.login;
    }

    function agendarRedirecionamentoNaExpiracao(expMs) {
      limparTimerExpiracao();
      if (!expMs) return;

      const msRestante = expMs - Date.now();
      if (msRestante <= 0) {
        redirecionarParaLogin("Sess√£o expirada. Fa√ßa login novamente.");
        return;
      }
      expTimerId = setTimeout(() => {
        redirecionarParaLogin("Sess√£o expirada. Fa√ßa login novamente.");
      }, msRestante);
    }

    /* =========================================================
       ‚úÖ NOVO: bloquear sele√ß√£o da pr√≥pria loja (origem)
       - desabilita a op√ß√£o do <select id="lojaDestino"> que
         corresponde √† loja da sess√£o (sessaoAtual.loja)
    ========================================================= */
    function normalizarLojaComparacao(s){
      return String(s || "").trim().toUpperCase().replace(/\s+/g, " ");
    }

    function bloquearLojaOrigemNoDestino(){
      const sel = document.getElementById("lojaDestino");
      if (!sel || !sessaoAtual || !sessaoAtual.loja) return;

      const origemN = normalizarLojaComparacao(sessaoAtual.loja);

      Array.from(sel.options).forEach(opt => {
        if (!opt.value) return; // mant√©m "Selecione"
        const optN = normalizarLojaComparacao(opt.value);
        opt.disabled = (optN === origemN);
      });

      // Se por algum motivo j√° estiver selecionada a pr√≥pria loja, limpa.
      if (sel.value && normalizarLojaComparacao(sel.value) === origemN) {
        sel.value = "";
      }
    }

    function aplicarSessaoNaTela(sessao) {
      sessaoAtual = sessao;
      setTexto("infoLoja", sessao.loja || "‚Äî");
      setTexto("infoUsuario", sessao.usuario || "‚Äî");

      const expMs = normalizarExpParaMs(sessao.exp);
      if (expMs) agendarRedirecionamentoNaExpiracao(expMs);

      // ‚úÖ NOVO: aplica bloqueio da loja de origem no seletor de destino
      bloquearLojaOrigemNoDestino();
    }

    /* ===== Persist√™ncia ===== */
    function salvarLocal() {
      try {
        localStorage.setItem(LS_KEY, JSON.stringify(estado));
      } catch (e) {
        console.warn("[BONO] N√£o foi poss√≠vel salvar no localStorage:", e);
      }
    }

    function carregarLocal() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || typeof obj !== "object") return null;
        if (!Array.isArray(obj.itens)) obj.itens = [];
        if (typeof obj.fornecedor !== "string") obj.fornecedor = "";
        return obj;
      } catch (e) {
        return null;
      }
    }

    function limparLocal() {
      try { localStorage.removeItem(LS_KEY); } catch(e) {}
    }

    function temPendenciaValida(obj) {
      if (!obj) return false;
      const temAlgo = (obj.data || obj.hora || obj.encarregado || obj.fornecedor || (obj.itens && obj.itens.length));
      return !!temAlgo;
    }

    /* ===== Util ===== */
    function pad2(n){ return String(n).padStart(2, "0"); }

    function formatarDataHoraParaPlanilha(dataYYYYMMDD, horaHHMM) {
      if (!dataYYYYMMDD || !horaHHMM) return "";
      const [y,m,d] = dataYYYYMMDD.split("-");
      if (!y || !m || !d) return "";
      const [hh,mm] = horaHHMM.split(":");
      if (hh == null || mm == null) return "";
      return `${pad2(d)}/${pad2(m)}/${y} ${pad2(hh)}:${pad2(mm)}`;
    }

    function normalizarTexto(t) {
      return String(t || "").trim();
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function abrirModal(id) { document.getElementById(id).classList.remove("hidden"); }
    function fecharModal(id) { document.getElementById(id).classList.add("hidden"); }

    /* ===== Loading overlay + progresso ===== */
    let loadTimer = null;
    function showLoading(){
      document.getElementById("loadingOverlay").classList.remove("hidden");
      setLoadingPct(0);
    }
    function hideLoading(){
      document.getElementById("loadingOverlay").classList.add("hidden");
      stopLoadingTimer();
    }
    function setLoadingPct(pct){
      const p = Math.max(0, Math.min(100, Number(pct) || 0));
      document.getElementById("loadFill").style.width = p + "%";
      document.getElementById("loadPct").textContent = p + "%";
      const bar = document.querySelector(".load-bar");
      if (bar) bar.setAttribute("aria-valuenow", String(p));
    }
    function stopLoadingTimer(){
      if (loadTimer) { clearInterval(loadTimer); loadTimer = null; }
    }
    function startLoadingTimer(){
      stopLoadingTimer();
      let p = 0;
      setLoadingPct(p);
      loadTimer = setInterval(() => {
        if (p < 95) {
          p += 5;
          if (p > 95) p = 95;
          setLoadingPct(p);
        }
      }, 180);
    }

    function atualizarCamposNaTela() {
      document.getElementById("dataEscolhida").value = estado.data || "";
      document.getElementById("horaEscolhida").value = estado.hora || "";
      document.getElementById("encarregado").value = estado.encarregado || "";
      document.getElementById("fornecedor").value = estado.fornecedor || "";
    }

    function renderLista() {
      const wrap = document.getElementById("listaWrap");
      const lista = document.getElementById("listaItens");

      lista.innerHTML = "";

      if (!estado.itens.length) {
        wrap.classList.add("hidden");
        return;
      }
      wrap.classList.remove("hidden");

      estado.itens.forEach((it, idx) => {
        const div = document.createElement("div");
        div.className = "item";

        const txt = document.createElement("div");
        txt.className = "txt";

        const tipoLabel =
          it.tipoLancamento === "MOV_INTERNA"
            ? "Movimenta√ß√£o interna"
            : (it.tipoLancamento === "RECEBIMENTO" ? "Recebimento de mercadorias" : "");

        const destinoTxt = (it.tipoLancamento === "MOV_INTERNA" && it.lojaDestino)
          ? `<br/>Para onde: <b>${escapeHtml(it.lojaDestino)}</b>`
          : "";

        txt.innerHTML = `
          <b>Item ${idx + 1}</b><br/>
          Produto: <b>${escapeHtml(it.produto)}</b><br/>
          Quantidade: <b>${escapeHtml(String(it.quantidadeFmt || ""))}</b><br/>
          Embalagem: <b>${escapeHtml(it.embalagem)}</b><br/>
          Tipo: <b>${escapeHtml(tipoLabel)}</b>
          ${destinoTxt}
        `;

        const btn = document.createElement("button");
        btn.className = "btn-mini";
        btn.textContent = "Retirar";
        btn.addEventListener("click", () => {
          estado.itens.splice(idx, 1);
          salvarLocal();
          renderLista();
          setMsg("Item removido da lista.", true);
        });

        div.appendChild(txt);
        div.appendChild(btn);
        lista.appendChild(div);
      });
    }

    /* ===== Quantidade m√°scara ===== */
    function formatIntPtBR(n) {
      return new Intl.NumberFormat("pt-BR", { maximumFractionDigits: 0 }).format(n);
    }

    function formatKgFromDigits(digits) {
      if (!digits) return "";
      if (digits.length <= 3) {
        const n = Number(digits);
        if (!Number.isFinite(n)) return "";
        return formatIntPtBR(n);
      }
      const intPart = digits.slice(0, -3);
      const decPart = digits.slice(-3);
      const nInt = Number(intPart);
      if (!Number.isFinite(nInt)) return "";
      const intFmt = new Intl.NumberFormat("pt-BR", { maximumFractionDigits: 0 }).format(nInt);
      return `${intFmt},${decPart}`;
    }

    function quantidadeParaNumero(embalagem, digits) {
      if (!digits) return null;

      if (embalagem === "UND") {
        const n = Number(digits);
        if (!Number.isFinite(n) || n <= 0) return null;
        return n;
      }

      if (embalagem === "KG") {
        if (digits.length <= 3) {
          const n = Number(digits);
          if (!Number.isFinite(n) || n <= 0) return null;
          return n;
        }
        const intPart = digits.slice(0, -3);
        const decPart = digits.slice(-3);
        const n = Number(`${intPart}.${decPart}`);
        if (!Number.isFinite(n) || n <= 0) return null;
        return n;
      }

      return null;
    }

    function bloquearPontuacao(e){
      const k = e.key;
      if (k === "." || k === "," || k === ";" || k === "-" || k === "+" ) {
        e.preventDefault();
      }
    }

    function limparParaDigitos(value){
      return String(value || "").replace(/\D/g, "");
    }

    function aplicarMascaraQuantidade() {
      const el = document.getElementById("quantidade");
      const emb = document.getElementById("embalagem").value;

      const digits = limparParaDigitos(el.value);
      el.dataset.digits = digits;

      if (!digits) {
        el.value = "";
        return;
      }

      if (emb === "UND") {
        el.value = formatIntPtBR(Number(digits));
      } else if (emb === "KG") {
        el.value = formatKgFromDigits(digits);
      } else {
        el.value = digits;
      }
    }

    /* ‚úÖ (2) NOVO: Qtd s√≥ habilita ap√≥s escolher Embalagem */
    function atualizarHabilitacaoQuantidade() {
      const emb = document.getElementById("embalagem").value;
      const elQtd = document.getElementById("quantidade");

      const pode = (emb === "KG" || emb === "UND");

      elQtd.disabled = !pode;

      if (!pode) {
        elQtd.value = "";
        elQtd.dataset.digits = "";
      }
    }

    /* ===== Tipo / Destino ===== */
    function atualizarVisibilidadeDestino() {
      const tipo = document.getElementById("tipoLancamento").value;
      const wrap = document.getElementById("wrapDestino");
      const sel = document.getElementById("lojaDestino");

      if (tipo === "MOV_INTERNA") {
        wrap.classList.remove("hidden");
      } else {
        wrap.classList.add("hidden");
        sel.value = "";
      }
    }

    /* ‚úÖ NOVO: Fornecedor (visibilidade/obrigatoriedade din√¢mica) */
    function atualizarVisibilidadeFornecedor() {
      const tipo = document.getElementById("tipoLancamento").value;
      const wrap = document.getElementById("wrapFornecedor");
      const inp = document.getElementById("fornecedor");

      if (tipo === "RECEBIMENTO") {
        wrap.classList.remove("hidden");
      } else {
        wrap.classList.add("hidden");
        inp.value = "";
        // fornecedor n√£o √© obrigat√≥rio quando invis√≠vel e deve sair do estado
        estado.fornecedor = "";
        salvarLocal();
      }
    }

    function aplicarTipoEDestinoNosItens() {
      if (!estado.itens.length) return;

      const tipoAtual = document.getElementById("tipoLancamento").value;
      const destinoAtual = document.getElementById("lojaDestino").value;

      estado.itens = estado.itens.map(it => {
        const novo = { ...it, tipoLancamento: tipoAtual || it.tipoLancamento };

        if (tipoAtual === "MOV_INTERNA") {
          novo.lojaDestino = destinoAtual || it.lojaDestino || "";
        } else if (tipoAtual === "RECEBIMENTO") {
          novo.lojaDestino = "";
        }
        return novo;
      });

      salvarLocal();
      renderLista();
      setMsg("Itens atualizados com o Tipo/Destino selecionados.", true);
    }

    /* ===== WhatsApp (AUTO) ===== */
    function normalizarTelefoneParaWa(dado) {
      const digits = String(dado || "").replace(/\D/g, "");
      if (!digits) return "";

      // Se j√° vem com DDI 55
      if (digits.startsWith("55") && (digits.length === 12 || digits.length === 13)) return digits;

      // Se veio s√≥ com DDD+numero (10 ou 11 d√≠gitos)
      if (digits.length === 10 || digits.length === 11) return "55" + digits;

      // Se veio com outro padr√£o, devolve o que tem (melhor do que quebrar)
      return digits;
    }

    function montarLinkLoginAbsoluto() {
      try {
        return new URL(ROTAS.login, window.location.origin).toString();
      } catch (e) {
        return window.location.origin + ROTAS.login;
      }
    }

    function montarMensagemWhats({
      lojaOrigem,
      lojaDestino,
      usuario,
      dataHora,
      linkLogin,
      itens = []
    }) {
      const linhas = [];

      linhas.push("üö® *BONO DE MOVIMENTA√á√ÉO INTERNA PENDENTE PARA APROVA√á√ÉO*");
      linhas.push("");

      linhas.push(`üìç *Destino:* ${lojaDestino || "‚Äî"}`);
      linhas.push(`üè™ *Origem:* ${lojaOrigem || "‚Äî"}`);
      linhas.push(`üë§ *Usu√°rio:* ${usuario || "‚Äî"}`);
      linhas.push(`üïí *Data/Hora:* ${dataHora || "‚Äî"}`);
      linhas.push("");

      linhas.push("üì¶ *Itens do Bono:*");

      if (Array.isArray(itens) && itens.length) {
        itens.forEach((it, idx) => {
          const qtd = (it && (it.quantidadeFmt || it.quantidade)) ? (it.quantidadeFmt || it.quantidade) : "‚Äî";
          const emb = (it && it.embalagem) ? it.embalagem : "";
          const prod = (it && it.produto) ? it.produto : "‚Äî";
          linhas.push(`‚Ä¢ ${idx + 1}. ${prod} ‚Äî ${qtd} ${emb}`.trim());
        });
      } else {
        linhas.push("‚Ä¢ Nenhum item informado");
      }

      linhas.push("");
      linhas.push("üîó *Acesse para aprovar:*");
      linhas.push(linkLogin || "‚Äî");

      return linhas.join("\n");
    }

    async function buscarTelefoneResponsavel(lojaDestino) {
      const loja = normalizarTexto(lojaDestino);
      if (!loja) return "";

      try {
        const resp = await fetch(`/api/bono-contato?loja=${encodeURIComponent(loja)}`, {
          method: "GET",
          credentials: "include",
          headers: { "Accept": "application/json" }
        });
        if (!resp.ok) return "";

        const dados = await resp.json().catch(() => null);
        if (!dados || !dados.sucesso) return "";

        return String(dados.whatsapp || "");
      } catch (e) {
        console.error("[BONO] Falha ao buscar contato:", e);
        return "";
      }
    }

    function abrirWhatsAppComMensagem(telefone55, mensagem) {
      const tel = normalizarTelefoneParaWa(telefone55);
      if (!tel) return false;

      // Melhor esfor√ßo: tenta abrir no app via scheme e faz fallback para wa.me
      const urlApp = `whatsapp://send?phone=${tel}&text=${encodeURIComponent(mensagem)}`;
      const urlWeb = `https://wa.me/${tel}?text=${encodeURIComponent(mensagem)}`;

      // ‚úÖ CORRE√á√ÉO: N√ÉO trocar a p√°gina do Bono (n√£o usar window.location.href)
      // Abre em nova aba/janela para manter o Bono aberto ao voltar.
      const opened = window.open(urlApp, "_blank");

      if (!opened) {
        window.open(urlWeb, "_blank");
      } else {
        // fallback leve: alguns aparelhos ignoram whatsapp:// em _blank
        setTimeout(() => {
          try { window.open(urlWeb, "_blank"); } catch(e) {}
        }, 500);
      }

      return true;
    }

    /* ===== A√ß√µes ===== */
    function capturarBaseDoFormulario() {
      estado.data = document.getElementById("dataEscolhida").value || "";
      estado.hora = document.getElementById("horaEscolhida").value || "";
      estado.encarregado = normalizarTexto(document.getElementById("encarregado").value);

      // ‚úÖ NOVO: fornecedor s√≥ √© relevante quando Tipo = RECEBIMENTO
      const tipoAtual = document.getElementById("tipoLancamento").value;
      if (tipoAtual === "RECEBIMENTO") {
        estado.fornecedor = normalizarTexto(document.getElementById("fornecedor").value);
      } else {
        estado.fornecedor = "";
      }

      salvarLocal();
    }

    function validarParaAdicionarItem() {
      capturarBaseDoFormulario();

      const dataHoraPlanilha = formatarDataHoraParaPlanilha(estado.data, estado.hora);
      if (!dataHoraPlanilha) { setMsg("Preencha a Data e o Hor√°rio do bono.", false); return false; }
      if (!estado.encarregado) { setMsg("Informe o nome do responsavel(opera√ß√£o) que fez o acompanhamento.", false); return false; }

      const produto = normalizarTexto(document.getElementById("produto").value);
      const embalagem = document.getElementById("embalagem").value;
      const tipoLancamento = document.getElementById("tipoLancamento").value;
      const lojaDestino = document.getElementById("lojaDestino").value;

      // ‚úÖ NOVO: fornecedor obrigat√≥rio apenas quando Tipo = RECEBIMENTO
      if (tipoLancamento === "RECEBIMENTO" && !estado.fornecedor) {
        setMsg('Informe o "Fornecedor" (obrigat√≥rio para Recebimento de mercadorias).', false);
        return false;
      }

      const digits = String(document.getElementById("quantidade").dataset.digits || "");
      const quantidadeNum = quantidadeParaNumero(embalagem, digits);
      const quantidadeFmt = document.getElementById("quantidade").value;

      if (!produto) { setMsg("Informe a descri√ß√£o.", false); return false; }
      if (embalagem !== "KG" && embalagem !== "UND") { setMsg("Selecione a embalagem (KG ou UND).", false); return false; }
      if (!tipoLancamento) { setMsg("Selecione um tipo", false); return false; }
      if (tipoLancamento === "MOV_INTERNA" && !lojaDestino) { setMsg("Selecione a loja de destino (Para onde est√° transferindo?).", false); return false; }
      if (!quantidadeNum) { setMsg("Informe uma quantidade v√°lida (maior que 0).", false); return false; }

      return {
        produto,
        embalagem,
        tipoLancamento,
        lojaDestino: (tipoLancamento === "MOV_INTERNA" ? lojaDestino : ""),
        quantidadeNum,
        quantidadeFmt,
        fornecedor: (tipoLancamento === "RECEBIMENTO" ? estado.fornecedor : "")
      };
    }

    async function finalizarBono() {
      capturarBaseDoFormulario();

      const dataHoraPlanilha = formatarDataHoraParaPlanilha(estado.data, estado.hora);
      if (!dataHoraPlanilha) { setMsg("Preencha a Data e o Hor√°rio do bono.", false); return; }
      if (!estado.encarregado) { setMsg("Informe o nome do responsavel(opera√ß√£o) que fez o acompanhamento.", false); return; }

      const tipoAtual = document.getElementById("tipoLancamento").value;
      if (!tipoAtual) { setMsg("Selecione um tipo", false); return; }

      // ‚úÖ NOVO: fornecedor obrigat√≥rio apenas quando Tipo = RECEBIMENTO
      if (tipoAtual === "RECEBIMENTO" && !estado.fornecedor) {
        setMsg('Informe o "Fornecedor" (obrigat√≥rio para Recebimento de mercadorias).', false);
        return;
      }

      if (!estado.itens.length) { setMsg("A lista est√° vazia. Adicione item's antes de salvar.", false); return; }

      aplicarTipoEDestinoNosItens();

      const destinoAtual = document.getElementById("lojaDestino").value;
      if (tipoAtual === "MOV_INTERNA" && !destinoAtual) {
        setMsg("Selecione a loja de destino antes de salvar (Movimenta√ß√£o interna).", false);
        return;
      }

      // ‚úÖ guarda antes de resetar (para WhatsApp p√≥s-sucesso)
      const tipoNoEnvio = tipoAtual;
      const destinoNoEnvio = destinoAtual;

      // ‚úÖ snapshot dos itens ANTES de limpar/resetar
      const itensNoEnvio = Array.isArray(estado.itens) ? estado.itens.map(it => ({ ...it })) : [];

      const payload = {
        dataHoraEscolhida: dataHoraPlanilha,
        encarregado: estado.encarregado,

        // ‚úÖ NOVO: Fornecedor (coluna M no backend, conforme sua regra)
        fornecedor: (tipoAtual === "RECEBIMENTO" ? estado.fornecedor : ""),

        itens: estado.itens.map(x => ({
          produto: x.produto,
          quantidade: x.quantidadeFmt,
          embalagem: x.embalagem,
          tipoLancamento: x.tipoLancamento,
          lojaDestino: x.lojaDestino || "",

          // ‚úÖ NOVO: tamb√©m manda por item (se o backend ignorar, n√£o quebra)
          fornecedor: (tipoAtual === "RECEBIMENTO" ? estado.fornecedor : "")
        }))
      };

      setMsg("Salvando... aguarde.", true);

      showLoading();
      startLoadingTimer();

      try {
        const resp = await fetch("/api/bono-salvar", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json", "Accept": "application/json" },
          body: JSON.stringify(payload)
        });

        const dados = await resp.json().catch(() => null);

        if (!resp.ok || !dados || !dados.sucesso) {
          const m =
            (dados && (dados.message || dados.mensagem)) ? (dados.message || dados.mensagem) :
            "Falha ao salvar o bono.";

          stopLoadingTimer();
          setLoadingPct(100);
          hideLoading();

          setMsg(m, false);
          return;
        }

        // ‚úÖ termina loading
        stopLoadingTimer();
        setLoadingPct(100);
        setTimeout(() => {
          hideLoading();
        }, 250);

        // ‚úÖ limpa estado como j√° fazia
        limparLocal();
        estado = { data: "", hora: "", encarregado: "", fornecedor: "", itens: [] };
        atualizarCamposNaTela();
        renderLista();

        document.getElementById("produto").value = "";
        document.getElementById("quantidade").value = "";
        document.getElementById("quantidade").dataset.digits = "";
        document.getElementById("embalagem").value = "";
        document.getElementById("tipoLancamento").value = "";
        document.getElementById("lojaDestino").value = "";
        document.getElementById("fornecedor").value = "";
        atualizarVisibilidadeDestino();
        atualizarVisibilidadeFornecedor();

        // ‚úÖ garante Qtd bloqueada quando embalagem resetar
        atualizarHabilitacaoQuantidade();

        setMsg("Bono finalizado e salvo com sucesso.", true);

        /* ‚úÖ AUTO (WhatsApp): se foi MOV_INTERNA, abre o WhatsApp automaticamente com a msg pronta */
        if (tipoNoEnvio === "MOV_INTERNA" && destinoNoEnvio) {
          const telefoneResp = await buscarTelefoneResponsavel(destinoNoEnvio);

          const linkLogin = montarLinkLoginAbsoluto();
          const msgWhats = montarMensagemWhats({
            lojaOrigem: (sessaoAtual && sessaoAtual.loja) ? sessaoAtual.loja : "",
            lojaDestino: destinoNoEnvio,
            usuario: (sessaoAtual && sessaoAtual.usuario) ? sessaoAtual.usuario : "",
            dataHora: dataHoraPlanilha,
            linkLogin,
            itens: itensNoEnvio
          });

          const okAbrir = abrirWhatsAppComMensagem(telefoneResp, msgWhats);

          if (!okAbrir) {
            setMsg("Bono salvo, mas n√£o encontrei o WhatsApp do respons√°vel da loja destino para abrir automaticamente.", false);
          }
        }

      } catch (e) {
        console.error(e);

        stopLoadingTimer();
        setLoadingPct(100);
        hideLoading();

        setMsg("Erro de rede ao salvar. Tente novamente.", false);
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("btnVoltarMenu").addEventListener("click", () => {
        window.location.href = ROTAS.menu;
      });

      document.getElementById("btnContinuar").addEventListener("click", () => {
        fecharModal("modalPendente");
        atualizarCamposNaTela();
        atualizarVisibilidadeDestino();
        atualizarVisibilidadeFornecedor();
        renderLista();
      });

      document.getElementById("btnDescartar").addEventListener("click", () => {
        limparLocal();
        estado = { data:"", hora:"", encarregado:"", fornecedor:"", itens:[] };
        fecharModal("modalPendente");
        atualizarCamposNaTela();
        atualizarVisibilidadeDestino();
        atualizarVisibilidadeFornecedor();
        renderLista();
        setMsg("Pend√™ncia descartada. Voc√™ pode iniciar um novo bono.", true);
      });

      document.getElementById("btnConfirmarNao").addEventListener("click", () => {
        fecharModal("modalConfirmar");
      });

      document.getElementById("btnConfirmarSim").addEventListener("click", async () => {
        fecharModal("modalConfirmar");
        await finalizarBono();
      });

      ["dataEscolhida","horaEscolhida","encarregado"].forEach(id => {
        document.getElementById(id).addEventListener("change", capturarBaseDoFormulario);
        document.getElementById(id).addEventListener("input", capturarBaseDoFormulario);
      });

      // ‚úÖ NOVO: fornecedor tamb√©m salva no estado
      document.getElementById("fornecedor").addEventListener("change", capturarBaseDoFormulario);
      document.getElementById("fornecedor").addEventListener("input", capturarBaseDoFormulario);

      document.getElementById("tipoLancamento").addEventListener("change", () => {
        atualizarVisibilidadeDestino();
        atualizarVisibilidadeFornecedor();
        capturarBaseDoFormulario();
        aplicarTipoEDestinoNosItens();
      });

      document.getElementById("lojaDestino").addEventListener("change", () => {
        capturarBaseDoFormulario();
        aplicarTipoEDestinoNosItens();
      });

      const elQtd = document.getElementById("quantidade");
      elQtd.addEventListener("keydown", bloquearPontuacao);
      elQtd.addEventListener("input", () => {
        aplicarMascaraQuantidade();
        capturarBaseDoFormulario();
      });

      document.getElementById("embalagem").addEventListener("change", () => {
        // ‚úÖ habilita/desabilita Qtd conforme embalagem
        atualizarHabilitacaoQuantidade();

        aplicarMascaraQuantidade();
        capturarBaseDoFormulario();
      });

      document.getElementById("btnAdicionar").addEventListener("click", () => {
        const dadosItem = validarParaAdicionarItem();
        if (!dadosItem) return;

        estado.itens.push({
          produto: dadosItem.produto,
          quantidade: dadosItem.quantidadeNum,
          quantidadeFmt: dadosItem.quantidadeFmt,
          embalagem: dadosItem.embalagem,
          tipoLancamento: dadosItem.tipoLancamento,
          lojaDestino: dadosItem.lojaDestino,
          // ‚úÖ NOVO: guarda fornecedor no item (n√£o muda a UI)
          fornecedor: dadosItem.fornecedor || ""
        });

        salvarLocal();
        renderLista();

        document.getElementById("produto").value = "";
        document.getElementById("quantidade").value = "";
        document.getElementById("quantidade").dataset.digits = "";

        setMsg("Item adicionado na lista.", true);
      });

      document.getElementById("btnSalvar").addEventListener("click", () => {
        const tipoAtual = document.getElementById("tipoLancamento").value;
        if (!tipoAtual) {
          setMsg("Selecione um tipo", false);
          return;
        }

        // ‚úÖ NOVO: fornecedor obrigat√≥rio apenas quando Tipo = RECEBIMENTO
        if (tipoAtual === "RECEBIMENTO") {
          capturarBaseDoFormulario();
          if (!estado.fornecedor) {
            setMsg('Informe o "Fornecedor" (obrigat√≥rio para Recebimento de mercadorias).', false);
            return;
          }
        }

        if (!estado.itens.length) {
          setMsg("A lista est√° vazia. Adicione um item antes de salvar.", false);
          return;
        }

        abrirModal("modalConfirmar");
      });

      const sessao = await obterSessaoDoBackend();
      if (!sessao) return redirecionarParaLogin("Sess√£o inv√°lida. Fa√ßa login para acessar.");

      aplicarSessaoNaTela(sessao);

      const pendente = carregarLocal();
      if (temPendenciaValida(pendente)) {
        estado = pendente;
        atualizarVisibilidadeDestino();
        atualizarVisibilidadeFornecedor();
        abrirModal("modalPendente");
      } else {
        atualizarCamposNaTela();
        atualizarVisibilidadeDestino();
        atualizarVisibilidadeFornecedor();
        renderLista();
      }

      // ‚úÖ estado inicial: Qtd bloqueada at√© escolher embalagem
      atualizarHabilitacaoQuantidade();
    });
  </script>
</body>
</html>
